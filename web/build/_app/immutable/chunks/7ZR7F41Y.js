const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_app/immutable/chunks/C1N4k4OZ.js","_app/immutable/chunks/DsnmJJEf.js","_app/immutable/chunks/DWQ0JXRY.js","_app/immutable/chunks/0qPXRVhz.js","_app/immutable/chunks/D0CSSuTl.js","_app/immutable/chunks/DIeogL5L.js","_app/immutable/chunks/C8vxa4mj.js","_app/immutable/chunks/Bd1JH_Ov.js","_app/immutable/chunks/D8NIUdeB.js","_app/immutable/chunks/orVkzVhB.js","_app/immutable/chunks/CMI33r64.js","_app/immutable/chunks/D-UYCH9y.js","_app/immutable/chunks/zonMEKN6.js","_app/immutable/chunks/gvLJu3l0.js","_app/immutable/chunks/BUApaBEI.js","_app/immutable/assets/Logo.REF6zmWd.css","_app/immutable/chunks/Cq6696VF.js","_app/immutable/chunks/BpCm29KX.js","_app/immutable/chunks/D1613R3V.js","_app/immutable/chunks/BP6NvnZ7.js","_app/immutable/chunks/BOeC8ZMP.js","_app/immutable/chunks/IOA7-Wrn.js","_app/immutable/chunks/BCf5NZQ6.js","_app/immutable/chunks/DU5vAHPb.js","_app/immutable/chunks/CJGyQpNN.js","_app/immutable/chunks/gegweU97.js","_app/immutable/chunks/BMcevgEe.js","_app/immutable/chunks/BHTYC334.js","_app/immutable/chunks/Tw41aoDi.js","_app/immutable/chunks/Bqqp8sy9.js","_app/immutable/chunks/DLePdI2u.js","_app/immutable/chunks/7tRQeUtl.js","_app/immutable/chunks/BgQCgJ0_.js","_app/immutable/chunks/s_2UW97Q.js","_app/immutable/assets/Input.idyGuON4.css","_app/immutable/chunks/i7F918yQ.js","_app/immutable/chunks/69_IOA4Y.js","_app/immutable/chunks/9chJ2bcr.js","_app/immutable/chunks/B8RZOa0L.js","_app/immutable/chunks/CeWyqUEf.js","_app/immutable/assets/Select.CV-KWLNP.css","_app/immutable/chunks/DUXNbmIP.js","_app/immutable/chunks/DxRnQWdm.js","_app/immutable/chunks/CG4KAGH3.js","_app/immutable/chunks/BRztk81V.js","_app/immutable/chunks/DDy4N4G7.js","_app/immutable/chunks/DyxjXAAs.js","_app/immutable/chunks/D-rYfuUG.js","_app/immutable/chunks/CUJqFo_9.js","_app/immutable/chunks/vr_k3QRA.js","_app/immutable/assets/map.BVV4B3I_.css","_app/immutable/chunks/DqZGkw0T.js","_app/immutable/chunks/BVZhy_zG.js","_app/immutable/chunks/BZ21-Ulh.js","_app/immutable/chunks/5Inb98wy.js","_app/immutable/chunks/FpAj0Eak.js","_app/immutable/chunks/BjFPDMuz.js","_app/immutable/chunks/msCV69PI.js","_app/immutable/chunks/CgXU4mBI.js","_app/immutable/chunks/Dgf_MdoC.js","_app/immutable/chunks/Biw8UfMB.js","_app/immutable/chunks/BzOEcAd-.js","_app/immutable/chunks/WQ1yKytR.js","_app/immutable/chunks/DnqqNi3p.js","_app/immutable/chunks/CSB7WcnD.js","_app/immutable/assets/photo-sphere-viewer-adapter.CksG-CW9.css","_app/immutable/chunks/Cs33NVWg.js","_app/immutable/chunks/BD8ry1BU.js","_app/immutable/assets/index.B9wQqAaO.css"])))=>i.map(i=>d[i]);
import"./DsnmJJEf.js";import{d as Fr,o as lr,s as ft,a as qs,e as He,r as Xc}from"./C8vxa4mj.js";import{aw as Nc,ar as Uc,ac as Gc,c as b,b as Lo,r as w,t as ct,p as kt,a as Ot,$ as Re,g as h,u as x,h as st,i as de,V as Ee,j as U,aQ as qc,s as k,n as ir,a0 as Kc,W as ws,f as _t,a1 as Qn,al as aa}from"./D0CSSuTl.js";import{a as D,f as q,t as xe,c as Gt}from"./Bd1JH_Ov.js";import{i as K}from"./D8NIUdeB.js";import{t as cr,h as he,e as kr,i as fl}from"./DLePdI2u.js";import{s as Wt,a as Se,bR as ml,cK as pl,au as $c,av as Zc,fd as Jc,aw as Qc,ax as th,I as ee,a4 as eh,a2 as rh,fe as sh,dj as ih,cv as nh,cE as vl,ff as oh,B as pn,ac as cs,v as Sr,h as _l,q as Cr,F as ar,ad as Ln,fg as ah,fh as lh,a8 as la,a9 as ca,ak as ch,ah as hh,bU as uh,eA as dh,aj as gh,bO as fh,fi as mh,c1 as ph,fj as vh,fk as _h,fl as yh,fm as xh,fn as wh,cl as bh,cm as Sh,dy as ha,br as Ys,r as yl,T as Rs,ag as Fo,w as Oi,bQ as Ch,G as Ts,fo as yo,u as Th,c7 as kh,cc as Oh,cX as Ah,p as xl,cy as ua,ab as Dh,bP as Eh,fp as Ph,aP as Mh,ca as Ih,c8 as Lh,fq as Fh,b5 as jh,b6 as Rh,fr as Bh,fs as zh,ft as Vh,fu as Wh,fv as Hh,c6 as Yh,fw as Xh,bp as wl,bo as bl,cd as Nh,f as Uh}from"./D-UYCH9y.js";import{a as Ue}from"./IOA7-Wrn.js";import{s as Et,a as ht,p as St,c as or,r as Gh,d as te,f as da,e as Fn}from"./zonMEKN6.js";import{g as vn}from"./gvLJu3l0.js";import{f as qh}from"./dsDpGkcL.js";import{s as Ps,a as Ai}from"./BVZhy_zG.js";import{$ as Ft,d as Kh}from"./DWQ0JXRY.js";import{s as Sl}from"./CMI33r64.js";import{c as Oe,A as Ve,g as $h,U as Zh,C as ps}from"./CIJfCxLq.js";import{A as Ls}from"./C_T4m_n1.js";import{M as Ae}from"./B2VKg7zy.js";import{A as Ut,h as Cl,a as _n,_ as zs,t as Jh,o as Xr,P as Tl}from"./0qPXRVhz.js";import{A as Qh,a as tu}from"./Q3VoKRsI.js";import{F as eu,G as ru,aw as su,s as iu,ax as nu,x as yi,y as ks,H as ou,ay as au,az as lu,aA as jo,h as Er,a9 as cu,M as kl,aB as hu,aC as Ol,aD as uu,aE as du,z as gu,l as fu,v as mu,a0 as pu,a7 as Al,ah as ga,ag as vu,al as _u,ai as fa,am as yu,n as ma}from"./DUXNbmIP.js";import{t as Pe,g as Dl,c as xu,b as wu}from"./CF_nq223.js";import{m as Or,H as yn,C as bu}from"./BHTYC334.js";import{o as Su}from"./WQ1yKytR.js";import{c2 as Cu,P as Tu,R as Di,cm as ku,a$ as Ou,au as Au,a5 as Du,E as El,cn as Eu,Q as as,F as ls,co as Pu,cp as Mu,n as an,k as Iu,cq as ai,cr as pa,cs as Lu,ct as Fu,h as xi,cu as va,bg as ju,cv as Ru,cw as Bu,cx as zu,cy as Vu,c7 as Wu,a2 as Hu}from"./BP6NvnZ7.js";import{f as Ro}from"./oXVv5nIS.js";import{A as Yu,d as Xu,g as _a,t as Nu,a as Uu}from"./ChL-L15l.js";import{p as Bo,u as Xs,D as fi}from"./CJGyQpNN.js";import{b as xn}from"./Dgf_MdoC.js";import{a as Rt,b as Gu,g as qu}from"./BZ21-Ulh.js";import{I as os,B as Ku,i as di}from"./CLpfTz4o.js";import{a as wn}from"./Cr9S0fVn.js";import{i as hs}from"./BmJQ54Se.js";import{I as $u}from"./s_2UW97Q.js";import{k as Zu,a as Ks}from"./DxRnQWdm.js";import{C as Ju,I as Qu}from"./D3D47pl8.js";import{a as ae,b as ln,c as td,s as jn,S as Os}from"./BOLL51yO.js";import{F as zo}from"./BMcevgEe.js";import{B as ed}from"./GXf5CvES.js";import{R as rr}from"./gegweU97.js";import{C as rd}from"./CG2BHJh0.js";import{O as Pl}from"./Cq6696VF.js";import{a as Vr,A as sd,b as id}from"./C3VE5xEq.js";import{e as Ml}from"./BpCm29KX.js";import{T as nd}from"./CbJ1QVsO.js";import{a as wi}from"./Biw8UfMB.js";import{T as od}from"./BcI9YXFA.js";import{C as ad}from"./BVcN3VUI.js";import{P as ld}from"./BRztk81V.js";import{a as cd,L as hd}from"./DU5vAHPb.js";import{f as ud,C as dd}from"./DCmy867i.js";import{g as gd}from"./DcdhlkRn.js";import{A as fd}from"./CC3fx6b-.js";import{D as md}from"./BCf5NZQ6.js";import{g as pd}from"./DxfhPdFw.js";import{P as vd,g as Il}from"./D5KKc-uL.js";import{l as Ll,q as _d}from"./Tw41aoDi.js";import"./69_IOA4Y.js";import{i as yd}from"./9chJ2bcr.js";import{t as xd}from"./BbpJDI0d.js";import{D as wd}from"./GyRE5G4-.js";import{F as li}from"./BgQCgJ0_.js";import{S as Ii}from"./i7F918yQ.js";import{N as bd}from"./XSsqx5Lk.js";import{H as Sd}from"./Dt4pkAJO.js";function Cd(a,t,e=t){var r=()=>{e(a.volume)};t()==null&&r(),Nc(a,["volumechange"],r,!1),Uc(()=>{var s=Number(t());s!==a.volume&&!isNaN(s)&&(a.volume=s)})}function Td(a,t,e,r,s){var i=()=>{r(e[a])};e.addEventListener(t,i),i(),(e===document.body||e===window||e===document)&&Gc(()=>{e.removeEventListener(t,i)})}var kd=q('<button type="button" class="my-auto mx-4 rounded-full p-3 text-gray-500 transition hover:bg-gray-500 hover:text-white"><!></button>');function Fl(a,t){var e=kd();e.__click=function(...s){t.onClick?.apply(this,s)};var r=b(e);Sl(r,()=>t.children??Lo),w(e),ct(()=>Wt(e,"aria-label",t.label)),D(a,e)}Fr(["click"]);function Od(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();Ue(Re,(i,n)=>Ps?.(i,n),()=>[{shortcut:{key:"ArrowRight"},onShortcut:t.onNextAsset},{shortcut:{key:"d"},onShortcut:t.onNextAsset}]);{let i=x(()=>e()("view_next_asset"));Fl(a,{get onClick(){return t.onNextAsset},get label(){return h(i)},children:(n,o)=>{Se(n,{get icon(){return ml},size:"36","aria-hidden":!0})}})}Ot(),s()}function Ad(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();Ue(Re,(i,n)=>Ps?.(i,n),()=>[{shortcut:{key:"ArrowLeft"},onShortcut:t.onPreviousAsset},{shortcut:{key:"a"},onShortcut:t.onPreviousAsset}]);{let i=x(()=>e()("view_previous_asset"));Fl(a,{get onClick(){return t.onPreviousAsset},get label(){return h(i)},children:(n,o)=>{Se(n,{get icon(){return pl},size:"36","aria-hidden":!0})}})}Ot(),s()}function ya(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"shared",3,!1);const n=async()=>{const o=await Or.show(Qh,{shared:i()});if(!(!o||o.length===0))if(o.length===1){const l=o[0];await eu(l.id,[t.asset.id]),t.onAction({type:Ut.ADD_TO_ALBUM,asset:Pe(t.asset),album:l})}else await ru(o.map(l=>l.id),[t.asset.id]),t.onAction({type:Ut.ADD_TO_ALBUM,asset:Pe(t.asset),album:o[0]})};Ue(Re,(o,l)=>Ai?.(o,l),()=>({shortcut:{key:"l",shift:i()},onShortcut:n}));{let o=x(()=>i()?$c:Zc),l=x(()=>i()?e()("add_to_shared_album"):e()("add_to_album"));Ae(a,{get icon(){return h(o)},get text(){return h(l)},onClick:n})}Ot(),s()}function Dd(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{const n=await Su({multiple:!0}),l=[t.stack?.primaryAssetId??t.asset.id,...n],c=await Cu({stackCreateDto:{assetIds:l}});t.onAction({type:Ut.STACK,stack:c})};{let n=x(()=>e()("add_upload_to_stack"));Ae(a,{get icon(){return Jc},onClick:i,get text(){return h(n)}})}Ot(),s()}function Ed(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{t.asset.isArchived||t.preAction({type:Ut.ARCHIVE,asset:Pe(t.asset)}),await su(t.asset)&&t.onAction({type:t.asset.isArchived?Ut.ARCHIVE:Ut.UNARCHIVE,asset:Pe(t.asset)})};Ue(Re,(n,o)=>Ai?.(n,o),()=>({shortcut:{key:"a",shift:!0},onShortcut:i}));{let n=x(()=>t.asset.isArchived?Qc:th),o=x(()=>t.asset.isArchived?e()("unarchive"):e()("to_archive"));Ae(a,{get icon(){return h(n)},get text(){return h(o)},onClick:i})}Ot(),s()}function Pd(a,t){kt(t,!0);const e=()=>ht(iu,"$showDeleteModal",s),r=()=>ht(Ft,"$t",s),[s,i]=Et();let n=St(t,"onUndoDelete",3,void 0);const o=x(()=>t.asset.isTrashed||!Ro.value.trash),l=async c=>{const u=Pe(t.asset);if(h(o)||c){if(e()&&!await Or.show(Yu,{size:1}))return;try{t.preAction({type:Ut.DELETE,asset:u}),await Tu({assetBulkDeleteDto:{ids:[t.asset.id],force:!0}}),t.onAction({type:Ut.DELETE,asset:u}),cr.success(r()("permanently_deleted_asset"))}catch(g){he(g,r()("errors.unable_to_delete_asset"))}return}t.preAction({type:Ut.TRASH,asset:u}),await Xu(!1,()=>t.onAction({type:Ut.TRASH,asset:u}),[u],n())};Ue(Re,(c,u)=>Ps?.(c,u),()=>[{shortcut:{key:"Delete"},onShortcut:()=>l()},{shortcut:{key:"Delete",shift:!0},onShortcut:()=>l(!0)}]);{let c=x(()=>h(o)?eh:rh),u=x(()=>h(o)?r()("permanently_delete"):r()("delete"));ee(a,{color:"secondary",shape:"round",variant:"ghost",get icon(){return h(c)},get"aria-label"(){return h(u)},onclick:()=>l()})}Ot(),i()}function Md(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{if(!await Or.showDialog({title:e()("keep_this_delete_others"),prompt:e()("confirm_keep_this_delete_others"),confirmText:e()("delete_others")}))return;const o=await nu(t.asset,t.stack);o&&t.onAction({type:Ut.UNSTACK,assets:[Pe(o)]})};{let n=x(()=>e()("keep_this_delete_others"));Ae(a,{get icon(){return sh},onClick:i,get text(){return h(n)}})}Ot(),s()}function Id(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",s),r=()=>ht(Bo,"$preferences",s),[s,i]=Et();let n=St(t,"asset",7);const o=async l=>{try{const c=l===null?{}:{rating:l};await Di({id:n().id,updateAssetDto:c}),n({...n(),exifInfo:{...n().exifInfo,rating:l}}),t.onAction({type:Ut.RATING,asset:Pe(n()),rating:l})}catch(c){he(c,e()("errors.unable_to_set_rating"))}};Ue(Re,(l,c)=>Ps?.(l,c),()=>r()?.ratings.enabled?[{shortcut:{key:"0"},onShortcut:()=>o(null)},...[1,2,3,4,5].map(l=>({shortcut:{key:String(l)},onShortcut:()=>o(l)}))]:[]),Ot(),i()}function Ld(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{await ku({id:t.stack.id,assetId:t.asset.id});const n={...t.stack,assets:t.stack.assets.filter(o=>o.id!==t.asset.id)};t.onAction({type:Ut.REMOVE_ASSET_FROM_STACK,stack:n,asset:t.asset})};{let n=x(()=>e()("viewer_remove_from_stack"));Ae(a,{get icon(){return ih},onClick:i,get text(){return h(n)}})}Ot(),s()}function Fd(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"asset",15);const n=async()=>{try{await Ou({bulkIdsDto:{ids:[i().id]}}),i(i().isTrashed=!1,!0),t.onAction({type:Ut.RESTORE,asset:Pe(i())}),cr.success(e()("restored_asset"))}catch(o){he(o,e()("errors.unable_to_restore_assets"))}};{let o=x(()=>e()("restore"));Ae(a,{get icon(){return nh},onClick:n,get text(){return h(o)}})}Ot(),s()}function jd(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{try{await Au({id:t.album.id,updateAlbumDto:{albumThumbnailAssetId:t.asset.id}}),cr.success(e()("album_cover_updated"))}catch(n){he(n,e()("errors.unable_to_update_album_cover"))}};{let n=x(()=>e()("set_as_album_cover"));Ae(a,{get text(){return h(n)},get icon(){return vl},onClick:i})}Ot(),s()}function Rd(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"person",7);const n=async()=>{try{const o=await Du({id:i().id,personUpdateDto:{featureFaceAssetId:t.asset.id}});i({...i(),...o}),t.onAction?.({type:Ut.SET_PERSON_FEATURED_PHOTO,asset:t.asset,person:i()}),cr.success(e()("feature_photo_updated"))}catch(o){he(o,e()("errors.unable_to_set_feature_photo"))}};{let o=x(()=>e()("set_as_featured_photo"));Ae(a,{get text(){return h(o)},get icon(){return oh},onClick:n})}Ot(),s()}var to={exports:{}},xa;function Bd(){return xa||(xa=1,(function(a){(function(t){var e=O(),r=A(),s=M(),i=F(),n={imagePlaceholder:void 0,cacheBust:!1},o={toSvg:l,toPng:u,toJpeg:d,toBlob:g,toPixelData:c,impl:{fontFaces:s,images:i,util:e,inliner:r,options:{}}};a.exports=o;function l(E,_){return _=_||{},f(_),Promise.resolve(E).then(function(Y){return p(Y,_.filter,!0)}).then(v).then(y).then(j).then(function(Y){return S(Y,_.width||e.width(E),_.height||e.height(E))});function j(Y){return _.bgcolor&&(Y.style.backgroundColor=_.bgcolor),_.width&&(Y.style.width=_.width+"px"),_.height&&(Y.style.height=_.height+"px"),_.style&&Object.keys(_.style).forEach(function(G){Y.style[G]=_.style[G]}),Y}}function c(E,_){return m(E,_||{}).then(function(j){return j.getContext("2d").getImageData(0,0,e.width(E),e.height(E)).data})}function u(E,_){return m(E,_||{}).then(function(j){return j.toDataURL()})}function d(E,_){return _=_||{},m(E,_).then(function(j){return j.toDataURL("image/jpeg",_.quality||1)})}function g(E,_){return m(E,_||{}).then(e.canvasToBlob)}function f(E){typeof E.imagePlaceholder>"u"?o.impl.options.imagePlaceholder=n.imagePlaceholder:o.impl.options.imagePlaceholder=E.imagePlaceholder,typeof E.cacheBust>"u"?o.impl.options.cacheBust=n.cacheBust:o.impl.options.cacheBust=E.cacheBust}function m(E,_){return l(E,_).then(e.makeImage).then(e.delay(100)).then(function(Y){var G=j(E);return G.getContext("2d").drawImage(Y,0,0),G});function j(Y){var G=document.createElement("canvas");if(G.width=_.width||e.width(Y),G.height=_.height||e.height(Y),_.bgcolor){var R=G.getContext("2d");R.fillStyle=_.bgcolor,R.fillRect(0,0,G.width,G.height)}return G}}function p(E,_,j){if(!j&&_&&!_(E))return Promise.resolve();return Promise.resolve(E).then(Y).then(function(V){return G(E,V,_)}).then(function(V){return R(E,V)});function Y(V){return V instanceof HTMLCanvasElement?e.makeImage(V.toDataURL()):V.cloneNode(!1)}function G(V,W,tt){var et=V.childNodes;if(et.length===0)return Promise.resolve(W);return z(W,e.asArray(et),tt).then(function(){return W});function z(Z,Q,rt){var nt=Promise.resolve();return Q.forEach(function(ut){nt=nt.then(function(){return p(ut,rt)}).then(function(lt){lt&&Z.appendChild(lt)})}),nt}}function R(V,W){if(!(W instanceof Element))return W;return Promise.resolve().then(tt).then(et).then(z).then(Z).then(function(){return W});function tt(){Q(window.getComputedStyle(V),W.style);function Q(rt,nt){rt.cssText?nt.cssText=rt.cssText:ut(rt,nt);function ut(lt,dt){e.asArray(lt).forEach(function(P){dt.setProperty(P,lt.getPropertyValue(P),lt.getPropertyPriority(P))})}}}function et(){[":before",":after"].forEach(function(rt){Q(rt)});function Q(rt){var nt=window.getComputedStyle(V,rt),ut=nt.getPropertyValue("content");if(ut===""||ut==="none")return;var lt=e.uid();W.className=W.className+" "+lt;var dt=document.createElement("style");dt.appendChild(P(lt,rt,nt)),W.appendChild(dt);function P(H,X,N){var I="."+H+":"+X,J=N.cssText?yt(N):Mt(N);return document.createTextNode(I+"{"+J+"}");function yt(pt){var It=pt.getPropertyValue("content");return pt.cssText+" content: "+It+";"}function Mt(pt){return e.asArray(pt).map(It).join("; ")+";";function It(Vt){return Vt+": "+pt.getPropertyValue(Vt)+(pt.getPropertyPriority(Vt)?" !important":"")}}}}}function z(){V instanceof HTMLTextAreaElement&&(W.innerHTML=V.value),V instanceof HTMLInputElement&&W.setAttribute("value",V.value)}function Z(){W instanceof SVGElement&&(W.setAttribute("xmlns","http://www.w3.org/2000/svg"),W instanceof SVGRectElement&&["width","height"].forEach(function(Q){var rt=W.getAttribute(Q);rt&&W.style.setProperty(Q,rt)}))}}}function v(E){return s.resolveAll().then(function(_){var j=document.createElement("style");return E.appendChild(j),j.appendChild(document.createTextNode(_)),E})}function y(E){return i.inlineAll(E).then(function(){return E})}function S(E,_,j){return Promise.resolve(E).then(function(Y){return Y.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),new XMLSerializer().serializeToString(Y)}).then(e.escapeXhtml).then(function(Y){return'<foreignObject x="0" y="0" width="100%" height="100%">'+Y+"</foreignObject>"}).then(function(Y){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+_+'" height="'+j+'">'+Y+"</svg>"}).then(function(Y){return"data:image/svg+xml;charset=utf-8,"+Y})}function O(){return{escape:Z,parseExtension:_,mimeType:j,dataAsUrl:z,isDataUrl:Y,canvasToBlob:R,resolveUrl:V,getAndEncode:et,uid:W(),delay:Q,asArray:rt,escapeXhtml:nt,makeImage:tt,width:ut,height:lt};function E(){var P="application/font-woff",H="image/jpeg";return{woff:P,woff2:P,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:H,jpeg:H,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}function _(P){var H=/\.([^\.\/]*?)$/g.exec(P);return H?H[1]:""}function j(P){var H=_(P).toLowerCase();return E()[H]||""}function Y(P){return P.search(/^(data:)/)!==-1}function G(P){return new Promise(function(H){for(var X=window.atob(P.toDataURL().split(",")[1]),N=X.length,I=new Uint8Array(N),J=0;J<N;J++)I[J]=X.charCodeAt(J);H(new Blob([I],{type:"image/png"}))})}function R(P){return P.toBlob?new Promise(function(H){P.toBlob(H)}):G(P)}function V(P,H){var X=document.implementation.createHTMLDocument(),N=X.createElement("base");X.head.appendChild(N);var I=X.createElement("a");return X.body.appendChild(I),N.href=H,I.href=P,I.href}function W(){var P=0;return function(){return"u"+H()+P++;function H(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}function tt(P){return new Promise(function(H,X){var N=new Image;N.onload=function(){H(N)},N.onerror=X,N.src=P})}function et(P){var H=3e4;return o.impl.options.cacheBust&&(P+=(/\?/.test(P)?"&":"?")+new Date().getTime()),new Promise(function(X){var N=new XMLHttpRequest;N.onreadystatechange=yt,N.ontimeout=Mt,N.responseType="blob",N.timeout=H,N.open("GET",P,!0),N.send();var I;if(o.impl.options.imagePlaceholder){var J=o.impl.options.imagePlaceholder.split(/,/);J&&J[1]&&(I=J[1])}function yt(){if(N.readyState===4){if(N.status!==200){I?X(I):pt("cannot fetch resource: "+P+", status: "+N.status);return}var It=new FileReader;It.onloadend=function(){var Vt=It.result.split(/,/)[1];X(Vt)},It.readAsDataURL(N.response)}}function Mt(){I?X(I):pt("timeout of "+H+"ms occured while fetching resource: "+P)}function pt(It){console.error(It),X("")}})}function z(P,H){return"data:"+H+";base64,"+P}function Z(P){return P.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function Q(P){return function(H){return new Promise(function(X){setTimeout(function(){X(H)},P)})}}function rt(P){for(var H=[],X=P.length,N=0;N<X;N++)H.push(P[N]);return H}function nt(P){return P.replace(/#/g,"%23").replace(/\n/g,"%0A")}function ut(P){var H=dt(P,"border-left-width"),X=dt(P,"border-right-width");return P.scrollWidth+H+X}function lt(P){var H=dt(P,"border-top-width"),X=dt(P,"border-bottom-width");return P.scrollHeight+H+X}function dt(P,H){var X=window.getComputedStyle(P).getPropertyValue(H);return parseFloat(X.replace("px",""))}}function A(){var E=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:G,shouldProcess:_,impl:{readUrls:j,inline:Y}};function _(R){return R.search(E)!==-1}function j(R){for(var V=[],W;(W=E.exec(R))!==null;)V.push(W[1]);return V.filter(function(tt){return!e.isDataUrl(tt)})}function Y(R,V,W,tt){return Promise.resolve(V).then(function(z){return W?e.resolveUrl(z,W):z}).then(tt||e.getAndEncode).then(function(z){return e.dataAsUrl(z,e.mimeType(V))}).then(function(z){return R.replace(et(V),"$1"+z+"$3")});function et(z){return new RegExp(`(url\\(['"]?)(`+e.escape(z)+`)(['"]?\\))`,"g")}}function G(R,V,W){if(tt())return Promise.resolve(R);return Promise.resolve(R).then(j).then(function(et){var z=Promise.resolve(R);return et.forEach(function(Z){z=z.then(function(Q){return Y(Q,Z,V,W)})}),z});function tt(){return!_(R)}}}function M(){return{resolveAll:E,impl:{readAll:_}};function E(){return _().then(function(j){return Promise.all(j.map(function(Y){return Y.resolve()}))}).then(function(j){return j.join(`
`)})}function _(){return Promise.resolve(e.asArray(document.styleSheets)).then(Y).then(j).then(function(R){return R.map(G)});function j(R){return R.filter(function(V){return V.type===CSSRule.FONT_FACE_RULE}).filter(function(V){return r.shouldProcess(V.style.getPropertyValue("src"))})}function Y(R){var V=[];return R.forEach(function(W){try{e.asArray(W.cssRules||[]).forEach(V.push.bind(V))}catch(tt){console.log("Error while reading CSS rules from "+W.href,tt.toString())}}),V}function G(R){return{resolve:function(){var W=(R.parentStyleSheet||{}).href;return r.inlineAll(R.cssText,W)},src:function(){return R.style.getPropertyValue("src")}}}}}function F(){return{inlineAll:_,impl:{newImage:E}};function E(j){return{inline:Y};function Y(G){return e.isDataUrl(j.src)?Promise.resolve():Promise.resolve(j.src).then(G||e.getAndEncode).then(function(R){return e.dataAsUrl(R,e.mimeType(j.src))}).then(function(R){return new Promise(function(V,W){j.onload=V,j.onerror=W,j.src=R})})}}function _(j){if(!(j instanceof Element))return Promise.resolve(j);return Y(j).then(function(){return j instanceof HTMLImageElement?E(j).inline():Promise.all(e.asArray(j.childNodes).map(function(G){return _(G)}))});function Y(G){var R=G.style.getPropertyValue("background");return R?r.inlineAll(R).then(function(V){G.style.setProperty("background",V,G.style.getPropertyPriority("background"))}).then(function(){return G}):Promise.resolve(G)}}}})()})(to)),to.exports}var zd=Bd();const Vd=Kh(zd);function eo(a,t,e){return Math.max(t,Math.min(e,a))}function cn(a){a.preventDefault()}var Wd=new Set(["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"]);function Hd(a){if(Wd.has(a.key))return cn(a),!1}var jl=new AbortController,Li=jl.signal;function Yd(){window.addEventListener("DOMMouseScroll",cn,{signal:Li}),window.addEventListener("wheel",cn,{passive:!1,signal:Li}),window.addEventListener("touchmove",cn,{passive:!1,signal:Li}),window.addEventListener("keydown",Hd,{signal:Li})}function ro(){jl?.abort()}function Xd(a){if(!a)throw new Error("Please specify a container for the zoom image");const t=a.querySelector("img");if(!t)throw new Error("Please place an image inside the container");return t}function wa(a,t){return{x:(a.x+t.x)/2,y:(a.y+t.y)/2}}function Nd(a,t){const e=wa(a[0],a[1]),r=wa(t[0],t[1]),s={x:r.x-e.x,y:r.y-e.y},i=Math.hypot(a[0].x-a[1].x,a[0].y-a[1].y);let o=Math.hypot(t[0].x-t[1].x,t[0].y-t[1].y)/i;const l=1e-5;return Math.abs(o-1)<l&&(o=1+l),{scale:o,center:{x:e.x+s.x/(1-o),y:e.y+s.y/(1-o)}}}function vs(a,t){return e=>{a()&&t(e)}}function Ud(a){let t=new Set,e=!1,r=a,s,i=(o={})=>{s={...s,...o},n()},n=()=>{if(e)return;let o=!1;if(s){for(let l in s)if(r[l]!==s[l]){o=!0;break}}o&&(r={...r,...s},t.forEach(l=>l({state:r,updatedProperties:s})),s=void 0)};return{subscribe:o=>(t.add(o),()=>{t.delete(o)}),cleanup:()=>t.clear(),getState:()=>r,setState:i,batch:o=>{e=!0,o(),e=!1,n()}}}var ba=.5,Sa={currentZoom:1,enable:!0,currentPositionX:0,currentPositionY:0,currentRotation:0},Gd=()=>!0;function qd(a,t={}){const e=Xd(a),r={maxZoom:t.maxZoom||4,wheelZoomRatio:t.wheelZoomRatio||.1,dblTapAnimationDuration:t.dblTapAnimationDuration||300,initialState:{...Sa,...t.initialState},shouldZoomOnSingleTouch:t.shouldZoomOnSingleTouch||Gd},s=Ud(r.initialState),i=()=>[90,270].includes(s.getState().currentRotation%360),n=(P,H,X)=>{if(P>0)return 0;const N=X?a.clientHeight:a.clientWidth;return P+N*H<N?-N*(H-1):P},o=(P,H,X)=>{if(P>0)return 0;const N=X?a.clientWidth:a.clientHeight;return P+N*H<N?-N*(H-1):P},l=P=>{const H=a.clientWidth/2,X=a.clientHeight/2,N=s.getState(),I=(H-N.currentPositionX)/N.currentZoom,J=(X-N.currentPositionY)/N.currentZoom;s.setState({currentZoom:P,currentPositionX:n(-I*P+H,P,!1),currentPositionY:o(-J*P+X,P,!1)})};let c=null,u=!0;const d=new Map;let g=0,f=0,m=0,p=0;a.style.overflow="hidden",e.style.transformOrigin="0 0";function v(){const P=s.getState();e.style.transform=`translate(${P.currentPositionX}px, ${P.currentPositionY}px) scale(${P.currentZoom})`,a.style.rotate=`${P.currentRotation}deg`}function y(P){s.batch(()=>{const H=s.getState();if(!(typeof P.enable=="boolean"&&P.enable!==H.enable&&(s.setState({enable:P.enable}),!P.enable))){if(typeof P.currentRotation=="number"){const X=P.currentRotation;s.setState({currentRotation:X})}if(typeof P.currentZoom=="number"&&P.currentZoom!==H.currentZoom){const X=eo(P.currentZoom,1,r.maxZoom);if(X===H.currentZoom)return;l(X)}}}),v()}function S({delta:P,x:H,y:X}){const N=a.getBoundingClientRect(),I=s.getState(),J=i();let yt=-1,Mt=-1;switch(I.currentRotation%360){case 0:yt=H-N.left,Mt=X-N.top;break;case 90:yt=Math.abs(H-N.right),Mt=Math.abs(X-N.top);break;case 180:yt=Math.abs(H-N.right),Mt=Math.abs(X-N.bottom);break;case 270:yt=Math.abs(H-N.left),Mt=Math.abs(X-N.bottom);break}const pt=J?I.currentPositionY:I.currentPositionX,It=J?I.currentPositionX:I.currentPositionY,Vt=(yt-pt)/I.currentZoom,Ce=(Mt-It)/I.currentZoom,Bt=eo(I.currentZoom+P*r.wheelZoomRatio*I.currentZoom,1,r.maxZoom),oe=n(-Vt*Bt+yt,Bt,J),ue=o(-Ce*Bt+Mt,Bt,J);s.setState({currentZoom:Bt,currentPositionX:J?ue:oe,currentPositionY:J?oe:ue})}function O(){if(d.size===1){const{x:H,y:X}=d.values().next().value,N=i();m=N?X:H,p=N?H:X}const P=s.getState();g=P.currentPositionX,f=P.currentPositionY}function A(P){if(P.preventDefault(),s.getState().currentZoom===r.maxZoom&&P.deltaY<0)return;const H=-eo(P.deltaY,-ba,ba);S({delta:H,x:P.clientX,y:P.clientY}),v(),O()}function M(P){P.preventDefault();const{clientX:H,clientY:X,pointerId:N}=P;for(const[yt]of d.entries())yt===N&&d.set(yt,{x:H,y:X});const{currentZoom:I,currentRotation:J}=s.getState();if(d.size===1&&I!==1){const yt=i(),Mt=yt?X:H,pt=yt?H:X;let It=-1,Vt=-1;switch(J%360){case 0:It=Mt-m,Vt=pt-p;break;case 90:It=Mt-m,Vt=p-pt;break;case 180:It=m-Mt,Vt=p-pt;break;case 270:It=m-Mt,Vt=pt-p;break}s.setState({currentPositionX:n(g+It,I,!1),currentPositionY:o(f+Vt,I,!1)}),v()}}const F={startTimestamp:null,start:{x:0,y:0,zoom:0},target:{x:0,y:0,zoom:0}};function E(P){const H=s.getState();F.startTimestamp=null,F.start={x:H.currentPositionX,y:H.currentPositionY,zoom:H.currentZoom},H.currentZoom>1?F.target={x:0,y:0,zoom:1}:F.target={zoom:r.maxZoom,x:P.x*(1-r.maxZoom),y:P.y*(1-r.maxZoom)};function X(I,J,yt){return I*(1-yt)+J*yt}function N(I){F.startTimestamp===null&&(F.startTimestamp=I);let J=(I-F.startTimestamp)/r.dblTapAnimationDuration;J>1&&(J=1),s.setState({currentPositionX:X(F.start.x,F.target.x,J),currentPositionY:X(F.start.y,F.target.y,J),currentZoom:X(F.start.zoom,F.target.zoom,J)}),v(),J<1&&requestAnimationFrame(N)}requestAnimationFrame(N)}let _=null;const j=300;function Y(P){if(!(P.touches.length>1))if(_===null)_=setTimeout(()=>{_=null},j);else{clearTimeout(_),_=null;const H=a.getBoundingClientRect(),X=P.touches[0];E({x:X.clientX-H.left,y:X.clientY-H.top});return}}function G(P){if(r.shouldZoomOnSingleTouch()&&P.preventDefault(),P.touches.length>1){P.preventDefault();const H=[...P.touches].map(X=>({x:X.clientX,y:X.clientY}));if(c!==null){const{scale:X,center:N}=Nd(c,H);S({delta:Math.log(X)/r.wheelZoomRatio,...N})}c=H,v();return}}function R(P){if(P.pointerType==="touch"&&!r.shouldZoomOnSingleTouch()||(P.preventDefault(),d.size===2))return;u&&(Yd(),u=!1);const{clientX:H,clientY:X,pointerId:N}=P,I=s.getState();g=I.currentPositionX,f=I.currentPositionY;const J=i();m=J?X:H,p=J?H:X,d.set(N,{x:H,y:X})}function V(P){d.delete(P.pointerId),d.size<2&&(c=null),d.size===0&&!u&&(ro(),u=!0),O()}function W(P){P.preventDefault(),d.delete(P.pointerId),c=null,u||(ro(),u=!0)}function tt(){return s.getState().enable}const et=vs(tt,A),z=vs(tt,R),Z=vs(tt,W),Q=vs(tt,M),rt=vs(tt,V),nt=vs(tt,Y),ut=vs(tt,G),lt=new AbortController,{signal:dt}=lt;return a.addEventListener("wheel",et,{signal:dt}),a.addEventListener("touchstart",nt,{signal:dt}),a.addEventListener("touchmove",ut,{signal:dt}),a.addEventListener("pointerdown",z,{signal:dt}),a.addEventListener("pointerleave",Z,{signal:dt}),a.addEventListener("pointermove",Q,{signal:dt}),a.addEventListener("pointerup",rt,{signal:dt}),a.addEventListener("touchend",()=>{u=!0,ro()},{signal:dt}),s.getState().currentZoom!==Sa.currentZoom&&(l(s.getState().currentZoom),v()),{cleanup(){lt.abort(),s.cleanup()},subscribe:s.subscribe,setState:y,getState:s.getState}}const Kd=(a,t)=>{const e=qd(a,{maxZoom:10,initialState:Rt.zoomState}),r=[Rt.on({ZoomChange:i=>e.setState(i)}),e.subscribe(({state:i})=>Rt.onZoomChange(i))],s=i=>{t?.disabled&&i.stopImmediatePropagation()};return a.addEventListener("wheel",s,{capture:!0}),a.addEventListener("pointerdown",s,{capture:!0}),a.style.overflow="visible",{update(i){t=i},destroy(){for(const i of r)i();a.removeEventListener("wheel",s,{capture:!0}),a.removeEventListener("pointerdown",s,{capture:!0}),e.cleanup()}}};function C(a,t,e){return(t=(function(r){var s=(function(i,n){if(typeof i!="object"||!i)return i;var o=i[Symbol.toPrimitive];if(o!==void 0){var l=o.call(i,n);if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(i)})(r,"string");return typeof s=="symbol"?s:s+""})(t))in a?Object.defineProperty(a,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):a[t]=e,a}function Ca(a,t){var e=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);t&&(r=r.filter((function(s){return Object.getOwnPropertyDescriptor(a,s).enumerable}))),e.push.apply(e,r)}return e}function T(a){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Ca(Object(e),!0).forEach((function(r){C(a,r,e[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(e)):Ca(Object(e)).forEach((function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(e,r))}))}return a}function ne(a,t){if(a==null)return{};var e,r,s=(function(n,o){if(n==null)return{};var l={};for(var c in n)if({}.hasOwnProperty.call(n,c)){if(o.indexOf(c)>=0)continue;l[c]=n[c]}return l})(a,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(a);for(r=0;r<i.length;r++)e=i[r],t.indexOf(e)>=0||{}.propertyIsEnumerable.call(a,e)&&(s[e]=a[e])}return s}function jr(a,t){return t||(t=a.slice(0)),Object.freeze(Object.defineProperties(a,{raw:{value:Object.freeze(t)}}))}class Ta{constructor(){C(this,"browserShadowBlurConstant",1),C(this,"DPI",96),C(this,"devicePixelRatio",typeof window<"u"?window.devicePixelRatio:1),C(this,"perfLimitSizeTotal",2097152),C(this,"maxCacheSideLimit",4096),C(this,"minCacheSideLimit",256),C(this,"disableStyleCopyPaste",!1),C(this,"enableGLFiltering",!0),C(this,"textureSize",4096),C(this,"forceGLPutImageData",!1),C(this,"cachesBoundsOfCurve",!1),C(this,"fontPaths",{}),C(this,"NUM_FRACTION_DIGITS",4)}}const Ht=new class extends Ta{constructor(a){super(),this.configure(a)}configure(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.assign(this,a)}addFonts(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.fontPaths=T(T({},this.fontPaths),a)}removeFonts(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach((a=>{delete this.fontPaths[a]}))}clearFonts(){this.fontPaths={}}restoreDefaults(a){const t=new Ta,e=a?.reduce(((r,s)=>(r[s]=t[s],r)),{})||t;this.configure(e)}},us=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return console[a]("fabric",...e)};class Mr extends Error{constructor(t,e){super("fabric: ".concat(t),e)}}class $d extends Mr{constructor(t){super("".concat(t," 'options.signal' is in 'aborted' state"))}}class Zd{}class Jd extends Zd{testPrecision(t,e){const r="precision ".concat(e,` float;
void main(){}`),s=t.createShader(t.FRAGMENT_SHADER);return!!s&&(t.shaderSource(s,r),t.compileShader(s),!!t.getShaderParameter(s,t.COMPILE_STATUS))}queryWebGL(t){const e=t.getContext("webgl");e&&(this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.GLPrecision=["highp","mediump","lowp"].find((r=>this.testPrecision(e,r))),e.getExtension("WEBGL_lose_context").loseContext(),us("log","WebGL: max texture size ".concat(this.maxTextureSize)))}isSupported(t){return!!this.maxTextureSize&&this.maxTextureSize>=t}}const Qd={};let ka;const Lr=()=>ka||(ka={document,window,isTouchSupported:"ontouchstart"in window||"ontouchstart"in document||window&&window.navigator&&window.navigator.maxTouchPoints>0,WebGLProbe:new Jd,dispose(){},copyPasteData:Qd}),Zs=()=>Lr().document,Rn=()=>Lr().window,Rl=()=>{var a;return Math.max((a=Ht.devicePixelRatio)!==null&&a!==void 0?a:Rn().devicePixelRatio,1)},mi=new class{constructor(){C(this,"boundsOfCurveCache",{}),this.charWidthsCache=new Map}getFontCache(a){let{fontFamily:t,fontStyle:e,fontWeight:r}=a;t=t.toLowerCase();const s=this.charWidthsCache;s.has(t)||s.set(t,new Map);const i=s.get(t),n="".concat(e.toLowerCase(),"_").concat((r+"").toLowerCase());return i.has(n)||i.set(n,new Map),i.get(n)}clearFontCache(a){a?this.charWidthsCache.delete((a||"").toLowerCase()):this.charWidthsCache=new Map}limitDimsByArea(a){const{perfLimitSizeTotal:t}=Ht,e=Math.sqrt(t*a);return[Math.floor(e),Math.floor(t/e)]}},xo="6.9.1";function hn(){}const Ei=Math.PI/2,bn=2*Math.PI,Vo=Math.PI/180,Be=Object.freeze([1,0,0,1,0,0]),Wo=16,is=.4477152502,Lt="center",qt="left",Ye="top",wo="bottom",me="right",Xe="none",Ho=/\r?\n/,Bl="moving",Bn="scaling",zl="rotating",Yo="rotate",Vl="skewing",bi="resizing",tg="modifyPoly",eg="modifyPath",Sn="changed",zn="scale",Ge="scaleX",hr="scaleY",Js="skewX",Qs="skewY",we="fill",Ne="stroke",Cn="modified",Fs="json",so="svg",mt=new class{constructor(){this[Fs]=new Map,this[so]=new Map}has(a){return this[Fs].has(a)}getClass(a){const t=this[Fs].get(a);if(!t)throw new Mr("No class registered for ".concat(a));return t}setClass(a,t){t?this[Fs].set(t,a):(this[Fs].set(a.type,a),this[Fs].set(a.type.toLowerCase(),a))}getSVGClass(a){return this[so].get(a)}setSVGClass(a,t){this[so].set(t??a.type.toLowerCase(),a)}},Tn=new class extends Array{remove(a){const t=this.indexOf(a);t>-1&&this.splice(t,1)}cancelAll(){const a=this.splice(0);return a.forEach((t=>t.abort())),a}cancelByCanvas(a){if(!a)return[];const t=this.filter((e=>{var r;return e.target===a||typeof e.target=="object"&&((r=e.target)===null||r===void 0?void 0:r.canvas)===a}));return t.forEach((e=>e.abort())),t}cancelByTarget(a){if(!a)return[];const t=this.filter((e=>e.target===a));return t.forEach((e=>e.abort())),t}};class rg{constructor(){C(this,"__eventListeners",{})}on(t,e){if(this.__eventListeners||(this.__eventListeners={}),typeof t=="object")return Object.entries(t).forEach((r=>{let[s,i]=r;this.on(s,i)})),()=>this.off(t);if(e){const r=t;return this.__eventListeners[r]||(this.__eventListeners[r]=[]),this.__eventListeners[r].push(e),()=>this.off(r,e)}return()=>!1}once(t,e){if(typeof t=="object"){const r=[];return Object.entries(t).forEach((s=>{let[i,n]=s;r.push(this.once(i,n))})),()=>r.forEach((s=>s()))}if(e){const r=this.on(t,(function(){for(var s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];e.call(this,...i),r()}));return r}return()=>!1}_removeEventListener(t,e){if(this.__eventListeners[t])if(e){const r=this.__eventListeners[t],s=r.indexOf(e);s>-1&&r.splice(s,1)}else this.__eventListeners[t]=[]}off(t,e){if(this.__eventListeners)if(t===void 0)for(const r in this.__eventListeners)this._removeEventListener(r);else typeof t=="object"?Object.entries(t).forEach((r=>{let[s,i]=r;this._removeEventListener(s,i)})):this._removeEventListener(t,e)}fire(t,e){var r;if(!this.__eventListeners)return;const s=(r=this.__eventListeners[t])===null||r===void 0?void 0:r.concat();if(s)for(let i=0;i<s.length;i++)s[i].call(this,e||{})}}const Bs=(a,t)=>{const e=a.indexOf(t);return e!==-1&&a.splice(e,1),a},$r=a=>{if(a===0)return 1;switch(Math.abs(a)/Ei){case 1:case 3:return 0;case 2:return-1}return Math.cos(a)},Zr=a=>{if(a===0)return 0;const t=a/Ei,e=Math.sign(a);switch(t){case 1:return e;case 2:return 0;case 3:return-e}return Math.sin(a)};class B{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}add(t){return new B(this.x+t.x,this.y+t.y)}addEquals(t){return this.x+=t.x,this.y+=t.y,this}scalarAdd(t){return new B(this.x+t,this.y+t)}scalarAddEquals(t){return this.x+=t,this.y+=t,this}subtract(t){return new B(this.x-t.x,this.y-t.y)}subtractEquals(t){return this.x-=t.x,this.y-=t.y,this}scalarSubtract(t){return new B(this.x-t,this.y-t)}scalarSubtractEquals(t){return this.x-=t,this.y-=t,this}multiply(t){return new B(this.x*t.x,this.y*t.y)}scalarMultiply(t){return new B(this.x*t,this.y*t)}scalarMultiplyEquals(t){return this.x*=t,this.y*=t,this}divide(t){return new B(this.x/t.x,this.y/t.y)}scalarDivide(t){return new B(this.x/t,this.y/t)}scalarDivideEquals(t){return this.x/=t,this.y/=t,this}eq(t){return this.x===t.x&&this.y===t.y}lt(t){return this.x<t.x&&this.y<t.y}lte(t){return this.x<=t.x&&this.y<=t.y}gt(t){return this.x>t.x&&this.y>t.y}gte(t){return this.x>=t.x&&this.y>=t.y}lerp(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.5;return e=Math.max(Math.min(1,e),0),new B(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}distanceFrom(t){const e=this.x-t.x,r=this.y-t.y;return Math.sqrt(e*e+r*r)}midPointFrom(t){return this.lerp(t)}min(t){return new B(Math.min(this.x,t.x),Math.min(this.y,t.y))}max(t){return new B(Math.max(this.x,t.x),Math.max(this.y,t.y))}toString(){return"".concat(this.x,",").concat(this.y)}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setFromPoint(t){return this.x=t.x,this.y=t.y,this}swap(t){const e=this.x,r=this.y;this.x=t.x,this.y=t.y,t.x=e,t.y=r}clone(){return new B(this.x,this.y)}rotate(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Xo;const r=Zr(t),s=$r(t),i=this.subtract(e);return new B(i.x*s-i.y*r,i.x*r+i.y*s).add(e)}transform(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new B(t[0]*this.x+t[2]*this.y+(e?0:t[4]),t[1]*this.x+t[3]*this.y+(e?0:t[5]))}}const Xo=new B(0,0),un=a=>!!a&&Array.isArray(a._objects);function Wl(a){class t extends a{constructor(){super(...arguments),C(this,"_objects",[])}_onObjectAdded(r){}_onObjectRemoved(r){}_onStackOrderChanged(r){}add(){for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];const n=this._objects.push(...s);return s.forEach((o=>this._onObjectAdded(o))),n}insertAt(r){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];return this._objects.splice(r,0,...i),i.forEach((o=>this._onObjectAdded(o))),this._objects.length}remove(){const r=this._objects,s=[];for(var i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return n.forEach((l=>{const c=r.indexOf(l);c!==-1&&(r.splice(c,1),s.push(l),this._onObjectRemoved(l))})),s}forEachObject(r){this.getObjects().forEach(((s,i,n)=>r(s,i,n)))}getObjects(){for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return s.length===0?[...this._objects]:this._objects.filter((n=>n.isType(...s)))}item(r){return this._objects[r]}isEmpty(){return this._objects.length===0}size(){return this._objects.length}contains(r,s){return!!this._objects.includes(r)||!!s&&this._objects.some((i=>i instanceof t&&i.contains(r,!0)))}complexity(){return this._objects.reduce(((r,s)=>r+=s.complexity?s.complexity():0),0)}sendObjectToBack(r){return!(!r||r===this._objects[0])&&(Bs(this._objects,r),this._objects.unshift(r),this._onStackOrderChanged(r),!0)}bringObjectToFront(r){return!(!r||r===this._objects[this._objects.length-1])&&(Bs(this._objects,r),this._objects.push(r),this._onStackOrderChanged(r),!0)}sendObjectBackwards(r,s){if(!r)return!1;const i=this._objects.indexOf(r);if(i!==0){const n=this.findNewLowerIndex(r,i,s);return Bs(this._objects,r),this._objects.splice(n,0,r),this._onStackOrderChanged(r),!0}return!1}bringObjectForward(r,s){if(!r)return!1;const i=this._objects.indexOf(r);if(i!==this._objects.length-1){const n=this.findNewUpperIndex(r,i,s);return Bs(this._objects,r),this._objects.splice(n,0,r),this._onStackOrderChanged(r),!0}return!1}moveObjectTo(r,s){return r!==this._objects[s]&&(Bs(this._objects,r),this._objects.splice(s,0,r),this._onStackOrderChanged(r),!0)}findNewLowerIndex(r,s,i){let n;if(i){n=s;for(let o=s-1;o>=0;--o)if(r.isOverlapping(this._objects[o])){n=o;break}}else n=s-1;return n}findNewUpperIndex(r,s,i){let n;if(i){n=s;for(let o=s+1;o<this._objects.length;++o)if(r.isOverlapping(this._objects[o])){n=o;break}}else n=s+1;return n}collectObjects(r){let{left:s,top:i,width:n,height:o}=r,{includeIntersecting:l=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const c=[],u=new B(s,i),d=u.add(new B(n,o));for(let g=this._objects.length-1;g>=0;g--){const f=this._objects[g];f.selectable&&f.visible&&(l&&f.intersectsWithRect(u,d)||f.isContainedWithinRect(u,d)||l&&f.containsPoint(u)||l&&f.containsPoint(d))&&c.push(f)}return c}}return t}class Hl extends rg{_setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};for(const e in t)this.set(e,t[e])}_setObject(t){for(const e in t)this._set(e,t[e])}set(t,e){return typeof t=="object"?this._setObject(t):this._set(t,e),this}_set(t,e){this[t]=e}toggle(t){const e=this.get(t);return typeof e=="boolean"&&this.set(t,!e),this}get(t){return this[t]}}function dn(a){return Rn().requestAnimationFrame(a)}function sg(a){return Rn().cancelAnimationFrame(a)}let ig=0;const ds=()=>ig++,Jr=()=>{const a=Zs().createElement("canvas");if(!a||a.getContext===void 0)throw new Mr("Failed to create `canvas` element");return a},ng=()=>Zs().createElement("img"),ur=a=>{const t=Jr();return t.width=a.width,t.height=a.height,t},Yl=(a,t,e)=>a.toDataURL("image/".concat(t),e),Xl=(a,t,e)=>new Promise(((r,s)=>{a.toBlob(r,"image/".concat(t),e)})),pe=a=>a*Vo,Qr=a=>a/Vo,og=a=>a.every(((t,e)=>t===Be[e])),We=(a,t,e)=>new B(a).transform(t,e),wr=a=>{const t=1/(a[0]*a[3]-a[1]*a[2]),e=[t*a[3],-t*a[1],-t*a[2],t*a[0],0,0],{x:r,y:s}=new B(a[4],a[5]).transform(e,!0);return e[4]=-r,e[5]=-s,e},De=(a,t,e)=>[a[0]*t[0]+a[2]*t[1],a[1]*t[0]+a[3]*t[1],a[0]*t[2]+a[2]*t[3],a[1]*t[2]+a[3]*t[3],e?0:a[0]*t[4]+a[2]*t[5]+a[4],e?0:a[1]*t[4]+a[3]*t[5]+a[5]],No=(a,t)=>a.reduceRight(((e,r)=>r&&e?De(r,e,t):r||e),void 0)||Be.concat(),Nl=a=>{let[t,e]=a;return Math.atan2(e,t)},kn=a=>{const t=Nl(a),e=Math.pow(a[0],2)+Math.pow(a[1],2),r=Math.sqrt(e),s=(a[0]*a[3]-a[2]*a[1])/r,i=Math.atan2(a[0]*a[2]+a[1]*a[3],e);return{angle:Qr(t),scaleX:r,scaleY:s,skewX:Qr(i),skewY:0,translateX:a[4]||0,translateY:a[5]||0}},Pi=function(a){return[1,0,0,1,a,arguments.length>1&&arguments[1]!==void 0?arguments[1]:0]};function ti(){let{angle:a=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{x:t=0,y:e=0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=pe(a),s=$r(r),i=Zr(r);return[s,i,-i,s,t?t-(s*t-i*e):0,e?e-(i*t+s*e):0]}const Uo=function(a){return[a,0,0,arguments.length>1&&arguments[1]!==void 0?arguments[1]:a,0,0]},Ul=a=>Math.tan(pe(a)),Gl=a=>[1,0,Ul(a),1,0,0],ql=a=>[1,Ul(a),0,1,0,0],Vn=a=>{let{scaleX:t=1,scaleY:e=1,flipX:r=!1,flipY:s=!1,skewX:i=0,skewY:n=0}=a,o=Uo(r?-t:t,s?-e:e);return i&&(o=De(o,Gl(i),!0)),n&&(o=De(o,ql(n),!0)),o},ag=a=>{const{translateX:t=0,translateY:e=0,angle:r=0}=a;let s=Pi(t,e);r&&(s=De(s,ti({angle:r})));const i=Vn(a);return og(i)||(s=De(s,i)),s},gn=function(a){let{signal:t,crossOrigin:e=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise((function(r,s){if(t&&t.aborted)return s(new $d("loadImage"));const i=ng();let n;t&&(n=function(l){i.src="",s(l)},t.addEventListener("abort",n,{once:!0}));const o=function(){i.onload=i.onerror=null,n&&t?.removeEventListener("abort",n),r(i)};a?(i.onload=o,i.onerror=function(){n&&t?.removeEventListener("abort",n),s(new Mr("Error loading ".concat(i.src)))},e&&(i.crossOrigin=e),i.src=a):o()}))},Si=function(a){let{signal:t,reviver:e=hn}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((r,s)=>{const i=[];t&&t.addEventListener("abort",s,{once:!0}),Promise.all(a.map((n=>mt.getClass(n.type).fromObject(n,{signal:t}).then((o=>(e(n,o),i.push(o),o)))))).then(r).catch((n=>{i.forEach((o=>{o.dispose&&o.dispose()})),s(n)})).finally((()=>{t&&t.removeEventListener("abort",s)}))}))},Wn=function(a){let{signal:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return new Promise(((e,r)=>{const s=[];t&&t.addEventListener("abort",r,{once:!0});const i=Object.values(a).map((o=>o&&o.type&&mt.has(o.type)?Si([o],{signal:t}).then((l=>{let[c]=l;return s.push(c),c})):o)),n=Object.keys(a);Promise.all(i).then((o=>o.reduce(((l,c,u)=>(l[n[u]]=c,l)),{}))).then(e).catch((o=>{s.forEach((l=>{l.dispose&&l.dispose()})),r(o)})).finally((()=>{t&&t.removeEventListener("abort",r)}))}))},ei=function(a){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:[]).reduce(((t,e)=>(e in a&&(t[e]=a[e]),t)),{})},Go=(a,t)=>Object.keys(a).reduce(((e,r)=>(t(a[r],r,a)&&(e[r]=a[r]),e)),{}),re=(a,t)=>parseFloat(Number(a).toFixed(t)),Ci=a=>"matrix("+a.map((t=>re(t,Ht.NUM_FRACTION_DIGITS))).join(" ")+")",nr=a=>!!a&&a.toLive!==void 0,Oa=a=>!!a&&typeof a.toObject=="function",Aa=a=>!!a&&a.offsetX!==void 0&&"source"in a,_s=a=>!!a&&"multiSelectionStacking"in a;function Kl(a){const t=a&&xr(a);let e=0,r=0;if(!a||!t)return{left:e,top:r};let s=a;const i=t.documentElement,n=t.body||{scrollLeft:0,scrollTop:0};for(;s&&(s.parentNode||s.host)&&(s=s.parentNode||s.host,s===t?(e=n.scrollLeft||i.scrollLeft||0,r=n.scrollTop||i.scrollTop||0):(e+=s.scrollLeft||0,r+=s.scrollTop||0),s.nodeType!==1||s.style.position!=="fixed"););return{left:e,top:r}}const xr=a=>a.ownerDocument||null,$l=a=>{var t;return((t=a.ownerDocument)===null||t===void 0?void 0:t.defaultView)||null},Zl=function(a,t,e){let{width:r,height:s}=e,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;a.width=r,a.height=s,i>1&&(a.setAttribute("width",(r*i).toString()),a.setAttribute("height",(s*i).toString()),t.scale(i,i))},bo=(a,t)=>{let{width:e,height:r}=t;e&&(a.style.width=typeof e=="number"?"".concat(e,"px"):e),r&&(a.style.height=typeof r=="number"?"".concat(r,"px"):r)};function Da(a){return a.onselectstart!==void 0&&(a.onselectstart=()=>!1),a.style.userSelect=Xe,a}class Jl{constructor(t){C(this,"_originalCanvasStyle",void 0),C(this,"lower",void 0);const e=this.createLowerCanvas(t);this.lower={el:e,ctx:e.getContext("2d")}}createLowerCanvas(t){const e=(r=t)&&r.getContext!==void 0?t:t&&Zs().getElementById(t)||Jr();var r;if(e.hasAttribute("data-fabric"))throw new Mr("Trying to initialize a canvas that has already been initialized. Did you forget to dispose the canvas?");return this._originalCanvasStyle=e.style.cssText,e.setAttribute("data-fabric","main"),e.classList.add("lower-canvas"),e}cleanupDOM(t){let{width:e,height:r}=t;const{el:s}=this.lower;s.classList.remove("lower-canvas"),s.removeAttribute("data-fabric"),s.setAttribute("width","".concat(e)),s.setAttribute("height","".concat(r)),s.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=void 0}setDimensions(t,e){const{el:r,ctx:s}=this.lower;Zl(r,s,t,e)}setCSSDimensions(t){bo(this.lower.el,t)}calcOffset(){return(function(t){var e;const r=t&&xr(t),s={left:0,top:0};if(!r)return s;const i=((e=$l(t))===null||e===void 0?void 0:e.getComputedStyle(t,null))||{};s.left+=parseInt(i.borderLeftWidth,10)||0,s.top+=parseInt(i.borderTopWidth,10)||0,s.left+=parseInt(i.paddingLeft,10)||0,s.top+=parseInt(i.paddingTop,10)||0;let n={left:0,top:0};const o=r.documentElement;t.getBoundingClientRect!==void 0&&(n=t.getBoundingClientRect());const l=Kl(t);return{left:n.left+l.left-(o.clientLeft||0)+s.left,top:n.top+l.top-(o.clientTop||0)+s.top}})(this.lower.el)}dispose(){Lr().dispose(this.lower.el),delete this.lower}}const lg={backgroundVpt:!0,backgroundColor:"",overlayVpt:!0,overlayColor:"",includeDefaultValues:!0,svgViewportTransformation:!0,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!0,imageSmoothingEnabled:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,viewportTransform:[...Be]},cg=["objects"];class Mi extends Wl(Hl){get lowerCanvasEl(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.el}get contextContainer(){var t;return(t=this.elements.lower)===null||t===void 0?void 0:t.ctx}static getDefaults(){return Mi.ownDefaults}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,this.constructor.getDefaults()),this.set(e),this.initElements(t),this._setDimensionsImpl({width:this.width||this.elements.lower.el.width||0,height:this.height||this.elements.lower.el.height||0}),this.skipControlsDrawing=!1,this.viewportTransform=[...this.viewportTransform],this.calcViewportBoundaries()}initElements(t){this.elements=new Jl(t)}add(){const t=super.add(...arguments);return arguments.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}insertAt(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),s=1;s<e;s++)r[s-1]=arguments[s];const i=super.insertAt(t,...r);return r.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),i}remove(){const t=super.remove(...arguments);return t.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),t}_onObjectAdded(t){t.canvas&&t.canvas!==this&&(us("warn",`Canvas is trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),t.canvas.remove(t)),t._set("canvas",this),t.setCoords(),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t){t._set("canvas",void 0),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}getRetinaScaling(){return this.enableRetinaScaling?Rl():1}calcOffset(){return this._offset=this.elements.calcOffset()}getWidth(){return this.width}getHeight(){return this.height}setWidth(t,e){return this.setDimensions({width:t},e)}setHeight(t,e){return this.setDimensions({height:t},e)}_setDimensionsImpl(t){let{cssOnly:e=!1,backstoreOnly:r=!1}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!e){const s=T({width:this.width,height:this.height},t);this.elements.setDimensions(s,this.getRetinaScaling()),this.hasLostContext=!0,this.width=s.width,this.height=s.height}r||this.elements.setCSSDimensions(t),this.calcOffset()}setDimensions(t,e){this._setDimensionsImpl(t,e),e&&e.cssOnly||this.requestRenderAll()}getZoom(){return this.viewportTransform[0]}setViewportTransform(t){this.viewportTransform=t,this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(t,e){const r=t,s=[...this.viewportTransform],i=We(t,wr(s));s[0]=e,s[3]=e;const n=We(i,s);s[4]+=r.x-n.x,s[5]+=r.y-n.y,this.setViewportTransform(s)}setZoom(t){this.zoomToPoint(new B(0,0),t)}absolutePan(t){const e=[...this.viewportTransform];return e[4]=-t.x,e[5]=-t.y,this.setViewportTransform(e)}relativePan(t){return this.absolutePan(new B(-t.x-this.viewportTransform[4],-t.y-this.viewportTransform[5]))}getElement(){return this.elements.lower.el}clearContext(t){t.clearRect(0,0,this.width,this.height)}getContext(){return this.elements.lower.ctx}clear(){this.remove(...this.getObjects()),this.backgroundImage=void 0,this.overlayImage=void 0,this.backgroundColor="",this.overlayColor="",this.clearContext(this.getContext()),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),this.destroyed||this.renderCanvas(this.getContext(),this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){this.nextRenderHandle||this.disposed||this.destroyed||(this.nextRenderHandle=dn((()=>this.renderAndReset())))}calcViewportBoundaries(){const t=this.width,e=this.height,r=wr(this.viewportTransform),s=We({x:0,y:0},r),i=We({x:t,y:e},r),n=s.min(i),o=s.max(i);return this.vptCoords={tl:n,tr:new B(o.x,n.y),bl:new B(n.x,o.y),br:o}}cancelRequestedRender(){this.nextRenderHandle&&(sg(this.nextRenderHandle),this.nextRenderHandle=0)}drawControls(t){}renderCanvas(t,e){if(this.destroyed)return;const r=this.viewportTransform,s=this.clipPath;this.calcViewportBoundaries(),this.clearContext(t),t.imageSmoothingEnabled=this.imageSmoothingEnabled,t.patternQuality="best",this.fire("before:render",{ctx:t}),this._renderBackground(t),t.save(),t.transform(r[0],r[1],r[2],r[3],r[4],r[5]),this._renderObjects(t,e),t.restore(),this.controlsAboveOverlay||this.skipControlsDrawing||this.drawControls(t),s&&(s._set("canvas",this),s.shouldCache(),s._transformDone=!0,s.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(t,s)),this._renderOverlay(t),this.controlsAboveOverlay&&!this.skipControlsDrawing&&this.drawControls(t),this.fire("after:render",{ctx:t}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=void 0)}drawClipPathOnCanvas(t,e){const r=this.viewportTransform;t.save(),t.transform(...r),t.globalCompositeOperation="destination-in",e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()}_renderObjects(t,e){for(let r=0,s=e.length;r<s;++r)e[r]&&e[r].render(t)}_renderBackgroundOrOverlay(t,e){const r=this["".concat(e,"Color")],s=this["".concat(e,"Image")],i=this.viewportTransform,n=this["".concat(e,"Vpt")];if(!r&&!s)return;const o=nr(r);if(r){if(t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.width,0),t.lineTo(this.width,this.height),t.lineTo(0,this.height),t.closePath(),t.fillStyle=o?r.toLive(t):r,n&&t.transform(...i),o){t.transform(1,0,0,1,r.offsetX||0,r.offsetY||0);const l=r.gradientTransform||r.patternTransform;l&&t.transform(...l)}t.fill(),t.restore()}if(s){t.save();const{skipOffscreen:l}=this;this.skipOffscreen=n,n&&t.transform(...i),s.render(t),this.skipOffscreen=l,t.restore()}}_renderBackground(t){this._renderBackgroundOrOverlay(t,"background")}_renderOverlay(t){this._renderBackgroundOrOverlay(t,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new B(this.width/2,this.height/2)}centerObjectH(t){return this._centerObject(t,new B(this.getCenterPoint().x,t.getCenterPoint().y))}centerObjectV(t){return this._centerObject(t,new B(t.getCenterPoint().x,this.getCenterPoint().y))}centerObject(t){return this._centerObject(t,this.getCenterPoint())}viewportCenterObject(t){return this._centerObject(t,this.getVpCenter())}viewportCenterObjectH(t){return this._centerObject(t,new B(this.getVpCenter().x,t.getCenterPoint().y))}viewportCenterObjectV(t){return this._centerObject(t,new B(t.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return We(this.getCenterPoint(),wr(this.viewportTransform))}_centerObject(t,e){t.setXY(e,Lt,Lt),t.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(t){return this.toDatalessObject(t)}toObject(t){return this._toObjectMethod("toObject",t)}toJSON(){return this.toObject()}toDatalessObject(t){return this._toObjectMethod("toDatalessObject",t)}_toObjectMethod(t,e){const r=this.clipPath,s=r&&!r.excludeFromExport?this._toObject(r,t,e):null;return T(T(T({version:xo},ei(this,e)),{},{objects:this._objects.filter((i=>!i.excludeFromExport)).map((i=>this._toObject(i,t,e)))},this.__serializeBgOverlay(t,e)),s?{clipPath:s}:null)}_toObject(t,e,r){let s;this.includeDefaultValues||(s=t.includeDefaultValues,t.includeDefaultValues=!1);const i=t[e](r);return this.includeDefaultValues||(t.includeDefaultValues=!!s),i}__serializeBgOverlay(t,e){const r={},s=this.backgroundImage,i=this.overlayImage,n=this.backgroundColor,o=this.overlayColor;return nr(n)?n.excludeFromExport||(r.background=n.toObject(e)):n&&(r.background=n),nr(o)?o.excludeFromExport||(r.overlay=o.toObject(e)):o&&(r.overlay=o),s&&!s.excludeFromExport&&(r.backgroundImage=this._toObject(s,t,e)),i&&!i.excludeFromExport&&(r.overlayImage=this._toObject(i,t,e)),r}toSVG(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0;t.reviver=e;const r=[];return this._setSVGPreamble(r,t),this._setSVGHeader(r,t),this.clipPath&&r.push('<g clip-path="url(#'.concat(this.clipPath.clipPathId,`)" >
`)),this._setSVGBgOverlayColor(r,"background"),this._setSVGBgOverlayImage(r,"backgroundImage",e),this._setSVGObjects(r,e),this.clipPath&&r.push(`</g>
`),this._setSVGBgOverlayColor(r,"overlay"),this._setSVGBgOverlayImage(r,"overlayImage",e),r.push("</svg>"),r.join("")}_setSVGPreamble(t,e){e.suppressPreamble||t.push('<?xml version="1.0" encoding="',e.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(t,e){const r=e.width||"".concat(this.width),s=e.height||"".concat(this.height),i=Ht.NUM_FRACTION_DIGITS,n=e.viewBox;let o;if(n)o='viewBox="'.concat(n.x," ").concat(n.y," ").concat(n.width," ").concat(n.height,'" ');else if(this.svgViewportTransformation){const l=this.viewportTransform;o='viewBox="'.concat(re(-l[4]/l[0],i)," ").concat(re(-l[5]/l[3],i)," ").concat(re(this.width/l[0],i)," ").concat(re(this.height/l[3],i),'" ')}else o='viewBox="0 0 '.concat(this.width," ").concat(this.height,'" ');t.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',r,'" ','height="',s,'" ',o,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",xo,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(e),`</defs>
`)}createSVGClipPathMarkup(t){const e=this.clipPath;return e?(e.clipPathId="CLIPPATH_".concat(ds()),'<clipPath id="'.concat(e.clipPathId,`" >
`).concat(e.toClipPathSVG(t.reviver),`</clipPath>
`)):""}createSVGRefElementsMarkup(){return["background","overlay"].map((t=>{const e=this["".concat(t,"Color")];if(nr(e)){const r=this["".concat(t,"Vpt")],s=this.viewportTransform,i={isType:()=>!1,width:this.width/(r?s[0]:1),height:this.height/(r?s[3]:1)};return e.toSVG(i,{additionalTransform:r?Ci(s):""})}})).join("")}createSVGFontFacesMarkup(){const t=[],e={},r=Ht.fontPaths;this._objects.forEach((function i(n){t.push(n),un(n)&&n._objects.forEach(i)})),t.forEach((i=>{if(!(n=i)||typeof n._renderText!="function")return;var n;const{styles:o,fontFamily:l}=i;!e[l]&&r[l]&&(e[l]=!0,o&&Object.values(o).forEach((c=>{Object.values(c).forEach((u=>{let{fontFamily:d=""}=u;!e[d]&&r[d]&&(e[d]=!0)}))})))}));const s=Object.keys(e).map((i=>`		@font-face {
			font-family: '`.concat(i,`';
			src: url('`).concat(r[i],`');
		}
`))).join("");return s?`	<style type="text/css"><![CDATA[
`.concat(s,`]]></style>
`):""}_setSVGObjects(t,e){this.forEachObject((r=>{r.excludeFromExport||this._setSVGObject(t,r,e)}))}_setSVGObject(t,e,r){t.push(e.toSVG(r))}_setSVGBgOverlayImage(t,e,r){const s=this[e];s&&!s.excludeFromExport&&s.toSVG&&t.push(s.toSVG(r))}_setSVGBgOverlayColor(t,e){const r=this["".concat(e,"Color")];if(r)if(nr(r)){const s=r.repeat||"",i=this.width,n=this.height,o=this["".concat(e,"Vpt")]?Ci(wr(this.viewportTransform)):"";t.push('<rect transform="'.concat(o," translate(").concat(i/2,",").concat(n/2,')" x="').concat(r.offsetX-i/2,'" y="').concat(r.offsetY-n/2,'" width="').concat(s!=="repeat-y"&&s!=="no-repeat"||!Aa(r)?i:r.source.width,'" height="').concat(s!=="repeat-x"&&s!=="no-repeat"||!Aa(r)?n:r.source.height,'" fill="url(#SVGID_').concat(r.id,`)"></rect>
`))}else t.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',r,'"',`></rect>
`)}loadFromJSON(t,e){let{signal:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(!t)return Promise.reject(new Mr("`json` is undefined"));const s=typeof t=="string"?JSON.parse(t):t,{objects:i=[]}=s,n=ne(s,cg),{backgroundImage:o,background:l,overlayImage:c,overlay:u,clipPath:d}=n,g=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([Si(i,{reviver:e,signal:r}),Wn({backgroundImage:o,backgroundColor:l,overlayImage:c,overlayColor:u,clipPath:d},{signal:r})]).then((f=>{let[m,p]=f;return this.clear(),this.add(...m),this.set(n),this.set(p),this.renderOnAddRemove=g,this}))}clone(t){const e=this.toObject(t);return this.cloneWithoutData().loadFromJSON(e)}cloneWithoutData(){const t=ur(this);return new this.constructor(t)}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:r=1,multiplier:s=1,enableRetinaScaling:i=!1}=t,n=s*(i?this.getRetinaScaling():1);return Yl(this.toCanvasElement(n,t),e,r)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{format:e="png",quality:r=1,multiplier:s=1,enableRetinaScaling:i=!1}=t,n=s*(i?this.getRetinaScaling():1);return Xl(this.toCanvasElement(n,t),e,r)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,{width:e,height:r,left:s,top:i,filter:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const o=(e||this.width)*t,l=(r||this.height)*t,c=this.getZoom(),u=this.width,d=this.height,g=this.skipControlsDrawing,f=c*t,m=this.viewportTransform,p=[f,0,0,f,(m[4]-(s||0))*t,(m[5]-(i||0))*t],v=this.enableRetinaScaling,y=ur({width:o,height:l}),S=n?this._objects.filter((O=>n(O))):this._objects;return this.enableRetinaScaling=!1,this.viewportTransform=p,this.width=o,this.height=l,this.skipControlsDrawing=!0,this.calcViewportBoundaries(),this.renderCanvas(y.getContext("2d"),S),this.viewportTransform=m,this.width=u,this.height=d,this.calcViewportBoundaries(),this.enableRetinaScaling=v,this.skipControlsDrawing=g,y}dispose(){return!this.disposed&&this.elements.cleanupDOM({width:this.width,height:this.height}),Tn.cancelByCanvas(this),this.disposed=!0,new Promise(((t,e)=>{const r=()=>{this.destroy(),t(!0)};r.kill=e,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?t(!1):this.nextRenderHandle?this.__cleanupTask=r:r()}))}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject((t=>t.dispose())),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose(),this.backgroundImage=void 0,this.overlayImage&&this.overlayImage.dispose(),this.overlayImage=void 0,this.elements.dispose()}toString(){return"#<Canvas (".concat(this.complexity(),"): { objects: ").concat(this._objects.length," }>")}}C(Mi,"ownDefaults",lg);const hg=["touchstart","touchmove","touchend"],ug=a=>{const t=Kl(a.target),e=(function(r){const s=r.changedTouches;return s&&s[0]?s[0]:r})(a);return new B(e.clientX+t.left,e.clientY+t.top)},So=a=>hg.includes(a.type)||a.pointerType==="touch",Ea=a=>{a.preventDefault(),a.stopPropagation()},qr=a=>{let t=0,e=0,r=0,s=0;for(let i=0,n=a.length;i<n;i++){const{x:o,y:l}=a[i];(o>r||!i)&&(r=o),(o<t||!i)&&(t=o),(l>s||!i)&&(s=l),(l<e||!i)&&(e=l)}return{left:t,top:e,width:r-t,height:s-e}},dg=["translateX","translateY","scaleX","scaleY"],gg=(a,t)=>On(a,De(t,a.calcOwnMatrix())),On=(a,t)=>{const e=kn(t),{translateX:r,translateY:s,scaleX:i,scaleY:n}=e,o=ne(e,dg),l=new B(r,s);a.flipX=!1,a.flipY=!1,Object.assign(a,o),a.set({scaleX:i,scaleY:n}),a.setPositionByOrigin(l,Lt,Lt)},fg=a=>{a.scaleX=1,a.scaleY=1,a.skewX=0,a.skewY=0,a.flipX=!1,a.flipY=!1,a.rotate(0)},Ql=a=>({scaleX:a.scaleX,scaleY:a.scaleY,skewX:a.skewX,skewY:a.skewY,angle:a.angle,left:a.left,flipX:a.flipX,flipY:a.flipY,top:a.top}),qo=(a,t,e)=>{const r=a/2,s=t/2,i=[new B(-r,-s),new B(r,-s),new B(-r,s),new B(r,s)].map((o=>o.transform(e))),n=qr(i);return new B(n.width,n.height)},Hn=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Be;return De(wr(arguments.length>1&&arguments[1]!==void 0?arguments[1]:Be),a)},Ns=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Be,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Be;return a.transform(Hn(t,e))},mg=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Be,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Be;return a.transform(Hn(t,e),!0)},pg=(a,t,e)=>{const r=Hn(t,e);return On(a,De(r,a.calcOwnMatrix())),r},tc=(a,t)=>{var e;const{transform:{target:r}}=t;(e=r.canvas)===null||e===void 0||e.fire("object:".concat(a),T(T({},t),{},{target:r})),r.fire(a,t)},vg={left:-.5,top:-.5,center:0,bottom:.5,right:.5},_e=a=>typeof a=="string"?vg[a]:a-.5,An="not-allowed";function ec(a){return _e(a.originX)===_e(Lt)&&_e(a.originY)===_e(Lt)}function Pa(a){return .5-_e(a)}const Tr=(a,t)=>a[t],rc=(a,t,e,r)=>({e:a,transform:t,pointer:new B(e,r)});function sc(a,t){const e=a.getTotalAngle()+Qr(Math.atan2(t.y,t.x))+360;return Math.round(e%360/45)}function Ko(a,t,e,r,s){var i;let{target:n,corner:o}=a;const l=n.controls[o],c=((i=n.canvas)===null||i===void 0?void 0:i.getZoom())||1,u=n.padding/c,d=(function(g,f,m,p){const v=g.getRelativeCenterPoint(),y=m!==void 0&&p!==void 0?g.translateToGivenOrigin(v,Lt,Lt,m,p):new B(g.left,g.top);return(g.angle?f.rotate(-pe(g.angle),v):f).subtract(y)})(n,new B(r,s),t,e);return d.x>=u&&(d.x-=u),d.x<=-u&&(d.x+=u),d.y>=u&&(d.y-=u),d.y<=u&&(d.y+=u),d.x-=l.offsetX,d.y-=l.offsetY,d}const _g=(a,t,e,r)=>{const{target:s,offsetX:i,offsetY:n}=t,o=e-i,l=r-n,c=!Tr(s,"lockMovementX")&&s.left!==o,u=!Tr(s,"lockMovementY")&&s.top!==l;return c&&s.set(qt,o),u&&s.set(Ye,l),(c||u)&&tc(Bl,rc(a,t,e,r)),c||u},Dn=a=>a.replace(/\s+/g," "),Ma={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#0FF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000",blanchedalmond:"#FFEBCD",blue:"#00F",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#0FF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#F0F",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#789",lightslategrey:"#789",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#0F0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#F0F",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#639",red:"#F00",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFF",whitesmoke:"#F5F5F5",yellow:"#FF0",yellowgreen:"#9ACD32"},io=(a,t,e)=>(e<0&&(e+=1),e>1&&(e-=1),e<1/6?a+6*(t-a)*e:e<.5?t:e<2/3?a+(t-a)*(2/3-e)*6:a),Ia=(a,t,e,r)=>{a/=255,t/=255,e/=255;const s=Math.max(a,t,e),i=Math.min(a,t,e);let n,o;const l=(s+i)/2;if(s===i)n=o=0;else{const c=s-i;switch(o=l>.5?c/(2-s-i):c/(s+i),s){case a:n=(t-e)/c+(t<e?6:0);break;case t:n=(e-a)/c+2;break;case e:n=(a-t)/c+4}n/=6}return[Math.round(360*n),Math.round(100*o),Math.round(100*l),r]},La=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"1";return parseFloat(a)/(a.endsWith("%")?100:1)},Fi=a=>Math.min(Math.round(a),255).toString(16).toUpperCase().padStart(2,"0"),Fa=a=>{let[t,e,r,s=1]=a;const i=Math.round(.3*t+.59*e+.11*r);return[i,i,i,s]};class $t{constructor(t){if(C(this,"isUnrecognised",!1),t)if(t instanceof $t)this.setSource([...t._source]);else if(Array.isArray(t)){const[e,r,s,i=1]=t;this.setSource([e,r,s,i])}else this.setSource(this._tryParsingColor(t));else this.setSource([0,0,0,1])}_tryParsingColor(t){return(t=t.toLowerCase())in Ma&&(t=Ma[t]),t==="transparent"?[255,255,255,0]:$t.sourceFromHex(t)||$t.sourceFromRgb(t)||$t.sourceFromHsl(t)||(this.isUnrecognised=!0)&&[0,0,0,1]}getSource(){return this._source}setSource(t){this._source=t}toRgb(){const[t,e,r]=this.getSource();return"rgb(".concat(t,",").concat(e,",").concat(r,")")}toRgba(){return"rgba(".concat(this.getSource().join(","),")")}toHsl(){const[t,e,r]=Ia(...this.getSource());return"hsl(".concat(t,",").concat(e,"%,").concat(r,"%)")}toHsla(){const[t,e,r,s]=Ia(...this.getSource());return"hsla(".concat(t,",").concat(e,"%,").concat(r,"%,").concat(s,")")}toHex(){return this.toHexa().slice(0,6)}toHexa(){const[t,e,r,s]=this.getSource();return"".concat(Fi(t)).concat(Fi(e)).concat(Fi(r)).concat(Fi(Math.round(255*s)))}getAlpha(){return this.getSource()[3]}setAlpha(t){return this._source[3]=t,this}toGrayscale(){return this.setSource(Fa(this.getSource())),this}toBlackWhite(t){const[e,,,r]=Fa(this.getSource()),s=e<(t||127)?0:255;return this.setSource([s,s,s,r]),this}overlayWith(t){t instanceof $t||(t=new $t(t));const e=this.getSource(),r=t.getSource(),[s,i,n]=e.map(((o,l)=>Math.round(.5*o+.5*r[l])));return this.setSource([s,i,n,e[3]]),this}static fromRgb(t){return $t.fromRgba(t)}static fromRgba(t){return new $t($t.sourceFromRgb(t))}static sourceFromRgb(t){const e=Dn(t).match(/^rgba?\(\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?(?:\s?[,/]\s?(\d{0,3}(?:\.\d+)?%?)\s?)?\)$/i);if(e){const[r,s,i]=e.slice(1,4).map((n=>{const o=parseFloat(n);return n.endsWith("%")?Math.round(2.55*o):o}));return[r,s,i,La(e[4])]}}static fromHsl(t){return $t.fromHsla(t)}static fromHsla(t){return new $t($t.sourceFromHsl(t))}static sourceFromHsl(t){const e=Dn(t).match(/^hsla?\(\s?([+-]?\d{0,3}(?:\.\d+)?(?:deg|turn|rad)?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?[\s|,]\s?(\d{0,3}(?:\.\d+)?%?)\s?(?:\s?[,/]\s?(\d*(?:\.\d+)?%?)\s?)?\)$/i);if(!e)return;const r=($t.parseAngletoDegrees(e[1])%360+360)%360/360,s=parseFloat(e[2])/100,i=parseFloat(e[3])/100;let n,o,l;if(s===0)n=o=l=i;else{const c=i<=.5?i*(s+1):i+s-i*s,u=2*i-c;n=io(u,c,r+1/3),o=io(u,c,r),l=io(u,c,r-1/3)}return[Math.round(255*n),Math.round(255*o),Math.round(255*l),La(e[4])]}static fromHex(t){return new $t($t.sourceFromHex(t))}static sourceFromHex(t){if(t.match(/^#?(([0-9a-f]){3,4}|([0-9a-f]{2}){3,4})$/i)){const e=t.slice(t.indexOf("#")+1);let r;r=e.length<=4?e.split("").map((l=>l+l)):e.match(/.{2}/g);const[s,i,n,o=255]=r.map((l=>parseInt(l,16)));return[s,i,n,o/255]}}static parseAngletoDegrees(t){const e=t.toLowerCase(),r=parseFloat(e);return e.includes("rad")?Qr(r):e.includes("turn")?360*r:r}}const Us=function(a){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Wo;const e=/\D{0,2}$/.exec(a),r=parseFloat(a),s=Ht.DPI;switch(e?.[0]){case"mm":return r*s/25.4;case"cm":return r*s/2.54;case"in":return r*s;case"pt":return r*s/72;case"pc":return r*s/72*12;case"em":return r*t;default:return r}},yg=a=>{const[t,e]=a.trim().split(" "),[r,s]=(i=t)&&i!==Xe?[i.slice(1,4),i.slice(5,8)]:i===Xe?[i,i]:["Mid","Mid"];var i;return{meetOrSlice:e||"meet",alignX:r,alignY:s}},Ti=function(a,t){let e,r,s=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];if(t)if(t.toLive)e="url(#SVGID_".concat(t.id,")");else{const i=new $t(t),n=i.getAlpha();e=i.toRgb(),n!==1&&(r=n.toString())}else e="none";return s?"".concat(a,": ").concat(e,"; ").concat(r?"".concat(a,"-opacity: ").concat(r,"; "):""):"".concat(a,'="').concat(e,'" ').concat(r?"".concat(a,'-opacity="').concat(r,'" '):"")};class ic{getSvgStyles(t){const e=this.fillRule?this.fillRule:"nonzero",r=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):Xe,i=this.strokeDashOffset?this.strokeDashOffset:"0",n=this.strokeLineCap?this.strokeLineCap:"butt",o=this.strokeLineJoin?this.strokeLineJoin:"miter",l=this.strokeMiterLimit?this.strokeMiterLimit:"4",c=this.opacity!==void 0?this.opacity:"1",u=this.visible?"":" visibility: hidden;",d=t?"":this.getSvgFilter(),g=Ti(we,this.fill);return[Ti(Ne,this.stroke),"stroke-width: ",r,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",n,"; ","stroke-dashoffset: ",i,"; ","stroke-linejoin: ",o,"; ","stroke-miterlimit: ",l,"; ",g,"fill-rule: ",e,"; ","opacity: ",c,";",d,u].join("")}getSvgFilter(){return this.shadow?"filter: url(#SVGID_".concat(this.shadow.id,");"):""}getSvgCommons(){return[this.id?'id="'.concat(this.id,'" '):"",this.clipPath?'clip-path="url(#'.concat(this.clipPath.clipPathId,')" '):""].join("")}getSvgTransform(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";const r=t?this.calcTransformMatrix():this.calcOwnMatrix(),s='transform="'.concat(Ci(r));return"".concat(s).concat(e,'" ')}_toSVG(t){return[""]}toSVG(t){return this._createBaseSVGMarkup(this._toSVG(t),{reviver:t})}toClipPathSVG(t){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(t),{reviver:t})}_createBaseClipPathSVGMarkup(t){let{reviver:e,additionalTransform:r=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const s=[this.getSvgTransform(!0,r),this.getSvgCommons()].join(""),i=t.indexOf("COMMON_PARTS");return t[i]=s,e?e(t.join("")):t.join("")}_createBaseSVGMarkup(t){let{noStyle:e,reviver:r,withShadow:s,additionalTransform:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=e?"":'style="'.concat(this.getSvgStyles(),'" '),o=s?'style="'.concat(this.getSvgFilter(),'" '):"",l=this.clipPath,c=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",u=l&&l.absolutePositioned,d=this.stroke,g=this.fill,f=this.shadow,m=[],p=t.indexOf("COMMON_PARTS");let v;l&&(l.clipPathId="CLIPPATH_".concat(ds()),v='<clipPath id="'.concat(l.clipPathId,`" >
`).concat(l.toClipPathSVG(r),`</clipPath>
`)),u&&m.push("<g ",o,this.getSvgCommons(),` >
`),m.push("<g ",this.getSvgTransform(!1),u?"":o+this.getSvgCommons(),` >
`);const y=[n,c,e?"":this.addPaintOrder()," ",i?'transform="'.concat(i,'" '):""].join("");return t[p]=y,nr(g)&&m.push(g.toSVG(this)),nr(d)&&m.push(d.toSVG(this)),f&&m.push(f.toSVG(this)),l&&m.push(v),m.push(t.join("")),m.push(`</g>
`),u&&m.push(`</g>
`),r?r(m.join("")):m.join("")}addPaintOrder(){return this.paintFirst!==we?' paint-order="'.concat(this.paintFirst,'" '):""}}function Yn(a){return new RegExp("^("+a.join("|")+")\\b","i")}const Ds="textDecorationThickness",nc=["fontSize","fontWeight","fontFamily","fontStyle"],oc=["underline","overline","linethrough"],ac=[...nc,"lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],lc=[...ac,...oc,"textBackgroundColor","direction",Ds],xg=[...nc,...oc,Ne,"strokeWidth",we,"deltaY","textBackgroundColor",Ds],wg={_reNewline:Ho,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:qt,fontStyle:"normal",lineHeight:1.16,textBackgroundColor:"",stroke:null,shadow:null,path:void 0,pathStartOffset:0,pathSide:qt,pathAlign:"baseline",charSpacing:0,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.28167,overline:-.81333},_fontSizeMult:1.13,[Ds]:66.667},Pr="justify",En="justify-left",pi="justify-right",vi="justify-center";var ja,Ra,Ba;const br=String.raw(ja||(ja=jr(["[-+]?(?:d*.d+|d+.?)(?:[eE][-+]?d+)?"],["[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?"]))),no=String.raw(Ra||(Ra=jr(["(?:s*,?s+|s*,s*)"],["(?:\\s*,?\\s+|\\s*,\\s*)"]))),bg=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+br+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+br+"))?\\s+(.*)"),Sg={cx:qt,x:qt,r:"radius",cy:Ye,y:Ye,display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing","text-decoration-thickness":Ds},oo="font-size",ao="clip-path";Yn(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]);Yn(["symbol","image","marker","pattern","view","svg"]);const za=Yn(["symbol","g","a","svg","clipPath","defs"]);new RegExp(String.raw(Ba||(Ba=jr(["^s*(",")","(",")","(",")","(",")s*$"],["^\\s*(",")","(",")","(",")","(",")\\s*$"])),br,no,br,no,br,no,br));const Cg=new B(1,0),cc=new B,hc=(a,t)=>a.rotate(t),Co=(a,t)=>new B(t).subtract(a),To=a=>a.distanceFrom(cc),ko=(a,t)=>Math.atan2(_i(a,t),kg(a,t)),Tg=a=>ko(Cg,a),$o=a=>a.eq(cc)?a:a.scalarDivide(To(a)),uc=function(a){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return $o(new B(-a.y,a.x).scalarMultiply(t?1:-1))},_i=(a,t)=>a.x*t.y-a.y*t.x,kg=(a,t)=>a.x*t.x+a.y*t.y,Va=(a,t,e)=>{if(a.eq(t)||a.eq(e))return!0;const r=_i(t,e),s=_i(t,a),i=_i(e,a);return r>=0?s>=0&&i<=0:!(s<=0&&i>=0)},Wa="(-?\\d+(?:\\.\\d*)?(?:px)?(?:\\s?|$))?",Ha=new RegExp("(?:\\s|^)"+Wa+Wa+"("+br+"?(?:px)?)?(?:\\s?|$)(?:$|\\s)");class Kr{constructor(t){const e=typeof t=="string"?Kr.parseShadow(t):t;Object.assign(this,Kr.ownDefaults,e),this.id=ds()}static parseShadow(t){const e=t.trim(),[,r=0,s=0,i=0]=(Ha.exec(e)||[]).map((n=>parseFloat(n)||0));return{color:(e.replace(Ha,"")||"rgb(0,0,0)").trim(),offsetX:r,offsetY:s,blur:i}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(t){const e=hc(new B(this.offsetX,this.offsetY),pe(-t.angle)),r=new $t(this.color);let s=40,i=40;return t.width&&t.height&&(s=100*re((Math.abs(e.x)+this.blur)/t.width,Ht.NUM_FRACTION_DIGITS)+20,i=100*re((Math.abs(e.y)+this.blur)/t.height,Ht.NUM_FRACTION_DIGITS)+20),t.flipX&&(e.x*=-1),t.flipY&&(e.y*=-1),'<filter id="SVGID_'.concat(this.id,'" y="-').concat(i,'%" height="').concat(100+2*i,'%" x="-').concat(s,'%" width="').concat(100+2*s,`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`).concat(re(this.blur?this.blur/2:0,Ht.NUM_FRACTION_DIGITS),`"></feGaussianBlur>
	<feOffset dx="`).concat(re(e.x,Ht.NUM_FRACTION_DIGITS),'" dy="').concat(re(e.y,Ht.NUM_FRACTION_DIGITS),`" result="oBlur" ></feOffset>
	<feFlood flood-color="`).concat(r.toRgb(),'" flood-opacity="').concat(r.getAlpha(),`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`)}toObject(){const t={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling,type:this.constructor.type},e=Kr.ownDefaults;return this.includeDefaultValues?t:Go(t,((r,s)=>r!==e[s]))}static async fromObject(t){return new this(t)}}C(Kr,"ownDefaults",{color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1}),C(Kr,"type","shadow"),mt.setClass(Kr,"shadow");const $s=(a,t,e)=>Math.max(a,Math.min(t,e)),Og=[Ye,qt,Ge,hr,"flipX","flipY","originX","originY","angle","opacity","globalCompositeOperation","shadow","visible",Js,Qs],ts=[we,Ne,"strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],Ag={top:0,left:0,width:0,height:0,angle:0,flipX:!1,flipY:!1,scaleX:1,scaleY:1,minScaleLimit:0,skewX:0,skewY:0,originX:qt,originY:Ye,strokeWidth:1,strokeUniform:!1,padding:0,opacity:1,paintFirst:we,fill:"rgb(0,0,0)",fillRule:"nonzero",stroke:null,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,globalCompositeOperation:"source-over",backgroundColor:"",shadow:null,visible:!0,includeDefaultValues:!0,excludeFromExport:!1,objectCaching:!0,clipPath:void 0,inverted:!1,absolutePositioned:!1,centeredRotation:!0,centeredScaling:!1,dirty:!0},Dg=(a,t,e,r)=>-e*Math.cos(a/r*Ei)+e+t,Eg=()=>!1;class Zo{constructor(t){let{startValue:e,byValue:r,duration:s=500,delay:i=0,easing:n=Dg,onStart:o=hn,onChange:l=hn,onComplete:c=hn,abort:u=Eg,target:d}=t;C(this,"_state","pending"),C(this,"durationProgress",0),C(this,"valueProgress",0),this.tick=this.tick.bind(this),this.duration=s,this.delay=i,this.easing=n,this._onStart=o,this._onChange=l,this._onComplete=c,this._abort=u,this.target=d,this.startValue=e,this.byValue=r,this.value=this.startValue,this.endValue=Object.freeze(this.calculate(this.duration).value)}get state(){return this._state}isDone(){return this._state==="aborted"||this._state==="completed"}start(){const t=e=>{this._state==="pending"&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout((()=>dn(t)),this.delay):dn(t)}tick(t){const e=(t||+new Date)-this.startTime,r=Math.min(e,this.duration);this.durationProgress=r/this.duration;const{value:s,valueProgress:i}=this.calculate(r);this.value=Object.freeze(s),this.valueProgress=i,this._state!=="aborted"&&(this._abort(this.value,this.valueProgress,this.durationProgress)?(this._state="aborted",this.unregister()):e>=this.duration?(this.durationProgress=this.valueProgress=1,this._onChange(this.endValue,this.valueProgress,this.durationProgress),this._state="completed",this._onComplete(this.endValue,this.valueProgress,this.durationProgress),this.unregister()):(this._onChange(this.value,this.valueProgress,this.durationProgress),dn(this.tick)))}register(){Tn.push(this)}unregister(){Tn.remove(this)}abort(){this._state="aborted",this.unregister()}}const Pg=["startValue","endValue"];class Mg extends Zo{constructor(t){let{startValue:e=0,endValue:r=100}=t;super(T(T({},ne(t,Pg)),{},{startValue:e,byValue:r-e}))}calculate(t){const e=this.easing(t,this.startValue,this.byValue,this.duration);return{value:e,valueProgress:Math.abs((e-this.startValue)/this.byValue)}}}const Ig=["startValue","endValue"];class Lg extends Zo{constructor(t){let{startValue:e=[0],endValue:r=[100]}=t;super(T(T({},ne(t,Ig)),{},{startValue:e,byValue:r.map(((s,i)=>s-e[i]))}))}calculate(t){const e=this.startValue.map(((r,s)=>this.easing(t,r,this.byValue[s],this.duration,s)));return{value:e,valueProgress:Math.abs((e[0]-this.startValue[0])/this.byValue[0])}}}const Fg=["startValue","endValue","easing","onChange","onComplete","abort"],jg=(a,t,e,r)=>t+e*(1-Math.cos(a/r*Ei)),lo=a=>a&&((t,e,r)=>a(new $t(t).toRgba(),e,r));class Rg extends Zo{constructor(t){let{startValue:e,endValue:r,easing:s=jg,onChange:i,onComplete:n,abort:o}=t,l=ne(t,Fg);const c=new $t(e).getSource(),u=new $t(r).getSource();super(T(T({},l),{},{startValue:c,byValue:u.map(((d,g)=>d-c[g])),easing:s,onChange:lo(i),onComplete:lo(n),abort:lo(o)}))}calculate(t){const[e,r,s,i]=this.startValue.map(((o,l)=>this.easing(t,o,this.byValue[l],this.duration,l))),n=[...[e,r,s].map(Math.round),$s(0,i,1)];return{value:n,valueProgress:n.map(((o,l)=>this.byValue[l]!==0?Math.abs((o-this.startValue[l])/this.byValue[l]):0)).find((o=>o!==0))||0}}}function dc(a){const t=(e=>Array.isArray(e.startValue)||Array.isArray(e.endValue))(a)?new Lg(a):new Mg(a);return t.start(),t}function Bg(a){const t=new Rg(a);return t.start(),t}class ce{constructor(t){this.status=t,this.points=[]}includes(t){return this.points.some((e=>e.eq(t)))}append(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.points=this.points.concat(e.filter((s=>!this.includes(s)))),this}static isPointContained(t,e,r){let s=arguments.length>3&&arguments[3]!==void 0&&arguments[3];if(e.eq(r))return t.eq(e);if(e.x===r.x)return t.x===e.x&&(s||t.y>=Math.min(e.y,r.y)&&t.y<=Math.max(e.y,r.y));if(e.y===r.y)return t.y===e.y&&(s||t.x>=Math.min(e.x,r.x)&&t.x<=Math.max(e.x,r.x));{const i=Co(e,r),n=Co(e,t).divide(i);return s?Math.abs(n.x)===Math.abs(n.y):n.x===n.y&&n.x>=0&&n.x<=1}}static isPointInPolygon(t,e){const r=new B(t).setX(Math.min(t.x-1,...e.map((i=>i.x))));let s=0;for(let i=0;i<e.length;i++){const n=this.intersectSegmentSegment(e[i],e[(i+1)%e.length],t,r);if(n.includes(t))return!0;s+=+(n.status==="Intersection")}return s%2==1}static intersectLineLine(t,e,r,s){let i=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4],n=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5];const o=e.x-t.x,l=e.y-t.y,c=s.x-r.x,u=s.y-r.y,d=t.x-r.x,g=t.y-r.y,f=c*g-u*d,m=o*g-l*d,p=u*o-c*l;if(p!==0){const v=f/p,y=m/p;return(i||0<=v&&v<=1)&&(n||0<=y&&y<=1)?new ce("Intersection").append(new B(t.x+v*o,t.y+v*l)):new ce}if(f===0||m===0){const v=i||n||ce.isPointContained(t,r,s)||ce.isPointContained(e,r,s)||ce.isPointContained(r,t,e)||ce.isPointContained(s,t,e);return new ce(v?"Coincident":void 0)}return new ce("Parallel")}static intersectSegmentLine(t,e,r,s){return ce.intersectLineLine(t,e,r,s,!1,!0)}static intersectSegmentSegment(t,e,r,s){return ce.intersectLineLine(t,e,r,s,!1,!1)}static intersectLinePolygon(t,e,r){let s=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];const i=new ce,n=r.length;for(let o,l,c,u=0;u<n;u++){if(o=r[u],l=r[(u+1)%n],c=ce.intersectLineLine(t,e,o,l,s,!1),c.status==="Coincident")return c;i.append(...c.points)}return i.points.length>0&&(i.status="Intersection"),i}static intersectSegmentPolygon(t,e,r){return ce.intersectLinePolygon(t,e,r,!1)}static intersectPolygonPolygon(t,e){const r=new ce,s=t.length,i=[];for(let n=0;n<s;n++){const o=t[n],l=t[(n+1)%s],c=ce.intersectSegmentPolygon(o,l,e);c.status==="Coincident"?(i.push(c),r.append(o,l)):r.append(...c.points)}return i.length>0&&i.length===t.length?new ce("Coincident"):(r.points.length>0&&(r.status="Intersection"),r)}static intersectPolygonRectangle(t,e,r){const s=e.min(r),i=e.max(r),n=new B(i.x,s.y),o=new B(s.x,i.y);return ce.intersectPolygonPolygon(t,[s,n,i,o])}}class zg extends Hl{getX(){return this.getXY().x}setX(t){this.setXY(this.getXY().setX(t))}getY(){return this.getXY().y}setY(t){this.setXY(this.getXY().setY(t))}getRelativeX(){return this.left}setRelativeX(t){this.left=t}getRelativeY(){return this.top}setRelativeY(t){this.top=t}getXY(){const t=this.getRelativeXY();return this.group?We(t,this.group.calcTransformMatrix()):t}setXY(t,e,r){this.group&&(t=We(t,wr(this.group.calcTransformMatrix()))),this.setRelativeXY(t,e,r)}getRelativeXY(){return new B(this.left,this.top)}setRelativeXY(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.originX,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.originY;this.setPositionByOrigin(t,e,r)}isStrokeAccountedForInDimensions(){return!1}getCoords(){const{tl:t,tr:e,br:r,bl:s}=this.aCoords||(this.aCoords=this.calcACoords()),i=[t,e,r,s];if(this.group){const n=this.group.calcTransformMatrix();return i.map((o=>We(o,n)))}return i}intersectsWithRect(t,e){return ce.intersectPolygonRectangle(this.getCoords(),t,e).status==="Intersection"}intersectsWithObject(t){const e=ce.intersectPolygonPolygon(this.getCoords(),t.getCoords());return e.status==="Intersection"||e.status==="Coincident"||t.isContainedWithinObject(this)||this.isContainedWithinObject(t)}isContainedWithinObject(t){return this.getCoords().every((e=>t.containsPoint(e)))}isContainedWithinRect(t,e){const{left:r,top:s,width:i,height:n}=this.getBoundingRect();return r>=t.x&&r+i<=e.x&&s>=t.y&&s+n<=e.y}isOverlapping(t){return this.intersectsWithObject(t)||this.isContainedWithinObject(t)||t.isContainedWithinObject(this)}containsPoint(t){return ce.isPointInPolygon(t,this.getCoords())}isOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return!!this.getCoords().some((r=>r.x<=e.x&&r.x>=t.x&&r.y<=e.y&&r.y>=t.y))||!!this.intersectsWithRect(t,e)||this.containsPoint(t.midPointFrom(e))}isPartiallyOnScreen(){if(!this.canvas)return!1;const{tl:t,br:e}=this.canvas.vptCoords;return this.intersectsWithRect(t,e)?!0:this.getCoords().every((r=>(r.x>=e.x||r.x<=t.x)&&(r.y>=e.y||r.y<=t.y)))&&this.containsPoint(t.midPointFrom(e))}getBoundingRect(){return qr(this.getCoords())}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(t){this._set(Ge,t),this._set(hr,t),this.setCoords()}scaleToWidth(t){const e=this.getBoundingRect().width/this.getScaledWidth();return this.scale(t/this.width/e)}scaleToHeight(t){const e=this.getBoundingRect().height/this.getScaledHeight();return this.scale(t/this.height/e)}getCanvasRetinaScaling(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.getRetinaScaling())||1}getTotalAngle(){return this.group?Qr(Nl(this.calcTransformMatrix())):this.angle}getViewportTransform(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.viewportTransform)||Be.concat()}calcACoords(){const t=ti({angle:this.angle}),{x:e,y:r}=this.getRelativeCenterPoint(),s=Pi(e,r),i=De(s,t),n=this._getTransformedDimensions(),o=n.x/2,l=n.y/2;return{tl:We({x:-o,y:-l},i),tr:We({x:o,y:-l},i),bl:We({x:-o,y:l},i),br:We({x:o,y:l},i)}}setCoords(){this.aCoords=this.calcACoords()}transformMatrixKey(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=[];return!t&&this.group&&(e=this.group.transformMatrixKey(t)),e.push(this.top,this.left,this.width,this.height,this.scaleX,this.scaleY,this.angle,this.strokeWidth,this.skewX,this.skewY,+this.flipX,+this.flipY,_e(this.originX),_e(this.originY)),e}calcTransformMatrix(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=this.calcOwnMatrix();if(t||!this.group)return e;const r=this.transformMatrixKey(t),s=this.matrixCache;return s&&s.key.every(((i,n)=>i===r[n]))?s.value:(this.group&&(e=De(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:r,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const r=this.getRelativeCenterPoint(),s={angle:this.angle,translateX:r.x,translateY:r.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},i=ag(s);return this.ownMatrixCache={key:t,value:i},i}_getNonTransformedDimensions(){return new B(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(t){return this._getTransformedDimensions(t).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=T({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},t),r=e.strokeWidth;let s=r,i=0;this.strokeUniform&&(s=0,i=r);const n=e.width+s,o=e.height+s;let l;return l=e.skewX===0&&e.skewY===0?new B(n*e.scaleX,o*e.scaleY):qo(n,o,Vn(e)),l.scalarAdd(i)}translateToGivenOrigin(t,e,r,s,i){let n=t.x,o=t.y;const l=_e(s)-_e(e),c=_e(i)-_e(r);if(l||c){const u=this._getTransformedDimensions();n+=l*u.x,o+=c*u.y}return new B(n,o)}translateToCenterPoint(t,e,r){if(e===Lt&&r===Lt)return t;const s=this.translateToGivenOrigin(t,e,r,Lt,Lt);return this.angle?s.rotate(pe(this.angle),t):s}translateToOriginPoint(t,e,r){const s=this.translateToGivenOrigin(t,Lt,Lt,e,r);return this.angle?s.rotate(pe(this.angle),t):s}getCenterPoint(){const t=this.getRelativeCenterPoint();return this.group?We(t,this.group.calcTransformMatrix()):t}getRelativeCenterPoint(){return this.translateToCenterPoint(new B(this.left,this.top),this.originX,this.originY)}getPointByOrigin(t,e){return this.translateToOriginPoint(this.getRelativeCenterPoint(),t,e)}setPositionByOrigin(t,e,r){const s=this.translateToCenterPoint(t,e,r),i=this.translateToOriginPoint(s,this.originX,this.originY);this.set({left:i.x,top:i.y})}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),qt,Ye)}}const Vg=["type"],Wg=["extraParam"];let Wr=class fn extends zg{static getDefaults(){return fn.ownDefaults}get type(){const t=this.constructor.type;return t==="FabricObject"?"object":t.toLowerCase()}set type(t){us("warn","Setting type has no effect",t)}constructor(t){super(),C(this,"_cacheContext",null),Object.assign(this,fn.ownDefaults),this.setOptions(t)}_createCacheCanvas(){this._cacheCanvas=Jr(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(t){const e=t.width,r=t.height,s=Ht.maxCacheSideLimit,i=Ht.minCacheSideLimit;if(e<=s&&r<=s&&e*r<=Ht.perfLimitSizeTotal)return e<i&&(t.width=i),r<i&&(t.height=i),t;const n=e/r,[o,l]=mi.limitDimsByArea(n),c=$s(i,o,s),u=$s(i,l,s);return e>c&&(t.zoomX/=e/c,t.width=c,t.capped=!0),r>u&&(t.zoomY/=r/u,t.height=u,t.capped=!0),t}_getCacheCanvasDimensions(){const t=this.getTotalObjectScaling(),e=this._getTransformedDimensions({skewX:0,skewY:0}),r=e.x*t.x/this.scaleX,s=e.y*t.y/this.scaleY;return{width:Math.ceil(r+2),height:Math.ceil(s+2),zoomX:t.x,zoomY:t.y,x:r,y:s}}_updateCacheCanvas(){const t=this._cacheCanvas,e=this._cacheContext,{width:r,height:s,zoomX:i,zoomY:n,x:o,y:l}=this._limitCacheSize(this._getCacheCanvasDimensions()),c=r!==t.width||s!==t.height,u=this.zoomX!==i||this.zoomY!==n;if(!t||!e)return!1;if(c||u){r!==t.width||s!==t.height?(t.width=r,t.height=s):(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height));const d=o/2,g=l/2;return this.cacheTranslationX=Math.round(t.width/2-d)+d,this.cacheTranslationY=Math.round(t.height/2-g)+g,e.translate(this.cacheTranslationX,this.cacheTranslationY),e.scale(i,n),this.zoomX=i,this.zoomY=n,!0}return!1}setOptions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setOptions(t)}transform(t){const e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,r=this.calcTransformMatrix(!e);t.transform(r[0],r[1],r[2],r[3],r[4],r[5])}getObjectScaling(){if(!this.group)return new B(Math.abs(this.scaleX),Math.abs(this.scaleY));const t=kn(this.calcTransformMatrix());return new B(Math.abs(t.scaleX),Math.abs(t.scaleY))}getTotalObjectScaling(){const t=this.getObjectScaling();if(this.canvas){const e=this.canvas.getZoom(),r=this.getCanvasRetinaScaling();return t.scalarMultiply(e*r)}return t}getObjectOpacity(){let t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t}_constrainScale(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t}_set(t,e){t!==Ge&&t!==hr||(e=this._constrainScale(e)),t===Ge&&e<0?(this.flipX=!this.flipX,e*=-1):t==="scaleY"&&e<0?(this.flipY=!this.flipY,e*=-1):t!=="shadow"||!e||e instanceof Kr||(e=new Kr(e));const r=this[t]!==e;return this[t]=e,r&&this.constructor.cacheProperties.includes(t)&&(this.dirty=!0),this.parent&&(this.dirty||r&&this.constructor.stateProperties.includes(t))&&this.parent._set("dirty",!0),this}isNotVisible(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible}render(t){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.drawObject(t,!1,{}),this.dirty=!1),t.restore())}drawSelectionBackground(t){}renderCache(t){if(t=t||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext){const{zoomX:e,zoomY:r,cacheTranslationX:s,cacheTranslationY:i}=this,{width:n,height:o}=this._cacheCanvas;this.drawObject(this._cacheContext,t.forClipping,{zoomX:e,zoomY:r,cacheTranslationX:s,cacheTranslationY:i,width:n,height:o,parentClipPaths:[]}),this.dirty=!1}}_removeCacheCanvas(){this._cacheCanvas=void 0,this._cacheContext=null}hasStroke(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0}hasFill(){return this.fill&&this.fill!=="transparent"}needsItsOwnCache(){return!!(this.paintFirst===Ne&&this.hasFill()&&this.hasStroke()&&this.shadow)||!!this.clipPath}shouldCache(){return this.ownCaching=this.objectCaching&&(!this.parent||!this.parent.isOnACache())||this.needsItsOwnCache(),this.ownCaching}willDrawShadow(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)}drawClipPathOnCache(t,e,r){t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",t.setTransform(1,0,0,1,0,0),t.drawImage(r,0,0),t.restore()}drawObject(t,e,r){const s=this.fill,i=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath,r),this.fill=s,this.stroke=i}createClipPathLayer(t,e){const r=ur(e),s=r.getContext("2d");if(s.translate(e.cacheTranslationX,e.cacheTranslationY),s.scale(e.zoomX,e.zoomY),t._cacheCanvas=r,e.parentClipPaths.forEach((i=>{i.transform(s)})),e.parentClipPaths.push(t),t.absolutePositioned){const i=wr(this.calcTransformMatrix());s.transform(i[0],i[1],i[2],i[3],i[4],i[5])}return t.transform(s),t.drawObject(s,!0,e),r}_drawClipPath(t,e,r){if(!e)return;e._transformDone=!0;const s=this.createClipPathLayer(e,r);this.drawClipPathOnCache(t,e,s)}drawCacheOnCanvas(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];if(this.isNotVisible())return!1;const e=this._cacheCanvas,r=this._cacheContext;return!(!e||!r||t||!this._updateCacheCanvas())||!!(this.dirty||this.clipPath&&this.clipPath.absolutePositioned)&&(e&&r&&!t&&(r.save(),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,e.width,e.height),r.restore()),!0)}_renderBackground(t){if(!this.backgroundColor)return;const e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y),this._removeShadow(t)}_setOpacity(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity}_setStrokeStyles(t,e){const r=e.stroke;r&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,nr(r)?r.gradientUnits==="percentage"||r.gradientTransform||r.patternTransform?this._applyPatternForTransformedGradient(t,r):(t.strokeStyle=r.toLive(t),this._applyPatternGradientTransform(t,r)):t.strokeStyle=e.stroke)}_setFillStyles(t,e){let{fill:r}=e;r&&(nr(r)?(t.fillStyle=r.toLive(t),this._applyPatternGradientTransform(t,r)):t.fillStyle=r)}_setClippingProperties(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"}_setLineDash(t,e){e&&e.length!==0&&t.setLineDash(e)}_setShadow(t){if(!this.shadow)return;const e=this.shadow,r=this.canvas,s=this.getCanvasRetinaScaling(),[i,,,n]=r?.viewportTransform||Be,o=i*s,l=n*s,c=e.nonScaling?new B(1,1):this.getObjectScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*Ht.browserShadowBlurConstant*(o+l)*(c.x+c.y)/4,t.shadowOffsetX=e.offsetX*o*c.x,t.shadowOffsetY=e.offsetY*l*c.y}_removeShadow(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)}_applyPatternGradientTransform(t,e){if(!nr(e))return{offsetX:0,offsetY:0};const r=e.gradientTransform||e.patternTransform,s=-this.width/2+e.offsetX||0,i=-this.height/2+e.offsetY||0;return e.gradientUnits==="percentage"?t.transform(this.width,0,0,this.height,s,i):t.transform(1,0,0,1,s,i),r&&t.transform(r[0],r[1],r[2],r[3],r[4],r[5]),{offsetX:s,offsetY:i}}_renderPaintInOrder(t){this.paintFirst===Ne?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))}_render(t){}_renderFill(t){this.fill&&(t.save(),this._setFillStyles(t,this),this.fillRule==="evenodd"?t.fill("evenodd"):t.fill(),t.restore())}_renderStroke(t){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform){const e=this.getObjectScaling();t.scale(1/e.x,1/e.y)}this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}}_applyPatternForTransformedGradient(t,e){var r;const s=this._limitCacheSize(this._getCacheCanvasDimensions()),i=this.getCanvasRetinaScaling(),n=s.x/this.scaleX/i,o=s.y/this.scaleY/i,l=ur({width:Math.ceil(n),height:Math.ceil(o)}),c=l.getContext("2d");c&&(c.beginPath(),c.moveTo(0,0),c.lineTo(n,0),c.lineTo(n,o),c.lineTo(0,o),c.closePath(),c.translate(n/2,o/2),c.scale(s.zoomX/this.scaleX/i,s.zoomY/this.scaleY/i),this._applyPatternGradientTransform(c,e),c.fillStyle=e.toLive(t),c.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(i*this.scaleX/s.zoomX,i*this.scaleY/s.zoomY),t.strokeStyle=(r=c.createPattern(l,"no-repeat"))!==null&&r!==void 0?r:"")}_findCenterFromElement(){return new B(this.left+this.width/2,this.top+this.height/2)}clone(t){const e=this.toObject(t);return this.constructor.fromObject(e)}cloneAsImage(t){const e=this.toCanvasElement(t);return new(mt.getClass("image"))(e)}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=Ql(this),r=this.group,s=this.shadow,i=Math.abs,n=t.enableRetinaScaling?Rl():1,o=(t.multiplier||1)*n,l=t.canvasProvider||(S=>new Mi(S,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1}));delete this.group,t.withoutTransform&&fg(this),t.withoutShadow&&(this.shadow=null),t.viewportTransform&&pg(this,this.getViewportTransform()),this.setCoords();const c=Jr(),u=this.getBoundingRect(),d=this.shadow,g=new B;if(d){const S=d.blur,O=d.nonScaling?new B(1,1):this.getObjectScaling();g.x=2*Math.round(i(d.offsetX)+S)*i(O.x),g.y=2*Math.round(i(d.offsetY)+S)*i(O.y)}const f=u.width+g.x,m=u.height+g.y;c.width=Math.ceil(f),c.height=Math.ceil(m);const p=l(c);t.format==="jpeg"&&(p.backgroundColor="#fff"),this.setPositionByOrigin(new B(p.width/2,p.height/2),Lt,Lt);const v=this.canvas;p._objects=[this],this.set("canvas",p),this.setCoords();const y=p.toCanvasElement(o||1,t);return this.set("canvas",v),this.shadow=s,r&&(this.group=r),this.set(e),this.setCoords(),p._objects=[],p.destroy(),y}toDataURL(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Yl(this.toCanvasElement(t),t.format||"png",t.quality||1)}toBlob(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Xl(this.toCanvasElement(t),t.format||"png",t.quality||1)}isType(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e.includes(this.constructor.type)||e.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(t){const{centeredRotation:e,originX:r,originY:s}=this;if(e){const{x:i,y:n}=this.getRelativeCenterPoint();this.originX=Lt,this.originY=Lt,this.left=i,this.top=n}if(this.set("angle",t),e){const{x:i,y:n}=this.translateToOriginPoint(this.getRelativeCenterPoint(),r,s);this.left=i,this.top=n,this.originX=r,this.originY=s}}setOnGroup(){}_setupCompositeOperation(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)}dispose(){Tn.cancelByTarget(this),this.off(),this._set("canvas",void 0),this._cacheCanvas&&Lr().dispose(this._cacheCanvas),this._cacheCanvas=void 0,this._cacheContext=null}animate(t,e){return Object.entries(t).reduce(((r,s)=>{let[i,n]=s;return r[i]=this._animate(i,n,e),r}),{})}_animate(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const s=t.split("."),i=this.constructor.colorProperties.includes(s[s.length-1]),{abort:n,startValue:o,onChange:l,onComplete:c}=r,u=T(T({},r),{},{target:this,startValue:o??s.reduce(((d,g)=>d[g]),this),endValue:e,abort:n?.bind(this),onChange:(d,g,f)=>{s.reduce(((m,p,v)=>(v===s.length-1&&(m[p]=d),m[p])),this),l&&l(d,g,f)},onComplete:(d,g,f)=>{this.setCoords(),c&&c(d,g,f)}});return i?Bg(u):dc(u)}isDescendantOf(t){const{parent:e,group:r}=this;return e===t||r===t||!!e&&e.isDescendantOf(t)||!!r&&r!==e&&r.isDescendantOf(t)}getAncestors(){const t=[];let e=this;do e=e.parent,e&&t.push(e);while(e);return t}findCommonAncestors(t){if(this===t)return{fork:[],otherFork:[],common:[this,...this.getAncestors()]};const e=this.getAncestors(),r=t.getAncestors();if(e.length===0&&r.length>0&&this===r[r.length-1])return{fork:[],otherFork:[t,...r.slice(0,r.length-1)],common:[this]};for(let s,i=0;i<e.length;i++){if(s=e[i],s===t)return{fork:[this,...e.slice(0,i)],otherFork:[],common:e.slice(i)};for(let n=0;n<r.length;n++){if(this===r[n])return{fork:[],otherFork:[t,...r.slice(0,n)],common:[this,...e]};if(s===r[n])return{fork:[this,...e.slice(0,i)],otherFork:[t,...r.slice(0,n)],common:e.slice(i)}}}return{fork:[this,...e],otherFork:[t,...r],common:[]}}hasCommonAncestors(t){const e=this.findCommonAncestors(t);return e&&!!e.common.length}isInFrontOf(t){if(this===t)return;const e=this.findCommonAncestors(t);if(e.fork.includes(t))return!0;if(e.otherFork.includes(this))return!1;const r=e.common[0]||this.canvas;if(!r)return;const s=e.fork.pop(),i=e.otherFork.pop(),n=r._objects.indexOf(s),o=r._objects.indexOf(i);return n>-1&&n>o}toObject(){const t=(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).concat(fn.customProperties,this.constructor.customProperties||[]);let e;const r=Ht.NUM_FRACTION_DIGITS,{clipPath:s,fill:i,stroke:n,shadow:o,strokeDashArray:l,left:c,top:u,originX:d,originY:g,width:f,height:m,strokeWidth:p,strokeLineCap:v,strokeDashOffset:y,strokeLineJoin:S,strokeUniform:O,strokeMiterLimit:A,scaleX:M,scaleY:F,angle:E,flipX:_,flipY:j,opacity:Y,visible:G,backgroundColor:R,fillRule:V,paintFirst:W,globalCompositeOperation:tt,skewX:et,skewY:z}=this;s&&!s.excludeFromExport&&(e=s.toObject(t.concat("inverted","absolutePositioned")));const Z=rt=>re(rt,r),Q=T(T({},ei(this,t)),{},{type:this.constructor.type,version:xo,originX:d,originY:g,left:Z(c),top:Z(u),width:Z(f),height:Z(m),fill:Oa(i)?i.toObject():i,stroke:Oa(n)?n.toObject():n,strokeWidth:Z(p),strokeDashArray:l&&l.concat(),strokeLineCap:v,strokeDashOffset:y,strokeLineJoin:S,strokeUniform:O,strokeMiterLimit:Z(A),scaleX:Z(M),scaleY:Z(F),angle:Z(E),flipX:_,flipY:j,opacity:Z(Y),shadow:o&&o.toObject(),visible:G,backgroundColor:R,fillRule:V,paintFirst:W,globalCompositeOperation:tt,skewX:Z(et),skewY:Z(z)},e?{clipPath:e}:null);return this.includeDefaultValues?Q:this._removeDefaultValues(Q)}toDatalessObject(t){return this.toObject(t)}_removeDefaultValues(t){const e=this.constructor.getDefaults(),r=Object.keys(e).length>0?e:Object.getPrototypeOf(this);return Go(t,((s,i)=>{if(i===qt||i===Ye||i==="type")return!0;const n=r[i];return s!==n&&!(Array.isArray(s)&&Array.isArray(n)&&s.length===0&&n.length===0)}))}toString(){return"#<".concat(this.constructor.type,">")}static _fromObject(t){let e=ne(t,Vg),r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{extraParam:s}=r,i=ne(r,Wg);return Wn(e,i).then((n=>s?(delete n[s],new this(e[s],n)):new this(n)))}static fromObject(t,e){return this._fromObject(t,e)}};C(Wr,"stateProperties",Og),C(Wr,"cacheProperties",ts),C(Wr,"ownDefaults",Ag),C(Wr,"type","FabricObject"),C(Wr,"colorProperties",[we,Ne,"backgroundColor"]),C(Wr,"customProperties",[]),mt.setClass(Wr),mt.setClass(Wr,"object");const ri=(a,t,e)=>(r,s,i,n)=>{const o=t(r,s,i,n);return o&&tc(a,T(T({},rc(r,s,i,n)),e)),o};function si(a){return(t,e,r,s)=>{const{target:i,originX:n,originY:o}=e,l=i.getRelativeCenterPoint(),c=i.translateToOriginPoint(l,n,o),u=a(t,e,r,s);return i.setPositionByOrigin(c,e.originX,e.originY),u}}const Ya=ri(bi,si(((a,t,e,r)=>{const s=Ko(t,t.originX,t.originY,e,r);if(_e(t.originX)===_e(Lt)||_e(t.originX)===_e(me)&&s.x<0||_e(t.originX)===_e(qt)&&s.x>0){const{target:i}=t,n=i.strokeWidth/(i.strokeUniform?i.scaleX:1),o=ec(t)?2:1,l=i.width,c=Math.abs(s.x*o/i.scaleX)-n;return i.set("width",Math.max(c,1)),l!==i.width}return!1})));function Hg(a,t,e,r,s){r=r||{};const i=this.sizeX||r.cornerSize||s.cornerSize,n=this.sizeY||r.cornerSize||s.cornerSize,o=r.transparentCorners!==void 0?r.transparentCorners:s.transparentCorners,l=o?Ne:we,c=!o&&(r.cornerStrokeColor||s.cornerStrokeColor);let u,d=t,g=e;a.save(),a.fillStyle=r.cornerColor||s.cornerColor||"",a.strokeStyle=r.cornerStrokeColor||s.cornerStrokeColor||"",i>n?(u=i,a.scale(1,n/i),g=e*i/n):n>i?(u=n,a.scale(i/n,1),d=t*n/i):u=i,a.beginPath(),a.arc(d,g,u/2,0,bn,!1),a[l](),c&&a.stroke(),a.restore()}function Yg(a,t,e,r,s){r=r||{};const i=this.sizeX||r.cornerSize||s.cornerSize,n=this.sizeY||r.cornerSize||s.cornerSize,o=r.transparentCorners!==void 0?r.transparentCorners:s.transparentCorners,l=o?Ne:we,c=!o&&(r.cornerStrokeColor||s.cornerStrokeColor),u=i/2,d=n/2;a.save(),a.fillStyle=r.cornerColor||s.cornerColor||"",a.strokeStyle=r.cornerStrokeColor||s.cornerStrokeColor||"",a.translate(t,e);const g=s.getTotalAngle();a.rotate(pe(g)),a["".concat(l,"Rect")](-u,-d,i,n),c&&a.strokeRect(-u,-d,i,n),a.restore()}class vr{constructor(t){C(this,"visible",!0),C(this,"actionName",zn),C(this,"angle",0),C(this,"x",0),C(this,"y",0),C(this,"offsetX",0),C(this,"offsetY",0),C(this,"sizeX",0),C(this,"sizeY",0),C(this,"touchSizeX",0),C(this,"touchSizeY",0),C(this,"cursorStyle","crosshair"),C(this,"withConnection",!1),Object.assign(this,t)}shouldActivate(t,e,r,s){var i;let{tl:n,tr:o,br:l,bl:c}=s;return((i=e.canvas)===null||i===void 0?void 0:i.getActiveObject())===e&&e.isControlVisible(t)&&ce.isPointInPolygon(r,[n,o,l,c])}getActionHandler(t,e,r){return this.actionHandler}getMouseDownHandler(t,e,r){return this.mouseDownHandler}getMouseUpHandler(t,e,r){return this.mouseUpHandler}cursorStyleHandler(t,e,r){return e.cursorStyle}getActionName(t,e,r){return e.actionName}getVisibility(t,e){var r,s;return(r=(s=t._controlsVisibility)===null||s===void 0?void 0:s[e])!==null&&r!==void 0?r:this.visible}setVisibility(t,e,r){this.visible=t}positionHandler(t,e,r,s){return new B(this.x*t.x+this.offsetX,this.y*t.y+this.offsetY).transform(e)}calcCornerCoords(t,e,r,s,i,n){const o=No([Pi(r,s),ti({angle:t}),Uo((i?this.touchSizeX:this.sizeX)||e,(i?this.touchSizeY:this.sizeY)||e)]);return{tl:new B(-.5,-.5).transform(o),tr:new B(.5,-.5).transform(o),br:new B(.5,.5).transform(o),bl:new B(-.5,.5).transform(o)}}render(t,e,r,s,i){((s=s||{}).cornerStyle||i.cornerStyle)==="circle"?Hg.call(this,t,e,r,s,i):Yg.call(this,t,e,r,s,i)}}const Xg=(a,t,e)=>e.lockRotation?An:t.cursorStyle,Ng=ri(zl,si(((a,t,e,r)=>{let{target:s,ex:i,ey:n,theta:o,originX:l,originY:c}=t;const u=s.translateToOriginPoint(s.getRelativeCenterPoint(),l,c);if(Tr(s,"lockRotation"))return!1;const d=Math.atan2(n-u.y,i-u.x),g=Math.atan2(r-u.y,e-u.x);let f=Qr(g-d+o);if(s.snapAngle&&s.snapAngle>0){const p=s.snapAngle,v=s.snapThreshold||p,y=Math.ceil(f/p)*p,S=Math.floor(f/p)*p;Math.abs(f-S)<v?f=S:Math.abs(f-y)<v&&(f=y)}f<0&&(f=360+f),f%=360;const m=s.angle!==f;return s.angle=f,m})));function gc(a,t){const e=t.canvas,r=a[e.uniScaleKey];return e.uniformScaling&&!r||!e.uniformScaling&&r}function fc(a,t,e){const r=Tr(a,"lockScalingX"),s=Tr(a,"lockScalingY");if(r&&s||!t&&(r||s)&&e||r&&t==="x"||s&&t==="y")return!0;const{width:i,height:n,strokeWidth:o}=a;return i===0&&o===0&&t!=="y"||n===0&&o===0&&t!=="x"}const Ug=["e","se","s","sw","w","nw","n","ne","e"],gi=(a,t,e)=>{const r=gc(a,e);if(fc(e,t.x!==0&&t.y===0?"x":t.x===0&&t.y!==0?"y":"",r))return An;const s=sc(e,t);return"".concat(Ug[s],"-resize")};function Jo(a,t,e,r){let s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};const i=t.target,n=s.by,o=gc(a,i);let l,c,u,d,g,f;if(fc(i,n,o))return!1;if(t.gestureScale)c=t.scaleX*t.gestureScale,u=t.scaleY*t.gestureScale;else{if(l=Ko(t,t.originX,t.originY,e,r),g=n!=="y"?Math.sign(l.x||t.signX||1):1,f=n!=="x"?Math.sign(l.y||t.signY||1):1,t.signX||(t.signX=g),t.signY||(t.signY=f),Tr(i,"lockScalingFlip")&&(t.signX!==g||t.signY!==f))return!1;if(d=i._getTransformedDimensions(),o&&!n){const v=Math.abs(l.x)+Math.abs(l.y),{original:y}=t,S=v/(Math.abs(d.x*y.scaleX/i.scaleX)+Math.abs(d.y*y.scaleY/i.scaleY));c=y.scaleX*S,u=y.scaleY*S}else c=Math.abs(l.x*i.scaleX/d.x),u=Math.abs(l.y*i.scaleY/d.y);ec(t)&&(c*=2,u*=2),t.signX!==g&&n!=="y"&&(t.originX=Pa(t.originX),c*=-1,t.signX=g),t.signY!==f&&n!=="x"&&(t.originY=Pa(t.originY),u*=-1,t.signY=f)}const m=i.scaleX,p=i.scaleY;return n?(n==="x"&&i.set(Ge,c),n==="y"&&i.set(hr,u)):(!Tr(i,"lockScalingX")&&i.set(Ge,c),!Tr(i,"lockScalingY")&&i.set(hr,u)),m!==i.scaleX||p!==i.scaleY}const ji=ri(Bn,si(((a,t,e,r)=>Jo(a,t,e,r)))),Gg=ri(Bn,si(((a,t,e,r)=>Jo(a,t,e,r,{by:"x"})))),qg=ri(Bn,si(((a,t,e,r)=>Jo(a,t,e,r,{by:"y"})))),Kg=["target","ex","ey","skewingSide"],co={x:{counterAxis:"y",scale:Ge,skew:Js,lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:hr,skew:Qs,lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},$g=["ns","nesw","ew","nwse"],Zg=(a,t,e)=>{if(t.x!==0&&Tr(e,"lockSkewingY")||t.y!==0&&Tr(e,"lockSkewingX"))return An;const r=sc(e,t)%4;return"".concat($g[r],"-resize")};function mc(a,t,e,r,s){const{target:i}=e,{counterAxis:n,origin:o,lockSkewing:l,skew:c,flip:u}=co[a];if(Tr(i,l))return!1;const{origin:d,flip:g}=co[n],f=_e(e[d])*(i[g]?-1:1),m=-Math.sign(f)*(i[u]?-1:1),p=.5*-((i[c]===0&&Ko(e,Lt,Lt,r,s)[a]>0||i[c]>0?1:-1)*m)+.5;return ri(Vl,si(((y,S,O,A)=>(function(M,F,E){let{target:_,ex:j,ey:Y,skewingSide:G}=F,R=ne(F,Kg);const{skew:V}=co[M],W=E.subtract(new B(j,Y)).divide(new B(_.scaleX,_.scaleY))[M],tt=_[V],et=R[V],z=Math.tan(pe(et)),Z=M==="y"?_._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:_._getTransformedDimensions({scaleX:1,scaleY:1}).y,Q=2*W*G/Math.max(Z,1)+z,rt=Qr(Math.atan(Q));_.set(V,rt);const nt=tt!==_[V];if(nt&&M==="y"){const{skewX:ut,scaleX:lt}=_,dt=_._getTransformedDimensions({skewY:tt}),P=_._getTransformedDimensions(),H=ut!==0?dt.x/P.x:1;H!==1&&_.set(Ge,H*lt)}return nt})(a,S,new B(O,A)))))(t,T(T({},e),{},{[o]:p,skewingSide:m}),r,s)}const Jg=(a,t,e,r)=>mc("x",a,t,e,r),Qg=(a,t,e,r)=>mc("y",a,t,e,r);function Xn(a,t){return a[t.canvas.altActionKey]}const Ri=(a,t,e)=>{const r=Xn(a,e);return t.x===0?r?Js:hr:t.y===0?r?Qs:Ge:""},Vs=(a,t,e)=>Xn(a,e)?Zg(0,t,e):gi(a,t,e),Xa=(a,t,e,r)=>Xn(a,t.target)?Qg(a,t,e,r):Gg(a,t,e,r),Na=(a,t,e,r)=>Xn(a,t.target)?Jg(a,t,e,r):qg(a,t,e,r),pc=()=>({ml:new vr({x:-.5,y:0,cursorStyleHandler:Vs,actionHandler:Xa,getActionName:Ri}),mr:new vr({x:.5,y:0,cursorStyleHandler:Vs,actionHandler:Xa,getActionName:Ri}),mb:new vr({x:0,y:.5,cursorStyleHandler:Vs,actionHandler:Na,getActionName:Ri}),mt:new vr({x:0,y:-.5,cursorStyleHandler:Vs,actionHandler:Na,getActionName:Ri}),tl:new vr({x:-.5,y:-.5,cursorStyleHandler:gi,actionHandler:ji}),tr:new vr({x:.5,y:-.5,cursorStyleHandler:gi,actionHandler:ji}),bl:new vr({x:-.5,y:.5,cursorStyleHandler:gi,actionHandler:ji}),br:new vr({x:.5,y:.5,cursorStyleHandler:gi,actionHandler:ji}),mtr:new vr({x:0,y:-.5,actionHandler:Ng,cursorStyleHandler:Xg,offsetY:-40,withConnection:!0,actionName:Yo})}),tf=()=>({mr:new vr({x:.5,y:0,actionHandler:Ya,cursorStyleHandler:Vs,actionName:bi}),ml:new vr({x:-.5,y:0,actionHandler:Ya,cursorStyleHandler:Vs,actionName:bi})}),ef=()=>T(T({},pc()),tf());class Es extends Wr{static getDefaults(){return T(T({},super.getDefaults()),Es.ownDefaults)}constructor(t){super(),Object.assign(this,this.constructor.createControls(),Es.ownDefaults),this.setOptions(t)}static createControls(){return{controls:pc()}}_updateCacheCanvas(){const t=this.canvas;if(this.noScaleCache&&t&&t._currentTransform){const e=t._currentTransform,r=e.target,s=e.action;if(this===r&&s&&s.startsWith(zn))return!1}return super._updateCacheCanvas()}getActiveControl(){const t=this.__corner;return t?{key:t,control:this.controls[t],coord:this.oCoords[t]}:void 0}findControl(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!this.hasControls||!this.canvas)return;this.__corner=void 0;const r=Object.entries(this.oCoords);for(let s=r.length-1;s>=0;s--){const[i,n]=r[s],o=this.controls[i];if(o.shouldActivate(i,this,t,e?n.touchCorner:n.corner))return this.__corner=i,{key:i,control:o,coord:this.oCoords[i]}}}calcOCoords(){const t=this.getViewportTransform(),e=this.getCenterPoint(),r=Pi(e.x,e.y),s=ti({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),i=De(r,s),n=De(t,i),o=De(n,[1/t[0],0,0,1/t[3],0,0]),l=this.group?kn(this.calcTransformMatrix()):void 0;l&&(l.scaleX=Math.abs(l.scaleX),l.scaleY=Math.abs(l.scaleY));const c=this._calculateCurrentDimensions(l),u={};return this.forEachControl(((d,g)=>{const f=d.positionHandler(c,o,this,d);u[g]=Object.assign(f,this._calcCornerCoords(d,f))})),u}_calcCornerCoords(t,e){const r=this.getTotalAngle();return{corner:t.calcCornerCoords(r,this.cornerSize,e.x,e.y,!1,this),touchCorner:t.calcCornerCoords(r,this.touchCornerSize,e.x,e.y,!0,this)}}setCoords(){super.setCoords(),this.canvas&&(this.oCoords=this.calcOCoords())}forEachControl(t){for(const e in this.controls)t(this.controls[e],e,this)}drawSelectionBackground(t){if(!this.selectionBackgroundColor||this.canvas&&this.canvas._activeObject!==this)return;t.save();const e=this.getRelativeCenterPoint(),r=this._calculateCurrentDimensions(),s=this.getViewportTransform();t.translate(e.x,e.y),t.scale(1/s[0],1/s[3]),t.rotate(pe(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-r.x/2,-r.y/2,r.x,r.y),t.restore()}strokeBorders(t,e){t.strokeRect(-e.x/2,-e.y/2,e.x,e.y)}_drawBorders(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};const s=T({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},r);t.save(),t.strokeStyle=s.borderColor,this._setLineDash(t,s.borderDashArray),this.strokeBorders(t,e),s.hasControls&&this.drawControlsConnectingLines(t,e),t.restore()}_renderControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const{hasBorders:r,hasControls:s}=this,i=T({hasBorders:r,hasControls:s},e),n=this.getViewportTransform(),o=i.hasBorders,l=i.hasControls,c=De(n,this.calcTransformMatrix()),u=kn(c);t.save(),t.translate(u.translateX,u.translateY),t.lineWidth=this.borderScaleFactor,this.group===this.parent&&(t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(u.angle-=180),t.rotate(pe(this.group?u.angle:this.angle)),o&&this.drawBorders(t,u,e),l&&this.drawControls(t,e),t.restore()}drawBorders(t,e,r){let s;if(r&&r.forActiveSelection||this.group){const i=qo(this.width,this.height,Vn(e)),n=this.isStrokeAccountedForInDimensions()?Xo:(this.strokeUniform?new B().scalarAdd(this.canvas?this.canvas.getZoom():1):new B(e.scaleX,e.scaleY)).scalarMultiply(this.strokeWidth);s=i.add(n).scalarAdd(this.borderScaleFactor).scalarAdd(2*this.padding)}else s=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(t,s,r)}drawControlsConnectingLines(t,e){let r=!1;t.beginPath(),this.forEachControl(((s,i)=>{s.withConnection&&s.getVisibility(this,i)&&(r=!0,t.moveTo(s.x*e.x,s.y*e.y),t.lineTo(s.x*e.x+s.offsetX,s.y*e.y+s.offsetY))})),r&&t.stroke()}drawControls(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t.save();const r=this.getCanvasRetinaScaling(),{cornerStrokeColor:s,cornerDashArray:i,cornerColor:n}=this,o=T({cornerStrokeColor:s,cornerDashArray:i,cornerColor:n},e);t.setTransform(r,0,0,r,0,0),t.strokeStyle=t.fillStyle=o.cornerColor,this.transparentCorners||(t.strokeStyle=o.cornerStrokeColor),this._setLineDash(t,o.cornerDashArray),this.forEachControl(((l,c)=>{if(l.getVisibility(this,c)){const u=this.oCoords[c];l.render(t,u.x,u.y,o,this)}})),t.restore()}isControlVisible(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)}setControlVisible(t,e){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=e}setControlsVisibility(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Object.entries(t).forEach((e=>{let[r,s]=e;return this.setControlVisible(r,s)}))}clearContextTop(t){if(!this.canvas)return;const e=this.canvas.contextTop;if(!e)return;const r=this.canvas.viewportTransform;e.save(),e.transform(r[0],r[1],r[2],r[3],r[4],r[5]),this.transform(e);const s=this.width+4,i=this.height+4;return e.clearRect(-s/2,-i/2,s,i),t||e.restore(),e}onDeselect(t){return!1}onSelect(t){return!1}shouldStartDragging(t){return!1}onDragStart(t){return!1}canDrop(t){return!1}renderDragSourceEffect(t){}renderDropTargetEffect(t){}}function vc(a,t){return t.forEach((e=>{Object.getOwnPropertyNames(e.prototype).forEach((r=>{r!=="constructor"&&Object.defineProperty(a.prototype,r,Object.getOwnPropertyDescriptor(e.prototype,r)||Object.create(null))}))})),a}C(Es,"ownDefaults",{noScaleCache:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,cornerSize:13,touchCornerSize:24,transparentCorners:!0,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,hasControls:!0,borderColor:"rgb(178,204,255)",borderDashArray:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,hasBorders:!0,selectionBackgroundColor:"",selectable:!0,evented:!0,perPixelTargetFind:!1,activeOn:"down",hoverCursor:null,moveCursor:null});class Me extends Es{}vc(Me,[ic]),mt.setClass(Me),mt.setClass(Me,"object");const rf=(a,t,e,r)=>{const s=2*(r=Math.round(r))+1,{data:i}=a.getImageData(t-r,e-r,s,s);for(let n=3;n<i.length;n+=4)if(i[n]>0)return!1;return!0};class _c{constructor(t){this.options=t,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new B(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new B(1/this.options.scaleX,1/this.options.scaleY):new B(1,1)}createSideVector(t,e){const r=Co(t,e);return this.options.strokeUniform?r.multiply(this.scale):r}projectOrthogonally(t,e,r){return this.applySkew(t.add(this.calcOrthogonalProjection(t,e,r)))}isSkewed(){return this.options.skewX!==0||this.options.skewY!==0}applySkew(t){const e=new B(t);return e.y+=e.x*Math.tan(pe(this.options.skewY)),e.x+=e.y*Math.tan(pe(this.options.skewX)),e}scaleUnitVector(t,e){return t.multiply(this.strokeUniformScalar).scalarMultiply(e)}}const sf=new B;class Gs extends _c{static getOrthogonalRotationFactor(t,e){const r=e?ko(t,e):Tg(t);return Math.abs(r)<Ei?-1:1}constructor(t,e,r,s){super(s),C(this,"AB",void 0),C(this,"AC",void 0),C(this,"alpha",void 0),C(this,"bisector",void 0),this.A=new B(t),this.B=new B(e),this.C=new B(r),this.AB=this.createSideVector(this.A,this.B),this.AC=this.createSideVector(this.A,this.C),this.alpha=ko(this.AB,this.AC),this.bisector=$o(hc(this.AB.eq(sf)?this.AC:this.AB,this.alpha/2))}calcOrthogonalProjection(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(t,e),i=uc(s),n=Gs.getOrthogonalRotationFactor(i,this.bisector);return this.scaleUnitVector(i,r*n)}projectBevel(){const t=[];return(this.alpha%bn==0?[this.B]:[this.B,this.C]).forEach((e=>{t.push(this.projectOrthogonally(this.A,e)),t.push(this.projectOrthogonally(this.A,e,-this.strokeProjectionMagnitude))})),t}projectMiter(){const t=[],e=Math.abs(this.alpha),r=1/Math.sin(e/2),s=this.scaleUnitVector(this.bisector,-this.strokeProjectionMagnitude*r),i=this.options.strokeUniform?To(this.scaleUnitVector(this.bisector,this.options.strokeMiterLimit)):this.options.strokeMiterLimit;return To(s)/this.strokeProjectionMagnitude<=i&&t.push(this.applySkew(this.A.add(s))),t.push(...this.projectBevel()),t}projectRoundNoSkew(t,e){const r=[],s=new B(Gs.getOrthogonalRotationFactor(this.bisector),Gs.getOrthogonalRotationFactor(new B(this.bisector.y,this.bisector.x)));return[new B(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s),new B(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(s)].forEach((i=>{Va(i,t,e)&&r.push(this.A.add(i))})),r}projectRoundWithSkew(t,e){const r=[],{skewX:s,skewY:i,scaleX:n,scaleY:o,strokeUniform:l}=this.options,c=new B(Math.tan(pe(s)),Math.tan(pe(i))),u=this.strokeProjectionMagnitude,d=l?u/o/Math.sqrt(1/o**2+1/n**2*c.y**2):u/Math.sqrt(1+c.y**2),g=new B(Math.sqrt(Math.max(u**2-d**2,0)),d),f=l?u/Math.sqrt(1+c.x**2*(1/o)**2/(1/n+1/n*c.x*c.y)**2):u/Math.sqrt(1+c.x**2/(1+c.x*c.y)**2),m=new B(f,Math.sqrt(Math.max(u**2-f**2,0)));return[m,m.scalarMultiply(-1),g,g.scalarMultiply(-1)].map((p=>this.applySkew(l?p.multiply(this.strokeUniformScalar):p))).forEach((p=>{Va(p,t,e)&&r.push(this.applySkew(this.A).add(p))})),r}projectRound(){const t=[];t.push(...this.projectBevel());const e=this.alpha%bn==0,r=this.applySkew(this.A),s=t[e?0:2].subtract(r),i=t[e?1:0].subtract(r),n=e?this.applySkew(this.AB.scalarMultiply(-1)):this.applySkew(this.bisector.multiply(this.strokeUniformScalar).scalarMultiply(-1)),o=_i(s,n)>0,l=o?s:i,c=o?i:s;return this.isSkewed()?t.push(...this.projectRoundWithSkew(l,c)):t.push(...this.projectRoundNoSkew(l,c)),t}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t,angle:this.alpha,bisector:this.bisector})))}}class Ua extends _c{constructor(t,e,r){super(r),this.A=new B(t),this.T=new B(e)}calcOrthogonalProjection(t,e){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.strokeProjectionMagnitude;const s=this.createSideVector(t,e);return this.scaleUnitVector(uc(s),r)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){const t=[];if(!this.isSkewed()&&this.A.eq(this.T)){const e=new B(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.applySkew(this.A.add(e)),this.applySkew(this.A.subtract(e)))}else t.push(...new Gs(this.A,this.T,this.T,this.options).projectRound());return t}projectSquare(){const t=[];if(this.A.eq(this.T)){const e=new B(1,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar);t.push(this.A.add(e),this.A.subtract(e))}else{const e=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),r=this.scaleUnitVector($o(this.createSideVector(this.A,this.T)),-this.strokeProjectionMagnitude),s=this.A.add(r);t.push(s.add(e),s.subtract(e))}return t.map((e=>this.applySkew(e)))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map((t=>({originPoint:this.A,projectedPoint:t})))}}const nf=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];const r=[];if(a.length===0)return r;const s=a.reduce(((i,n)=>(i[i.length-1].eq(n)||i.push(new B(n)),i)),[new B(a[0])]);if(s.length===1)e=!0;else if(!e){const i=s[0],n=((o,l)=>{for(let c=o.length-1;c>=0;c--)if(l(o[c],c,o))return c;return-1})(s,(o=>!o.eq(i)));s.splice(n+1)}return s.forEach(((i,n,o)=>{let l,c;n===0?(c=o[1],l=e?i:o[o.length-1]):n===o.length-1?(l=o[n-1],c=e?i:o[0]):(l=o[n-1],c=o[n+1]),e&&o.length===1?r.push(...new Ua(i,i,t).project()):!e||n!==0&&n!==o.length-1?r.push(...new Gs(i,l,c,t).project()):r.push(...new Ua(i,n===0?c:l,t).project())})),r},Qo=a=>{const t={};return Object.keys(a).forEach((e=>{t[e]={},Object.keys(a[e]).forEach((r=>{t[e][r]=T({},a[e][r])}))})),t},of=a=>a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let ci;const ta=a=>{if(ci||ci||(ci="Intl"in Rn()&&"Segmenter"in Intl&&new Intl.Segmenter(void 0,{granularity:"grapheme"})),ci){const t=ci.segment(a);return Array.from(t).map((e=>{let{segment:r}=e;return r}))}return af(a)},af=a=>{const t=[];for(let e,r=0;r<a.length;r++)(e=lf(a,r))!==!1&&t.push(e);return t},lf=(a,t)=>{const e=a.charCodeAt(t);if(isNaN(e))return"";if(e<55296||e>57343)return a.charAt(t);if(55296<=e&&e<=56319){if(a.length<=t+1)throw"High surrogate without following low surrogate";const s=a.charCodeAt(t+1);if(56320>s||s>57343)throw"High surrogate without following low surrogate";return a.charAt(t)+a.charAt(t+1)}if(t===0)throw"Low surrogate without preceding high surrogate";const r=a.charCodeAt(t-1);if(55296>r||r>56319)throw"Low surrogate without preceding high surrogate";return!1},ea=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];return a.fill!==t.fill||a.stroke!==t.stroke||a.strokeWidth!==t.strokeWidth||a.fontSize!==t.fontSize||a.fontFamily!==t.fontFamily||a.fontWeight!==t.fontWeight||a.fontStyle!==t.fontStyle||a.textDecorationThickness!==t.textDecorationThickness||a.textBackgroundColor!==t.textBackgroundColor||a.deltaY!==t.deltaY||e&&(a.overline!==t.overline||a.underline!==t.underline||a.linethrough!==t.linethrough)},cf=(a,t)=>{const e=t.split(`
`),r=[];let s=-1,i={};a=Qo(a);for(let n=0;n<e.length;n++){const o=ta(e[n]);if(a[n])for(let l=0;l<o.length;l++){s++;const c=a[n][l];c&&Object.keys(c).length>0&&(ea(i,c,!0)?r.push({start:s,end:s+1,style:c}):r[r.length-1].end++),i=c||{}}else s+=o.length,i={}}return r},hf=(a,t)=>{if(!Array.isArray(a))return Qo(a);const e=t.split(Ho),r={};let s=-1,i=0;for(let n=0;n<e.length;n++){const o=ta(e[n]);for(let l=0;l<o.length;l++)s++,a[i]&&a[i].start<=s&&s<a[i].end&&(r[n]=r[n]||{},r[n][l]=T({},a[i].style),s===a[i].end-1&&i++)}return r},gs=["display","transform",we,"fill-opacity","fill-rule","opacity",Ne,"stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];function Ga(a,t){const e=a.nodeName,r=a.getAttribute("class"),s=a.getAttribute("id"),i="(?![a-zA-Z\\-]+)";let n;if(n=new RegExp("^"+e,"i"),t=t.replace(n,""),s&&t.length&&(n=new RegExp("#"+s+i,"i"),t=t.replace(n,"")),r&&t.length){const o=r.split(" ");for(let l=o.length;l--;)n=new RegExp("\\."+o[l]+i,"i"),t=t.replace(n,"")}return t.length===0}function uf(a,t){let e=!0;const r=Ga(a,t.pop());return r&&t.length&&(e=(function(s,i){let n,o=!0;for(;s.parentElement&&s.parentElement.nodeType===1&&i.length;)o&&(n=i.pop()),o=Ga(s=s.parentElement,n);return i.length===0})(a,t)),r&&e&&t.length===0}const df=a=>{var t;return(t=Sg[a])!==null&&t!==void 0?t:a},gf=new RegExp("(".concat(br,")"),"gi"),ff=a=>Dn(a.replace(gf," $1 ").replace(/,/gi," "));var qa,Ka,$a,Za,Ja,Qa,tl;const je="(".concat(br,")"),mf=String.raw(qa||(qa=jr(["(skewX)(",")"],["(skewX)\\(","\\)"])),je),pf=String.raw(Ka||(Ka=jr(["(skewY)(",")"],["(skewY)\\(","\\)"])),je),vf=String.raw($a||($a=jr(["(rotate)(","(?: "," ",")?)"],["(rotate)\\(","(?: "," ",")?\\)"])),je,je,je),_f=String.raw(Za||(Za=jr(["(scale)(","(?: ",")?)"],["(scale)\\(","(?: ",")?\\)"])),je,je),yf=String.raw(Ja||(Ja=jr(["(translate)(","(?: ",")?)"],["(translate)\\(","(?: ",")?\\)"])),je,je),xf=String.raw(Qa||(Qa=jr(["(matrix)("," "," "," "," "," ",")"],["(matrix)\\("," "," "," "," "," ","\\)"])),je,je,je,je,je,je),ra="(?:".concat(xf,"|").concat(yf,"|").concat(vf,"|").concat(_f,"|").concat(mf,"|").concat(pf,")"),wf="(?:".concat(ra,"*)"),bf=String.raw(tl||(tl=jr(["^s*(?:","?)s*$"],["^\\s*(?:","?)\\s*$"])),wf),Sf=new RegExp(bf),Cf=new RegExp(ra),Tf=new RegExp(ra,"g");function Oo(a){const t=[];if(!(a=ff(a).replace(/\s*([()])\s*/gi,"$1"))||a&&!Sf.test(a))return[...Be];for(const e of a.matchAll(Tf)){const r=Cf.exec(e[0]);if(!r)continue;let s=Be;const i=r.filter((m=>!!m)),[,n,...o]=i,[l,c,u,d,g,f]=o.map((m=>parseFloat(m)));switch(n){case"translate":s=Pi(l,c);break;case Yo:s=ti({angle:l},{x:c,y:u});break;case zn:s=Uo(l,c);break;case Js:s=Gl(l);break;case Qs:s=ql(l);break;case"matrix":s=[l,c,u,d,g,f]}t.push(s)}return No(t)}function kf(a,t,e,r){const s=Array.isArray(t);let i,n=t;if(a!==we&&a!==Ne||t!==Xe){if(a==="strokeUniform")return t==="non-scaling-stroke";if(a==="strokeDashArray")n=t===Xe?null:t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(a==="transformMatrix")n=e&&e.transformMatrix?De(e.transformMatrix,Oo(t)):Oo(t);else if(a==="visible")n=t!==Xe&&t!=="hidden",e&&e.visible===!1&&(n=!1);else if(a==="opacity")n=parseFloat(t),e&&e.opacity!==void 0&&(n*=e.opacity);else if(a==="textAnchor")n=t==="start"?qt:t==="end"?me:Lt;else if(a==="charSpacing"||a===Ds)i=Us(t,r)/r*1e3;else if(a==="paintFirst"){const o=t.indexOf(we),l=t.indexOf(Ne);n=we,(o>-1&&l>-1&&l<o||o===-1&&l>-1)&&(n=Ne)}else{if(a==="href"||a==="xlink:href"||a==="font"||a==="id")return t;if(a==="imageSmoothing")return t==="optimizeQuality";i=s?t.map(Us):Us(t,r)}}else n="";return!s&&isNaN(i)?n:i}function Of(a,t){const e=a.match(bg);if(!e)return;const r=e[1],s=e[3],i=e[4],n=e[5],o=e[6];r&&(t.fontStyle=r),s&&(t.fontWeight=isNaN(parseFloat(s))?s:parseFloat(s)),i&&(t.fontSize=Us(i)),o&&(t.fontFamily=o),n&&(t.lineHeight=n==="normal"?1:n)}function Af(a,t){a.replace(/;\s*$/,"").split(";").forEach((e=>{if(!e)return;const[r,s]=e.split(":");t[r.trim().toLowerCase()]=s.trim()}))}function Df(a){const t={},e=a.getAttribute("style");return e&&(typeof e=="string"?Af(e,t):(function(r,s){Object.entries(r).forEach((i=>{let[n,o]=i;o!==void 0&&(s[n.toLowerCase()]=o)}))})(e,t)),t}const Ef={stroke:"strokeOpacity",fill:"fillOpacity"};function es(a,t,e){if(!a)return{};let r,s={},i=Wo;a.parentNode&&za.test(a.parentNode.nodeName)&&(s=es(a.parentElement,t,e),s.fontSize&&(r=i=Us(s.fontSize)));const n=T(T(T({},t.reduce(((c,u)=>{const d=a.getAttribute(u);return d&&(c[u]=d),c}),{})),(function(c){let u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d={};for(const g in u)uf(c,g.split(" "))&&(d=T(T({},d),u[g]));return d})(a,e)),Df(a));n[ao]&&a.setAttribute(ao,n[ao]),n[oo]&&(r=Us(n[oo],i),n[oo]="".concat(r));const o={};for(const c in n){const u=df(c),d=kf(u,n[c],s,r);o[u]=d}o&&o.font&&Of(o.font,o);const l=T(T({},s),o);return za.test(a.nodeName)?l:(function(c){const u=Me.getDefaults();return Object.entries(Ef).forEach((d=>{let[g,f]=d;if(c[f]===void 0||c[g]==="")return;if(c[g]===void 0){if(!u[g])return;c[g]=u[g]}if(c[g].indexOf("url(")===0)return;const m=new $t(c[g]);c[g]=m.setAlpha(re(m.getAlpha()*c[f],2)).toRgba()})),c})(l)}const Pf=["left","top","width","height","visible"],yc=["rx","ry"];class yr extends Me{static getDefaults(){return T(T({},super.getDefaults()),yr.ownDefaults)}constructor(t){super(),Object.assign(this,yr.ownDefaults),this.setOptions(t),this._initRxRy()}_initRxRy(){const{rx:t,ry:e}=this;t&&!e?this.ry=t:e&&!t&&(this.rx=e)}_render(t){const{width:e,height:r}=this,s=-e/2,i=-r/2,n=this.rx?Math.min(this.rx,e/2):0,o=this.ry?Math.min(this.ry,r/2):0,l=n!==0||o!==0;t.beginPath(),t.moveTo(s+n,i),t.lineTo(s+e-n,i),l&&t.bezierCurveTo(s+e-is*n,i,s+e,i+is*o,s+e,i+o),t.lineTo(s+e,i+r-o),l&&t.bezierCurveTo(s+e,i+r-is*o,s+e-is*n,i+r,s+e-n,i+r),t.lineTo(s+n,i+r),l&&t.bezierCurveTo(s+is*n,i+r,s,i+r-is*o,s,i+r-o),t.lineTo(s,i+o),l&&t.bezierCurveTo(s,i+is*o,s+is*n,i,s+n,i),t.closePath(),this._renderPaintInOrder(t)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...yc,...t])}_toSVG(){const{width:t,height:e,rx:r,ry:s}=this;return["<rect ","COMMON_PARTS",'x="'.concat(-t/2,'" y="').concat(-e/2,'" rx="').concat(r,'" ry="').concat(s,'" width="').concat(t,'" height="').concat(e,`" />
`)]}static async fromElement(t,e,r){const s=es(t,this.ATTRIBUTE_NAMES,r),{left:i=0,top:n=0,width:o=0,height:l=0,visible:c=!0}=s,u=ne(s,Pf);return new this(T(T(T({},e),u),{},{left:i,top:n,width:o,height:l,visible:!!(c&&o&&l)}))}}C(yr,"type","Rect"),C(yr,"cacheProperties",[...ts,...yc]),C(yr,"ownDefaults",{rx:0,ry:0}),C(yr,"ATTRIBUTE_NAMES",[...gs,"x","y","rx","ry","width","height"]),mt.setClass(yr),mt.setSVGClass(yr);const Nr="initialization",Pn="added",sa="removed",Mn="imperative",xc=(a,t)=>{const{strokeUniform:e,strokeWidth:r,width:s,height:i,group:n}=t,o=n&&n!==a?Hn(n.calcTransformMatrix(),a.calcTransformMatrix()):null,l=o?t.getRelativeCenterPoint().transform(o):t.getRelativeCenterPoint(),c=!t.isStrokeAccountedForInDimensions(),u=e&&c?mg(new B(r,r),void 0,a.calcTransformMatrix()):Xo,d=!e&&c?r:0,g=qo(s+d,i+d,No([o,t.calcOwnMatrix()],!0)).add(u).scalarDivide(2);return[l.subtract(g),l.add(g)]};class Nn{calcLayoutResult(t,e){if(this.shouldPerformLayout(t))return this.calcBoundingBox(e,t)}shouldPerformLayout(t){let{type:e,prevStrategy:r,strategy:s}=t;return e===Nr||e===Mn||!!r&&s!==r}shouldLayoutClipPath(t){let{type:e,target:{clipPath:r}}=t;return e!==Nr&&r&&!r.absolutePositioned}getInitialSize(t,e){return e.size}calcBoundingBox(t,e){const{type:r,target:s}=e;if(r===Mn&&e.overrides)return e.overrides;if(t.length===0)return;const{left:i,top:n,width:o,height:l}=qr(t.map((d=>xc(s,d))).reduce(((d,g)=>d.concat(g)),[])),c=new B(o,l),u=new B(i,n).add(c.scalarDivide(2));if(r===Nr){const d=this.getInitialSize(e,{size:c,center:u});return{center:u,relativeCorrection:new B(0,0),size:d}}return{center:u.transform(s.calcOwnMatrix()),size:c}}}C(Nn,"type","strategy");class Ao extends Nn{shouldPerformLayout(t){return!0}}C(Ao,"type","fit-content"),mt.setClass(Ao);const Mf=["strategy"],If=["target","strategy","bubbles","prevStrategy"],wc="layoutManager";class ki{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:new Ao;C(this,"strategy",void 0),this.strategy=t,this._subscriptions=new Map}performLayout(t){const e=T(T({bubbles:!0,strategy:this.strategy},t),{},{prevStrategy:this._prevLayoutStrategy,stopPropagation(){this.bubbles=!1}});this.onBeforeLayout(e);const r=this.getLayoutResult(e);r&&this.commitLayout(e,r),this.onAfterLayout(e,r),this._prevLayoutStrategy=e.strategy}attachHandlers(t,e){const{target:r}=e;return[Cn,Bl,bi,zl,Bn,Vl,Sn,tg,eg].map((s=>t.on(s,(i=>this.performLayout(s===Cn?{type:"object_modified",trigger:s,e:i,target:r}:{type:"object_modifying",trigger:s,e:i,target:r})))))}subscribe(t,e){this.unsubscribe(t,e);const r=this.attachHandlers(t,e);this._subscriptions.set(t,r)}unsubscribe(t,e){(this._subscriptions.get(t)||[]).forEach((r=>r())),this._subscriptions.delete(t)}unsubscribeTargets(t){t.targets.forEach((e=>this.unsubscribe(e,t)))}subscribeTargets(t){t.targets.forEach((e=>this.subscribe(e,t)))}onBeforeLayout(t){const{target:e,type:r}=t,{canvas:s}=e;if(r===Nr||r===Pn?this.subscribeTargets(t):r===sa&&this.unsubscribeTargets(t),e.fire("layout:before",{context:t}),s&&s.fire("object:layout:before",{target:e,context:t}),r===Mn&&t.deep){const i=ne(t,Mf);e.forEachObject((n=>n.layoutManager&&n.layoutManager.performLayout(T(T({},i),{},{bubbles:!1,target:n}))))}}getLayoutResult(t){const{target:e,strategy:r,type:s}=t,i=r.calcLayoutResult(t,e.getObjects());if(!i)return;const n=s===Nr?new B:e.getRelativeCenterPoint(),{center:o,correction:l=new B,relativeCorrection:c=new B}=i,u=n.subtract(o).add(l).transform(s===Nr?Be:wr(e.calcOwnMatrix()),!0).add(c);return{result:i,prevCenter:n,nextCenter:o,offset:u}}commitLayout(t,e){const{target:r}=t,{result:{size:s},nextCenter:i}=e;var n,o;r.set({width:s.x,height:s.y}),this.layoutObjects(t,e),t.type===Nr?r.set({left:(n=t.x)!==null&&n!==void 0?n:i.x+s.x*_e(r.originX),top:(o=t.y)!==null&&o!==void 0?o:i.y+s.y*_e(r.originY)}):(r.setPositionByOrigin(i,Lt,Lt),r.setCoords(),r.set("dirty",!0))}layoutObjects(t,e){const{target:r}=t;r.forEachObject((s=>{s.group===r&&this.layoutObject(t,e,s)})),t.strategy.shouldLayoutClipPath(t)&&this.layoutObject(t,e,r.clipPath)}layoutObject(t,e,r){let{offset:s}=e;r.set({left:r.left+s.x,top:r.top+s.y})}onAfterLayout(t,e){const{target:r,strategy:s,bubbles:i,prevStrategy:n}=t,o=ne(t,If),{canvas:l}=r;r.fire("layout:after",{context:t,result:e}),l&&l.fire("object:layout:after",{context:t,result:e,target:r});const c=r.parent;i&&c!=null&&c.layoutManager&&((o.path||(o.path=[])).push(r),c.layoutManager.performLayout(T(T({},o),{},{target:c}))),r.set("dirty",!0)}dispose(){const{_subscriptions:t}=this;t.forEach((e=>e.forEach((r=>r())))),t.clear()}toObject(){return{type:wc,strategy:this.strategy.constructor.type}}toJSON(){return this.toObject()}}mt.setClass(ki,wc);const Lf=["type","objects","layoutManager"];class Ff extends ki{performLayout(){}}class As extends Wl(Me){static getDefaults(){return T(T({},super.getDefaults()),As.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),C(this,"_activeObjects",[]),C(this,"__objectSelectionTracker",void 0),C(this,"__objectSelectionDisposer",void 0),Object.assign(this,As.ownDefaults),this.setOptions(e),this.groupInit(t,e)}groupInit(t,e){var r;this._objects=[...t],this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this.forEachObject((s=>{this.enterGroup(s,!1)})),this.layoutManager=(r=e.layoutManager)!==null&&r!==void 0?r:new ki,this.layoutManager.performLayout({type:Nr,target:this,targets:[...t],x:e.left,y:e.top})}canEnterGroup(t){return t===this||this.isDescendantOf(t)?(us("error","Group: circular object trees are not supported, this call has no effect"),!1):this._objects.indexOf(t)===-1||(us("error","Group: duplicate objects are not supported inside group, this call has no effect"),!1)}_filterObjectsBeforeEnteringGroup(t){return t.filter(((e,r,s)=>this.canEnterGroup(e)&&s.indexOf(e)===r))}add(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];const s=this._filterObjectsBeforeEnteringGroup(e),i=super.add(...s);return this._onAfterObjectsChange(Pn,s),i}insertAt(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),s=1;s<e;s++)r[s-1]=arguments[s];const i=this._filterObjectsBeforeEnteringGroup(r),n=super.insertAt(t,...i);return this._onAfterObjectsChange(Pn,i),n}remove(){const t=super.remove(...arguments);return this._onAfterObjectsChange(sa,t),t}_onObjectAdded(t){this.enterGroup(t,!0),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t,e){this.exitGroup(t,e),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onAfterObjectsChange(t,e){this.layoutManager.performLayout({type:t,targets:e,target:this})}_onStackOrderChanged(){this._set("dirty",!0)}_set(t,e){const r=this[t];return super._set(t,e),t==="canvas"&&r!==e&&(this._objects||[]).forEach((s=>{s._set(t,e)})),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectSelectionMonitor(t,e){let{target:r}=e;const s=this._activeObjects;if(t)s.push(r),this._set("dirty",!0);else if(s.length>0){const i=s.indexOf(r);i>-1&&(s.splice(i,1),this._set("dirty",!0))}}_watchObject(t,e){t&&this._watchObject(!1,e),t?(e.on("selected",this.__objectSelectionTracker),e.on("deselected",this.__objectSelectionDisposer)):(e.off("selected",this.__objectSelectionTracker),e.off("deselected",this.__objectSelectionDisposer))}enterGroup(t,e){t.group&&t.group.remove(t),t._set("parent",this),this._enterGroup(t,e)}_enterGroup(t,e){e&&On(t,De(wr(this.calcTransformMatrix()),t.calcTransformMatrix())),this._shouldSetNestedCoords()&&t.setCoords(),t._set("group",this),t._set("canvas",this.canvas),this._watchObject(!0,t);const r=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();r&&(r===t||t.isDescendantOf(r))&&this._activeObjects.push(t)}exitGroup(t,e){this._exitGroup(t,e),t._set("parent",void 0),t._set("canvas",void 0)}_exitGroup(t,e){t._set("group",void 0),e||(On(t,De(this.calcTransformMatrix(),t.calcTransformMatrix())),t.setCoords()),this._watchObject(!1,t);const r=this._activeObjects.length>0?this._activeObjects.indexOf(t):-1;r>-1&&this._activeObjects.splice(r,1)}shouldCache(){const t=Me.prototype.shouldCache.call(this);if(t){for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t}willDrawShadow(){if(super.willDrawShadow())return!0;for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.parent&&this.parent.isOnACache()}drawObject(t,e,r){this._renderBackground(t);for(let i=0;i<this._objects.length;i++){var s;const n=this._objects[i];(s=this.canvas)!==null&&s!==void 0&&s.preserveObjectStacking&&n.group!==this?(t.save(),t.transform(...wr(this.calcTransformMatrix())),n.render(t),t.restore()):n.group===this&&n.render(t)}this._drawClipPath(t,this.clipPath,r)}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject((t=>t.setCoords()))}triggerLayout(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.layoutManager.performLayout(T({target:this,type:Mn},t))}render(t){this._transformDone=!0,super.render(t),this._transformDone=!1}__serializeObjects(t,e){const r=this.includeDefaultValues;return this._objects.filter((function(s){return!s.excludeFromExport})).map((function(s){const i=s.includeDefaultValues;s.includeDefaultValues=r;const n=s[t||"toObject"](e);return s.includeDefaultValues=i,n}))}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.layoutManager.toObject();return T(T(T({},super.toObject(["subTargetCheck","interactive",...t])),e.strategy!=="fit-content"||this.includeDefaultValues?{layoutManager:e}:{}),{},{objects:this.__serializeObjects("toObject",t)})}toString(){return"#<Group: (".concat(this.complexity(),")>")}dispose(){this.layoutManager.unsubscribeTargets({targets:this.getObjects(),target:this}),this._activeObjects=[],this.forEachObject((t=>{this._watchObject(!1,t),t.dispose()})),super.dispose()}_createSVGBgRect(t){if(!this.backgroundColor)return"";const e=yr.prototype._toSVG.call(this),r=e.indexOf("COMMON_PARTS");e[r]='for="group" ';const s=e.join("");return t?t(s):s}_toSVG(t){const e=["<g ","COMMON_PARTS",` >
`],r=this._createSVGBgRect(t);r&&e.push("		",r);for(let s=0;s<this._objects.length;s++)e.push("		",this._objects[s].toSVG(t));return e.push(`</g>
`),e}getSvgStyles(){const t=this.opacity!==void 0&&this.opacity!==1?"opacity: ".concat(this.opacity,";"):"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")}toClipPathSVG(t){const e=[],r=this._createSVGBgRect(t);r&&e.push("	",r);for(let s=0;s<this._objects.length;s++)e.push("	",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}static fromObject(t,e){let{type:r,objects:s=[],layoutManager:i}=t,n=ne(t,Lf);return Promise.all([Si(s,e),Wn(n,e)]).then((o=>{let[l,c]=o;const u=new this(l,T(T(T({},n),c),{},{layoutManager:new Ff}));if(i){const d=mt.getClass(i.type),g=mt.getClass(i.strategy);u.layoutManager=new d(new g)}else u.layoutManager=new ki;return u.layoutManager.subscribeTargets({type:Nr,target:u,targets:u.getObjects()}),u.setCoords(),u}))}}C(As,"type","Group"),C(As,"ownDefaults",{strokeWidth:0,subTargetCheck:!1,interactive:!1}),mt.setClass(As);const jf=(a,t)=>Math.min(t.width/a.width,t.height/a.height),Rf=(a,t)=>Math.max(t.width/a.width,t.height/a.height),Do="\\s*,?\\s*",hi="".concat(Do,"(").concat(br,")"),Bf="".concat(hi).concat(hi).concat(hi).concat(Do,"([01])").concat(Do,"([01])").concat(hi).concat(hi),zf={m:"l",M:"L"},Vf=(a,t,e,r,s,i,n,o,l,c,u)=>{const d=$r(a),g=Zr(a),f=$r(t),m=Zr(t),p=e*s*f-r*i*m+n,v=r*s*f+e*i*m+o;return["C",c+l*(-e*s*g-r*i*d),u+l*(-r*s*g+e*i*d),p+l*(e*s*m+r*i*f),v+l*(r*s*m-e*i*f),p,v]},el=(a,t,e,r)=>{const s=Math.atan2(t,a),i=Math.atan2(r,e);return i>=s?i-s:2*Math.PI-(s-i)};function rl(a,t,e,r,s,i,n,o){let l;if(Ht.cachesBoundsOfCurve&&(l=[...arguments].join(),mi.boundsOfCurveCache[l]))return mi.boundsOfCurveCache[l];const c=Math.sqrt,u=Math.abs,d=[],g=[[0,0],[0,0]];let f=6*a-12*e+6*s,m=-3*a+9*e-9*s+3*n,p=3*e-3*a;for(let A=0;A<2;++A){if(A>0&&(f=6*t-12*r+6*i,m=-3*t+9*r-9*i+3*o,p=3*r-3*t),u(m)<1e-12){if(u(f)<1e-12)continue;const j=-p/f;0<j&&j<1&&d.push(j);continue}const M=f*f-4*p*m;if(M<0)continue;const F=c(M),E=(-f+F)/(2*m);0<E&&E<1&&d.push(E);const _=(-f-F)/(2*m);0<_&&_<1&&d.push(_)}let v=d.length;const y=v,S=bc(a,t,e,r,s,i,n,o);for(;v--;){const{x:A,y:M}=S(d[v]);g[0][v]=A,g[1][v]=M}g[0][y]=a,g[1][y]=t,g[0][y+1]=n,g[1][y+1]=o;const O=[new B(Math.min(...g[0]),Math.min(...g[1])),new B(Math.max(...g[0]),Math.max(...g[1]))];return Ht.cachesBoundsOfCurve&&(mi.boundsOfCurveCache[l]=O),O}const Wf=(a,t,e)=>{let[r,s,i,n,o,l,c,u]=e;const d=((g,f,m,p,v,y,S)=>{if(m===0||p===0)return[];let O=0,A=0,M=0;const F=Math.PI,E=S*Vo,_=Zr(E),j=$r(E),Y=.5*(-j*g-_*f),G=.5*(-j*f+_*g),R=m**2,V=p**2,W=G**2,tt=Y**2,et=R*V-R*W-V*tt;let z=Math.abs(m),Z=Math.abs(p);if(et<0){const J=Math.sqrt(1-et/(R*V));z*=J,Z*=J}else M=(v===y?-1:1)*Math.sqrt(et/(R*W+V*tt));const Q=M*z*G/Z,rt=-M*Z*Y/z,nt=j*Q-_*rt+.5*g,ut=_*Q+j*rt+.5*f;let lt=el(1,0,(Y-Q)/z,(G-rt)/Z),dt=el((Y-Q)/z,(G-rt)/Z,(-Y-Q)/z,(-G-rt)/Z);y===0&&dt>0?dt-=2*F:y===1&&dt<0&&(dt+=2*F);const P=Math.ceil(Math.abs(dt/F*2)),H=[],X=dt/P,N=8/3*Math.sin(X/4)*Math.sin(X/4)/Math.sin(X/2);let I=lt+X;for(let J=0;J<P;J++)H[J]=Vf(lt,I,j,_,z,Z,nt,ut,N,O,A),O=H[J][5],A=H[J][6],lt=I,I+=X;return H})(c-a,u-t,s,i,o,l,n);for(let g=0,f=d.length;g<f;g++)d[g][1]+=a,d[g][2]+=t,d[g][3]+=a,d[g][4]+=t,d[g][5]+=a,d[g][6]+=t;return d},Hf=a=>{let t=0,e=0,r=0,s=0;const i=[];let n,o=0,l=0;for(const c of a){const u=[...c];let d;switch(u[0]){case"l":u[1]+=t,u[2]+=e;case"L":t=u[1],e=u[2],d=["L",t,e];break;case"h":u[1]+=t;case"H":t=u[1],d=["L",t,e];break;case"v":u[1]+=e;case"V":e=u[1],d=["L",t,e];break;case"m":u[1]+=t,u[2]+=e;case"M":t=u[1],e=u[2],r=u[1],s=u[2],d=["M",t,e];break;case"c":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e,u[5]+=t,u[6]+=e;case"C":o=u[3],l=u[4],t=u[5],e=u[6],d=["C",u[1],u[2],o,l,t,e];break;case"s":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e;case"S":n==="C"?(o=2*t-o,l=2*e-l):(o=t,l=e),t=u[3],e=u[4],d=["C",o,l,u[1],u[2],t,e],o=d[3],l=d[4];break;case"q":u[1]+=t,u[2]+=e,u[3]+=t,u[4]+=e;case"Q":o=u[1],l=u[2],t=u[3],e=u[4],d=["Q",o,l,t,e];break;case"t":u[1]+=t,u[2]+=e;case"T":n==="Q"?(o=2*t-o,l=2*e-l):(o=t,l=e),t=u[1],e=u[2],d=["Q",o,l,t,e];break;case"a":u[6]+=t,u[7]+=e;case"A":Wf(t,e,u).forEach((g=>i.push(g))),t=u[6],e=u[7];break;case"z":case"Z":t=r,e=s,d=["Z"]}d?(i.push(d),n=d[0]):n=""}return i},In=(a,t,e,r)=>Math.sqrt((e-a)**2+(r-t)**2),bc=(a,t,e,r,s,i,n,o)=>l=>{const c=l**3,u=(f=>3*f**2*(1-f))(l),d=(f=>3*f*(1-f)**2)(l),g=(f=>(1-f)**3)(l);return new B(n*c+s*u+e*d+a*g,o*c+i*u+r*d+t*g)},Sc=a=>a**2,Cc=a=>2*a*(1-a),Tc=a=>(1-a)**2,Yf=(a,t,e,r,s,i,n,o)=>l=>{const c=Sc(l),u=Cc(l),d=Tc(l),g=3*(d*(e-a)+u*(s-e)+c*(n-s)),f=3*(d*(r-t)+u*(i-r)+c*(o-i));return Math.atan2(f,g)},Xf=(a,t,e,r,s,i)=>n=>{const o=Sc(n),l=Cc(n),c=Tc(n);return new B(s*o+e*l+a*c,i*o+r*l+t*c)},Nf=(a,t,e,r,s,i)=>n=>{const o=1-n,l=2*(o*(e-a)+n*(s-e)),c=2*(o*(r-t)+n*(i-r));return Math.atan2(c,l)},sl=(a,t,e)=>{let r=new B(t,e),s=0;for(let i=1;i<=100;i+=1){const n=a(i/100);s+=In(r.x,r.y,n.x,n.y),r=n}return s},Uf=(a,t)=>{let e,r=0,s=0,i={x:a.x,y:a.y},n=T({},i),o=.01,l=0;const c=a.iterator,u=a.angleFinder;for(;s<t&&o>1e-4;)n=c(r),l=r,e=In(i.x,i.y,n.x,n.y),e+s>t?(r-=o,o/=2):(i=n,r+=o,s+=e);return T(T({},n),{},{angle:u(l)})},kc=a=>{let t,e,r=0,s=0,i=0,n=0,o=0;const l=[];for(const c of a){const u={x:s,y:i,command:c[0],length:0};switch(c[0]){case"M":e=u,e.x=n=s=c[1],e.y=o=i=c[2];break;case"L":e=u,e.length=In(s,i,c[1],c[2]),s=c[1],i=c[2];break;case"C":t=bc(s,i,c[1],c[2],c[3],c[4],c[5],c[6]),e=u,e.iterator=t,e.angleFinder=Yf(s,i,c[1],c[2],c[3],c[4],c[5],c[6]),e.length=sl(t,s,i),s=c[5],i=c[6];break;case"Q":t=Xf(s,i,c[1],c[2],c[3],c[4]),e=u,e.iterator=t,e.angleFinder=Nf(s,i,c[1],c[2],c[3],c[4]),e.length=sl(t,s,i),s=c[3],i=c[4];break;case"Z":e=u,e.destX=n,e.destY=o,e.length=In(s,i,n,o),s=n,i=o}r+=e.length,l.push(e)}return l.push({length:r,x:s,y:i}),l},Gf=function(a,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:kc(a),r=0;for(;t-e[r].length>0&&r<e.length-2;)t-=e[r].length,r++;const s=e[r],i=t/s.length,n=a[r];switch(s.command){case"M":return{x:s.x,y:s.y,angle:0};case"Z":return T(T({},new B(s.x,s.y).lerp(new B(s.destX,s.destY),i)),{},{angle:Math.atan2(s.destY-s.y,s.destX-s.x)});case"L":return T(T({},new B(s.x,s.y).lerp(new B(n[1],n[2]),i)),{},{angle:Math.atan2(n[2]-s.y,n[1]-s.x)});case"C":case"Q":return Uf(s,t)}},qf=new RegExp("[mzlhvcsqta][^mzlhvcsqta]*","gi"),il=new RegExp(Bf,"g"),Kf=new RegExp(br,"gi"),$f={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},Zf=a=>{var t;const e=[],r=(t=a.match(qf))!==null&&t!==void 0?t:[];for(const s of r){const i=s[0];if(i==="z"||i==="Z"){e.push([i]);continue}const n=$f[i.toLowerCase()];let o=[];if(i==="a"||i==="A"){il.lastIndex=0;for(let l=null;l=il.exec(s);)o.push(...l.slice(1))}else o=s.match(Kf)||[];for(let l=0;l<o.length;l+=n){const c=new Array(n),u=zf[i];c[0]=l>0&&u?u:i;for(let d=0;d<n;d++)c[d+1]=parseFloat(o[l+d]);e.push(c)}}return e},Jf=(a,t)=>a.map((e=>e.map(((r,s)=>s===0||t===void 0?r:re(r,t))).join(" "))).join(" ");function Eo(a,t){const e=a.style;e&&t&&(typeof t=="string"?e.cssText+=";"+t:Object.entries(t).forEach((r=>{let[s,i]=r;return e.setProperty(s,i)})))}class Qf extends Jl{constructor(t){let{allowTouchScrolling:e=!1,containerClass:r=""}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(t),C(this,"upper",void 0),C(this,"container",void 0);const{el:s}=this.lower,i=this.createUpperCanvas();this.upper={el:i,ctx:i.getContext("2d")},this.applyCanvasStyle(s,{allowTouchScrolling:e}),this.applyCanvasStyle(i,{allowTouchScrolling:e,styles:{position:"absolute",left:"0",top:"0"}});const n=this.createContainerElement();n.classList.add(r),s.parentNode&&s.parentNode.replaceChild(n,s),n.append(s,i),this.container=n}createUpperCanvas(){const{el:t}=this.lower,e=Jr();return e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),e.style.cssText=t.style.cssText,e.setAttribute("draggable","true"),e}createContainerElement(){const t=Zs().createElement("div");return t.setAttribute("data-fabric","wrapper"),Eo(t,{position:"relative"}),Da(t),t}applyCanvasStyle(t,e){const{styles:r,allowTouchScrolling:s}=e;Eo(t,T(T({},r),{},{"touch-action":s?"manipulation":Xe})),Da(t)}setDimensions(t,e){super.setDimensions(t,e);const{el:r,ctx:s}=this.upper;Zl(r,s,t,e)}setCSSDimensions(t){super.setCSSDimensions(t),bo(this.upper.el,t),bo(this.container,t)}cleanupDOM(t){const e=this.container,{el:r}=this.lower,{el:s}=this.upper;super.cleanupDOM(t),e.removeChild(s),e.removeChild(r),e.parentNode&&e.parentNode.replaceChild(r,e)}dispose(){super.dispose(),Lr().dispose(this.upper.el),delete this.upper,delete this.container}}class Un extends Mi{constructor(){super(...arguments),C(this,"targets",[]),C(this,"_hoveredTargets",[]),C(this,"_currentTransform",null),C(this,"_groupSelector",null),C(this,"contextTopDirty",!1)}static getDefaults(){return T(T({},super.getDefaults()),Un.ownDefaults)}get upperCanvasEl(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.el}get contextTop(){var t;return(t=this.elements.upper)===null||t===void 0?void 0:t.ctx}get wrapperEl(){return this.elements.container}initElements(t){this.elements=new Qf(t,{allowTouchScrolling:this.allowTouchScrolling,containerClass:this.containerClass}),this._createCacheCanvas()}_onObjectAdded(t){this._objectsToRender=void 0,super._onObjectAdded(t)}_onObjectRemoved(t){this._objectsToRender=void 0,t===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[t]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[t]}),t.fire("deselected",{target:t})),t===this._hoveredTarget&&(this._hoveredTarget=void 0,this._hoveredTargets=[]),super._onObjectRemoved(t)}_onStackOrderChanged(){this._objectsToRender=void 0,super._onStackOrderChanged()}_chooseObjectsToRender(){const t=this._activeObject;return!this.preserveObjectStacking&&t?this._objects.filter((e=>!e.group&&e!==t)).concat(t):this._objects}renderAll(){this.cancelRequestedRender(),this.destroyed||(!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.getContext(),this._objectsToRender))}renderTopLayer(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}renderTop(){const t=this.contextTop;this.clearContext(t),this.renderTopLayer(t),this.fire("after:render",{ctx:t})}setTargetFindTolerance(t){t=Math.round(t),this.targetFindTolerance=t;const e=this.getRetinaScaling(),r=Math.ceil((2*t+1)*e);this.pixelFindCanvasEl.width=this.pixelFindCanvasEl.height=r,this.pixelFindContext.scale(e,e)}isTargetTransparent(t,e,r){const s=this.targetFindTolerance,i=this.pixelFindContext;this.clearContext(i),i.save(),i.translate(-e+s,-r+s),i.transform(...this.viewportTransform);const n=t.selectionBackgroundColor;t.selectionBackgroundColor="",t.render(i),t.selectionBackgroundColor=n,i.restore();const o=Math.round(s*this.getRetinaScaling());return rf(i,o,o,o)}_isSelectionKeyPressed(t){const e=this.selectionKey;return!!e&&(Array.isArray(e)?!!e.find((r=>!!r&&t[r]===!0)):t[e])}_shouldClearSelection(t,e){const r=this.getActiveObjects(),s=this._activeObject;return!!(!e||e&&s&&r.length>1&&r.indexOf(e)===-1&&s!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&s&&s!==e)}_shouldCenterTransform(t,e,r){if(!t)return;let s;return e===zn||e===Ge||e===hr||e===bi?s=this.centeredScaling||t.centeredScaling:e===Yo&&(s=this.centeredRotation||t.centeredRotation),s?!r:r}_getOriginFromCorner(t,e){const r={x:t.originX,y:t.originY};return e&&(["ml","tl","bl"].includes(e)?r.x=me:["mr","tr","br"].includes(e)&&(r.x=qt),["tl","mt","tr"].includes(e)?r.y=wo:["bl","mb","br"].includes(e)&&(r.y=Ye)),r}_setupCurrentTransform(t,e,r){var s;const i=e.group?Ns(this.getScenePoint(t),void 0,e.group.calcTransformMatrix()):this.getScenePoint(t),{key:n="",control:o}=e.getActiveControl()||{},l=r&&o?(s=o.getActionHandler(t,e,o))===null||s===void 0?void 0:s.bind(o):_g,c=((f,m,p,v)=>{if(!m||!f)return"drag";const y=v.controls[m];return y.getActionName(p,y,v)})(r,n,t,e),u=t[this.centeredKey],d=this._shouldCenterTransform(e,c,u)?{x:Lt,y:Lt}:this._getOriginFromCorner(e,n),g={target:e,action:c,actionHandler:l,actionPerformed:!1,corner:n,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:i.x-e.left,offsetY:i.y-e.top,originX:d.x,originY:d.y,ex:i.x,ey:i.y,lastX:i.x,lastY:i.y,theta:pe(e.angle),width:e.width,height:e.height,shiftKey:t.shiftKey,altKey:u,original:T(T({},Ql(e)),{},{originX:d.x,originY:d.y})};this._currentTransform=g,this.fire("before:transform",{e:t,transform:g})}setCursor(t){this.upperCanvasEl.style.cursor=t}_drawSelection(t){const{x:e,y:r,deltaX:s,deltaY:i}=this._groupSelector,n=new B(e,r).transform(this.viewportTransform),o=new B(e+s,r+i).transform(this.viewportTransform),l=this.selectionLineWidth/2;let c=Math.min(n.x,o.x),u=Math.min(n.y,o.y),d=Math.max(n.x,o.x),g=Math.max(n.y,o.y);this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(c,u,d-c,g-u)),this.selectionLineWidth&&this.selectionBorderColor&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,c+=l,u+=l,d-=l,g-=l,Me.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(c,u,d-c,g-u))}findTarget(t){if(this.skipTargetFind)return;const e=this.getViewportPoint(t),r=this._activeObject,s=this.getActiveObjects();if(this.targets=[],r&&s.length>=1){if(r.findControl(e,So(t))||s.length>1&&this.searchPossibleTargets([r],e))return r;if(r===this.searchPossibleTargets([r],e)){if(this.preserveObjectStacking){const i=this.targets;this.targets=[];const n=this.searchPossibleTargets(this._objects,e);return t[this.altSelectionKey]&&n&&n!==r?(this.targets=i,r):n}return r}}return this.searchPossibleTargets(this._objects,e)}_pointIsInObjectSelectionArea(t,e){let r=t.getCoords();const s=this.getZoom(),i=t.padding/s;if(i){const[n,o,l,c]=r,u=Math.atan2(o.y-n.y,o.x-n.x),d=$r(u)*i,g=Zr(u)*i,f=d+g,m=d-g;r=[new B(n.x-m,n.y-f),new B(o.x+f,o.y-m),new B(l.x+m,l.y+f),new B(c.x-f,c.y+m)]}return ce.isPointInPolygon(e,r)}_checkTarget(t,e){return!!(t&&t.visible&&t.evented&&this._pointIsInObjectSelectionArea(t,Ns(e,void 0,this.viewportTransform))&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,e.x,e.y)))}_searchPossibleTargets(t,e){let r=t.length;for(;r--;){const s=t[r];if(this._checkTarget(s,e)){if(un(s)&&s.subTargetCheck){const i=this._searchPossibleTargets(s._objects,e);i&&this.targets.push(i)}return s}}}searchPossibleTargets(t,e){const r=this._searchPossibleTargets(t,e);if(r&&un(r)&&r.interactive&&this.targets[0]){const s=this.targets;for(let i=s.length-1;i>0;i--){const n=s[i];if(!un(n)||!n.interactive)return n}return s[0]}return r}getViewportPoint(t){return this._pointer?this._pointer:this.getPointer(t,!0)}getScenePoint(t){return this._absolutePointer?this._absolutePointer:this.getPointer(t)}getPointer(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const r=this.upperCanvasEl,s=r.getBoundingClientRect();let i=ug(t),n=s.width||0,o=s.height||0;n&&o||(Ye in s&&wo in s&&(o=Math.abs(s.top-s.bottom)),me in s&&qt in s&&(n=Math.abs(s.right-s.left))),this.calcOffset(),i.x=i.x-this._offset.left,i.y=i.y-this._offset.top,e||(i=Ns(i,void 0,this.viewportTransform));const l=this.getRetinaScaling();l!==1&&(i.x/=l,i.y/=l);const c=n===0||o===0?new B(1,1):new B(r.width/n,r.height/o);return i.multiply(c)}_setDimensionsImpl(t,e){this._resetTransformEventData(),super._setDimensionsImpl(t,e),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_createCacheCanvas(){this.pixelFindCanvasEl=Jr(),this.pixelFindContext=this.pixelFindCanvasEl.getContext("2d",{willReadFrequently:!0}),this.setTargetFindTolerance(this.targetFindTolerance)}getTopContext(){return this.elements.upper.ctx}getSelectionContext(){return this.elements.upper.ctx}getSelectionElement(){return this.elements.upper.el}getActiveObject(){return this._activeObject}getActiveObjects(){const t=this._activeObject;return _s(t)?t.getObjects():t?[t]:[]}_fireSelectionEvents(t,e){let r=!1,s=!1;const i=this.getActiveObjects(),n=[],o=[];t.forEach((l=>{i.includes(l)||(r=!0,l.fire("deselected",{e,target:l}),o.push(l))})),i.forEach((l=>{t.includes(l)||(r=!0,l.fire("selected",{e,target:l}),n.push(l))})),t.length>0&&i.length>0?(s=!0,r&&this.fire("selection:updated",{e,selected:n,deselected:o})):i.length>0?(s=!0,this.fire("selection:created",{e,selected:n})):t.length>0&&(s=!0,this.fire("selection:cleared",{e,deselected:o})),s&&(this._objectsToRender=void 0)}setActiveObject(t,e){const r=this.getActiveObjects(),s=this._setActiveObject(t,e);return this._fireSelectionEvents(r,e),s}_setActiveObject(t,e){const r=this._activeObject;return r!==t&&!(!this._discardActiveObject(e,t)&&this._activeObject)&&!t.onSelect({e})&&(this._activeObject=t,_s(t)&&r!==t&&t.set("canvas",this),t.setCoords(),!0)}_discardActiveObject(t,e){const r=this._activeObject;return!!r&&!r.onDeselect({e:t,object:e})&&(this._currentTransform&&this._currentTransform.target===r&&this.endCurrentTransform(t),_s(r)&&r===this._hoveredTarget&&(this._hoveredTarget=void 0),this._activeObject=void 0,!0)}discardActiveObject(t){const e=this.getActiveObjects(),r=this.getActiveObject();e.length&&this.fire("before:selection:cleared",{e:t,deselected:[r]});const s=this._discardActiveObject(t);return this._fireSelectionEvents(e,t),s}endCurrentTransform(t){const e=this._currentTransform;this._finalizeCurrentTransform(t),e&&e.target&&(e.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(t){const e=this._currentTransform,r=e.target,s={e:t,target:r,transform:e,action:e.action};r._scaling&&(r._scaling=!1),r.setCoords(),e.actionPerformed&&(this.fire("object:modified",s),r.fire(Cn,s))}setViewportTransform(t){super.setViewportTransform(t);const e=this._activeObject;e&&e.setCoords()}destroy(){const t=this._activeObject;_s(t)&&(t.removeAll(),t.dispose()),delete this._activeObject,super.destroy(),this.pixelFindContext=null,this.pixelFindCanvasEl=void 0}clear(){this.discardActiveObject(),this._activeObject=void 0,this.clearContext(this.contextTop),super.clear()}drawControls(t){const e=this._activeObject;e&&e._renderControls(t)}_toObject(t,e,r){const s=this._realizeGroupTransformOnObject(t),i=super._toObject(t,e,r);return t.set(s),i}_realizeGroupTransformOnObject(t){const{group:e}=t;if(e&&_s(e)&&this._activeObject===e){const r=ei(t,["angle","flipX","flipY",qt,Ge,hr,Js,Qs,Ye]);return gg(t,e.calcOwnMatrix()),r}return{}}_setSVGObject(t,e,r){const s=this._realizeGroupTransformOnObject(e);super._setSVGObject(t,e,r),e.set(s)}}C(Un,"ownDefaults",{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1,containerClass:"canvas-container",preserveObjectStacking:!1});class tm{constructor(t){C(this,"targets",[]),C(this,"__disposer",void 0);const e=()=>{const{hiddenTextarea:s}=t.getActiveObject()||{};s&&s.focus()},r=t.upperCanvasEl;r.addEventListener("click",e),this.__disposer=()=>r.removeEventListener("click",e)}exitTextEditing(){this.target=void 0,this.targets.forEach((t=>{t.isEditing&&t.exitEditing()}))}add(t){this.targets.push(t)}remove(t){this.unregister(t),Bs(this.targets,t)}register(t){this.target=t}unregister(t){t===this.target&&(this.target=void 0)}onMouseMove(t){var e;!((e=this.target)===null||e===void 0)&&e.isEditing&&this.target.updateSelectionOnMouseMove(t)}clear(){this.targets=[],this.target=void 0}dispose(){this.clear(),this.__disposer(),delete this.__disposer}}const em=["target","oldTarget","fireCanvas","e"],$e={passive:!1},js=(a,t)=>{const e=a.getViewportPoint(t),r=a.getScenePoint(t);return{viewportPoint:e,scenePoint:r,pointer:e,absolutePointer:r}},ns=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return a.addEventListener(...e)},tr=function(a){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return a.removeEventListener(...e)},rm={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}};class Po extends Un{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}),C(this,"_isClick",void 0),C(this,"textEditingManager",new tm(this)),["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach((e=>{this[e]=this[e].bind(this)})),this.addOrRemove(ns,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(t,e){const r=this.upperCanvasEl,s=this._getEventPrefix();t($l(r),"resize",this._onResize),t(r,s+"down",this._onMouseDown),t(r,"".concat(s,"move"),this._onMouseMove,$e),t(r,"".concat(s,"out"),this._onMouseOut),t(r,"".concat(s,"enter"),this._onMouseEnter),t(r,"wheel",this._onMouseWheel,{passive:!1}),t(r,"contextmenu",this._onContextMenu),t(r,"click",this._onClick),t(r,"dblclick",this._onClick),t(r,"dragstart",this._onDragStart),t(r,"dragend",this._onDragEnd),t(r,"dragover",this._onDragOver),t(r,"dragenter",this._onDragEnter),t(r,"dragleave",this._onDragLeave),t(r,"drop",this._onDrop),this.enablePointerEvents||t(r,"touchstart",this._onTouchStart,$e)}removeListeners(){this.addOrRemove(tr,"remove");const t=this._getEventPrefix(),e=xr(this.upperCanvasEl);tr(e,"".concat(t,"up"),this._onMouseUp),tr(e,"touchend",this._onTouchEnd,$e),tr(e,"".concat(t,"move"),this._onMouseMove,$e),tr(e,"touchmove",this._onMouseMove,$e),clearTimeout(this._willAddMouseDown)}_onMouseWheel(t){this.__onMouseWheel(t)}_onMouseOut(t){const e=this._hoveredTarget,r=T({e:t},js(this,t));this.fire("mouse:out",T(T({},r),{},{target:e})),this._hoveredTarget=void 0,e&&e.fire("mouseout",T({},r)),this._hoveredTargets.forEach((s=>{this.fire("mouse:out",T(T({},r),{},{target:s})),s&&s.fire("mouseout",T({},r))})),this._hoveredTargets=[]}_onMouseEnter(t){this._currentTransform||this.findTarget(t)||(this.fire("mouse:over",T({e:t},js(this,t))),this._hoveredTarget=void 0,this._hoveredTargets=[])}_onDragStart(t){this._isClick=!1;const e=this.getActiveObject();if(e&&e.onDragStart(t)){this._dragSource=e;const r={e:t,target:e};return this.fire("dragstart",r),e.fire("dragstart",r),void ns(this.upperCanvasEl,"drag",this._onDragProgress)}Ea(t)}_renderDragEffects(t,e,r){let s=!1;const i=this._dropTarget;i&&i!==e&&i!==r&&(i.clearContextTop(),s=!0),e?.clearContextTop(),r!==e&&r?.clearContextTop();const n=this.contextTop;n.save(),n.transform(...this.viewportTransform),e&&(n.save(),e.transform(n),e.renderDragSourceEffect(t),n.restore(),s=!0),r&&(n.save(),r.transform(n),r.renderDropTargetEffect(t),n.restore(),s=!0),n.restore(),s&&(this.contextTopDirty=!0)}_onDragEnd(t){const e=!!t.dataTransfer&&t.dataTransfer.dropEffect!==Xe,r=e?this._activeObject:void 0,s={e:t,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:e,dropTarget:r};tr(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",s),this._dragSource&&this._dragSource.fire("dragend",s),delete this._dragSource,this._onMouseUp(t)}_onDragProgress(t){const e={e:t,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",e),this._dragSource&&this._dragSource.fire("drag",e)}findDragTargets(t){return this.targets=[],{target:this._searchPossibleTargets(this._objects,this.getViewportPoint(t)),targets:[...this.targets]}}_onDragOver(t){const e="dragover",{target:r,targets:s}=this.findDragTargets(t),i=this._dragSource,n={e:t,target:r,subTargets:s,dragSource:i,canDrop:!1,dropTarget:void 0};let o;this.fire(e,n),this._fireEnterLeaveEvents(r,n),r&&(r.canDrop(t)&&(o=r),r.fire(e,n));for(let l=0;l<s.length;l++){const c=s[l];c.canDrop(t)&&(o=c),c.fire(e,n)}this._renderDragEffects(t,i,o),this._dropTarget=o}_onDragEnter(t){const{target:e,targets:r}=this.findDragTargets(t),s={e:t,target:e,subTargets:r,dragSource:this._dragSource};this.fire("dragenter",s),this._fireEnterLeaveEvents(e,s)}_onDragLeave(t){const e={e:t,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",e),this._fireEnterLeaveEvents(void 0,e),this._renderDragEffects(t,this._dragSource),this._dropTarget=void 0,this.targets=[],this._hoveredTargets=[]}_onDrop(t){const{target:e,targets:r}=this.findDragTargets(t),s=this._basicEventHandler("drop:before",T({e:t,target:e,subTargets:r,dragSource:this._dragSource},js(this,t)));s.didDrop=!1,s.dropTarget=void 0,this._basicEventHandler("drop",s),this.fire("drop:after",s)}_onContextMenu(t){const e=this.findTarget(t),r=this.targets||[],s=this._basicEventHandler("contextmenu:before",{e:t,target:e,subTargets:r});return this.stopContextMenu&&Ea(t),this._basicEventHandler("contextmenu",s),!1}_onClick(t){const e=t.detail;e>3||e<2||(this._cacheTransformEventData(t),e==2&&t.type==="dblclick"&&this._handleEvent(t,"dblclick"),e==3&&this._handleEvent(t,"tripleclick"),this._resetTransformEventData())}getPointerId(t){const e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1}_isMainEvent(t){return t.isPrimary===!0||t.isPrimary!==!1&&(t.type==="touchend"&&t.touches.length===0||!t.changedTouches||t.changedTouches[0].identifier===this.mainTouchId)}_onTouchStart(t){let e=!this.allowTouchScrolling;const r=this._activeObject;this.mainTouchId===void 0&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),(this.isDrawingMode||r&&this._target===r)&&(e=!0),e&&t.preventDefault(),this._resetTransformEventData();const s=this.upperCanvasEl,i=this._getEventPrefix(),n=xr(s);ns(n,"touchend",this._onTouchEnd,$e),e&&ns(n,"touchmove",this._onMouseMove,$e),tr(s,"".concat(i,"down"),this._onMouseDown)}_onMouseDown(t){this.__onMouseDown(t),this._resetTransformEventData();const e=this.upperCanvasEl,r=this._getEventPrefix();tr(e,"".concat(r,"move"),this._onMouseMove,$e);const s=xr(e);ns(s,"".concat(r,"up"),this._onMouseUp),ns(s,"".concat(r,"move"),this._onMouseMove,$e)}_onTouchEnd(t){if(t.touches.length>0)return;this.__onMouseUp(t),this._resetTransformEventData(),delete this.mainTouchId;const e=this._getEventPrefix(),r=xr(this.upperCanvasEl);tr(r,"touchend",this._onTouchEnd,$e),tr(r,"touchmove",this._onMouseMove,$e),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout((()=>{ns(this.upperCanvasEl,"".concat(e,"down"),this._onMouseDown),this._willAddMouseDown=0}),400)}_onMouseUp(t){this.__onMouseUp(t),this._resetTransformEventData();const e=this.upperCanvasEl,r=this._getEventPrefix();if(this._isMainEvent(t)){const s=xr(this.upperCanvasEl);tr(s,"".concat(r,"up"),this._onMouseUp),tr(s,"".concat(r,"move"),this._onMouseMove,$e),ns(e,"".concat(r,"move"),this._onMouseMove,$e)}}_onMouseMove(t){const e=this.getActiveObject();!this.allowTouchScrolling&&(!e||!e.shouldStartDragging(t))&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(t){const e=this.getActiveObject();return!!e!=!!t||e&&t&&e!==t}__onMouseUp(t){var e;this._cacheTransformEventData(t),this._handleEvent(t,"up:before");const r=this._currentTransform,s=this._isClick,i=this._target,{button:n}=t;if(n)return(this.fireMiddleClick&&n===1||this.fireRightClick&&n===2)&&this._handleEvent(t,"up"),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)return void this._onMouseUpInDrawingMode(t);if(!this._isMainEvent(t))return;let o,l,c=!1;if(r&&(this._finalizeCurrentTransform(t),c=r.actionPerformed),!s){const u=i===this._activeObject;this.handleSelection(t),c||(c=this._shouldRender(i)||!u&&i===this._activeObject)}if(i){const u=i.findControl(this.getViewportPoint(t),So(t)),{key:d,control:g}=u||{};if(l=d,i.selectable&&i!==this._activeObject&&i.activeOn==="up")this.setActiveObject(i,t),c=!0;else if(g){const f=g.getMouseUpHandler(t,i,g);f&&(o=this.getScenePoint(t),f.call(g,t,r,o.x,o.y))}i.isMoving=!1}if(r&&(r.target!==i||r.corner!==l)){const u=r.target&&r.target.controls[r.corner],d=u&&u.getMouseUpHandler(t,r.target,u);o=o||this.getScenePoint(t),d&&d.call(u,t,r,o.x,o.y)}this._setCursorFromEvent(t,i),this._handleEvent(t,"up"),this._groupSelector=null,this._currentTransform=null,i&&(i.__corner=void 0),c?this.requestRenderAll():s||(e=this._activeObject)!==null&&e!==void 0&&e.isEditing||this.renderTop()}_basicEventHandler(t,e){const{target:r,subTargets:s=[]}=e;this.fire(t,e),r&&r.fire(t,e);for(let i=0;i<s.length;i++)s[i]!==r&&s[i].fire(t,e);return e}_handleEvent(t,e,r){const s=this._target,i=this.targets||[],n=T(T(T({e:t,target:s,subTargets:i},js(this,t)),{},{transform:this._currentTransform},e==="up:before"||e==="up"?{isClick:this._isClick,currentTarget:this.findTarget(t),currentSubTargets:this.targets}:{}),e==="down:before"||e==="down"?r:{});this.fire("mouse:".concat(e),n),s&&s.fire("mouse".concat(e),n);for(let o=0;o<i.length;o++)i[o]!==s&&i[o].fire("mouse".concat(e),n)}_onMouseDownInDrawingMode(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(t),this.requestRenderAll());const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down",{alreadySelected:!1})}_onMouseMoveInDrawingMode(t){if(this._isCurrentlyDrawing){const e=this.getScenePoint(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")}_onMouseUpInDrawingMode(t){const e=this.getScenePoint(t);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e:t,pointer:e}):this._isCurrentlyDrawing=!1,this._handleEvent(t,"up")}__onMouseDown(t){this._isClick=!0,this._cacheTransformEventData(t),this._handleEvent(t,"down:before");let e=this._target,r=!!e&&e===this._activeObject;const{button:s}=t;if(s)return(this.fireMiddleClick&&s===1||this.fireRightClick&&s===2)&&this._handleEvent(t,"down",{alreadySelected:r}),void this._resetTransformEventData();if(this.isDrawingMode)return void this._onMouseDownInDrawingMode(t);if(!this._isMainEvent(t)||this._currentTransform)return;let i=this._shouldRender(e),n=!1;if(this.handleMultiSelection(t,e)?(e=this._activeObject,n=!0,i=!0):this._shouldClearSelection(t,e)&&this.discardActiveObject(t),this.selection&&(!e||!e.selectable&&!e.isEditing&&e!==this._activeObject)){const o=this.getScenePoint(t);this._groupSelector={x:o.x,y:o.y,deltaY:0,deltaX:0}}if(r=!!e&&e===this._activeObject,e){e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);const o=e.findControl(this.getViewportPoint(t),So(t));if(e===this._activeObject&&(o||!n)){this._setupCurrentTransform(t,e,r);const l=o?o.control:void 0,c=this.getScenePoint(t),u=l&&l.getMouseDownHandler(t,e,l);u&&u.call(l,t,this._currentTransform,c.x,c.y)}}i&&(this._objectsToRender=void 0),this._handleEvent(t,"down",{alreadySelected:r}),i&&this.requestRenderAll()}_resetTransformEventData(){this._target=this._pointer=this._absolutePointer=void 0}_cacheTransformEventData(t){this._resetTransformEventData(),this._pointer=this.getViewportPoint(t),this._absolutePointer=Ns(this._pointer,void 0,this.viewportTransform),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)}__onMouseMove(t){if(this._isClick=!1,this._cacheTransformEventData(t),this._handleEvent(t,"move:before"),this.isDrawingMode)return void this._onMouseMoveInDrawingMode(t);if(!this._isMainEvent(t))return;const e=this._groupSelector;if(e){const r=this.getScenePoint(t);e.deltaX=r.x-e.x,e.deltaY=r.y-e.y,this.renderTop()}else if(this._currentTransform)this._transformObject(t);else{const r=this.findTarget(t);this._setCursorFromEvent(t,r),this._fireOverOutEvents(t,r)}this.textEditingManager.onMouseMove(t),this._handleEvent(t,"move"),this._resetTransformEventData()}_fireOverOutEvents(t,e){const r=this._hoveredTarget,s=this._hoveredTargets,i=this.targets,n=Math.max(s.length,i.length);this.fireSyntheticInOutEvents("mouse",{e:t,target:e,oldTarget:r,fireCanvas:!0});for(let o=0;o<n;o++)i[o]===e||s[o]&&s[o]===r||this.fireSyntheticInOutEvents("mouse",{e:t,target:i[o],oldTarget:s[o]});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(t,e){const r=this._draggedoverTarget,s=this._hoveredTargets,i=this.targets,n=Math.max(s.length,i.length);this.fireSyntheticInOutEvents("drag",T(T({},e),{},{target:t,oldTarget:r,fireCanvas:!0}));for(let o=0;o<n;o++)this.fireSyntheticInOutEvents("drag",T(T({},e),{},{target:i[o],oldTarget:s[o]}));this._draggedoverTarget=t}fireSyntheticInOutEvents(t,e){let{target:r,oldTarget:s,fireCanvas:i,e:n}=e,o=ne(e,em);const{targetIn:l,targetOut:c,canvasIn:u,canvasOut:d}=rm[t],g=s!==r;if(s&&g){const f=T(T({},o),{},{e:n,target:s,nextTarget:r},js(this,n));i&&this.fire(d,f),s.fire(c,f)}if(r&&g){const f=T(T({},o),{},{e:n,target:r,previousTarget:s},js(this,n));i&&this.fire(u,f),r.fire(l,f)}}__onMouseWheel(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()}_transformObject(t){const e=this.getScenePoint(t),r=this._currentTransform,s=r.target,i=s.group?Ns(e,void 0,s.group.calcTransformMatrix()):e;r.shiftKey=t.shiftKey,r.altKey=!!this.centeredKey&&t[this.centeredKey],this._performTransformAction(t,r,i),r.actionPerformed&&this.requestRenderAll()}_performTransformAction(t,e,r){const{action:s,actionHandler:i,target:n}=e,o=!!i&&i(t,e,r.x,r.y);o&&n.setCoords(),s==="drag"&&o&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||o}_setCursorFromEvent(t,e){if(!e)return void this.setCursor(this.defaultCursor);let r=e.hoverCursor||this.hoverCursor;const s=_s(this._activeObject)?this._activeObject:null,i=(!s||e.group!==s)&&e.findControl(this.getViewportPoint(t));if(i){const n=i.control;this.setCursor(n.cursorStyleHandler(t,n,e))}else e.subTargetCheck&&this.targets.concat().reverse().map((n=>{r=n.hoverCursor||r})),this.setCursor(r)}handleMultiSelection(t,e){const r=this._activeObject,s=_s(r);if(r&&this._isSelectionKeyPressed(t)&&this.selection&&e&&e.selectable&&(r!==e||s)&&(s||!e.isDescendantOf(r)&&!r.isDescendantOf(e))&&!e.onSelect({e:t})&&!r.getActiveControl()){if(s){const i=r.getObjects();if(e===r){const n=this.getViewportPoint(t);if(!(e=this.searchPossibleTargets(i,n)||this.searchPossibleTargets(this._objects,n))||!e.selectable)return!1}e.group===r?(r.remove(e),this._hoveredTarget=e,this._hoveredTargets=[...this.targets],r.size()===1&&this._setActiveObject(r.item(0),t)):(r.multiSelectAdd(e),this._hoveredTarget=r,this._hoveredTargets=[...this.targets]),this._fireSelectionEvents(i,t)}else{r.isEditing&&r.exitEditing();const i=new(mt.getClass("ActiveSelection"))([],{canvas:this});i.multiSelectAdd(r,e),this._hoveredTarget=i,this._setActiveObject(i,t),this._fireSelectionEvents([r],t)}return!0}return!1}handleSelection(t){if(!this.selection||!this._groupSelector)return!1;const{x:e,y:r,deltaX:s,deltaY:i}=this._groupSelector,n=new B(e,r),o=n.add(new B(s,i)),l=n.min(o),c=n.max(o).subtract(l),u=this.collectObjects({left:l.x,top:l.y,width:c.x,height:c.y},{includeIntersecting:!this.selectionFullyContained}),d=n.eq(o)?u[0]?[u[0]]:[]:u.length>1?u.filter((g=>!g.onSelect({e:t}))).reverse():u;if(d.length===1)this.setActiveObject(d[0],t);else if(d.length>1){const g=mt.getClass("ActiveSelection");this.setActiveObject(new g(d,{canvas:this}),t)}return this._groupSelector=null,!0}toCanvasElement(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0;const{upper:r}=this.elements;r.ctx=void 0;const s=super.toCanvasElement(t,e);return r.ctx=r.el.getContext("2d"),s}clear(){this.textEditingManager.clear(),super.clear()}destroy(){this.removeListeners(),this.textEditingManager.dispose(),super.destroy()}}const Oc={x1:0,y1:0,x2:0,y2:0},sm=T(T({},Oc),{},{r1:0,r2:0}),Ws=(a,t)=>isNaN(a)&&typeof t=="number"?t:a;function Ac(a){return a&&/%$/.test(a)&&Number.isFinite(parseFloat(a))}function Dc(a,t){const e=typeof a=="number"?a:typeof a=="string"?parseFloat(a)/(Ac(a)?100:1):NaN;return $s(0,Ws(e,t),1)}const im=/\s*;\s*/,nm=/\s*:\s*/;function om(a,t){let e,r;const s=a.getAttribute("style");if(s){const n=s.split(im);n[n.length-1]===""&&n.pop();for(let o=n.length;o--;){const[l,c]=n[o].split(nm).map((u=>u.trim()));l==="stop-color"?e=c:l==="stop-opacity"&&(r=c)}}const i=new $t(e||a.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:Dc(a.getAttribute("offset"),0),color:i.toRgb(),opacity:Ws(parseFloat(r||a.getAttribute("stop-opacity")||""),1)*i.getAlpha()*t}}function am(a,t){const e=[],r=a.getElementsByTagName("stop"),s=Dc(t,1);for(let i=r.length;i--;)e.push(om(r[i],s));return e}function Ec(a){return a.nodeName==="linearGradient"||a.nodeName==="LINEARGRADIENT"?"linear":"radial"}function Pc(a){return a.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage"}function pr(a,t){return a.getAttribute(t)}function lm(a,t){return(function(e,r){let s,{width:i,height:n,gradientUnits:o}=r;return Object.entries(e).reduce(((l,c)=>{let[u,d]=c;if(d==="Infinity")s=1;else if(d==="-Infinity")s=0;else{const g=typeof d=="string";s=g?parseFloat(d):d,g&&Ac(d)&&(s*=.01,o==="pixels"&&(u!=="x1"&&u!=="x2"&&u!=="r2"||(s*=i),u!=="y1"&&u!=="y2"||(s*=n)))}return l[u]=s,l}),{})})(Ec(a)==="linear"?(function(e){return{x1:pr(e,"x1")||0,y1:pr(e,"y1")||0,x2:pr(e,"x2")||"100%",y2:pr(e,"y2")||0}})(a):(function(e){return{x1:pr(e,"fx")||pr(e,"cx")||"50%",y1:pr(e,"fy")||pr(e,"cy")||"50%",r1:0,x2:pr(e,"cx")||"50%",y2:pr(e,"cy")||"50%",r2:pr(e,"r")||"50%"}})(a),T(T({},t),{},{gradientUnits:Pc(a)}))}class Bi{constructor(t){const{type:e="linear",gradientUnits:r="pixels",coords:s={},colorStops:i=[],offsetX:n=0,offsetY:o=0,gradientTransform:l,id:c}=t||{};Object.assign(this,{type:e,gradientUnits:r,coords:T(T({},e==="radial"?sm:Oc),s),colorStops:i,offsetX:n,offsetY:o,gradientTransform:l,id:c?"".concat(c,"_").concat(ds()):ds()})}addColorStop(t){for(const e in t){const r=new $t(t[e]);this.colorStops.push({offset:parseFloat(e),color:r.toRgb(),opacity:r.getAlpha()})}return this}toObject(t){return T(T({},ei(this,t)),{},{type:this.type,coords:T({},this.coords),colorStops:this.colorStops.map((e=>T({},e))),offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?[...this.gradientTransform]:void 0})}toSVG(t){let{additionalTransform:e}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const r=[],s=this.gradientTransform?this.gradientTransform.concat():Be.concat(),i=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox",n=this.colorStops.map((d=>T({},d))).sort(((d,g)=>d.offset-g.offset));let o=-this.offsetX,l=-this.offsetY;var c;i==="objectBoundingBox"?(o/=t.width,l/=t.height):(o+=t.width/2,l+=t.height/2),(c=t)&&typeof c._renderPathCommands=="function"&&this.gradientUnits!=="percentage"&&(o-=t.pathOffset.x,l-=t.pathOffset.y),s[4]-=o,s[5]-=l;const u=['id="SVGID_'.concat(this.id,'"'),'gradientUnits="'.concat(i,'"'),'gradientTransform="'.concat(e?e+" ":"").concat(Ci(s),'"'),""].join(" ");if(this.type==="linear"){const{x1:d,y1:g,x2:f,y2:m}=this.coords;r.push("<linearGradient ",u,' x1="',d,'" y1="',g,'" x2="',f,'" y2="',m,`">
`)}else if(this.type==="radial"){const{x1:d,y1:g,x2:f,y2:m,r1:p,r2:v}=this.coords,y=p>v;r.push("<radialGradient ",u,' cx="',y?d:f,'" cy="',y?g:m,'" r="',y?p:v,'" fx="',y?f:d,'" fy="',y?m:g,`">
`),y&&(n.reverse(),n.forEach((O=>{O.offset=1-O.offset})));const S=Math.min(p,v);if(S>0){const O=S/Math.max(p,v);n.forEach((A=>{A.offset+=O*(1-A.offset)}))}}return n.forEach((d=>{let{color:g,offset:f,opacity:m}=d;r.push("<stop ",'offset="',100*f+"%",'" style="stop-color:',g,m!==void 0?";stop-opacity: "+m:";",`"/>
`)})),r.push(this.type==="linear"?"</linearGradient>":"</radialGradient>",`
`),r.join("")}toLive(t){const{x1:e,y1:r,x2:s,y2:i,r1:n,r2:o}=this.coords,l=this.type==="linear"?t.createLinearGradient(e,r,s,i):t.createRadialGradient(e,r,n,s,i,o);return this.colorStops.forEach((c=>{let{color:u,opacity:d,offset:g}=c;l.addColorStop(g,d!==void 0?new $t(u).setAlpha(d).toRgba():u)})),l}static async fromObject(t){const{colorStops:e,gradientTransform:r}=t;return new this(T(T({},t),{},{colorStops:e?e.map((s=>T({},s))):void 0,gradientTransform:r?[...r]:void 0}))}static fromElement(t,e,r){const s=Pc(t),i=e._findCenterFromElement();return new this(T({id:t.getAttribute("id")||void 0,type:Ec(t),coords:lm(t,{width:r.viewBoxWidth||r.width,height:r.viewBoxHeight||r.height}),colorStops:am(t,r.opacity),gradientUnits:s,gradientTransform:Oo(t.getAttribute("gradientTransform")||"")},s==="pixels"?{offsetX:e.width/2-i.x,offsetY:e.height/2-i.y}:{offsetX:0,offsetY:0}))}}C(Bi,"type","Gradient"),mt.setClass(Bi,"gradient"),mt.setClass(Bi,"linear"),mt.setClass(Bi,"radial");const cm=["type","source","patternTransform"];class ho{get type(){return"pattern"}set type(t){us("warn","Setting type has no effect",t)}constructor(t){C(this,"repeat","repeat"),C(this,"offsetX",0),C(this,"offsetY",0),C(this,"crossOrigin",""),this.id=ds(),Object.assign(this,t)}isImageSource(){return!!this.source&&typeof this.source.src=="string"}isCanvasSource(){return!!this.source&&!!this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(t){return this.source&&(!this.isImageSource()||this.source.complete&&this.source.naturalWidth!==0&&this.source.naturalHeight!==0)?t.createPattern(this.source,this.repeat):null}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const{repeat:e,crossOrigin:r}=this;return T(T({},ei(this,t)),{},{type:"pattern",source:this.sourceToString(),repeat:e,crossOrigin:r,offsetX:re(this.offsetX,Ht.NUM_FRACTION_DIGITS),offsetY:re(this.offsetY,Ht.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?[...this.patternTransform]:null})}toSVG(t){let{width:e,height:r}=t;const{source:s,repeat:i,id:n}=this,o=Ws(this.offsetX/e,0),l=Ws(this.offsetY/r,0),c=i==="repeat-y"||i==="no-repeat"?1+Math.abs(o||0):Ws(s.width/e,0),u=i==="repeat-x"||i==="no-repeat"?1+Math.abs(l||0):Ws(s.height/r,0);return['<pattern id="SVGID_'.concat(n,'" x="').concat(o,'" y="').concat(l,'" width="').concat(c,'" height="').concat(u,'">'),'<image x="0" y="0" width="'.concat(s.width,'" height="').concat(s.height,'" xlink:href="').concat(this.sourceToString(),'"></image>'),"</pattern>",""].join(`
`)}static async fromObject(t,e){let{type:r,source:s,patternTransform:i}=t,n=ne(t,cm);const o=await gn(s,T(T({},e),{},{crossOrigin:n.crossOrigin}));return new this(T(T({},n),{},{patternTransform:i&&i.slice(0),source:o}))}}C(ho,"type","Pattern"),mt.setClass(ho),mt.setClass(ho,"pattern");const hm=["path","left","top"],um=["d"];class ys extends Me{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{path:r,left:s,top:i}=e,n=ne(e,hm);super(),Object.assign(this,ys.ownDefaults),this.setOptions(n),this._setPath(t||[],!0),typeof s=="number"&&this.set(qt,s),typeof i=="number"&&this.set(Ye,i)}_setPath(t,e){this.path=Hf(Array.isArray(t)?t:Zf(t)),this.setBoundingBox(e)}_findCenterFromElement(){const t=this._calcBoundsFromPath();return new B(t.left+t.width/2,t.top+t.height/2)}_renderPathCommands(t){const e=-this.pathOffset.x,r=-this.pathOffset.y;t.beginPath();for(const s of this.path)switch(s[0]){case"L":t.lineTo(s[1]+e,s[2]+r);break;case"M":t.moveTo(s[1]+e,s[2]+r);break;case"C":t.bezierCurveTo(s[1]+e,s[2]+r,s[3]+e,s[4]+r,s[5]+e,s[6]+r);break;case"Q":t.quadraticCurveTo(s[1]+e,s[2]+r,s[3]+e,s[4]+r);break;case"Z":t.closePath()}}_render(t){this._renderPathCommands(t),this._renderPaintInOrder(t)}toString(){return"#<Path (".concat(this.complexity(),'): { "top": ').concat(this.top,', "left": ').concat(this.left," }>")}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return T(T({},super.toObject(t)),{},{path:this.path.map((e=>e.slice()))})}toDatalessObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=this.toObject(t);return this.sourcePath&&(delete e.path,e.sourcePath=this.sourcePath),e}_toSVG(){const t=Jf(this.path,Ht.NUM_FRACTION_DIGITS);return["<path ","COMMON_PARTS",'d="'.concat(t,`" stroke-linecap="round" />
`)]}_getOffsetTransform(){const t=Ht.NUM_FRACTION_DIGITS;return" translate(".concat(re(-this.pathOffset.x,t),", ").concat(re(-this.pathOffset.y,t),")")}toClipPathSVG(t){const e=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}toSVG(t){const e=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}complexity(){return this.path.length}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{width:e,height:r,pathOffset:s}=this._calcDimensions();this.set({width:e,height:r,pathOffset:s}),t&&this.setPositionByOrigin(s,Lt,Lt)}_calcBoundsFromPath(){const t=[];let e=0,r=0,s=0,i=0;for(const n of this.path)switch(n[0]){case"L":s=n[1],i=n[2],t.push({x:e,y:r},{x:s,y:i});break;case"M":s=n[1],i=n[2],e=s,r=i;break;case"C":t.push(...rl(s,i,n[1],n[2],n[3],n[4],n[5],n[6])),s=n[5],i=n[6];break;case"Q":t.push(...rl(s,i,n[1],n[2],n[1],n[2],n[3],n[4])),s=n[3],i=n[4];break;case"Z":s=e,i=r}return qr(t)}_calcDimensions(){const t=this._calcBoundsFromPath();return T(T({},t),{},{pathOffset:new B(t.left+t.width/2,t.top+t.height/2)})}static fromObject(t){return this._fromObject(t,{extraParam:"path"})}static async fromElement(t,e,r){const s=es(t,this.ATTRIBUTE_NAMES,r),{d:i}=s;return new this(i,T(T(T({},ne(s,um)),e),{},{left:void 0,top:void 0}))}}C(ys,"type","Path"),C(ys,"cacheProperties",[...ts,"path","fillRule"]),C(ys,"ATTRIBUTE_NAMES",[...gs,"d"]),mt.setClass(ys),mt.setSVGClass(ys);const dm=["left","top","radius"],Mc=["radius","startAngle","endAngle","counterClockwise"];class Hr extends Me{static getDefaults(){return T(T({},super.getDefaults()),Hr.ownDefaults)}constructor(t){super(),Object.assign(this,Hr.ownDefaults),this.setOptions(t)}_set(t,e){return super._set(t,e),t==="radius"&&this.setRadius(e),this}_render(t){t.beginPath(),t.arc(0,0,this.radius,pe(this.startAngle),pe(this.endAngle),this.counterClockwise),this._renderPaintInOrder(t)}getRadiusX(){return this.get("radius")*this.get(Ge)}getRadiusY(){return this.get("radius")*this.get(hr)}setRadius(t){this.radius=t,this.set({width:2*t,height:2*t})}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Mc,...t])}_toSVG(){const t=(this.endAngle-this.startAngle)%360;if(t===0)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',"".concat(this.radius),`" />
`];{const{radius:e}=this,r=pe(this.startAngle),s=pe(this.endAngle),i=$r(r)*e,n=Zr(r)*e,o=$r(s)*e,l=Zr(s)*e,c=t>180?1:0,u=this.counterClockwise?0:1;return['<path d="M '.concat(i," ").concat(n," A ").concat(e," ").concat(e," 0 ").concat(c," ").concat(u," ").concat(o," ").concat(l,'" '),"COMMON_PARTS",` />
`]}}static async fromElement(t,e,r){const s=es(t,this.ATTRIBUTE_NAMES,r),{left:i=0,top:n=0,radius:o=0}=s;return new this(T(T({},ne(s,dm)),{},{radius:o,left:i-o,top:n-o}))}static fromObject(t){return super._fromObject(t)}}C(Hr,"type","Circle"),C(Hr,"cacheProperties",[...ts,...Mc]),C(Hr,"ownDefaults",{radius:0,startAngle:0,endAngle:360,counterClockwise:!1}),C(Hr,"ATTRIBUTE_NAMES",["cx","cy","r",...gs]),mt.setClass(Hr),mt.setSVGClass(Hr);const gm=["x1","y1","x2","y2"],fm=["x1","y1","x2","y2"],Mo=["x1","x2","y1","y2"];class xs extends Me{constructor(){let[t,e,r,s]=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[0,0,0,0],i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,xs.ownDefaults),this.setOptions(i),this.x1=t,this.x2=r,this.y1=e,this.y2=s,this._setWidthHeight();const{left:n,top:o}=i;typeof n=="number"&&this.set(qt,n),typeof o=="number"&&this.set(Ye,o)}_setWidthHeight(){const{x1:t,y1:e,x2:r,y2:s}=this;this.width=Math.abs(r-t),this.height=Math.abs(s-e);const{left:i,top:n,width:o,height:l}=qr([{x:t,y:e},{x:r,y:s}]),c=new B(i+o/2,n+l/2);this.setPositionByOrigin(c,Lt,Lt)}_set(t,e){return super._set(t,e),Mo.includes(t)&&this._setWidthHeight(),this}_render(t){t.beginPath();const e=this.calcLinePoints();t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.lineWidth=this.strokeWidth;const r=t.strokeStyle;var s;nr(this.stroke)?t.strokeStyle=this.stroke.toLive(t):t.strokeStyle=(s=this.stroke)!==null&&s!==void 0?s:t.fillStyle,this.stroke&&this._renderStroke(t),t.strokeStyle=r}_findCenterFromElement(){return new B((this.x1+this.x2)/2,(this.y1+this.y2)/2)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return T(T({},super.toObject(t)),this.calcLinePoints())}_getNonTransformedDimensions(){const t=super._getNonTransformedDimensions();return this.strokeLineCap==="butt"&&(this.width===0&&(t.y-=this.strokeWidth),this.height===0&&(t.x-=this.strokeWidth)),t}calcLinePoints(){const{x1:t,x2:e,y1:r,y2:s,width:i,height:n}=this,o=t<=e?-1:1,l=r<=s?-1:1;return{x1:o*i/2,x2:o*-i/2,y1:l*n/2,y2:l*-n/2}}_toSVG(){const{x1:t,x2:e,y1:r,y2:s}=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="'.concat(t,'" y1="').concat(r,'" x2="').concat(e,'" y2="').concat(s,`" />
`)]}static async fromElement(t,e,r){const s=es(t,this.ATTRIBUTE_NAMES,r),{x1:i=0,y1:n=0,x2:o=0,y2:l=0}=s;return new this([i,n,o,l],ne(s,gm))}static fromObject(t){let{x1:e,y1:r,x2:s,y2:i}=t,n=ne(t,fm);return this._fromObject(T(T({},n),{},{points:[e,r,s,i]}),{extraParam:"points"})}}C(xs,"type","Line"),C(xs,"cacheProperties",[...ts,...Mo]),C(xs,"ATTRIBUTE_NAMES",gs.concat(Mo)),mt.setClass(xs),mt.setSVGClass(xs);class bs extends Me{static getDefaults(){return T(T({},super.getDefaults()),bs.ownDefaults)}constructor(t){super(),Object.assign(this,bs.ownDefaults),this.setOptions(t)}_render(t){const e=this.width/2,r=this.height/2;t.beginPath(),t.moveTo(-e,r),t.lineTo(0,-r),t.lineTo(e,r),t.closePath(),this._renderPaintInOrder(t)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',"".concat(-t," ").concat(e,",0 ").concat(-e,",").concat(t," ").concat(e),'" />']}}C(bs,"type","Triangle"),C(bs,"ownDefaults",{width:100,height:100}),mt.setClass(bs),mt.setSVGClass(bs);const Ic=["rx","ry"];class Yr extends Me{static getDefaults(){return T(T({},super.getDefaults()),Yr.ownDefaults)}constructor(t){super(),Object.assign(this,Yr.ownDefaults),this.setOptions(t)}_set(t,e){switch(super._set(t,e),t){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this}getRx(){return this.get("rx")*this.get(Ge)}getRy(){return this.get("ry")*this.get(hr)}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject([...Ic,...t])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" rx="'.concat(this.rx,'" ry="').concat(this.ry,`" />
`)]}_render(t){t.beginPath(),t.save(),t.transform(1,0,0,this.ry/this.rx,0,0),t.arc(0,0,this.rx,0,bn,!1),t.restore(),this._renderPaintInOrder(t)}static async fromElement(t,e,r){const s=es(t,this.ATTRIBUTE_NAMES,r);return s.left=(s.left||0)-s.rx,s.top=(s.top||0)-s.ry,new this(s)}}function mm(a){if(!a)return[];const t=a.replace(/,/g," ").trim().split(/\s+/),e=[];for(let r=0;r<t.length;r+=2)e.push({x:parseFloat(t[r]),y:parseFloat(t[r+1])});return e}C(Yr,"type","Ellipse"),C(Yr,"cacheProperties",[...ts,...Ic]),C(Yr,"ownDefaults",{rx:0,ry:0}),C(Yr,"ATTRIBUTE_NAMES",[...gs,"cx","cy","rx","ry"]),mt.setClass(Yr),mt.setSVGClass(Yr);const pm=["left","top"],Lc={exactBoundingBox:!1};class _r extends Me{static getDefaults(){return T(T({},super.getDefaults()),_r.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),C(this,"strokeDiff",void 0),Object.assign(this,_r.ownDefaults),this.setOptions(e),this.points=t;const{left:r,top:s}=e;this.initialized=!0,this.setBoundingBox(!0),typeof r=="number"&&this.set(qt,r),typeof s=="number"&&this.set(Ye,s)}isOpen(){return!0}_projectStrokeOnPoints(t){return nf(this.points,t,this.isOpen())}_calcDimensions(t){t=T({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,strokeLineCap:this.strokeLineCap,strokeLineJoin:this.strokeLineJoin,strokeMiterLimit:this.strokeMiterLimit,strokeUniform:this.strokeUniform,strokeWidth:this.strokeWidth},t||{});const e=this.exactBoundingBox?this._projectStrokeOnPoints(t).map((c=>c.projectedPoint)):this.points;if(e.length===0)return{left:0,top:0,width:0,height:0,pathOffset:new B,strokeOffset:new B,strokeDiff:new B};const r=qr(e),s=Vn(T(T({},t),{},{scaleX:1,scaleY:1})),i=qr(this.points.map((c=>We(c,s,!0)))),n=new B(this.scaleX,this.scaleY);let o=r.left+r.width/2,l=r.top+r.height/2;return this.exactBoundingBox&&(o-=l*Math.tan(pe(this.skewX)),l-=o*Math.tan(pe(this.skewY))),T(T({},r),{},{pathOffset:new B(o,l),strokeOffset:new B(i.left,i.top).subtract(new B(r.left,r.top)).multiply(n),strokeDiff:new B(r.width,r.height).subtract(new B(i.width,i.height)).multiply(n)})}_findCenterFromElement(){const t=qr(this.points);return new B(t.left+t.width/2,t.top+t.height/2)}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{left:e,top:r,width:s,height:i,pathOffset:n,strokeOffset:o,strokeDiff:l}=this._calcDimensions();this.set({width:s,height:i,pathOffset:n,strokeOffset:o,strokeDiff:l}),t&&this.setPositionByOrigin(new B(e+s/2,r+i/2),Lt,Lt)}isStrokeAccountedForInDimensions(){return this.exactBoundingBox}_getNonTransformedDimensions(){return this.exactBoundingBox?new B(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.exactBoundingBox){let n;if(Object.keys(t).some((o=>this.strokeUniform||this.constructor.layoutProperties.includes(o)))){var e,r;const{width:o,height:l}=this._calcDimensions(t);n=new B((e=t.width)!==null&&e!==void 0?e:o,(r=t.height)!==null&&r!==void 0?r:l)}else{var s,i;n=new B((s=t.width)!==null&&s!==void 0?s:this.width,(i=t.height)!==null&&i!==void 0?i:this.height)}return n.multiply(new B(t.scaleX||this.scaleX,t.scaleY||this.scaleY))}return super._getTransformedDimensions(t)}_set(t,e){const r=this.initialized&&this[t]!==e,s=super._set(t,e);return this.exactBoundingBox&&r&&((t===Ge||t===hr)&&this.strokeUniform&&this.constructor.layoutProperties.includes("strokeUniform")||this.constructor.layoutProperties.includes(t))&&this.setDimensions(),s}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return T(T({},super.toObject(t)),{},{points:this.points.map((e=>{let{x:r,y:s}=e;return{x:r,y:s}}))})}_toSVG(){const t=[],e=this.pathOffset.x,r=this.pathOffset.y,s=Ht.NUM_FRACTION_DIGITS;for(let i=0,n=this.points.length;i<n;i++)t.push(re(this.points[i].x-e,s),",",re(this.points[i].y-r,s)," ");return["<".concat(this.constructor.type.toLowerCase()," "),"COMMON_PARTS",'points="'.concat(t.join(""),`" />
`)]}_render(t){const e=this.points.length,r=this.pathOffset.x,s=this.pathOffset.y;if(e&&!isNaN(this.points[e-1].y)){t.beginPath(),t.moveTo(this.points[0].x-r,this.points[0].y-s);for(let i=0;i<e;i++){const n=this.points[i];t.lineTo(n.x-r,n.y-s)}!this.isOpen()&&t.closePath(),this._renderPaintInOrder(t)}}complexity(){return this.points.length}static async fromElement(t,e,r){return new this(mm(t.getAttribute("points")),T(T({},ne(es(t,this.ATTRIBUTE_NAMES,r),pm)),e))}static fromObject(t){return this._fromObject(t,{extraParam:"points"})}}C(_r,"ownDefaults",Lc),C(_r,"type","Polyline"),C(_r,"layoutProperties",[Js,Qs,"strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]),C(_r,"cacheProperties",[...ts,"points"]),C(_r,"ATTRIBUTE_NAMES",[...gs]),mt.setClass(_r),mt.setSVGClass(_r);class zi extends _r{isOpen(){return!1}}C(zi,"ownDefaults",Lc),C(zi,"type","Polygon"),mt.setClass(zi),mt.setSVGClass(zi);class Fc extends Me{isEmptyStyles(t){if(!this.styles||t!==void 0&&!this.styles[t])return!0;const e=t===void 0?this.styles:{line:this.styles[t]};for(const r in e)for(const s in e[r])for(const i in e[r][s])return!1;return!0}styleHas(t,e){if(!this.styles||e!==void 0&&!this.styles[e])return!1;const r=e===void 0?this.styles:{0:this.styles[e]};for(const s in r)for(const i in r[s])if(r[s][i][t]!==void 0)return!0;return!1}cleanStyle(t){if(!this.styles)return!1;const e=this.styles;let r,s,i=0,n=!0,o=0;for(const l in e){r=0;for(const c in e[l]){const u=e[l][c]||{};i++,u[t]!==void 0?(s?u[t]!==s&&(n=!1):s=u[t],u[t]===this[t]&&delete u[t]):n=!1,Object.keys(u).length!==0?r++:delete e[l][c]}r===0&&delete e[l]}for(let l=0;l<this._textLines.length;l++)o+=this._textLines[l].length;n&&i===o&&(this[t]=s,this.removeStyle(t))}removeStyle(t){if(!this.styles)return;const e=this.styles;let r,s,i;for(s in e){for(i in r=e[s],r)delete r[i][t],Object.keys(r[i]).length===0&&delete r[i];Object.keys(r).length===0&&delete e[s]}}_extendStyles(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t);this._getLineStyle(r)||this._setLineStyle(r);const i=Go(T(T({},this._getStyleDeclaration(r,s)),e),(n=>n!==void 0));this._setStyleDeclaration(r,s,i)}getSelectionStyles(t,e,r){const s=[];for(let i=t;i<(e||t);i++)s.push(this.getStyleAtPosition(i,r));return s}getStyleAtPosition(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t);return e?this.getCompleteStyleDeclaration(r,s):this._getStyleDeclaration(r,s)}setSelectionStyles(t,e,r){for(let s=e;s<(r||e);s++)this._extendStyles(s,t);this._forceClearCache=!0}_getStyleDeclaration(t,e){var r;const s=this.styles&&this.styles[t];return s&&(r=s[e])!==null&&r!==void 0?r:{}}getCompleteStyleDeclaration(t,e){return T(T({},ei(this,this.constructor._styleProperties)),this._getStyleDeclaration(t,e))}_setStyleDeclaration(t,e,r){this.styles[t][e]=r}_deleteStyleDeclaration(t,e){delete this.styles[t][e]}_getLineStyle(t){return!!this.styles[t]}_setLineStyle(t){this.styles[t]={}}_deleteLineStyle(t){delete this.styles[t]}}C(Fc,"_styleProperties",xg);const vm=/  +/g,_m=/"/g;function uo(a,t,e,r,s){return"		".concat((function(i,n){let{left:o,top:l,width:c,height:u}=n,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ht.NUM_FRACTION_DIGITS;const g=Ti(we,i,!1),[f,m,p,v]=[o,l,c,u].map((y=>re(y,d)));return"<rect ".concat(g,' x="').concat(f,'" y="').concat(m,'" width="').concat(p,'" height="').concat(v,'"></rect>')})(a,{left:t,top:e,width:r,height:s}),`
`)}const ym=["textAnchor","textDecoration","dx","dy","top","left","fontSize","strokeWidth"];let go;class Fe extends Fc{static getDefaults(){return T(T({},super.getDefaults()),Fe.ownDefaults)}constructor(t,e){super(),C(this,"__charBounds",[]),Object.assign(this,Fe.ownDefaults),this.setOptions(e),this.styles||(this.styles={}),this.text=t,this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords()}setPathInfo(){const t=this.path;t&&(t.segmentsInfo=kc(t.path))}_splitText(){const t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t}initDimensions(){this._splitText(),this._clearCache(),this.dirty=!0,this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.includes(Pr)&&this.enlargeSpaces()}enlargeSpaces(){let t,e,r,s,i,n,o;for(let l=0,c=this._textLines.length;l<c;l++)if((this.textAlign===Pr||l!==c-1&&!this.isEndOfWrapping(l))&&(s=0,i=this._textLines[l],e=this.getLineWidth(l),e<this.width&&(o=this.textLines[l].match(this._reSpacesAndTabs)))){r=o.length,t=(this.width-e)/r;for(let u=0;u<=i.length;u++)n=this.__charBounds[l][u],this._reSpaceAndTab.test(i[u])?(n.width+=t,n.kernedWidth+=t,n.left+=s,s+=t):n.left+=s}}isEndOfWrapping(t){return t===this._textLines.length-1}missingNewlineOffset(t){return 1}get2DCursorLocation(t,e){const r=e?this._unwrappedTextLines:this._textLines;let s;for(s=0;s<r.length;s++){if(t<=r[s].length)return{lineIndex:s,charIndex:t};t-=r[s].length+this.missingNewlineOffset(s,e)}return{lineIndex:s-1,charIndex:r[s-1].length<t?r[s-1].length:t}}toString(){return"#<Text (".concat(this.complexity(),'): { "text": "').concat(this.text,'", "fontFamily": "').concat(this.fontFamily,'" }>')}_getCacheCanvasDimensions(){const t=super._getCacheCanvasDimensions(),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t}_render(t){const e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")}_renderText(t){this.paintFirst===Ne?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))}_setTextStyles(t,e,r){if(t.textBaseline="alphabetic",this.path)switch(this.pathAlign){case Lt:t.textBaseline="middle";break;case"ascender":t.textBaseline=Ye;break;case"descender":t.textBaseline=wo}t.font=this._getFontDeclaration(e,r)}calcTextWidth(){let t=this.getLineWidth(0);for(let e=1,r=this._textLines.length;e<r;e++){const s=this.getLineWidth(e);s>t&&(t=s)}return t}_renderTextLine(t,e,r,s,i,n){this._renderChars(t,e,r,s,i,n)}_renderTextLinesBackground(t){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const e=t.fillStyle,r=this._getLeftOffset();let s=this._getTopOffset();for(let i=0,n=this._textLines.length;i<n;i++){const o=this.getHeightOfLine(i);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",i)){s+=o;continue}const l=this._textLines[i].length,c=this._getLineLeftOffset(i);let u,d,g=0,f=0,m=this.getValueOfPropertyAt(i,0,"textBackgroundColor");const p=this.getHeightOfLineImpl(i);for(let v=0;v<l;v++){const y=this.__charBounds[i][v];d=this.getValueOfPropertyAt(i,v,"textBackgroundColor"),this.path?(t.save(),t.translate(y.renderLeft,y.renderTop),t.rotate(y.angle),t.fillStyle=d,d&&t.fillRect(-y.width/2,-p*(1-this._fontSizeFraction),y.width,p),t.restore()):d!==m?(u=r+c+f,this.direction==="rtl"&&(u=this.width-u-g),t.fillStyle=m,m&&t.fillRect(u,s,g,p),f=y.left,g=y.width,m=d):g+=y.kernedWidth}d&&!this.path&&(u=r+c+f,this.direction==="rtl"&&(u=this.width-u-g),t.fillStyle=d,t.fillRect(u,s,g,p)),s+=o}t.fillStyle=e,this._removeShadow(t)}_measureChar(t,e,r,s){const i=mi.getFontCache(e),n=this._getFontDeclaration(e),o=r?r+t:t,l=r&&n===this._getFontDeclaration(s),c=e.fontSize/this.CACHE_FONT_SIZE;let u,d,g,f;if(r&&i.has(r)&&(g=i.get(r)),i.has(t)&&(f=u=i.get(t)),l&&i.has(o)&&(d=i.get(o),f=d-g),u===void 0||g===void 0||d===void 0){const m=(function(){return go||(go=ur({width:0,height:0}).getContext("2d")),go})();this._setTextStyles(m,e,!0),u===void 0&&(f=u=m.measureText(t).width,i.set(t,u)),g===void 0&&l&&r&&(g=m.measureText(r).width,i.set(r,g)),l&&d===void 0&&(d=m.measureText(o).width,i.set(o,d),f=d-g)}return{width:u*c,kernedWidth:f*c}}getHeightOfChar(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")}measureLine(t){const e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e}_measureLine(t){let e,r,s=0;const i=this.pathSide===me,n=this.path,o=this._textLines[t],l=o.length,c=new Array(l);this.__charBounds[t]=c;for(let u=0;u<l;u++){const d=o[u];r=this._getGraphemeBox(d,t,u,e),c[u]=r,s+=r.kernedWidth,e=d}if(c[l]={left:r?r.left+r.width:0,width:0,kernedWidth:0,height:this.fontSize,deltaY:0},n&&n.segmentsInfo){let u=0;const d=n.segmentsInfo[n.segmentsInfo.length-1].length;switch(this.textAlign){case qt:u=i?d-s:0;break;case Lt:u=(d-s)/2;break;case me:u=i?0:d-s}u+=this.pathStartOffset*(i?-1:1);for(let g=i?l-1:0;i?g>=0:g<l;i?g--:g++)r=c[g],u>d?u%=d:u<0&&(u+=d),this._setGraphemeOnPath(u,r),u+=r.kernedWidth}return{width:s,numOfSpaces:0}}_setGraphemeOnPath(t,e){const r=t+e.kernedWidth/2,s=this.path,i=Gf(s.path,r,s.segmentsInfo);e.renderLeft=i.x-s.pathOffset.x,e.renderTop=i.y-s.pathOffset.y,e.angle=i.angle+(this.pathSide===me?Math.PI:0)}_getGraphemeBox(t,e,r,s,i){const n=this.getCompleteStyleDeclaration(e,r),o=s?this.getCompleteStyleDeclaration(e,r-1):{},l=this._measureChar(t,n,s,o);let c,u=l.kernedWidth,d=l.width;this.charSpacing!==0&&(c=this._getWidthOfCharSpacing(),d+=c,u+=c);const g={width:d,left:0,height:n.fontSize,kernedWidth:u,deltaY:n.deltaY};if(r>0&&!i){const f=this.__charBounds[e][r-1];g.left=f.left+f.width+l.kernedWidth-l.width}return g}getHeightOfLineImpl(t){const e=this.__lineHeights;if(e[t])return e[t];let r=this.getHeightOfChar(t,0);for(let s=1,i=this._textLines[t].length;s<i;s++)r=Math.max(this.getHeightOfChar(t,s),r);return e[t]=r*this._fontSizeMult}getHeightOfLine(t){return this.getHeightOfLineImpl(t)*this.lineHeight}calcTextHeight(){let t=0;for(let e=0,r=this._textLines.length;e<r;e++)t+=e===r-1?this.getHeightOfLineImpl(e):this.getHeightOfLine(e);return t}_getLeftOffset(){return this.direction==="ltr"?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(t,e){t.save();let r=0;const s=this._getLeftOffset(),i=this._getTopOffset();for(let n=0,o=this._textLines.length;n<o;n++)this._renderTextLine(e,t,this._textLines[n],s+this._getLineLeftOffset(n),i+r+this.getHeightOfLineImpl(n),n),r+=this.getHeightOfLine(n);t.restore()}_renderTextFill(t){(this.fill||this.styleHas(we))&&this._renderTextCommon(t,"fillText")}_renderTextStroke(t){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())}_renderChars(t,e,r,s,i,n){const o=this.textAlign.includes(Pr),l=this.path,c=!o&&this.charSpacing===0&&this.isEmptyStyles(n)&&!l,u=this.direction==="ltr",d=this.direction==="ltr"?1:-1,g=e.direction;let f,m,p,v,y,S="",O=0;if(e.save(),g!==this.direction&&(e.canvas.setAttribute("dir",u?"ltr":"rtl"),e.direction=u?"ltr":"rtl",e.textAlign=u?qt:me),i-=this.getHeightOfLineImpl(n)*this._fontSizeFraction,c)return this._renderChar(t,e,n,0,r.join(""),s,i),void e.restore();for(let A=0,M=r.length-1;A<=M;A++)v=A===M||this.charSpacing||l,S+=r[A],p=this.__charBounds[n][A],O===0?(s+=d*(p.kernedWidth-p.width),O+=p.width):O+=p.kernedWidth,o&&!v&&this._reSpaceAndTab.test(r[A])&&(v=!0),v||(f=f||this.getCompleteStyleDeclaration(n,A),m=this.getCompleteStyleDeclaration(n,A+1),v=ea(f,m,!1)),v&&(l?(e.save(),e.translate(p.renderLeft,p.renderTop),e.rotate(p.angle),this._renderChar(t,e,n,A,S,-O/2,0),e.restore()):(y=s,this._renderChar(t,e,n,A,S,y,i)),S="",f=m,s+=d*O,O=0);e.restore()}_applyPatternGradientTransformText(t){const e=this.width+this.strokeWidth,r=this.height+this.strokeWidth,s=ur({width:e,height:r}),i=s.getContext("2d");return s.width=e,s.height=r,i.beginPath(),i.moveTo(0,0),i.lineTo(e,0),i.lineTo(e,r),i.lineTo(0,r),i.closePath(),i.translate(e/2,r/2),i.fillStyle=t.toLive(i),this._applyPatternGradientTransform(i,t),i.fill(),i.createPattern(s,"no-repeat")}handleFiller(t,e,r){let s,i;return nr(r)?r.gradientUnits==="percentage"||r.gradientTransform||r.patternTransform?(s=-this.width/2,i=-this.height/2,t.translate(s,i),t[e]=this._applyPatternGradientTransformText(r),{offsetX:s,offsetY:i}):(t[e]=r.toLive(t),this._applyPatternGradientTransform(t,r)):(t[e]=r,{offsetX:0,offsetY:0})}_setStrokeStyles(t,e){let{stroke:r,strokeWidth:s}=e;return t.lineWidth=s,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",r)}_setFillStyles(t,e){let{fill:r}=e;return this.handleFiller(t,"fillStyle",r)}_renderChar(t,e,r,s,i,n,o){const l=this._getStyleDeclaration(r,s),c=this.getCompleteStyleDeclaration(r,s),u=t==="fillText"&&c.fill,d=t==="strokeText"&&c.stroke&&c.strokeWidth;if(d||u){if(e.save(),e.font=this._getFontDeclaration(c),l.textBackgroundColor&&this._removeShadow(e),l.deltaY&&(o+=l.deltaY),u){const g=this._setFillStyles(e,c);e.fillText(i,n-g.offsetX,o-g.offsetY)}if(d){const g=this._setStrokeStyles(e,c);e.strokeText(i,n-g.offsetX,o-g.offsetY)}e.restore()}}setSuperscript(t,e){this._setScript(t,e,this.superscript)}setSubscript(t,e){this._setScript(t,e,this.subscript)}_setScript(t,e,r){const s=this.get2DCursorLocation(t,!0),i=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),n=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),o={fontSize:i*r.size,deltaY:n+i*r.baseline};this.setSelectionStyles(o,t,e)}_getLineLeftOffset(t){const e=this.getLineWidth(t),r=this.width-e,s=this.textAlign,i=this.direction,n=this.isEndOfWrapping(t);let o=0;return s===Pr||s===vi&&!n||s===pi&&!n||s===En&&!n?0:(s===Lt&&(o=r/2),s===me&&(o=r),s===vi&&(o=r/2),s===pi&&(o=r),i==="rtl"&&(s===me||s===Pr||s===pi?o=0:s===qt||s===En?o=-r:s!==Lt&&s!==vi||(o=-r/2)),o)}_clearCache(){this._forceClearCache=!1,this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}getLineWidth(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];const{width:e}=this.measureLine(t);return this.__lineWidths[t]=e,e}_getWidthOfCharSpacing(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(t,e,r){var s;return(s=this._getStyleDeclaration(t,e)[r])!==null&&s!==void 0?s:this[r]}_renderTextDecoration(t,e){if(!this[e]&&!this.styleHas(e))return;let r=this._getTopOffset();const s=this._getLeftOffset(),i=this.path,n=this._getWidthOfCharSpacing(),o=e==="linethrough"?.5:e==="overline"?1:0,l=this.offsets[e];for(let c=0,u=this._textLines.length;c<u;c++){const d=this.getHeightOfLine(c);if(!this[e]&&!this.styleHas(e,c)){r+=d;continue}const g=this._textLines[c],f=d/this.lineHeight,m=this._getLineLeftOffset(c);let p=0,v=0,y=this.getValueOfPropertyAt(c,0,e),S=this.getValueOfPropertyAt(c,0,we),O=this.getValueOfPropertyAt(c,0,Ds),A=y,M=S,F=O;const E=r+f*(1-this._fontSizeFraction);let _=this.getHeightOfChar(c,0),j=this.getValueOfPropertyAt(c,0,"deltaY");for(let R=0,V=g.length;R<V;R++){const W=this.__charBounds[c][R];A=this.getValueOfPropertyAt(c,R,e),M=this.getValueOfPropertyAt(c,R,we),F=this.getValueOfPropertyAt(c,R,Ds);const tt=this.getHeightOfChar(c,R),et=this.getValueOfPropertyAt(c,R,"deltaY");if(i&&A&&M){const z=this.fontSize*F/1e3;t.save(),t.fillStyle=S,t.translate(W.renderLeft,W.renderTop),t.rotate(W.angle),t.fillRect(-W.kernedWidth/2,l*tt+et-o*z,W.kernedWidth,z),t.restore()}else if((A!==y||M!==S||tt!==_||F!==O||et!==j)&&v>0){const z=this.fontSize*O/1e3;let Z=s+m+p;this.direction==="rtl"&&(Z=this.width-Z-v),y&&S&&O&&(t.fillStyle=S,t.fillRect(Z,E+l*_+j-o*z,v,z)),p=W.left,v=W.width,y=A,O=F,S=M,_=tt,j=et}else v+=W.kernedWidth}let Y=s+m+p;this.direction==="rtl"&&(Y=this.width-Y-v),t.fillStyle=M;const G=this.fontSize*F/1e3;A&&M&&F&&t.fillRect(Y,E+l*_+j-o*G,v-n,G),r+=d}this._removeShadow(t)}_getFontDeclaration(){let{fontFamily:t=this.fontFamily,fontStyle:e=this.fontStyle,fontWeight:r=this.fontWeight,fontSize:s=this.fontSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;const n=t.includes("'")||t.includes('"')||t.includes(",")||Fe.genericFonts.includes(t.toLowerCase())?t:'"'.concat(t,'"');return[e,r,"".concat(i?this.CACHE_FONT_SIZE:s,"px"),n].join(" ")}render(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._forceClearCache&&this.initDimensions(),super.render(t)))}graphemeSplit(t){return ta(t)}_splitTextIntoLines(t){const e=t.split(this._reNewline),r=new Array(e.length),s=[`
`];let i=[];for(let n=0;n<e.length;n++)r[n]=this.graphemeSplit(e[n]),i=i.concat(r[n],s);return i.pop(),{_unwrappedLines:r,lines:e,graphemeText:i,graphemeLines:r}}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return T(T({},super.toObject([...lc,...t])),{},{styles:cf(this.styles,this.text)},this.path?{path:this.path.toObject()}:{})}set(t,e){const{textLayoutProperties:r}=this.constructor;super.set(t,e);let s=!1,i=!1;if(typeof t=="object")for(const n in t)n==="path"&&this.setPathInfo(),s=s||r.includes(n),i=i||n==="path";else s=r.includes(t),i=t==="path";return i&&this.setPathInfo(),s&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static async fromElement(t,e,r){const s=es(t,Fe.ATTRIBUTE_NAMES,r),i=T(T({},e),s),{textAnchor:n=qt,textDecoration:o="",dx:l=0,dy:c=0,top:u=0,left:d=0,fontSize:g=Wo,strokeWidth:f=1}=i,m=ne(i,ym),p=new this(Dn(t.textContent||"").trim(),T({left:d+l,top:u+c,underline:o.includes("underline"),overline:o.includes("overline"),linethrough:o.includes("line-through"),strokeWidth:0,fontSize:g},m)),v=p.getScaledHeight()/p.height,y=((p.height+p.strokeWidth)*p.lineHeight-p.height)*v,S=p.getScaledHeight()+y;let O=0;return n===Lt&&(O=p.getScaledWidth()/2),n===me&&(O=p.getScaledWidth()),p.set({left:p.left-O,top:p.top-(S-p.fontSize*(.07+p._fontSizeFraction))/p.lineHeight,strokeWidth:f}),p}static fromObject(t){return this._fromObject(T(T({},t),{},{styles:hf(t.styles||{},t.text)}),{extraParam:"text"})}}C(Fe,"textLayoutProperties",ac),C(Fe,"cacheProperties",[...ts,...lc]),C(Fe,"ownDefaults",wg),C(Fe,"type","Text"),C(Fe,"genericFonts",["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),C(Fe,"ATTRIBUTE_NAMES",gs.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor")),vc(Fe,[class extends ic{_toSVG(){const a=this._getSVGLeftTopOffsets(),t=this._getSVGTextAndBg(a.textTop,a.textLeft);return this._wrapSVGTextAndBg(t)}toSVG(a){const t=this._createBaseSVGMarkup(this._toSVG(),{reviver:a,noStyle:!0,withShadow:!0}),e=this.path;return e?t+e._createBaseSVGMarkup(e._toSVG(),{reviver:a,withShadow:!0,additionalTransform:Ci(this.calcOwnMatrix())}):t}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg(a){let{textBgRects:t,textSpans:e}=a;const r=this.getSvgTextDecoration(this);return[t.join(""),'		<text xml:space="preserve" ','font-family="'.concat(this.fontFamily.replace(_m,"'"),'" '),'font-size="'.concat(this.fontSize,'" '),this.fontStyle?'font-style="'.concat(this.fontStyle,'" '):"",this.fontWeight?'font-weight="'.concat(this.fontWeight,'" '):"",r?'text-decoration="'.concat(r,'" '):"",this.direction==="rtl"?'direction="'.concat(this.direction,'" '):"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.join(""),`</text>
`]}_getSVGTextAndBg(a,t){const e=[],r=[];let s,i=a;this.backgroundColor&&r.push(...uo(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let n=0,o=this._textLines.length;n<o;n++)s=this._getLineLeftOffset(n),this.direction==="rtl"&&(s+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",n))&&this._setSVGTextLineBg(r,n,t+s,i),this._setSVGTextLineText(e,n,t+s,i),i+=this.getHeightOfLine(n);return{textSpans:e,textBgRects:r}}_createTextCharSpan(a,t,e,r,s){const i=Ht.NUM_FRACTION_DIGITS,n=this.getSvgSpanStyles(t,a!==a.trim()||!!a.match(vm)),o=n?'style="'.concat(n,'"'):"",l=t.deltaY,c=l?' dy="'.concat(re(l,i),'" '):"",{angle:u,renderLeft:d,renderTop:g,width:f}=s;let m="";if(d!==void 0){const p=f/2;u&&(m=' rotate="'.concat(re(Qr(u),i),'"'));const v=ti({angle:Qr(u)});v[4]=d,v[5]=g;const y=new B(-p,0).transform(v);e=y.x,r=y.y}return'<tspan x="'.concat(re(e,i),'" y="').concat(re(r,i),'" ').concat(c).concat(m).concat(o,">").concat(of(a),"</tspan>")}_setSVGTextLineText(a,t,e,r){const s=this.getHeightOfLine(t),i=this.textAlign.includes(Pr),n=this._textLines[t];let o,l,c,u,d,g="",f=0;r+=s*(1-this._fontSizeFraction)/this.lineHeight;for(let m=0,p=n.length-1;m<=p;m++)d=m===p||this.charSpacing||this.path,g+=n[m],c=this.__charBounds[t][m],f===0?(e+=c.kernedWidth-c.width,f+=c.width):f+=c.kernedWidth,i&&!d&&this._reSpaceAndTab.test(n[m])&&(d=!0),d||(o=o||this.getCompleteStyleDeclaration(t,m),l=this.getCompleteStyleDeclaration(t,m+1),d=ea(o,l,!0)),d&&(u=this._getStyleDeclaration(t,m),a.push(this._createTextCharSpan(g,u,e,r,c)),g="",o=l,this.direction==="rtl"?e-=f:e+=f,f=0)}_setSVGTextLineBg(a,t,e,r){const s=this._textLines[t],i=this.getHeightOfLine(t)/this.lineHeight;let n,o=0,l=0,c=this.getValueOfPropertyAt(t,0,"textBackgroundColor");for(let u=0;u<s.length;u++){const{left:d,width:g,kernedWidth:f}=this.__charBounds[t][u];n=this.getValueOfPropertyAt(t,u,"textBackgroundColor"),n!==c?(c&&a.push(...uo(c,e+l,r,o,i)),l=d,o=g,c=n):o+=f}n&&a.push(...uo(c,e+l,r,o,i))}_getSVGLineTopOffset(a){let t,e=0;for(t=0;t<a;t++)e+=this.getHeightOfLine(t);const r=this.getHeightOfLine(t);return{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*r/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(a){return"".concat(super.getSvgStyles(a)," text-decoration-thickness: ").concat(re(this.textDecorationThickness*this.getObjectScaling().y/10,Ht.NUM_FRACTION_DIGITS),"%; white-space: pre;")}getSvgSpanStyles(a,t){const{fontFamily:e,strokeWidth:r,stroke:s,fill:i,fontSize:n,fontStyle:o,fontWeight:l,deltaY:c,textDecorationThickness:u,linethrough:d,overline:g,underline:f}=a,m=this.getSvgTextDecoration({underline:f??this.underline,overline:g??this.overline,linethrough:d??this.linethrough}),p=u||this.textDecorationThickness;return[s?Ti(Ne,s):"",r?"stroke-width: ".concat(r,"; "):"",e?"font-family: ".concat(e.includes("'")||e.includes('"')?e:"'".concat(e,"'"),"; "):"",n?"font-size: ".concat(n,"px; "):"",o?"font-style: ".concat(o,"; "):"",l?"font-weight: ".concat(l,"; "):"",m?"text-decoration: ".concat(m,"; text-decoration-thickness: ").concat(re(p*this.getObjectScaling().y/10,Ht.NUM_FRACTION_DIGITS),"%; "):"",i?Ti(we,i):"",c?"baseline-shift: ".concat(-c,"; "):"",t?"white-space: pre; ":""].join("")}getSvgTextDecoration(a){return["overline","underline","line-through"].filter((t=>a[t.replace("-","")])).join(" ")}}]),mt.setClass(Fe),mt.setSVGClass(Fe);class xm{constructor(t){C(this,"target",void 0),C(this,"__mouseDownInPlace",!1),C(this,"__dragStartFired",!1),C(this,"__isDraggingOver",!1),C(this,"__dragStartSelection",void 0),C(this,"__dragImageDisposer",void 0),C(this,"_dispose",void 0),this.target=t;const e=[this.target.on("dragenter",this.dragEnterHandler.bind(this)),this.target.on("dragover",this.dragOverHandler.bind(this)),this.target.on("dragleave",this.dragLeaveHandler.bind(this)),this.target.on("dragend",this.dragEndHandler.bind(this)),this.target.on("drop",this.dropHandler.bind(this))];this._dispose=()=>{e.forEach((r=>r())),this._dispose=void 0}}isPointerOverSelection(t){const e=this.target,r=e.getSelectionStartFromPointer(t);return e.isEditing&&r>=e.selectionStart&&r<=e.selectionEnd&&e.selectionStart<e.selectionEnd}start(t){return this.__mouseDownInPlace=this.isPointerOverSelection(t)}isActive(){return this.__mouseDownInPlace}end(t){const e=this.isActive();return e&&!this.__dragStartFired&&(this.target.setCursorByClick(t),this.target.initDelayedCursor(!0)),this.__mouseDownInPlace=!1,this.__dragStartFired=!1,this.__isDraggingOver=!1,e}getDragStartSelection(){return this.__dragStartSelection}setDragImage(t,e){var r;let{selectionStart:s,selectionEnd:i}=e;const n=this.target,o=n.canvas,l=new B(n.flipX?-1:1,n.flipY?-1:1),c=n._getCursorBoundaries(s),u=new B(c.left+c.leftOffset,c.top+c.topOffset).multiply(l).transform(n.calcTransformMatrix()),d=o.getScenePoint(t).subtract(u),g=n.getCanvasRetinaScaling(),f=n.getBoundingRect(),m=u.subtract(new B(f.left,f.top)),p=o.viewportTransform,v=m.add(d).transform(p,!0),y=n.backgroundColor,S=Qo(n.styles);n.backgroundColor="";const O={stroke:"transparent",fill:"transparent",textBackgroundColor:"transparent"};n.setSelectionStyles(O,0,s),n.setSelectionStyles(O,i,n.text.length),n.dirty=!0;const A=n.toCanvasElement({enableRetinaScaling:o.enableRetinaScaling,viewportTransform:!0});n.backgroundColor=y,n.styles=S,n.dirty=!0,Eo(A,{position:"fixed",left:"".concat(-A.width,"px"),border:Xe,width:"".concat(A.width/g,"px"),height:"".concat(A.height/g,"px")}),this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{A.remove()},xr(t.target||this.target.hiddenTextarea).body.appendChild(A),(r=t.dataTransfer)===null||r===void 0||r.setDragImage(A,v.x,v.y)}onDragStart(t){this.__dragStartFired=!0;const e=this.target,r=this.isActive();if(r&&t.dataTransfer){const s=this.__dragStartSelection={selectionStart:e.selectionStart,selectionEnd:e.selectionEnd},i=e._text.slice(s.selectionStart,s.selectionEnd).join(""),n=T({text:e.text,value:i},s);t.dataTransfer.setData("text/plain",i),t.dataTransfer.setData("application/fabric",JSON.stringify({value:i,styles:e.getSelectionStyles(s.selectionStart,s.selectionEnd,!0)})),t.dataTransfer.effectAllowed="copyMove",this.setDragImage(t,n)}return e.abortCursorAnimation(),r}canDrop(t){if(this.target.editable&&!this.target.getActiveControl()&&!t.defaultPrevented){if(this.isActive()&&this.__dragStartSelection){const e=this.target.getSelectionStartFromPointer(t),r=this.__dragStartSelection;return e<r.selectionStart||e>r.selectionEnd}return!0}return!1}targetCanDrop(t){return this.target.canDrop(t)}dragEnterHandler(t){let{e}=t;const r=this.targetCanDrop(e);!this.__isDraggingOver&&r&&(this.__isDraggingOver=!0)}dragOverHandler(t){const{e}=t,r=this.targetCanDrop(e);!this.__isDraggingOver&&r?this.__isDraggingOver=!0:this.__isDraggingOver&&!r&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(e.preventDefault(),t.canDrop=!0,t.dropTarget=this.target)}dragLeaveHandler(){(this.__isDraggingOver||this.isActive())&&(this.__isDraggingOver=!1)}dropHandler(t){var e;const{e:r}=t,s=r.defaultPrevented;this.__isDraggingOver=!1,r.preventDefault();let i=(e=r.dataTransfer)===null||e===void 0?void 0:e.getData("text/plain");if(i&&!s){const n=this.target,o=n.canvas;let l=n.getSelectionStartFromPointer(r);const{styles:c}=r.dataTransfer.types.includes("application/fabric")?JSON.parse(r.dataTransfer.getData("application/fabric")):{},u=i[Math.max(0,i.length-1)],d=0;if(this.__dragStartSelection){const g=this.__dragStartSelection.selectionStart,f=this.__dragStartSelection.selectionEnd;l>g&&l<=f?l=g:l>f&&(l-=f-g),n.removeChars(g,f),delete this.__dragStartSelection}n._reNewline.test(u)&&(n._reNewline.test(n._text[l])||l===n._text.length)&&(i=i.trimEnd()),t.didDrop=!0,t.dropTarget=n,n.insertChars(i,c,l),o.setActiveObject(n),n.enterEditing(r),n.selectionStart=Math.min(l+d,n._text.length),n.selectionEnd=Math.min(n.selectionStart+i.length,n._text.length),n.hiddenTextarea.value=n.text,n._updateTextarea(),n.hiddenTextarea.focus(),n.fire(Sn,{index:l+d,action:"drop"}),o.fire("text:changed",{target:n}),o.contextTopDirty=!0,o.requestRenderAll()}}dragEndHandler(t){let{e}=t;if(this.isActive()&&this.__dragStartFired&&this.__dragStartSelection){var r;const s=this.target,i=this.target.canvas,{selectionStart:n,selectionEnd:o}=this.__dragStartSelection,l=((r=e.dataTransfer)===null||r===void 0?void 0:r.dropEffect)||Xe;l===Xe?(s.selectionStart=n,s.selectionEnd=o,s._updateTextarea(),s.hiddenTextarea.focus()):(s.clearContextTop(),l==="move"&&(s.removeChars(n,o),s.selectionStart=s.selectionEnd=n,s.hiddenTextarea&&(s.hiddenTextarea.value=s.text),s._updateTextarea(),s.fire(Sn,{index:n,action:"dragend"}),i.fire("text:changed",{target:s}),i.requestRenderAll()),s.exitEditing())}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dispose(){this._dispose&&this._dispose()}}const nl=/[ \n\.,;!\?\-]/;class wm extends Fe{constructor(){super(...arguments),C(this,"_currentCursorOpacity",1)}initBehavior(){this._tick=this._tick.bind(this),this._onTickComplete=this._onTickComplete.bind(this),this.updateSelectionOnMouseMove=this.updateSelectionOnMouseMove.bind(this)}onDeselect(t){return this.isEditing&&this.exitEditing(),this.selected=!1,super.onDeselect(t)}_animateCursor(t){let{toValue:e,duration:r,delay:s,onComplete:i}=t;return dc({startValue:this._currentCursorOpacity,endValue:e,duration:r,delay:s,onComplete:i,abort:()=>!this.canvas||this.selectionStart!==this.selectionEnd,onChange:n=>{this._currentCursorOpacity=n,this.renderCursorOrSelection()}})}_tick(t){this._currentTickState=this._animateCursor({toValue:0,duration:this.cursorDuration/2,delay:Math.max(t||0,100),onComplete:this._onTickComplete})}_onTickComplete(){var t;(t=this._currentTickCompleteState)===null||t===void 0||t.abort(),this._currentTickCompleteState=this._animateCursor({toValue:1,duration:this.cursorDuration,onComplete:this._tick})}initDelayedCursor(t){this.abortCursorAnimation(),this._tick(t?0:this.cursorDelay)}abortCursorAnimation(){let t=!1;[this._currentTickState,this._currentTickCompleteState].forEach((e=>{e&&!e.isDone()&&(t=!0,e.abort())})),this._currentCursorOpacity=1,t&&this.clearContextTop()}restartCursorIfNeeded(){[this._currentTickState,this._currentTickCompleteState].some((t=>!t||t.isDone()))&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}cmdAll(){this.selectAll(),this.renderCursorOrSelection()}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(t){let e=0,r=t-1;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)e++,r--;for(;/\S/.test(this._text[r])&&r>-1;)e++,r--;return t-e}findWordBoundaryRight(t){let e=0,r=t;if(this._reSpace.test(this._text[r]))for(;this._reSpace.test(this._text[r]);)e++,r++;for(;/\S/.test(this._text[r])&&r<this._text.length;)e++,r++;return t+e}findLineBoundaryLeft(t){let e=0,r=t-1;for(;!/\n/.test(this._text[r])&&r>-1;)e++,r--;return t-e}findLineBoundaryRight(t){let e=0,r=t;for(;!/\n/.test(this._text[r])&&r<this._text.length;)e++,r++;return t+e}searchWordBoundary(t,e){const r=this._text;let s=t>0&&this._reSpace.test(r[t])&&(e===-1||!Ho.test(r[t-1]))?t-1:t,i=r[s];for(;s>0&&s<r.length&&!nl.test(i);)s+=e,i=r[s];return e===-1&&nl.test(i)&&s++,s}selectWord(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const r=this.searchWordBoundary(t,-1),s=Math.max(r,this.searchWordBoundary(t,1));this.selectionStart=r,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(t){var e;t=(e=t)!==null&&e!==void 0?e:this.selectionStart;const r=this.findLineBoundaryLeft(t),s=this.findLineBoundaryRight(t);this.selectionStart=r,this.selectionEnd=s,this._fireSelectionChanged(),this._updateTextarea()}enterEditing(t){!this.isEditing&&this.editable&&(this.enterEditingImpl(),this.fire("editing:entered",t?{e:t}:void 0),this._fireSelectionChanged(),this.canvas&&(this.canvas.fire("text:editing:entered",{target:this,e:t}),this.canvas.requestRenderAll()))}enterEditingImpl(){this.canvas&&(this.canvas.calcOffset(),this.canvas.textEditingManager.exitTextEditing()),this.isEditing=!0,this.initHiddenTextarea(),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick()}updateSelectionOnMouseMove(t){if(this.getActiveControl())return;const e=this.hiddenTextarea;xr(e).activeElement!==e&&e.focus();const r=this.getSelectionStartFromPointer(t),s=this.selectionStart,i=this.selectionEnd;(r===this.__selectionStartOnMouseDown&&s!==i||s!==r&&i!==r)&&(r>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=r):(this.selectionStart=r,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===s&&this.selectionEnd===i||(this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(t,e,r){const s=r.slice(0,t),i=this.graphemeSplit(s).length;if(t===e)return{selectionStart:i,selectionEnd:i};const n=r.slice(t,e);return{selectionStart:i,selectionEnd:i+this.graphemeSplit(n).length}}fromGraphemeToStringSelection(t,e,r){const s=r.slice(0,t).join("").length;return t===e?{selectionStart:s,selectionEnd:s}:{selectionStart:s,selectionEnd:s+r.slice(t,e).join("").length}}_updateTextarea(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){const t=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=t.selectionStart,this.hiddenTextarea.selectionEnd=t.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={};const t=this.hiddenTextarea;this.text=t.value,this.set("dirty",!0),this.initDimensions(),this.setCoords();const e=this.fromStringToGraphemeSelection(t.selectionStart,t.selectionEnd,t.value);this.selectionEnd=this.selectionStart=e.selectionEnd,this.inCompositionMode||(this.selectionStart=e.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const t=this._calcTextareaPosition();this.hiddenTextarea.style.left=t.left,this.hiddenTextarea.style.top=t.top}}_calcTextareaPosition(){if(!this.canvas)return{left:"1px",top:"1px"};const t=this.inCompositionMode?this.compositionStart:this.selectionStart,e=this._getCursorBoundaries(t),r=this.get2DCursorLocation(t),s=r.lineIndex,i=r.charIndex,n=this.getValueOfPropertyAt(s,i,"fontSize")*this.lineHeight,o=e.leftOffset,l=this.getCanvasRetinaScaling(),c=this.canvas.upperCanvasEl,u=c.width/l,d=c.height/l,g=u-n,f=d-n,m=new B(e.left+o,e.top+e.topOffset+n).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new B(c.clientWidth/u,c.clientHeight/d));return m.x<0&&(m.x=0),m.x>g&&(m.x=g),m.y<0&&(m.y=0),m.y>f&&(m.y=f),m.x+=this.canvas._offset.left,m.y+=this.canvas._offset.top,{left:"".concat(m.x,"px"),top:"".concat(m.y,"px"),fontSize:"".concat(n,"px"),charHeight:n}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor||this.canvas.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor||this.canvas.moveCursor),delete this._savedProps)}_exitEditing(){const t=this.hiddenTextarea;this.selected=!1,this.isEditing=!1,t&&(t.blur&&t.blur(),t.parentNode&&t.parentNode.removeChild(t)),this.hiddenTextarea=null,this.abortCursorAnimation(),this.selectionStart!==this.selectionEnd&&this.clearContextTop()}exitEditingImpl(){this._exitEditing(),this.selectionEnd=this.selectionStart,this._restoreEditingProps(),this._forceClearCache&&(this.initDimensions(),this.setCoords())}exitEditing(){const t=this._textBeforeEdit!==this.text;return this.exitEditingImpl(),this.fire("editing:exited"),t&&this.fire(Cn),this.canvas&&(this.canvas.fire("text:editing:exited",{target:this}),t&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const t in this.styles)this._textLines[t]||delete this.styles[t]}removeStyleFromTo(t,e){const{lineIndex:r,charIndex:s}=this.get2DCursorLocation(t,!0),{lineIndex:i,charIndex:n}=this.get2DCursorLocation(e,!0);if(r!==i){if(this.styles[r])for(let o=s;o<this._unwrappedTextLines[r].length;o++)delete this.styles[r][o];if(this.styles[i])for(let o=n;o<this._unwrappedTextLines[i].length;o++){const l=this.styles[i][o];l&&(this.styles[r]||(this.styles[r]={}),this.styles[r][s+o-n]=l)}for(let o=r+1;o<=i;o++)delete this.styles[o];this.shiftLineStyles(i,r-i)}else if(this.styles[r]){const o=this.styles[r],l=n-s;for(let c=s;c<n;c++)delete o[c];for(const c in this.styles[r]){const u=parseInt(c,10);u>=n&&(o[u-l]=o[c],delete o[c])}}}shiftLineStyles(t,e){const r=Object.assign({},this.styles);for(const s in this.styles){const i=parseInt(s,10);i>t&&(this.styles[i+e]=r[i],r[i-e]||delete this.styles[i])}}insertNewlineStyleObject(t,e,r,s){const i={},n=this._unwrappedTextLines[t].length,o=n===e;let l=!1;r||(r=1),this.shiftLineStyles(t,r);const c=this.styles[t]?this.styles[t][e===0?e:e-1]:void 0;for(const d in this.styles[t]){const g=parseInt(d,10);g>=e&&(l=!0,i[g-e]=this.styles[t][d],o&&e===0||delete this.styles[t][d])}let u=!1;for(l&&!o&&(this.styles[t+r]=i,u=!0),(u||n>e)&&r--;r>0;)s&&s[r-1]?this.styles[t+r]={0:T({},s[r-1])}:c?this.styles[t+r]={0:T({},c)}:delete this.styles[t+r],r--;this._forceClearCache=!0}insertCharStyleObject(t,e,r,s){this.styles||(this.styles={});const i=this.styles[t],n=i?T({},i):{};r||(r=1);for(const l in n){const c=parseInt(l,10);c>=e&&(i[c+r]=n[c],n[c-r]||delete i[c])}if(this._forceClearCache=!0,s){for(;r--;)Object.keys(s[r]).length&&(this.styles[t]||(this.styles[t]={}),this.styles[t][e+r]=T({},s[r]));return}if(!i)return;const o=i[e?e-1:1];for(;o&&r--;)this.styles[t][e+r]=T({},o)}insertNewStyleBlock(t,e,r){const s=this.get2DCursorLocation(e,!0),i=[0];let n,o=0;for(let l=0;l<t.length;l++)t[l]===`
`?(o++,i[o]=0):i[o]++;for(i[0]>0&&(this.insertCharStyleObject(s.lineIndex,s.charIndex,i[0],r),r=r&&r.slice(i[0]+1)),o&&this.insertNewlineStyleObject(s.lineIndex,s.charIndex+i[0],o),n=1;n<o;n++)i[n]>0?this.insertCharStyleObject(s.lineIndex+n,0,i[n],r):r&&this.styles[s.lineIndex+n]&&r[0]&&(this.styles[s.lineIndex+n][0]=r[0]),r=r&&r.slice(i[n]+1);i[n]>0&&this.insertCharStyleObject(s.lineIndex+n,0,i[n],r)}removeChars(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:t+1;this.removeStyleFromTo(t,e),this._text.splice(t,e-t),this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}insertChars(t,e,r){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:r;s>r&&this.removeStyleFromTo(r,s);const i=this.graphemeSplit(t);this.insertNewStyleBlock(i,r,e),this._text=[...this._text.slice(0,r),...i,...this._text.slice(s)],this.text=this._text.join(""),this.set("dirty",!0),this.initDimensions(),this.setCoords(),this._removeExtraneousStyles()}setSelectionStartEndWithShift(t,e,r){r<=t?(e===t?this._selectionDirection=qt:this._selectionDirection===me&&(this._selectionDirection=qt,this.selectionEnd=t),this.selectionStart=r):r>t&&r<e?this._selectionDirection===me?this.selectionEnd=r:this.selectionStart=r:(e===t?this._selectionDirection=me:this._selectionDirection===qt&&(this._selectionDirection=me,this.selectionStart=e),this.selectionEnd=r)}}class bm extends wm{initHiddenTextarea(){const t=this.canvas&&xr(this.canvas.getElement())||Zs(),e=t.createElement("textarea");Object.entries({autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false","data-fabric":"textarea",wrap:"off",name:"fabricTextarea"}).map((n=>{let[o,l]=n;return e.setAttribute(o,l)}));const{top:r,left:s,fontSize:i}=this._calcTextareaPosition();e.style.cssText="position: absolute; top: ".concat(r,"; left: ").concat(s,"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ").concat(i,";"),(this.hiddenTextareaContainer||t.body).appendChild(e),Object.entries({blur:"blur",keydown:"onKeyDown",keyup:"onKeyUp",input:"onInput",copy:"copy",cut:"copy",paste:"paste",compositionstart:"onCompositionStart",compositionupdate:"onCompositionUpdate",compositionend:"onCompositionEnd"}).map((n=>{let[o,l]=n;return e.addEventListener(o,this[l].bind(this))})),this.hiddenTextarea=e}blur(){this.abortCursorAnimation()}onKeyDown(t){if(!this.isEditing)return;const e=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(t.keyCode in e)this[e[t.keyCode]](t);else{if(!(t.keyCode in this.ctrlKeysMapDown)||!t.ctrlKey&&!t.metaKey)return;this[this.ctrlKeysMapDown[t.keyCode]](t)}t.stopImmediatePropagation(),t.preventDefault(),t.keyCode>=33&&t.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(t){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:t.keyCode in this.ctrlKeysMapUp&&(t.ctrlKey||t.metaKey)&&(this[this.ctrlKeysMapUp[t.keyCode]](t),t.stopImmediatePropagation(),t.preventDefault(),this.canvas&&this.canvas.requestRenderAll())}onInput(t){const e=this.fromPaste,{value:r,selectionStart:s,selectionEnd:i}=this.hiddenTextarea;if(this.fromPaste=!1,t&&t.stopPropagation(),!this.isEditing)return;const n=()=>{this.updateFromTextArea(),this.fire(Sn),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())};if(this.hiddenTextarea.value==="")return this.styles={},void n();const o=this._splitTextIntoLines(r).graphemeText,l=this._text.length,c=o.length,u=this.selectionStart,d=this.selectionEnd,g=u!==d;let f,m,p,v,y=c-l;const S=this.fromStringToGraphemeSelection(s,i,r),O=u>S.selectionStart;g?(m=this._text.slice(u,d),y+=d-u):c<l&&(m=O?this._text.slice(d+y,d):this._text.slice(u,u-y));const A=o.slice(S.selectionEnd-y,S.selectionEnd);if(m&&m.length&&(A.length&&(f=this.getSelectionStyles(u,u+1,!1),f=A.map((()=>f[0]))),g?(p=u,v=d):O?(p=d-m.length,v=d):(p=d,v=d+m.length),this.removeStyleFromTo(p,v)),A.length){const{copyPasteData:M}=Lr();e&&A.join("")===M.copiedText&&!Ht.disableStyleCopyPaste&&(f=M.copiedTextStyle),this.insertNewStyleBlock(A,u,f)}n()}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(t){let{target:e}=t;const{selectionStart:r,selectionEnd:s}=e;this.compositionStart=r,this.compositionEnd=s,this.updateTextareaPosition()}copy(){if(this.selectionStart===this.selectionEnd)return;const{copyPasteData:t}=Lr();t.copiedText=this.getSelectedText(),Ht.disableStyleCopyPaste?t.copiedTextStyle=void 0:t.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0}paste(){this.fromPaste=!0}_getWidthBeforeCursor(t,e){let r,s=this._getLineLeftOffset(t);return e>0&&(r=this.__charBounds[t][e-1],s+=r.left+r.width),s}getDownCursorOffset(t,e){const r=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(r),i=s.lineIndex;if(i===this._textLines.length-1||t.metaKey||t.keyCode===34)return this._text.length-r;const n=s.charIndex,o=this._getWidthBeforeCursor(i,n),l=this._getIndexOnLine(i+1,o);return this._textLines[i].slice(n).length+l+1+this.missingNewlineOffset(i)}_getSelectionForOffset(t,e){return t.shiftKey&&this.selectionStart!==this.selectionEnd&&e?this.selectionEnd:this.selectionStart}getUpCursorOffset(t,e){const r=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(r),i=s.lineIndex;if(i===0||t.metaKey||t.keyCode===33)return-r;const n=s.charIndex,o=this._getWidthBeforeCursor(i,n),l=this._getIndexOnLine(i-1,o),c=this._textLines[i].slice(0,n),u=this.missingNewlineOffset(i-1);return-this._textLines[i-1].length+l-c.length+(1-u)}_getIndexOnLine(t,e){const r=this._textLines[t];let s,i,n=this._getLineLeftOffset(t),o=0;for(let l=0,c=r.length;l<c;l++)if(s=this.__charBounds[t][l].width,n+=s,n>e){i=!0;const u=n-s,d=n,g=Math.abs(u-e);o=Math.abs(d-e)<g?l:l-1;break}return i||(o=r.length-1),o}moveCursorDown(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",t)}moveCursorUp(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",t)}_moveCursorUpOrDown(t,e){const r=this["get".concat(t,"CursorOffset")](e,this._selectionDirection===me);if(e.shiftKey?this.moveCursorWithShift(r):this.moveCursorWithoutShift(r),r!==0){const s=this.text.length;this.selectionStart=$s(0,this.selectionStart,s),this.selectionEnd=$s(0,this.selectionEnd,s),this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(t){const e=this._selectionDirection===qt?this.selectionStart+t:this.selectionEnd+t;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,e),t!==0}moveCursorWithoutShift(t){return t<0?(this.selectionStart+=t,this.selectionEnd=this.selectionStart):(this.selectionEnd+=t,this.selectionStart=this.selectionEnd),t!==0}moveCursorLeft(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",t)}_move(t,e,r){let s;if(t.altKey)s=this["findWordBoundary".concat(r)](this[e]);else{if(!t.metaKey&&t.keyCode!==35&&t.keyCode!==36)return this[e]+=r==="Left"?-1:1,!0;s=this["findLineBoundary".concat(r)](this[e])}return s!==void 0&&this[e]!==s&&(this[e]=s,!0)}_moveLeft(t,e){return this._move(t,e,"Left")}_moveRight(t,e){return this._move(t,e,"Right")}moveCursorLeftWithoutShift(t){let e=!0;return this._selectionDirection=qt,this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(e=this._moveLeft(t,"selectionStart")),this.selectionEnd=this.selectionStart,e}moveCursorLeftWithShift(t){return this._selectionDirection===me&&this.selectionStart!==this.selectionEnd?this._moveLeft(t,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection=qt,this._moveLeft(t,"selectionStart")):void 0}moveCursorRight(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",t)}_moveCursorLeftOrRight(t,e){const r="moveCursor".concat(t).concat(e.shiftKey?"WithShift":"WithoutShift");this._currentCursorOpacity=1,this[r](e)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(t){return this._selectionDirection===qt&&this.selectionStart!==this.selectionEnd?this._moveRight(t,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection=me,this._moveRight(t,"selectionEnd")):void 0}moveCursorRightWithoutShift(t){let e=!0;return this._selectionDirection=me,this.selectionStart===this.selectionEnd?(e=this._moveRight(t,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,e}}const ol=a=>!!a.button;class Sm extends bm{constructor(){super(...arguments),C(this,"draggableTextDelegate",void 0)}initBehavior(){this.on("mousedown",this._mouseDownHandler),this.on("mouseup",this.mouseUpHandler),this.on("mousedblclick",this.doubleClickHandler),this.on("mousetripleclick",this.tripleClickHandler),this.draggableTextDelegate=new xm(this),super.initBehavior()}shouldStartDragging(){return this.draggableTextDelegate.isActive()}onDragStart(t){return this.draggableTextDelegate.onDragStart(t)}canDrop(t){return this.draggableTextDelegate.canDrop(t)}doubleClickHandler(t){this.isEditing&&(this.selectWord(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}tripleClickHandler(t){this.isEditing&&(this.selectLine(this.getSelectionStartFromPointer(t.e)),this.renderCursorOrSelection())}_mouseDownHandler(t){let{e,alreadySelected:r}=t;this.canvas&&this.editable&&!ol(e)&&!this.getActiveControl()&&(this.draggableTextDelegate.start(e)||(this.canvas.textEditingManager.register(this),r&&(this.inCompositionMode=!1,this.setCursorByClick(e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()),this.selected||(this.selected=r||this.isEditing)))}mouseUpHandler(t){let{e,transform:r}=t;const s=this.draggableTextDelegate.end(e);if(this.canvas){this.canvas.textEditingManager.unregister(this);const i=this.canvas._activeObject;if(i&&i!==this)return}!this.editable||this.group&&!this.group.interactive||r&&r.actionPerformed||ol(e)||s||this.selected&&!this.getActiveControl()&&(this.enterEditing(e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection())}setCursorByClick(t){const e=this.getSelectionStartFromPointer(t),r=this.selectionStart,s=this.selectionEnd;t.shiftKey?this.setSelectionStartEndWithShift(r,s,e):(this.selectionStart=e,this.selectionEnd=e),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getSelectionStartFromPointer(t){const e=this.canvas.getScenePoint(t).transform(wr(this.calcTransformMatrix())).add(new B(-this._getLeftOffset(),-this._getTopOffset()));let r=0,s=0,i=0;for(let c=0;c<this._textLines.length&&r<=e.y;c++)r+=this.getHeightOfLine(c),i=c,c>0&&(s+=this._textLines[c-1].length+this.missingNewlineOffset(c-1));let n=Math.abs(this._getLineLeftOffset(i));const o=this._textLines[i].length,l=this.__charBounds[i];for(let c=0;c<o;c++){const u=n+l[c].kernedWidth;if(e.x<=u){Math.abs(e.x-u)<=Math.abs(e.x-n)&&s++;break}n=u,s++}return Math.min(this.flipX?o-s:s,this._text.length)}}const Vi="moveCursorUp",Wi="moveCursorDown",Hi="moveCursorLeft",Yi="moveCursorRight",Xi="exitEditing",al=(a,t)=>{const e=t.getRetinaScaling();a.setTransform(e,0,0,e,0,0);const r=t.viewportTransform;a.transform(r[0],r[1],r[2],r[3],r[4],r[5])},Cm=T({selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,keysMap:{9:Xi,27:Xi,33:Vi,34:Wi,35:Yi,36:Hi,37:Hi,38:Vi,39:Yi,40:Wi},keysMapRtl:{9:Xi,27:Xi,33:Vi,34:Wi,35:Hi,36:Yi,37:Yi,38:Vi,39:Hi,40:Wi},ctrlKeysMapDown:{65:"cmdAll"},ctrlKeysMapUp:{67:"copy",88:"cut"}},{_selectionDirection:null,_reSpace:/\s|\r?\n/,inCompositionMode:!1});class Ur extends Sm{static getDefaults(){return T(T({},super.getDefaults()),Ur.ownDefaults)}get type(){const t=super.type;return t==="itext"?"i-text":t}constructor(t,e){super(t,T(T({},Ur.ownDefaults),e)),this.initBehavior()}_set(t,e){return this.isEditing&&this._savedProps&&t in this._savedProps?(this._savedProps[t]=e,this):(t==="canvas"&&(this.canvas instanceof Po&&this.canvas.textEditingManager.remove(this),e instanceof Po&&e.textEditingManager.add(this)),super._set(t,e))}setSelectionStart(t){t=Math.max(t,0),this._updateAndFire("selectionStart",t)}setSelectionEnd(t){t=Math.min(t,this.text.length),this._updateAndFire("selectionEnd",t)}_updateAndFire(t,e){this[t]!==e&&(this._fireSelectionChanged(),this[t]=e),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),super.initDimensions()}getSelectionStyles(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart||0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionEnd,r=arguments.length>2?arguments[2]:void 0;return super.getSelectionStyles(t,e,r)}setSelectionStyles(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.selectionStart||0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.selectionEnd;return super.setSelectionStyles(t,e,r)}get2DCursorLocation(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;return super.get2DCursorLocation(t,e)}render(t){super.render(t),this.cursorOffsetCache={},this.renderCursorOrSelection()}toCanvasElement(t){const e=this.isEditing;this.isEditing=!1;const r=super.toCanvasElement(t);return this.isEditing=e,r}renderCursorOrSelection(){if(!this.isEditing||!this.canvas)return;const t=this.clearContextTop(!0);if(!t)return;const e=this._getCursorBoundaries(),r=this.findAncestorsWithClipPath(),s=r.length>0;let i,n=t;if(s){i=ur(t.canvas),n=i.getContext("2d"),al(n,this.canvas);const o=this.calcTransformMatrix();n.transform(o[0],o[1],o[2],o[3],o[4],o[5])}if(this.selectionStart!==this.selectionEnd||this.inCompositionMode?this.renderSelection(n,e):this.renderCursor(n,e),s)for(const o of r){const l=o.clipPath,c=ur(t.canvas),u=c.getContext("2d");if(al(u,this.canvas),!l.absolutePositioned){const d=o.calcTransformMatrix();u.transform(d[0],d[1],d[2],d[3],d[4],d[5])}l.transform(u),l.drawObject(u,!0,{}),this.drawClipPathOnCache(n,l,c)}s&&(t.setTransform(1,0,0,1,0,0),t.drawImage(i,0,0)),this.canvas.contextTopDirty=!0,t.restore()}findAncestorsWithClipPath(){const t=[];let e=this;for(;e;)e.clipPath&&t.push(e),e=e.parent;return t}_getCursorBoundaries(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1?arguments[1]:void 0;const r=this._getLeftOffset(),s=this._getTopOffset(),i=this._getCursorBoundariesOffsets(t,e);return{left:r,top:s,leftOffset:i.left,topOffset:i.top}}_getCursorBoundariesOffsets(t,e){return e?this.__getCursorBoundariesOffsets(t):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(t)}__getCursorBoundariesOffsets(t){let e=0,r=0;const{charIndex:s,lineIndex:i}=this.get2DCursorLocation(t);for(let c=0;c<i;c++)e+=this.getHeightOfLine(c);const n=this._getLineLeftOffset(i),o=this.__charBounds[i][s];o&&(r=o.left),this.charSpacing!==0&&s===this._textLines[i].length&&(r-=this._getWidthOfCharSpacing());const l={top:e,left:n+(r>0?r:0)};return this.direction==="rtl"&&(this.textAlign===me||this.textAlign===Pr||this.textAlign===pi?l.left*=-1:this.textAlign===qt||this.textAlign===En?l.left=n-(r>0?r:0):this.textAlign!==Lt&&this.textAlign!==vi||(l.left=n-(r>0?r:0))),l}renderCursorAt(t){this._renderCursor(this.canvas.contextTop,this._getCursorBoundaries(t,!0),t)}renderCursor(t,e){this._renderCursor(t,e,this.selectionStart)}getCursorRenderingData(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.selectionStart,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this._getCursorBoundaries(t);const r=this.get2DCursorLocation(t),s=r.lineIndex,i=r.charIndex>0?r.charIndex-1:0,n=this.getValueOfPropertyAt(s,i,"fontSize"),o=this.getObjectScaling().x*this.canvas.getZoom(),l=this.cursorWidth/o,c=this.getValueOfPropertyAt(s,i,"deltaY"),u=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(s)/this.lineHeight-n*(1-this._fontSizeFraction);return{color:this.cursorColor||this.getValueOfPropertyAt(s,i,"fill"),opacity:this._currentCursorOpacity,left:e.left+e.leftOffset-l/2,top:u+e.top+c,width:l,height:n}}_renderCursor(t,e,r){const{color:s,opacity:i,left:n,top:o,width:l,height:c}=this.getCursorRenderingData(r,e);t.fillStyle=s,t.globalAlpha=i,t.fillRect(n,o,l,c)}renderSelection(t,e){const r={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(t,r,e)}renderDragSourceEffect(){const t=this.draggableTextDelegate.getDragStartSelection();this._renderSelection(this.canvas.contextTop,t,this._getCursorBoundaries(t.selectionStart,!0))}renderDropTargetEffect(t){const e=this.getSelectionStartFromPointer(t);this.renderCursorAt(e)}_renderSelection(t,e,r){const s=e.selectionStart,i=e.selectionEnd,n=this.textAlign.includes(Pr),o=this.get2DCursorLocation(s),l=this.get2DCursorLocation(i),c=o.lineIndex,u=l.lineIndex,d=o.charIndex<0?0:o.charIndex,g=l.charIndex<0?0:l.charIndex;for(let f=c;f<=u;f++){const m=this._getLineLeftOffset(f)||0;let p=this.getHeightOfLine(f),v=0,y=0,S=0;if(f===c&&(y=this.__charBounds[c][d].left),f>=c&&f<u)S=n&&!this.isEndOfWrapping(f)?this.width:this.getLineWidth(f)||5;else if(f===u)if(g===0)S=this.__charBounds[u][g].left;else{const E=this._getWidthOfCharSpacing();S=this.__charBounds[u][g-1].left+this.__charBounds[u][g-1].width-E}v=p,(this.lineHeight<1||f===u&&this.lineHeight>1)&&(p/=this.lineHeight);let O=r.left+m+y,A=p,M=0;const F=S-y;this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",A=1,M=p):t.fillStyle=this.selectionColor,this.direction==="rtl"&&(this.textAlign===me||this.textAlign===Pr||this.textAlign===pi?O=this.width-O-F:this.textAlign===qt||this.textAlign===En?O=r.left+m-S:this.textAlign!==Lt&&this.textAlign!==vi||(O=r.left+m-S)),t.fillRect(O,r.top+r.topOffset+M,F,A),r.topOffset+=v}}getCurrentCharFontSize(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fontSize")}getCurrentCharColor(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,we)}_getCurrentCharIndex(){const t=this.get2DCursorLocation(this.selectionStart,!0),e=t.charIndex>0?t.charIndex-1:0;return{l:t.lineIndex,c:e}}dispose(){this.exitEditingImpl(),this.draggableTextDelegate.dispose(),super.dispose()}}C(Ur,"ownDefaults",Cm),C(Ur,"type","IText"),mt.setClass(Ur),mt.setClass(Ur,"i-text");class Ss extends Ur{static getDefaults(){return T(T({},super.getDefaults()),Ss.ownDefaults)}constructor(t,e){super(t,T(T({},Ss.ownDefaults),e))}static createControls(){return{controls:ef()}}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.includes(Pr)&&this.enlargeSpaces(),this.height=this.calcTextHeight())}_generateStyleMap(t){let e=0,r=0,s=0;const i={};for(let n=0;n<t.graphemeLines.length;n++)t.graphemeText[s]===`
`&&n>0?(r=0,s++,e++):!this.splitByGrapheme&&this._reSpaceAndTab.test(t.graphemeText[s])&&n>0&&(r++,s++),i[n]={line:e,offset:r},s+=t.graphemeLines[n].length,r+=t.graphemeLines[n].length;return i}styleHas(t,e){if(this._styleMap&&!this.isWrapping){const r=this._styleMap[e];r&&(e=r.line)}return super.styleHas(t,e)}isEmptyStyles(t){if(!this.styles)return!0;let e,r=0,s=t+1,i=!1;const n=this._styleMap[t],o=this._styleMap[t+1];n&&(t=n.line,r=n.offset),o&&(s=o.line,i=s===t,e=o.offset);const l=t===void 0?this.styles:{line:this.styles[t]};for(const c in l)for(const u in l[c]){const d=parseInt(u,10);if(d>=r&&(!i||d<e))for(const g in l[c][u])return!1}return!0}_getStyleDeclaration(t,e){if(this._styleMap&&!this.isWrapping){const r=this._styleMap[t];if(!r)return{};t=r.line,e=r.offset+e}return super._getStyleDeclaration(t,e)}_setStyleDeclaration(t,e,r){const s=this._styleMap[t];super._setStyleDeclaration(s.line,s.offset+e,r)}_deleteStyleDeclaration(t,e){const r=this._styleMap[t];super._deleteStyleDeclaration(r.line,r.offset+e)}_getLineStyle(t){const e=this._styleMap[t];return!!this.styles[e.line]}_setLineStyle(t){const e=this._styleMap[t];super._setLineStyle(e.line)}_wrapText(t,e){this.isWrapping=!0;const r=this.getGraphemeDataForRender(t),s=[];for(let i=0;i<r.wordsData.length;i++)s.push(...this._wrapLine(i,e,r));return this.isWrapping=!1,s}getGraphemeDataForRender(t){const e=this.splitByGrapheme,r=e?"":" ";let s=0;return{wordsData:t.map(((i,n)=>{let o=0;const l=e?this.graphemeSplit(i):this.wordSplit(i);return l.length===0?[{word:[],width:0}]:l.map((c=>{const u=e?[c]:this.graphemeSplit(c),d=this._measureWord(u,n,o);return s=Math.max(d,s),o+=u.length+r.length,{word:u,width:d}}))})),largestWordWidth:s}}_measureWord(t,e){let r,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=0;for(let n=0,o=t.length;n<o;n++)i+=this._getGraphemeBox(t[n],e,n+s,r,!0).kernedWidth,r=t[n];return i}wordSplit(t){return t.split(this._wordJoiners)}_wrapLine(t,e,r){let{largestWordWidth:s,wordsData:i}=r,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0;const o=this._getWidthOfCharSpacing(),l=this.splitByGrapheme,c=[],u=l?"":" ";let d=0,g=[],f=0,m=0,p=!0;e-=n;const v=Math.max(e,s,this.dynamicMinWidth),y=i[t];let S;for(f=0,S=0;S<y.length;S++){const{word:O,width:A}=y[S];f+=O.length,d+=m+A-o,d>v&&!p?(c.push(g),g=[],d=A,p=!0):d+=o,p||l||g.push(u),g=g.concat(O),m=l?0:this._measureWord([u],t,f),f++,p=!1}return S&&c.push(g),s+n>this.dynamicMinWidth&&(this.dynamicMinWidth=s-o+n),c}isEndOfWrapping(t){return!this._styleMap[t+1]||this._styleMap[t+1].line!==this._styleMap[t].line}missingNewlineOffset(t,e){return this.splitByGrapheme&&!e?this.isEndOfWrapping(t)?1:0:1}_splitTextIntoLines(t){const e=super._splitTextIntoLines(t),r=this._wrapText(e.lines,this.width),s=new Array(r.length);for(let i=0;i<r.length;i++)s[i]=r[i].join("");return e.lines=s,e.graphemeLines=r,e}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const t=new Map;for(const e in this._styleMap){const r=parseInt(e,10);if(this._textLines[r]){const s=this._styleMap[e].line;t.set("".concat(s),!0)}}for(const e in this.styles)t.has(e)||delete this.styles[e]}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return super.toObject(["minWidth","splitByGrapheme",...t])}}C(Ss,"type","Textbox"),C(Ss,"textLayoutProperties",[...Ur.textLayoutProperties,"width"]),C(Ss,"ownDefaults",{minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_wordJoiners:/[ \t\r]/,splitByGrapheme:!1}),mt.setClass(Ss);class ll extends Nn{shouldPerformLayout(t){return!!t.target.clipPath&&super.shouldPerformLayout(t)}shouldLayoutClipPath(){return!1}calcLayoutResult(t,e){const{target:r}=t,{clipPath:s,group:i}=r;if(!s||!this.shouldPerformLayout(t))return;const{width:n,height:o}=qr(xc(r,s)),l=new B(n,o);if(s.absolutePositioned)return{center:Ns(s.getRelativeCenterPoint(),void 0,i?i.calcTransformMatrix():void 0),size:l};{const c=s.getRelativeCenterPoint().transform(r.calcOwnMatrix(),!0);if(this.shouldPerformLayout(t)){const{center:u=new B,correction:d=new B}=this.calcBoundingBox(e,t)||{};return{center:u.add(c),correction:d.subtract(c),size:l}}return{center:r.getRelativeCenterPoint().add(c),size:l}}}}C(ll,"type","clip-path"),mt.setClass(ll);class cl extends Nn{getInitialSize(t,e){let{target:r}=t,{size:s}=e;return new B(r.width||s.x,r.height||s.y)}}C(cl,"type","fixed"),mt.setClass(cl);class Tm extends ki{subscribeTargets(t){const e=t.target;t.targets.reduce(((r,s)=>(s.parent&&r.add(s.parent),r)),new Set).forEach((r=>{r.layoutManager.subscribeTargets({target:r,targets:[e]})}))}unsubscribeTargets(t){const e=t.target,r=e.getObjects();t.targets.reduce(((s,i)=>(i.parent&&s.add(i.parent),s)),new Set).forEach((s=>{!r.some((i=>i.parent===s))&&s.layoutManager.unsubscribeTargets({target:s,targets:[e]})}))}}class Cs extends As{static getDefaults(){return T(T({},super.getDefaults()),Cs.ownDefaults)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Object.assign(this,Cs.ownDefaults),this.setOptions(e);const{left:r,top:s,layoutManager:i}=e;this.groupInit(t,{left:r,top:s,layoutManager:i??new Tm})}_shouldSetNestedCoords(){return!0}__objectSelectionMonitor(){}multiSelectAdd(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];this.multiSelectionStacking==="selection-order"?this.add(...e):e.forEach((s=>{const i=this._objects.findIndex((o=>o.isInFrontOf(s))),n=i===-1?this.size():i;this.insertAt(n,s)}))}canEnterGroup(t){return this.getObjects().some((e=>e.isDescendantOf(t)||t.isDescendantOf(e)))?(us("error","ActiveSelection: circular object trees are not supported, this call has no effect"),!1):super.canEnterGroup(t)}enterGroup(t,e){t.parent&&t.parent===t.group?t.parent._exitGroup(t):t.group&&t.parent!==t.group&&t.group.remove(t),this._enterGroup(t,e)}exitGroup(t,e){this._exitGroup(t,e),t.parent&&t.parent._enterGroup(t,!0)}_onAfterObjectsChange(t,e){super._onAfterObjectsChange(t,e);const r=new Set;e.forEach((s=>{const{parent:i}=s;i&&r.add(i)})),t===sa?r.forEach((s=>{s._onAfterObjectsChange(Pn,e)})):r.forEach((s=>{s._set("dirty",!0)}))}onDeselect(){return this.removeAll(),!1}toString(){return"#<ActiveSelection: (".concat(this.complexity(),")>")}shouldCache(){return!1}isOnACache(){return!1}_renderControls(t,e,r){t.save(),t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1;const s=T(T({hasControls:!1},r),{},{forActiveSelection:!0});for(let i=0;i<this._objects.length;i++)this._objects[i]._renderControls(t,s);super._renderControls(t,e),t.restore()}}C(Cs,"type","ActiveSelection"),C(Cs,"ownDefaults",{multiSelectionStacking:"canvas-stacking"}),mt.setClass(Cs),mt.setClass(Cs,"activeSelection");class km{constructor(){C(this,"resources",{})}applyFilters(t,e,r,s,i){const n=i.getContext("2d");if(!n)return;n.drawImage(e,0,0,r,s);const o={sourceWidth:r,sourceHeight:s,imageData:n.getImageData(0,0,r,s),originalEl:e,originalImageData:n.getImageData(0,0,r,s),canvasEl:i,ctx:n,filterBackend:this};t.forEach((c=>{c.applyTo(o)}));const{imageData:l}=o;return l.width===r&&l.height===s||(i.width=l.width,i.height=l.height),n.putImageData(l,0,0),o}}class jc{constructor(){let{tileSize:t=Ht.textureSize}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};C(this,"aPosition",new Float32Array([0,0,0,1,1,0,1,1])),C(this,"resources",{}),this.tileSize=t,this.setupGLContext(t,t),this.captureGPUInfo()}setupGLContext(t,e){this.dispose(),this.createWebGLCanvas(t,e)}createWebGLCanvas(t,e){const r=ur({width:t,height:e}),s=r.getContext("webgl",{alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1});s&&(s.clearColor(0,0,0,0),this.canvas=r,this.gl=s)}applyFilters(t,e,r,s,i,n){const o=this.gl,l=i.getContext("2d");if(!o||!l)return;let c;n&&(c=this.getCachedTexture(n,e));const u={originalWidth:e.width||e.naturalWidth||0,originalHeight:e.height||e.naturalHeight||0,sourceWidth:r,sourceHeight:s,destinationWidth:r,destinationHeight:s,context:o,sourceTexture:this.createTexture(o,r,s,c?void 0:e),targetTexture:this.createTexture(o,r,s),originalTexture:c||this.createTexture(o,r,s,c?void 0:e),passes:t.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:i},d=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,d),t.forEach((g=>{g&&g.applyTo(u)})),(function(g){const f=g.targetCanvas,m=f.width,p=f.height,v=g.destinationWidth,y=g.destinationHeight;m===v&&p===y||(f.width=v,f.height=y)})(u),this.copyGLTo2D(o,u),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(u.sourceTexture),o.deleteTexture(u.targetTexture),o.deleteFramebuffer(d),l.setTransform(1,0,0,1,0,0),u}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(t,e,r,s,i){const{NEAREST:n,TEXTURE_2D:o,RGBA:l,UNSIGNED_BYTE:c,CLAMP_TO_EDGE:u,TEXTURE_MAG_FILTER:d,TEXTURE_MIN_FILTER:g,TEXTURE_WRAP_S:f,TEXTURE_WRAP_T:m}=t,p=t.createTexture();return t.bindTexture(o,p),t.texParameteri(o,d,i||n),t.texParameteri(o,g,i||n),t.texParameteri(o,f,u),t.texParameteri(o,m,u),s?t.texImage2D(o,0,l,l,c,s):t.texImage2D(o,0,l,e,r,0,l,c,null),p}getCachedTexture(t,e,r){const{textureCache:s}=this;if(s[t])return s[t];{const i=this.createTexture(this.gl,e.width,e.height,e,r);return i&&(s[t]=i),i}}evictCachesForKey(t){this.textureCache[t]&&(this.gl.deleteTexture(this.textureCache[t]),delete this.textureCache[t])}copyGLTo2D(t,e){const r=t.canvas,s=e.targetCanvas,i=s.getContext("2d");if(!i)return;i.translate(0,s.height),i.scale(1,-1);const n=r.height-s.height;i.drawImage(r,0,n,s.width,s.height,0,0,s.width,s.height)}copyGLTo2DPutImageData(t,e){const r=e.targetCanvas.getContext("2d"),s=e.destinationWidth,i=e.destinationHeight,n=s*i*4;if(!r)return;const o=new Uint8Array(this.imageBuffer,0,n),l=new Uint8ClampedArray(this.imageBuffer,0,n);t.readPixels(0,0,s,i,t.RGBA,t.UNSIGNED_BYTE,o);const c=new ImageData(l,s,i);r.putImageData(c,0,0)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const r=t.getExtension("WEBGL_debug_renderer_info");if(r){const s=t.getParameter(r.UNMASKED_RENDERER_WEBGL),i=t.getParameter(r.UNMASKED_VENDOR_WEBGL);s&&(e.renderer=s.toLowerCase()),i&&(e.vendor=i.toLowerCase())}return this.gpuInfo=e,e}}let fo;function Om(){const{WebGLProbe:a}=Lr();return a.queryWebGL(Jr()),Ht.enableGLFiltering&&a.isSupported(Ht.textureSize)?new jc({tileSize:Ht.textureSize}):new km}function mo(){return!fo&&(!(arguments.length>0&&arguments[0]!==void 0)||arguments[0])&&(fo=Om()),fo}const Am=["filters","resizeFilter","src","crossOrigin","type"],Rc=["cropX","cropY"];class sr extends Me{static getDefaults(){return T(T({},super.getDefaults()),sr.ownDefaults)}constructor(t,e){super(),C(this,"_lastScaleX",1),C(this,"_lastScaleY",1),C(this,"_filterScalingX",1),C(this,"_filterScalingY",1),this.filters=[],Object.assign(this,sr.ownDefaults),this.setOptions(e),this.cacheKey="texture".concat(ds()),this.setElement(typeof t=="string"?(this.canvas&&xr(this.canvas.getElement())||Zs()).getElementById(t):t,e)}getElement(){return this._element}setElement(t){var e;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._element=t,this._originalElement=t,this._setWidthHeight(r),(e=t.classList)===null||e===void 0||e.add(sr.CSS_CANVAS),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(t){const e=mo(!1);e instanceof jc&&e.evictCachesForKey(t)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture("".concat(this.cacheKey,"_filtered")),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((t=>{const e=this[t];e&&Lr().dispose(e),this[t]=void 0}))}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const t=this.getElement();return t?{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}:{width:0,height:0}}_stroke(t){if(!this.stroke||this.strokeWidth===0)return;const e=this.width/2,r=this.height/2;t.beginPath(),t.moveTo(-e,-r),t.lineTo(e,-r),t.lineTo(e,r),t.lineTo(-e,r),t.lineTo(-e,-r),t.closePath()}toObject(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];const e=[];return this.filters.forEach((r=>{r&&e.push(r.toObject())})),T(T({},super.toObject([...Rc,...t])),{},{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e},this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const t=[],e=this._element,r=-this.width/2,s=-this.height/2;let i=[],n=[],o="",l="";if(!e)return[];if(this.hasCrop()){const c=ds();i.push('<clipPath id="imageCrop_'+c+`">
`,'	<rect x="'+r+'" y="'+s+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),o=' clip-path="url(#imageCrop_'+c+')" '}if(this.imageSmoothing||(l=' image-rendering="optimizeSpeed"'),t.push("	<image ","COMMON_PARTS",'xlink:href="'.concat(this.getSvgSrc(!0),'" x="').concat(r-this.cropX,'" y="').concat(s-this.cropY,'" width="').concat(e.width||e.naturalWidth,'" height="').concat(e.height||e.naturalHeight,'"').concat(l).concat(o,`></image>
`)),this.stroke||this.strokeDashArray){const c=this.fill;this.fill=null,n=['	<rect x="'.concat(r,'" y="').concat(s,'" width="').concat(this.width,'" height="').concat(this.height,'" style="').concat(this.getSvgStyles(),`" />
`)],this.fill=c}return i=this.paintFirst!==we?i.concat(n,t):i.concat(t,n),i}getSrc(t){const e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src")||"":e.src:this.src||""}getSvgSrc(t){return this.getSrc(t)}setSrc(t){let{crossOrigin:e,signal:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return gn(t,{crossOrigin:e,signal:r}).then((s=>{e!==void 0&&this.set({crossOrigin:e}),this.setElement(s)}))}toString(){return'#<Image: { src: "'.concat(this.getSrc(),'" }>')}applyResizeFilters(){const t=this.resizeFilter,e=this.minimumScaleTrigger,r=this.getTotalObjectScaling(),s=r.x,i=r.y,n=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||s>e&&i>e)return this._element=n,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=s,void(this._lastScaleY=i);const o=ur(n),{width:l,height:c}=n;this._element=o,this._lastScaleX=t.scaleX=s,this._lastScaleY=t.scaleY=i,mo().applyFilters([t],n,l,c,this._element),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height}applyFilters(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.filters||[];if(t=t.filter((i=>i&&!i.isNeutralState())),this.set("dirty",!0),this.removeTexture("".concat(this.cacheKey,"_filtered")),t.length===0)return this._element=this._originalElement,this._filteredEl=void 0,this._filterScalingX=1,void(this._filterScalingY=1);const e=this._originalElement,r=e.naturalWidth||e.width,s=e.naturalHeight||e.height;if(this._element===this._originalElement){const i=ur({width:r,height:s});this._element=i,this._filteredEl=i}else this._filteredEl&&(this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,r,s),this._lastScaleX=1,this._lastScaleY=1);mo().applyFilters(t,this._originalElement,r,s,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(t){t.imageSmoothingEnabled=this.imageSmoothing,this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)}drawCacheOnCanvas(t){t.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(t)}shouldCache(){return this.needsItsOwnCache()}_renderFill(t){const e=this._element;if(!e)return;const r=this._filterScalingX,s=this._filterScalingY,i=this.width,n=this.height,o=Math.max(this.cropX,0),l=Math.max(this.cropY,0),c=e.naturalWidth||e.width,u=e.naturalHeight||e.height,d=o*r,g=l*s,f=Math.min(i*r,c-d),m=Math.min(n*s,u-g),p=-i/2,v=-n/2,y=Math.min(i,c/r-o),S=Math.min(n,u/s-l);e&&t.drawImage(e,d,g,f,m,p,v,y,S)}_needsResize(){const t=this.getTotalObjectScaling();return t.x!==this._lastScaleX||t.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight(){let{width:t,height:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r=this.getOriginalSize();this.width=t||r.width,this.height=e||r.height}parsePreserveAspectRatioAttribute(){const t=yg(this.preserveAspectRatio||""),e=this.width,r=this.height,s={width:e,height:r};let i,n=this._element.width,o=this._element.height,l=1,c=1,u=0,d=0,g=0,f=0;return!t||t.alignX===Xe&&t.alignY===Xe?(l=e/n,c=r/o):(t.meetOrSlice==="meet"&&(l=c=jf(this._element,s),i=(e-n*l)/2,t.alignX==="Min"&&(u=-i),t.alignX==="Max"&&(u=i),i=(r-o*c)/2,t.alignY==="Min"&&(d=-i),t.alignY==="Max"&&(d=i)),t.meetOrSlice==="slice"&&(l=c=Rf(this._element,s),i=n-e/l,t.alignX==="Mid"&&(g=i/2),t.alignX==="Max"&&(g=i),i=o-r/c,t.alignY==="Mid"&&(f=i/2),t.alignY==="Max"&&(f=i),n=e/l,o=r/c)),{width:n,height:o,scaleX:l,scaleY:c,offsetLeft:u,offsetTop:d,cropX:g,cropY:f}}static fromObject(t,e){let{filters:r,resizeFilter:s,src:i,crossOrigin:n,type:o}=t,l=ne(t,Am);return Promise.all([gn(i,T(T({},e),{},{crossOrigin:n})),r&&Si(r,e),s&&Si([s],e),Wn(l,e)]).then((c=>{let[u,d=[],[g]=[],f={}]=c;return new this(u,T(T({},l),{},{src:i,filters:d,resizeFilter:g},f))}))}static fromURL(t){let{crossOrigin:e=null,signal:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0;return gn(t,{crossOrigin:e,signal:r}).then((i=>new this(i,s)))}static async fromElement(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;const s=es(t,this.ATTRIBUTE_NAMES,r);return this.fromURL(s["xlink:href"]||s.href,e,s).catch((i=>(us("log","Unable to parse Image",i),null)))}}C(sr,"type","Image"),C(sr,"cacheProperties",[...ts,...Rc]),C(sr,"ownDefaults",{strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,cropX:0,cropY:0,imageSmoothing:!0}),C(sr,"CSS_CANVAS","canvas-img"),C(sr,"ATTRIBUTE_NAMES",[...gs,"x","y","width","height","preserveAspectRatio","xlink:href","href","crossOrigin","image-rendering"]),mt.setClass(sr),mt.setSVGClass(sr);Yn(["pattern","defs","symbol","metadata","clipPath","mask","desc"]);const Gn=a=>a.webgl!==void 0,ia="precision highp float",Dm=`
    `.concat(ia,`;
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`),Em=["type"],Pm=["type"],Mm=new RegExp(ia,"g");class be{get type(){return this.constructor.type}constructor(){let t=ne(arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},Em);Object.assign(this,this.constructor.defaults,t)}getFragmentSource(){return Dm}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}createProgram(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.getFragmentSource(),r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.getVertexSource();const{WebGLProbe:{GLPrecision:s="highp"}}=Lr();s!=="highp"&&(e=e.replace(Mm,ia.replace("highp",s)));const i=t.createShader(t.VERTEX_SHADER),n=t.createShader(t.FRAGMENT_SHADER),o=t.createProgram();if(!i||!n||!o)throw new Mr("Vertex, fragment shader or program creation error");if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Mr("Vertex shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(i)));if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Mr("Fragment shader compile error for ".concat(this.type,": ").concat(t.getShaderInfoLog(n)));if(t.attachShader(o,i),t.attachShader(o,n),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw new Mr('Shader link error for "'.concat(this.type,'" ').concat(t.getProgramInfoLog(o)));const l=this.getUniformLocations(t,o)||{};return l.uStepW=t.getUniformLocation(o,"uStepW"),l.uStepH=t.getUniformLocation(o,"uStepH"),{program:o,attributeLocations:this.getAttributeLocations(t,o),uniformLocations:l}}getAttributeLocations(t,e){return{aPosition:t.getAttribLocation(e,"aPosition")}}getUniformLocations(t,e){const r=this.constructor.uniformLocations,s={};for(let i=0;i<r.length;i++)s[r[i]]=t.getUniformLocation(e,r[i]);return s}sendAttributeData(t,e,r){const s=e.aPosition,i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW)}_setupFrameBuffer(t){const e=t.context;if(t.passes>1){const r=t.destinationWidth,s=t.destinationHeight;t.sourceWidth===r&&t.sourceHeight===s||(e.deleteTexture(t.targetTexture),t.targetTexture=t.filterBackend.createTexture(e,r,s)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.targetTexture,0)}else e.bindFramebuffer(e.FRAMEBUFFER,null),e.finish()}_swapTextures(t){t.passes--,t.pass++;const e=t.targetTexture;t.targetTexture=t.sourceTexture,t.sourceTexture=e}isNeutralState(t){return!1}applyTo(t){Gn(t)?(this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){}getCacheKey(){return this.type}retrieveShader(t){const e=this.getCacheKey();return t.programCache[e]||(t.programCache[e]=this.createProgram(t.context)),t.programCache[e]}applyToWebGL(t){const e=t.context,r=this.retrieveShader(t);t.pass===0&&t.originalTexture?e.bindTexture(e.TEXTURE_2D,t.originalTexture):e.bindTexture(e.TEXTURE_2D,t.sourceTexture),e.useProgram(r.program),this.sendAttributeData(e,r.attributeLocations,t.aPosition),e.uniform1f(r.uniformLocations.uStepW,1/t.sourceWidth),e.uniform1f(r.uniformLocations.uStepH,1/t.sourceHeight),this.sendUniformData(e,r.uniformLocations),e.viewport(0,0,t.destinationWidth,t.destinationHeight),e.drawArrays(e.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(t,e,r){t.activeTexture(r),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE0)}unbindAdditionalTexture(t,e){t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)}sendUniformData(t,e){}createHelpLayer(t){if(!t.helpLayer){const{sourceWidth:e,sourceHeight:r}=t,s=ur({width:e,height:r});t.helpLayer=s}}toObject(){const t=Object.keys(this.constructor.defaults||{});return T({type:this.type},t.reduce(((e,r)=>(e[r]=this[r],e)),{}))}toJSON(){return this.toObject()}static async fromObject(t,e){return new this(ne(t,Pm))}}C(be,"type","BaseFilter"),C(be,"uniformLocations",[]);const Im={multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,difference:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
    if (uColor.r < 0.5) {
      gl_FragColor.r *= 2.0 * uColor.r;
    } else {
      gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
    }
    if (uColor.g < 0.5) {
      gl_FragColor.g *= 2.0 * uColor.g;
    } else {
      gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
    }
    if (uColor.b < 0.5) {
      gl_FragColor.b *= 2.0 * uColor.b;
    } else {
      gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
    }
    `,tint:`
    gl_FragColor.rgb *= (1.0 - uColor.a);
    gl_FragColor.rgb += uColor.rgb;
    `};class Ni extends be{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          `.concat(Im[this.mode],`
        }
      }
      `)}applyTo2d(t){let{imageData:{data:e}}=t;const r=new $t(this.color).getSource(),s=this.alpha,i=r[0]*s,n=r[1]*s,o=r[2]*s,l=1-s;for(let c=0;c<e.length;c+=4){const u=e[c],d=e[c+1],g=e[c+2];let f,m,p;switch(this.mode){case"multiply":f=u*i/255,m=d*n/255,p=g*o/255;break;case"screen":f=255-(255-u)*(255-i)/255,m=255-(255-d)*(255-n)/255,p=255-(255-g)*(255-o)/255;break;case"add":f=u+i,m=d+n,p=g+o;break;case"difference":f=Math.abs(u-i),m=Math.abs(d-n),p=Math.abs(g-o);break;case"subtract":f=u-i,m=d-n,p=g-o;break;case"darken":f=Math.min(u,i),m=Math.min(d,n),p=Math.min(g,o);break;case"lighten":f=Math.max(u,i),m=Math.max(d,n),p=Math.max(g,o);break;case"overlay":f=i<128?2*u*i/255:255-2*(255-u)*(255-i)/255,m=n<128?2*d*n/255:255-2*(255-d)*(255-n)/255,p=o<128?2*g*o/255:255-2*(255-g)*(255-o)/255;break;case"exclusion":f=i+u-2*i*u/255,m=n+d-2*n*d/255,p=o+g-2*o*g/255;break;case"tint":f=i+u*l,m=n+d*l,p=o+g*l}e[c]=f,e[c+1]=m,e[c+2]=p}}sendUniformData(t,e){const r=new $t(this.color).getSource();r[0]=this.alpha*r[0]/255,r[1]=this.alpha*r[1]/255,r[2]=this.alpha*r[2]/255,r[3]=this.alpha,t.uniform4fv(e.uColor,r)}}C(Ni,"defaults",{color:"#F95C63",mode:"multiply",alpha:1}),C(Ni,"type","BlendColor"),C(Ni,"uniformLocations",["uColor"]),mt.setClass(Ni);const Lm={multiply:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.rgba *= color2.rgba;
      gl_FragColor = color;
    }
    `,mask:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform sampler2D uImage;
    uniform vec4 uColor;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec4 color2 = texture2D(uImage, vTexCoord2);
      color.a = color2.a;
      gl_FragColor = color;
    }
    `},Fm=["type","image"];class Ui extends be{getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Lm[this.mode]}getVertexSource(){return`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `}applyToWebGL(t){const e=t.context,r=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,r,e.TEXTURE1),super.applyToWebGL(t),this.unbindAdditionalTexture(e,e.TEXTURE1)}createTexture(t,e){return t.getCachedTexture(e.cacheKey,e.getElement())}calculateMatrix(){const t=this.image,{width:e,height:r}=t.getElement();return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/r,1]}applyTo2d(t){let{imageData:{data:e,width:r,height:s},filterBackend:{resources:i}}=t;const n=this.image;i.blendImage||(i.blendImage=Jr());const o=i.blendImage,l=o.getContext("2d");o.width!==r||o.height!==s?(o.width=r,o.height=s):l.clearRect(0,0,r,s),l.setTransform(n.scaleX,0,0,n.scaleY,n.left,n.top),l.drawImage(n.getElement(),0,0,r,s);const c=l.getImageData(0,0,r,s).data;for(let u=0;u<e.length;u+=4){const d=e[u],g=e[u+1],f=e[u+2],m=e[u+3],p=c[u],v=c[u+1],y=c[u+2],S=c[u+3];switch(this.mode){case"multiply":e[u]=d*p/255,e[u+1]=g*v/255,e[u+2]=f*y/255,e[u+3]=m*S/255;break;case"mask":e[u+3]=S}}}sendUniformData(t,e){const r=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,r)}toObject(){return T(T({},super.toObject()),{},{image:this.image&&this.image.toObject()})}static async fromObject(t,e){let{type:r,image:s}=t,i=ne(t,Fm);return sr.fromObject(s,e).then((n=>new this(T(T({},i),{},{image:n}))))}}C(Ui,"type","BlendImage"),C(Ui,"defaults",{mode:"multiply",alpha:1}),C(Ui,"uniformLocations",["uTransformMatrix","uImage"]),mt.setClass(Ui);class Gi extends be{getFragmentSource(){return`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float totalC = 0.0;
      float totalA = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        vec4 sample = texture2D(uTexture, vTexCoord + uDelta * percent);
        float weight = 1.0 - abs(percent);
        float alpha = weight * sample.a;
        color.rgb += sample.rgb * alpha;
        color.a += alpha;
        totalA += weight;
        totalC += alpha;
      }
      gl_FragColor.rgb = color.rgb / totalC;
      gl_FragColor.a = color.a / totalA;
    }
  `}applyTo(t){Gn(t)?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){let{imageData:{data:e,width:r,height:s}}=t;this.aspectRatio=r/s,this.horizontal=!0;let i=this.getBlurValue()*r;const n=new Uint8ClampedArray(e),o=15,l=4*r;for(let c=0;c<e.length;c+=4){let u=0,d=0,g=0,f=0,m=0;const p=c-c%l,v=p+l;for(let y=-14;y<o;y++){const S=y/o,O=4*Math.floor(i*S),A=1-Math.abs(S);let M=c+O;M<p?M=p:M>v&&(M=v);const F=e[M+3]*A;u+=e[M]*F,d+=e[M+1]*F,g+=e[M+2]*F,f+=F,m+=A}n[c]=u/f,n[c+1]=d/f,n[c+2]=g/f,n[c+3]=f/m}this.horizontal=!1,i=this.getBlurValue()*s;for(let c=0;c<n.length;c+=4){let u=0,d=0,g=0,f=0,m=0;const p=c%l,v=n.length-l+p;for(let y=-14;y<o;y++){const S=y/o,O=Math.floor(i*S)*l,A=1-Math.abs(S);let M=c+O;M<p?M=p:M>v&&(M=v);const F=n[M+3]*A;u+=n[M]*F,d+=n[M+1]*F,g+=n[M+2]*F,f+=F,m+=A}e[c]=u/f,e[c+1]=d/f,e[c+2]=g/f,e[c+3]=f/m}}sendUniformData(t,e){const r=this.chooseRightDelta();t.uniform2fv(e.uDelta,r)}isNeutralState(){return this.blur===0}getBlurValue(){let t=1;const{horizontal:e,aspectRatio:r}=this;return e?r>1&&(t=1/r):r<1&&(t=r),t*this.blur*.12}chooseRightDelta(){const t=this.getBlurValue();return this.horizontal?[t,0]:[0,t]}}C(Gi,"type","Blur"),C(Gi,"defaults",{blur:0}),C(Gi,"uniformLocations",["uDelta"]),mt.setClass(Gi);class qi extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBrightness;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += uBrightness;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=Math.round(255*this.brightness);for(let s=0;s<e.length;s+=4)e[s]+=r,e[s+1]+=r,e[s+2]+=r}isNeutralState(){return this.brightness===0}sendUniformData(t,e){t.uniform1f(e.uBrightness,this.brightness)}}C(qi,"type","Brightness"),C(qi,"defaults",{brightness:0}),C(qi,"uniformLocations",["uBrightness"]),mt.setClass(qi);const Bc={matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],colorsOnly:!0};class Hs extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  varying vec2 vTexCoord;
  uniform mat4 uColorMatrix;
  uniform vec4 uConstants;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color *= uColorMatrix;
    color += uConstants;
    gl_FragColor = color;
  }`}applyTo2d(t){const e=t.imageData.data,r=this.matrix,s=this.colorsOnly;for(let i=0;i<e.length;i+=4){const n=e[i],o=e[i+1],l=e[i+2];if(e[i]=n*r[0]+o*r[1]+l*r[2]+255*r[4],e[i+1]=n*r[5]+o*r[6]+l*r[7]+255*r[9],e[i+2]=n*r[10]+o*r[11]+l*r[12]+255*r[14],!s){const c=e[i+3];e[i]+=c*r[3],e[i+1]+=c*r[8],e[i+2]+=c*r[13],e[i+3]=n*r[15]+o*r[16]+l*r[17]+c*r[18]+255*r[19]}}}sendUniformData(t,e){const r=this.matrix,s=[r[0],r[1],r[2],r[3],r[5],r[6],r[7],r[8],r[10],r[11],r[12],r[13],r[15],r[16],r[17],r[18]],i=[r[4],r[9],r[14],r[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,s),t.uniform4fv(e.uConstants,i)}toObject(){return T(T({},super.toObject()),{},{matrix:[...this.matrix]})}}function Ms(a,t){var e;const r=(C(e=class extends Hs{toObject(){return{type:this.type,colorsOnly:this.colorsOnly}}},"type",a),C(e,"defaults",{colorsOnly:!1,matrix:t}),e);return mt.setClass(r,a),r}C(Hs,"type","ColorMatrix"),C(Hs,"defaults",Bc),C(Hs,"uniformLocations",["uColorMatrix","uConstants"]),mt.setClass(Hs);Ms("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]);Ms("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]);Ms("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]);Ms("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]);Ms("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]);Ms("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]);Ms("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]);class hl extends be{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.subFilters=t.subFilters||[]}applyTo(t){Gn(t)&&(t.passes+=this.subFilters.length-1),this.subFilters.forEach((e=>{e.applyTo(t)}))}toObject(){return{type:this.type,subFilters:this.subFilters.map((t=>t.toObject()))}}isNeutralState(){return!this.subFilters.some((t=>!t.isNeutralState()))}static fromObject(t,e){return Promise.all((t.subFilters||[]).map((r=>mt.getClass(r.type).fromObject(r,e)))).then((r=>new this({subFilters:r})))}}C(hl,"type","Composed"),mt.setClass(hl);class Ki extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uContrast;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
    color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
    gl_FragColor = color;
  }`}isNeutralState(){return this.contrast===0}applyTo2d(t){let{imageData:{data:e}}=t;const r=Math.floor(255*this.contrast),s=259*(r+255)/(255*(259-r));for(let i=0;i<e.length;i+=4)e[i]=s*(e[i]-128)+128,e[i+1]=s*(e[i+1]-128)+128,e[i+2]=s*(e[i+2]-128)+128}sendUniformData(t,e){t.uniform1f(e.uContrast,this.contrast)}}C(Ki,"type","Contrast"),C(Ki,"defaults",{contrast:0}),C(Ki,"uniformLocations",["uContrast"]),mt.setClass(Ki);const jm={Convolute_3_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_3_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[9];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 3.0; h+=1.0) {
        for (float w = 0.0; w < 3.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_5_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_5_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[25];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 5.0; h+=1.0) {
        for (float w = 0.0; w < 5.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_7_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_7_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[49];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 7.0; h+=1.0) {
        for (float w = 0.0; w < 7.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `,Convolute_9_1:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 0);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
        }
      }
      gl_FragColor = color;
    }
    `,Convolute_9_0:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uMatrix[81];
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = vec4(0, 0, 0, 1);
      for (float h = 0.0; h < 9.0; h+=1.0) {
        for (float w = 0.0; w < 9.0; w+=1.0) {
          vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
          color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
        }
      }
      float alpha = texture2D(uTexture, vTexCoord).a;
      gl_FragColor = color;
      gl_FragColor.a = alpha;
    }
    `};class $i extends be{getCacheKey(){return"".concat(this.type,"_").concat(Math.sqrt(this.matrix.length),"_").concat(this.opaque?1:0)}getFragmentSource(){return jm[this.getCacheKey()]}applyTo2d(t){const e=t.imageData,r=e.data,s=this.matrix,i=Math.round(Math.sqrt(s.length)),n=Math.floor(i/2),o=e.width,l=e.height,c=t.ctx.createImageData(o,l),u=c.data,d=this.opaque?1:0;let g,f,m,p,v,y,S,O,A,M,F,E,_;for(F=0;F<l;F++)for(M=0;M<o;M++){for(v=4*(F*o+M),g=0,f=0,m=0,p=0,_=0;_<i;_++)for(E=0;E<i;E++)S=F+_-n,y=M+E-n,S<0||S>=l||y<0||y>=o||(O=4*(S*o+y),A=s[_*i+E],g+=r[O]*A,f+=r[O+1]*A,m+=r[O+2]*A,d||(p+=r[O+3]*A));u[v]=g,u[v+1]=f,u[v+2]=m,u[v+3]=d?r[v+3]:p}t.imageData=c}sendUniformData(t,e){t.uniform1fv(e.uMatrix,this.matrix)}toObject(){return T(T({},super.toObject()),{},{opaque:this.opaque,matrix:[...this.matrix]})}}C($i,"type","Convolute"),C($i,"defaults",{opaque:!1,matrix:[0,0,0,0,1,0,0,0,0]}),C($i,"uniformLocations",["uMatrix","uOpaque","uHalfSize","uSize"]),mt.setClass($i);const zc="Gamma";class Zi extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform vec3 uGamma;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec3 correction = (1.0 / uGamma);
    color.r = pow(color.r, correction.r);
    color.g = pow(color.g, correction.g);
    color.b = pow(color.b, correction.b);
    gl_FragColor = color;
    gl_FragColor.rgb *= color.a;
  }
`}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(t),this.gamma=t.gamma||this.constructor.defaults.gamma.concat()}applyTo2d(t){let{imageData:{data:e}}=t;const r=this.gamma,s=1/r[0],i=1/r[1],n=1/r[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});const o=this.rgbValues;for(let l=0;l<256;l++)o.r[l]=255*Math.pow(l/255,s),o.g[l]=255*Math.pow(l/255,i),o.b[l]=255*Math.pow(l/255,n);for(let l=0;l<e.length;l+=4)e[l]=o.r[e[l]],e[l+1]=o.g[e[l+1]],e[l+2]=o.b[e[l+2]]}sendUniformData(t,e){t.uniform3fv(e.uGamma,this.gamma)}isNeutralState(){const{gamma:t}=this;return t[0]===1&&t[1]===1&&t[2]===1}toObject(){return{type:zc,gamma:this.gamma.concat()}}}C(Zi,"type",zc),C(Zi,"defaults",{gamma:[1,1,1]}),C(Zi,"uniformLocations",["uGamma"]),mt.setClass(Zi);const Rm={average:`
    precision highp float;
    uniform sampler2D uTexture;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float average = (color.r + color.b + color.g) / 3.0;
      gl_FragColor = vec4(average, average, average, color.a);
    }
    `,lightness:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `,luminosity:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uMode;
    varying vec2 vTexCoord;
    void main() {
      vec4 col = texture2D(uTexture, vTexCoord);
      float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
      gl_FragColor = vec4(average, average, average, col.a);
    }
    `};class Ji extends be{applyTo2d(t){let{imageData:{data:e}}=t;for(let r,s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2];switch(this.mode){case"average":r=(i+n+o)/3;break;case"lightness":r=(Math.min(i,n,o)+Math.max(i,n,o))/2;break;case"luminosity":r=.21*i+.72*n+.07*o}e[s+2]=e[s+1]=e[s]=r}}getCacheKey(){return"".concat(this.type,"_").concat(this.mode)}getFragmentSource(){return Rm[this.mode]}sendUniformData(t,e){t.uniform1i(e.uMode,1)}isNeutralState(){return!1}}C(Ji,"type","Grayscale"),C(Ji,"defaults",{mode:"average"}),C(Ji,"uniformLocations",["uMode"]),mt.setClass(Ji);const Bm=T(T({},Bc),{},{rotation:0});class po extends Hs{calculateMatrix(){const t=this.rotation*Math.PI,e=$r(t),r=Zr(t),s=1/3,i=Math.sqrt(s)*r,n=1-e;this.matrix=[e+n/3,s*n-i,s*n+i,0,0,s*n+i,e+s*n,s*n-i,0,0,s*n-i,s*n+i,e+s*n,0,0,0,0,0,1,0]}isNeutralState(){return this.rotation===0}applyTo(t){this.calculateMatrix(),super.applyTo(t)}toObject(){return{type:this.type,rotation:this.rotation}}}C(po,"type","HueRotation"),C(po,"defaults",Bm),mt.setClass(po);class Qi extends be{applyTo2d(t){let{imageData:{data:e}}=t;for(let r=0;r<e.length;r+=4)e[r]=255-e[r],e[r+1]=255-e[r+1],e[r+2]=255-e[r+2],this.alpha&&(e[r+3]=255-e[r+3])}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform int uInvert;
  uniform int uAlpha;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    if (uInvert == 1) {
      if (uAlpha == 1) {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
      } else {
        gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
      }
    } else {
      gl_FragColor = color;
    }
  }
`}isNeutralState(){return!this.invert}sendUniformData(t,e){t.uniform1i(e.uInvert,Number(this.invert)),t.uniform1i(e.uAlpha,Number(this.alpha))}}C(Qi,"type","Invert"),C(Qi,"defaults",{alpha:!1,invert:!0}),C(Qi,"uniformLocations",["uInvert","uAlpha"]),mt.setClass(Qi);class tn extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uStepH;
  uniform float uNoise;
  uniform float uSeed;
  varying vec2 vTexCoord;
  float rand(vec2 co, float seed, float vScale) {
    return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
  }
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=this.noise;for(let s=0;s<e.length;s+=4){const i=(.5-Math.random())*r;e[s]+=i,e[s+1]+=i,e[s+2]+=i}}sendUniformData(t,e){t.uniform1f(e.uNoise,this.noise/255),t.uniform1f(e.uSeed,Math.random())}isNeutralState(){return this.noise===0}}C(tn,"type","Noise"),C(tn,"defaults",{noise:0}),C(tn,"uniformLocations",["uNoise","uSeed"]),mt.setClass(tn);class en extends be{applyTo2d(t){let{imageData:{data:e,width:r,height:s}}=t;for(let i=0;i<s;i+=this.blocksize)for(let n=0;n<r;n+=this.blocksize){const o=4*i*r+4*n,l=e[o],c=e[o+1],u=e[o+2],d=e[o+3];for(let g=i;g<Math.min(i+this.blocksize,s);g++)for(let f=n;f<Math.min(n+this.blocksize,r);f++){const m=4*g*r+4*f;e[m]=l,e[m+1]=c,e[m+2]=u,e[m+3]=d}}}isNeutralState(){return this.blocksize===1}getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uBlocksize;
  uniform float uStepW;
  uniform float uStepH;
  varying vec2 vTexCoord;
  void main() {
    float blockW = uBlocksize * uStepW;
    float blockH = uBlocksize * uStepH;
    int posX = int(vTexCoord.x / blockW);
    int posY = int(vTexCoord.y / blockH);
    float fposX = float(posX);
    float fposY = float(posY);
    vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
    vec4 color = texture2D(uTexture, squareCoords);
    gl_FragColor = color;
  }
`}sendUniformData(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}}C(en,"type","Pixelate"),C(en,"defaults",{blocksize:4}),C(en,"uniformLocations",["uBlocksize"]),mt.setClass(en);class rn extends be{getFragmentSource(){return`
precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
  gl_FragColor = texture2D(uTexture, vTexCoord);
  if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
    gl_FragColor.a = 0.0;
  }
}
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=255*this.distance,s=new $t(this.color).getSource(),i=[s[0]-r,s[1]-r,s[2]-r],n=[s[0]+r,s[1]+r,s[2]+r];for(let o=0;o<e.length;o+=4){const l=e[o],c=e[o+1],u=e[o+2];l>i[0]&&c>i[1]&&u>i[2]&&l<n[0]&&c<n[1]&&u<n[2]&&(e[o+3]=0)}}sendUniformData(t,e){const r=new $t(this.color).getSource(),s=this.distance,i=[0+r[0]/255-s,0+r[1]/255-s,0+r[2]/255-s,1],n=[r[0]/255+s,r[1]/255+s,r[2]/255+s,1];t.uniform4fv(e.uLow,i),t.uniform4fv(e.uHigh,n)}}C(rn,"type","RemoveColor"),C(rn,"defaults",{color:"#FFFFFF",distance:.02,useAlpha:!1}),C(rn,"uniformLocations",["uLow","uHigh"]),mt.setClass(rn);class sn extends be{sendUniformData(t,e){t.uniform2fv(e.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),t.uniform1fv(e.uTaps,this.taps)}getFilterWindow(){const t=this.tempScale;return Math.ceil(this.lanczosLobes/t)}getCacheKey(){const t=this.getFilterWindow();return"".concat(this.type,"_").concat(t)}getFragmentSource(){const t=this.getFilterWindow();return this.generateShader(t)}getTaps(){const t=this.lanczosCreate(this.lanczosLobes),e=this.tempScale,r=this.getFilterWindow(),s=new Array(r);for(let i=1;i<=r;i++)s[i-1]=t(i*e);return s}generateShader(t){const e=new Array(t);for(let r=1;r<=t;r++)e[r-1]="".concat(r,".0 * uDelta");return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec2 uDelta;
      varying vec2 vTexCoord;
      uniform float uTaps[`.concat(t,`];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        `).concat(e.map(((r,s)=>`
              color += texture2D(uTexture, vTexCoord + `.concat(r,") * uTaps[").concat(s,"] + texture2D(uTexture, vTexCoord - ").concat(r,") * uTaps[").concat(s,`];
              sum += 2.0 * uTaps[`).concat(s,`];
            `))).join(`
`),`
        gl_FragColor = color / sum;
      }
    `)}applyToForWebgl(t){t.passes++,this.width=t.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=t.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),t.destinationWidth=this.dW,super.applyTo(t),t.sourceWidth=t.destinationWidth,this.height=t.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),t.destinationHeight=this.dH,super.applyTo(t),t.sourceHeight=t.destinationHeight}applyTo(t){Gn(t)?this.applyToForWebgl(t):this.applyTo2d(t)}isNeutralState(){return this.scaleX===1&&this.scaleY===1}lanczosCreate(t){return e=>{if(e>=t||e<=-t)return 0;if(e<11920929e-14&&e>-11920929e-14)return 1;const r=(e*=Math.PI)/t;return Math.sin(e)/e*Math.sin(r)/r}}applyTo2d(t){const e=t.imageData,r=this.scaleX,s=this.scaleY;this.rcpScaleX=1/r,this.rcpScaleY=1/s;const i=e.width,n=e.height,o=Math.round(i*r),l=Math.round(n*s);let c;c=this.resizeType==="sliceHack"?this.sliceByTwo(t,i,n,o,l):this.resizeType==="hermite"?this.hermiteFastResize(t,i,n,o,l):this.resizeType==="bilinear"?this.bilinearFiltering(t,i,n,o,l):this.resizeType==="lanczos"?this.lanczosResize(t,i,n,o,l):new ImageData(o,l),t.imageData=c}sliceByTwo(t,e,r,s,i){const n=t.imageData,o=.5;let l=!1,c=!1,u=e*o,d=r*o;const g=t.filterBackend.resources;let f=0,m=0;const p=e;let v=0;g.sliceByTwo||(g.sliceByTwo=Jr());const y=g.sliceByTwo;(y.width<1.5*e||y.height<r)&&(y.width=1.5*e,y.height=r);const S=y.getContext("2d");for(S.clearRect(0,0,1.5*e,r),S.putImageData(n,0,0),s=Math.floor(s),i=Math.floor(i);!l||!c;)e=u,r=d,s<Math.floor(u*o)?u=Math.floor(u*o):(u=s,l=!0),i<Math.floor(d*o)?d=Math.floor(d*o):(d=i,c=!0),S.drawImage(y,f,m,e,r,p,v,u,d),f=p,m=v,v+=d;return S.getImageData(f,m,s,i)}lanczosResize(t,e,r,s,i){const n=t.imageData.data,o=t.ctx.createImageData(s,i),l=o.data,c=this.lanczosCreate(this.lanczosLobes),u=this.rcpScaleX,d=this.rcpScaleY,g=2/this.rcpScaleX,f=2/this.rcpScaleY,m=Math.ceil(u*this.lanczosLobes/2),p=Math.ceil(d*this.lanczosLobes/2),v={},y={x:0,y:0},S={x:0,y:0};return(function O(A){let M,F,E,_,j,Y,G,R,V,W,tt;for(y.x=(A+.5)*u,S.x=Math.floor(y.x),M=0;M<i;M++){for(y.y=(M+.5)*d,S.y=Math.floor(y.y),j=0,Y=0,G=0,R=0,V=0,F=S.x-m;F<=S.x+m;F++)if(!(F<0||F>=e)){W=Math.floor(1e3*Math.abs(F-y.x)),v[W]||(v[W]={});for(let et=S.y-p;et<=S.y+p;et++)et<0||et>=r||(tt=Math.floor(1e3*Math.abs(et-y.y)),v[W][tt]||(v[W][tt]=c(Math.sqrt(Math.pow(W*g,2)+Math.pow(tt*f,2))/1e3)),E=v[W][tt],E>0&&(_=4*(et*e+F),j+=E,Y+=E*n[_],G+=E*n[_+1],R+=E*n[_+2],V+=E*n[_+3]))}_=4*(M*s+A),l[_]=Y/j,l[_+1]=G/j,l[_+2]=R/j,l[_+3]=V/j}return++A<s?O(A):o})(0)}bilinearFiltering(t,e,r,s,i){let n,o,l,c,u,d,g,f,m,p,v,y,S,O=0;const A=this.rcpScaleX,M=this.rcpScaleY,F=4*(e-1),E=t.imageData.data,_=t.ctx.createImageData(s,i),j=_.data;for(g=0;g<i;g++)for(f=0;f<s;f++)for(u=Math.floor(A*f),d=Math.floor(M*g),m=A*f-u,p=M*g-d,S=4*(d*e+u),v=0;v<4;v++)n=E[S+v],o=E[S+4+v],l=E[S+F+v],c=E[S+F+4+v],y=n*(1-m)*(1-p)+o*m*(1-p)+l*p*(1-m)+c*m*p,j[O++]=y;return _}hermiteFastResize(t,e,r,s,i){const n=this.rcpScaleX,o=this.rcpScaleY,l=Math.ceil(n/2),c=Math.ceil(o/2),u=t.imageData.data,d=t.ctx.createImageData(s,i),g=d.data;for(let f=0;f<i;f++)for(let m=0;m<s;m++){const p=4*(m+f*s);let v=0,y=0,S=0,O=0,A=0,M=0,F=0;const E=(f+.5)*o;for(let _=Math.floor(f*o);_<(f+1)*o;_++){const j=Math.abs(E-(_+.5))/c,Y=(m+.5)*n,G=j*j;for(let R=Math.floor(m*n);R<(m+1)*n;R++){let V=Math.abs(Y-(R+.5))/l;const W=Math.sqrt(G+V*V);W>1&&W<-1||(v=2*W*W*W-3*W*W+1,v>0&&(V=4*(R+_*e),F+=v*u[V+3],S+=v,u[V+3]<255&&(v=v*u[V+3]/250),O+=v*u[V],A+=v*u[V+1],M+=v*u[V+2],y+=v))}}g[p]=O/y,g[p+1]=A/y,g[p+2]=M/y,g[p+3]=F/S}return d}}C(sn,"type","Resize"),C(sn,"defaults",{resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3}),C(sn,"uniformLocations",["uDelta","uTaps"]),mt.setClass(sn);class nn extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uSaturation;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float rgMax = max(color.r, color.g);
    float rgbMax = max(rgMax, color.b);
    color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
    color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
    color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=-this.saturation;for(let s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2],l=Math.max(i,n,o);e[s]+=l!==i?(l-i)*r:0,e[s+1]+=l!==n?(l-n)*r:0,e[s+2]+=l!==o?(l-o)*r:0}}sendUniformData(t,e){t.uniform1f(e.uSaturation,-this.saturation)}isNeutralState(){return this.saturation===0}}C(nn,"type","Saturation"),C(nn,"defaults",{saturation:0}),C(nn,"uniformLocations",["uSaturation"]),mt.setClass(nn);class on extends be{getFragmentSource(){return`
  precision highp float;
  uniform sampler2D uTexture;
  uniform float uVibrance;
  varying vec2 vTexCoord;
  void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    float max = max(color.r, max(color.g, color.b));
    float avg = (color.r + color.g + color.b) / 3.0;
    float amt = (abs(max - avg) * 2.0) * uVibrance;
    color.r += max != color.r ? (max - color.r) * amt : 0.00;
    color.g += max != color.g ? (max - color.g) * amt : 0.00;
    color.b += max != color.b ? (max - color.b) * amt : 0.00;
    gl_FragColor = color;
  }
`}applyTo2d(t){let{imageData:{data:e}}=t;const r=-this.vibrance;for(let s=0;s<e.length;s+=4){const i=e[s],n=e[s+1],o=e[s+2],l=Math.max(i,n,o),c=(i+n+o)/3,u=2*Math.abs(l-c)/255*r;e[s]+=l!==i?(l-i)*u:0,e[s+1]+=l!==n?(l-n)*u:0,e[s+2]+=l!==o?(l-o)*u:0}}sendUniformData(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}isNeutralState(){return this.vibrance===0}}C(on,"type","Vibrance"),C(on,"defaults",{vibrance:0}),C(on,"uniformLocations",["uVibrance"]),mt.setClass(on);var zm=q('<button type="button" class="w-full flex place-items-center gap-2 rounded-lg ps-1 pe-4 py-2 hover:bg-immich-primary/25"><!> <p class="text-sm"> </p></button>'),Vm=q('<div class="mt-2 rounded-lg"></div>'),Wm=q('<div class="flex items-center justify-center py-4"><p class="text-sm text-gray-500"> </p></div>'),Hm=q('<div class="absolute start-0 top-0"><canvas id="face-editor" class="absolute top-0 start-0"></canvas> <div id="face-selector" class="absolute top-[calc(50%-250px)] start-[calc(50%-125px)] max-w-[250px] w-[250px] bg-white dark:bg-immich-dark-gray dark:text-immich-dark-fg backdrop-blur-sm px-2 py-4 rounded-xl border border-gray-200 dark:border-gray-800"><p class="text-center text-sm"> </p> <div class="my-3 relative"><!></div> <div class="h-62.5 overflow-y-auto mt-2"><!></div> <!></div></div>');function Vc(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=st(void 0),n=st(void 0),o=st(void 0),l=st(void 0),c=st(1),u=st(de([])),d=st(""),g=x(()=>h(d)?h(u).filter(z=>z.name.toLowerCase().includes(h(d).toLowerCase())):h(u));const f=()=>{Es.ownDefaults={...Es.ownDefaults,cornerStyle:"circle",cornerColor:"rgb(153,166,251)",cornerSize:10,padding:8,transparentCorners:!1,lockRotation:!0,hasBorders:!0}},m=()=>{!h(i)||!t.htmlElement||(U(n,new Po(h(i)),!0),f(),U(o,new yr({fill:"rgba(66,80,175,0.25)",stroke:"rgb(66,80,175)",strokeWidth:2,strokeUniform:!0,width:112,height:112,objectCaching:!0,rx:8,ry:8}),!0),h(n).add(h(o)),h(n).setActiveObject(h(o)))};lr(async()=>{m(),await y()}),Ee(()=>{const{actualWidth:z,actualHeight:Z}=p(t.htmlElement),Q={width:(t.containerWidth-z)/2,height:(t.containerHeight-Z)/2},rt={top:Q.height,left:Q.width,width:t.containerWidth-Q.width*2,height:t.containerHeight-Q.height*2};h(n)&&(h(n).setDimensions({width:t.containerWidth,height:t.containerHeight}),h(o)&&(h(o).set({top:rt.top+200,left:rt.left+200}),h(o).setCoords(),S()))});const p=z=>{if(z instanceof HTMLImageElement){const Z=z.naturalWidth/z.naturalHeight;let Q=z.height*Z,rt=z.height;return Q>z.width&&(Q=z.width,rt=z.width/Z),{actualWidth:Q,actualHeight:rt}}else if(z instanceof HTMLVideoElement){const Z=z.videoWidth/z.videoHeight;let Q=z.clientHeight*Z,rt=z.clientHeight;return Q>z.clientWidth&&(Q=z.clientWidth,rt=z.clientWidth/Z),{actualWidth:Q,actualHeight:rt}}return{actualWidth:0,actualHeight:0}},v=()=>{hs.value=!1},y=async()=>{const{hasNextPage:z,people:Z,total:Q}=await El({page:h(c),size:1e3,withHidden:!1});h(u).length!==Q&&(U(u,[...h(u),...Z],!0),z&&qc(c))},S=()=>{if(!h(o)||!h(l))return;const z=h(o).getBoundingRect(),Z=h(l).offsetWidth,Q=h(l).offsetHeight,rt=z.top,nt=t.containerHeight-(z.top+z.height),ut=z.left,lt=t.containerWidth-(z.left+z.width);let dt,P;nt>=Q||nt>=rt&&nt>=ut&&nt>=lt?(dt=z.top+z.height+15,P=z.left):rt>=Q||rt>=nt&&rt>=ut&&rt>=lt?(dt=z.top-Q-15,P=z.left):lt>=Z||lt>=ut&&lt>=rt&&lt>=nt?(dt=z.top,P=z.left+z.width+15):(dt=z.top,P=z.left-Z-15),P+Z>t.containerWidth&&(P=t.containerWidth-Z-15),P<0&&(P=15),dt+Q>t.containerHeight&&(dt=t.containerHeight-Q-15),dt<0&&(dt=15),h(l).style.top=`${dt}px`,h(l).style.left=`${P}px`};Ee(()=>{h(o)&&(h(o).on("moving",S),h(o).on("scaling",S))});const O=()=>{if(!h(o)||!t.htmlElement)return;const{left:z,top:Z,width:Q,height:rt}=h(o).getBoundingRect(),{actualWidth:nt,actualHeight:ut}=p(t.htmlElement),lt={width:(t.containerWidth-nt)/2,height:(t.containerHeight-ut)/2},dt=(z-lt.width)/nt,P=(Z-lt.height)/ut,H=(z+Q-lt.width)/nt,X=(Z+rt-lt.height)/ut;if(t.htmlElement instanceof HTMLImageElement){const N=dt*t.htmlElement.naturalWidth,I=P*t.htmlElement.naturalHeight,J=H*t.htmlElement.naturalWidth,yt=X*t.htmlElement.naturalHeight;return{imageWidth:t.htmlElement.naturalWidth,imageHeight:t.htmlElement.naturalHeight,x:Math.floor(N),y:Math.floor(I),width:Math.floor(J-N),height:Math.floor(yt-I)}}else if(t.htmlElement instanceof HTMLVideoElement){const N=dt*t.htmlElement.videoWidth,I=P*t.htmlElement.videoHeight,J=H*t.htmlElement.videoWidth,yt=X*t.htmlElement.videoHeight;return{imageWidth:t.htmlElement.videoWidth,imageHeight:t.htmlElement.videoHeight,x:Math.floor(N),y:Math.floor(I),width:Math.floor(J-N),height:Math.floor(yt-I)}}},A=async z=>{try{const Z=O();if(!Z){cr.warning(e()("error_tag_face_bounding_box"));return}if(!await Or.showDialog({prompt:z.name?e()("confirm_tag_face",{values:{name:z.name}}):e()("confirm_tag_face_unnamed")}))return;await Eu({assetFaceCreateDto:{assetId:t.assetId,personId:z.id,...Z}}),await wn.setAssetId(t.assetId)}catch(Z){he(Z,"Error tagging face")}finally{hs.value=!1}};var M=Hm(),F=b(M);or(F,z=>U(i,z),()=>h(i));var E=k(F,2),_=b(E),j=b(_,!0);w(_);var Y=k(_,2),G=b(Y);{let z=x(()=>e()("search_people"));$u(G,{get placeholder(){return h(z)},size:"tiny",get value(){return h(d)},set value(Z){U(d,Z,!0)}})}w(Y);var R=k(Y,2),V=b(R);{var W=z=>{var Z=Vm();kr(Z,21,()=>h(g),Q=>Q.id,(Q,rt)=>{var nt=zm();nt.__click=()=>A(h(rt));var ut=b(nt);{let P=x(()=>yi(h(rt)));os(ut,{curve:!0,shadow:!0,get url(){return h(P)},get altText(){return h(rt).name},get title(){return h(rt).name},widthStyle:"30px",heightStyle:"30px"})}var lt=k(ut,2),dt=b(lt,!0);w(lt),w(nt),ct(()=>ft(dt,h(rt).name)),D(Q,nt)}),w(Z),D(z,Z)},tt=z=>{var Z=Wm(),Q=b(Z),rt=b(Q,!0);w(Q),w(Z),ct(nt=>ft(rt,nt),[()=>e()("no_people_found")]),D(z,Z)};K(V,z=>{h(g).length>0?z(W):z(tt,!1)})}w(R);var et=k(R,2);pn(et,{size:"small",fullWidth:!0,onclick:v,color:"danger",class:"mt-2",children:(z,Z)=>{ir();var Q=xe();ct(rt=>ft(Q,rt),[()=>e()("cancel")]),D(z,Q)},$$slots:{default:!0}}),w(E),or(E,z=>U(l,z),()=>h(l)),w(M),ct(z=>ft(j,z),[()=>e()("select_person_to_tag")]),D(a,M),Ot(),s()}Fr(["click"]);const Ym=a=>{const t=a.naturalWidth/a.naturalHeight;let e=a.height*t,r=a.height;return e>a.width&&(e=a.width,r=a.width/t),{width:e,height:r}},Xm=a=>{const[t,e,r,s]=a,i=Math.min(...a.map(({x:A})=>A)),n=Math.max(...a.map(({x:A})=>A)),o=Math.min(...a.map(({y:A})=>A)),l=Math.max(...a.map(({y:A})=>A)),c=n-i,u=l-o,d=(i+n)/2,g=(o+l)/2,f=Math.atan2(r.y-s.y,r.x-s.x)*(180/Math.PI),m=Math.atan2(s.y-t.y,s.x-t.x),v=(Math.atan2(r.y-e.y,r.x-e.x)-m)*(180/Math.PI),y=Math.atan2(e.y-t.y,e.x-t.x),O=(Math.atan2(r.y-s.y,r.x-s.x)-y)*(180/Math.PI);return{minX:i,maxX:n,minY:o,maxY:l,width:c,height:u,centerX:d,centerY:g,rotation:f,skewX:v,skewY:O}},Nm=(a,t,e)=>{const r=[];if(e===null||!e.naturalWidth||!e.naturalHeight)return r;const s=e.clientHeight,i=e.clientWidth,{width:n,height:o}=Ym(e),l=e.naturalWidth,c=e.naturalHeight;for(const u of a){const d=[{x:u.x1,y:u.y1},{x:u.x2,y:u.y2},{x:u.x3,y:u.y3},{x:u.x4,y:u.y4}].map(g=>({x:n/l*t.currentZoom*g.x*l+(i-n)/2*t.currentZoom+t.currentPositionX,y:o/c*t.currentZoom*g.y*c+(s-o)/2*t.currentZoom+t.currentPositionY}));r.push({id:u.id,points:d,text:u.text,confidence:u.textScore})}return r};var Um=q('<div class="absolute group left-0 top-0 pointer-events-none"><div class="absolute border-2 border-blue-500 bg-blue-500/10 cursor-pointer pointer-events-auto transition-all group-hover:bg-blue-500/30 group-hover:border-blue-600 group-hover:border-[3px]"></div> <div class="absolute flex items-center justify-center text-transparent text-sm px-2 py-1 pointer-events-auto cursor-text whitespace-pre-wrap wrap-break-word select-text group-hover:text-white group-hover:bg-black/75 group-hover:z-10"> </div></div>');function Gm(a,t){kt(t,!0);const e=x(()=>Xm(t.ocrBox.points)),r=x(()=>`translate(${h(e).minX}px, ${h(e).minY}px) rotate(${h(e).rotation}deg) skew(${h(e).skewX}deg, ${h(e).skewY}deg)`),s=x(()=>`${h(e).centerX-h(e).minX}px ${h(e).centerY-h(e).minY}px`);var i=Um(),n=b(i),o=k(n,2),l=b(o,!0);w(o),w(i),ct(()=>{cs(n,`width: ${h(e).width??""}px; height: ${h(e).height??""}px; transform: ${h(r)??""}; transform-origin: ${h(s)??""};`),cs(o,`width: ${h(e).width??""}px; height: ${h(e).height??""}px; transform: ${h(r)??""}; transform-origin: ${h(s)??""};`),ft(l,t.ocrBox.text)}),D(a,i),Ot()}function qm(a,t){kt(t,!0);const e=Gh(t,["$$slots","$$events","$$legacy"]);lr(()=>{const r={};for(const[s,i]of Object.entries(e))if(i){const n=s.slice(2);r[n]=i}return Rt.on(r)}),Ot()}class Km{#t=st(de([]));#r=st(!1);get showOverlay(){return h(this.#r)}set showOverlay(t){U(this.#r,t,!0)}#i=x(()=>h(this.#t).length>0);#s=new Ju;#e=!1;get data(){return h(this.#t)}get hasOcrData(){return h(this.#i)}async getAssetOcr(t){this.#e&&(await this.#s.reset(),this.#e=!1),await this.#s.execute(async()=>{U(this.#t,await Zu.getAssetOcr(t),!0)},!1)}clear(){this.#e=!0,U(this.#t,[],!0),this.showOverlay=!1}toggleOcrBoundingBox(){this.showOverlay=!this.showOverlay}}const Ir=new Km,Gr=Kc([]),$m=a=>{const t=a.naturalWidth/a.naturalHeight;let e=a.height*t,r=a.height;return e>a.width&&(e=a.width,r=a.width/t),{width:e,height:r}},Zm=(a,t,e)=>{const r=[];if(!e)return r;const s=e.clientHeight,i=e.clientWidth,{width:n,height:o}=$m(e);for(const l of a){const c={x1:n/l.imageWidth*t.currentZoom*l.boundingBoxX1+(i-n)/2*t.currentZoom+t.currentPositionX,x2:n/l.imageWidth*t.currentZoom*l.boundingBoxX2+(i-n)/2*t.currentZoom+t.currentPositionX,y1:o/l.imageHeight*t.currentZoom*l.boundingBoxY1+(s-o)/2*t.currentZoom+t.currentPositionY,y2:o/l.imageHeight*t.currentZoom*l.boundingBoxY2+(s-o)/2*t.currentZoom+t.currentPositionY};r.push({top:Math.round(c.y1),left:Math.round(c.x1),width:Math.round(c.x2-c.x1),height:Math.round(c.y2-c.y1)})}return r},Wc=async(a,t,e,r)=>{let s;if(e===as.Image)s=r;else if(e===as.Video){const y=ks({id:t}),S=new Image;S.src=y,await new Promise(O=>{S.addEventListener("load",()=>O()),S.addEventListener("error",()=>O())}),s=S}if(!s)return null;const{boundingBoxX1:i,boundingBoxX2:n,boundingBoxY1:o,boundingBoxY2:l,imageWidth:c,imageHeight:u}=a,d={x1:s.naturalWidth/c*i,x2:s.naturalWidth/c*n,y1:s.naturalHeight/u*o,y2:s.naturalHeight/u*l},g=d.x2-d.x1,f=d.y2-d.y1,m=new Image;m.src=s.src,await new Promise(y=>{m.addEventListener("load",y),m.addEventListener("error",()=>y(null))});const p=document.createElement("canvas");p.width=g,p.height=f;const v=p.getContext("2d");return v?(v.drawImage(m,d.x1,d.y1,g,f,0,0,g,f),p.toDataURL()):null},Jm=300,Qm=60,Hc="none";function tp(a){return Array.isArray(a)?a:[a]}function ui(a,t,e){return a.addEventListener(t,e),()=>a.removeEventListener(t,e)}function ep(a,t){return t.filter(e=>a.pointerId!==e.pointerId)}function rp(a,t){const e=a.getBoundingClientRect();return{x:Math.round(t.clientX-e.left),y:Math.round(t.clientY-e.top)}}function sp(a,t,e){const{x:r,y:s}=rp(a,t);return{event:t,pointersCount:e.length,target:t.target,x:r,y:s,attachmentNode:a}}function vo(a,t,e,r,s){const i=sp(a,e,r);return a.dispatchEvent(new CustomEvent(`${t}${s}`,{detail:i})),i}function ip(){let a=[],t=()=>{},e=[];return{setPointerControls:(r,s,i,n,o,l=Hc,c=[])=>(s.style.touchAction=tp(l).join(" "),e=c,e.forEach(u=>{u.onInit?.(a)}),a.length||(t=ui(s,"pointerdown",function(d){a.push(d);const g=vo(s,r,d,a,"down");n?.(a,d),setTimeout(()=>{e.forEach(O=>{O.onDown?.(g,a)})});function f(O){const A=a.length;if(a=ep(O,a),A>a.length){a.length||m();const F=vo(s,r,O,a,"up");o?.(a,O),setTimeout(()=>{e.forEach(E=>{E.onUp?.(F,a)})})}}function m(){p(),v(),y(),S()}const p=ui(s,"pointermove",O=>{a=a.map(M=>O.pointerId===M.pointerId?O:M);const A=vo(s,r,O,a,"move");i?.(a,O),e.forEach(M=>{M.onMove?.(A,a)})}),v=ui(s,"lostpointercapture",O=>{f(O)}),y=ui(s,"pointerup",O=>{f(O)}),S=ui(s,"pointerleave",O=>{f(O)})})),{destroy:()=>{a.length||(t(),e.forEach(u=>{u.onDestroy?.()}))}})}}const np="@attach";function op(){return Symbol(np)}const mn="swipe";function na(a,t,e,r=!1){const{setPointerControls:s}=ip(),i=r?mn:op();return{...e,[`on${mn}`]:a,[i]:n=>{const{onDown:o,onUp:l,parameters:c}=ap(n,t?.());return s(mn,n,null,o,l,c.touchAction,c.plugins).destroy}}}function ap(a,t){const e={timeframe:Jm,minSwipeDistance:Qm,touchAction:Hc,composed:!1,...t};let r,s,i,n;function o(c,u){s=u.clientX,i=u.clientY,r=Date.now(),c.length===1&&(n=u.target)}function l(c,u){if(u.type==="pointerup"&&c.length===0&&Date.now()-r<e.timeframe){const d=u.clientX-s,g=u.clientY-i,f=Math.abs(d),m=Math.abs(g);let p=null;f>=2*m&&f>e.minSwipeDistance?p=d>0?"right":"left":m>=2*f&&m>e.minSwipeDistance&&(p=g>0?"bottom":"top"),p&&a.dispatchEvent(new CustomEvent(mn,{detail:{direction:p,target:n,pointerType:u.pointerType}}))}}return{onDown:o,onUp:l,parameters:e}}var lp=q('<div id="broken-asset" class="h-full w-full svelte-raj50z"><!></div>'),cp=q('<div id="spinner" class="flex h-full items-center justify-center svelte-raj50z"><!></div>'),hp=q('<img alt="" class="-z-1 absolute top-0 start-0 object-cover h-full w-full blur-lg" draggable="false"/>'),up=q('<div class="absolute border-solid border-white border-3 rounded-lg"></div>'),dp=q('<div><!> <img draggable="false"/> <!> <!></div> <!>',1),gp=q('<!> <!> <img style="display:none" alt="" aria-hidden="true"/> <div class="relative h-full w-full select-none"><!></div>',1);function Io(a,t){kt(t,!0);const e=()=>ht(Gr,"$boundingBoxesArray",o),r=()=>ht(Ft,"$t",o),s=()=>ht(m,"$slideshowState",o),i=()=>ht(p,"$slideshowLook",o),n=()=>ht(Dl,"$getAltText",o),[o,l]=Et();let c=St(t,"element",15),u=St(t,"haveFadeTransition",3,!0),d=St(t,"sharedLink",3,void 0),g=St(t,"onPreviousAsset",3,null),f=St(t,"onNextAsset",3,null);const{slideshowState:m,slideshowLook:p}=jn,v=x(()=>t.cursor.current);let y=st(!1),S=st(!1),O=st(!1),A=st(void 0);Rt.zoomState={currentRotation:0,currentZoom:1,enable:!0,currentPositionX:0,currentPositionY:0},qs(()=>{te(Gr,[])});let M=x(()=>Ir.showOverlay&&Rt.imgRef?Nm(Ir.data,Rt.zoomState,Rt.imgRef):[]),F=x(()=>Ir.showOverlay);const E=async()=>{if(!(!ou()||!Rt.imgRef))try{await au(Rt.imgRef),cr.info(r()("copied_image_to_clipboard"))}catch(I){he(I,r()("copy_error"))}},_=()=>{Rt.zoom=Rt.zoom>1?1:2},j=()=>te(m,ae.PlaySlideshow);Ee(()=>{hs.value&&Rt.zoom>1&&_()});const Y=I=>{globalThis.getSelection()?.type!=="Range"&&(I.preventDefault(),Er(E()))},G=I=>{Rt.zoom>1||Ir.showOverlay||(f()&&I.detail.direction==="left"&&f()(),g()&&I.detail.direction==="right"&&g()())},R=x(()=>lu(h(v),h(S)||Rt.zoom>1));Ee(()=>{h(et)&&V(h(et))});const V=async I=>{if(!I||!Oe.isCasting)return;const J=new URL(I,globalThis.location.href);try{await Oe.loadMedia(J.href)}catch(yt){he(yt,"Unable to cast");return}},W=()=>{U(y,!0),U(S,h(R)===ls.Fullsize||h(R)==="original",!0)},tt=()=>{U(O,U(y,!0),!0)};qs(()=>di.cancelPreloadUrl(h(et)));let et=x(()=>jo({asset:h(v),sharedLink:d(),forceOriginal:h(S)||Rt.zoom>1})),z=st(0),Z=st(0),Q;Ee(()=>{Q&&Q!==h(et)&&ws(()=>{U(y,!1),U(S,!1),U(O,!1)}),Q=h(et)});var rt=gp();Ue(Re,(I,J)=>Ps?.(I,J),()=>[{shortcut:{key:"z"},onShortcut:_,preventDefault:!0},{shortcut:{key:"s"},onShortcut:j,preventDefault:!0},{shortcut:{key:"c",ctrl:!0},onShortcut:Y,preventDefault:!1},{shortcut:{key:"c",meta:!0},onShortcut:Y,preventDefault:!1}]);var nt=_t(rt);qm(nt,{onCopy:E,onZoom:_});var ut=k(nt,2);{var lt=I=>{var J=lp(),yt=b(J);Ku(yt,{class:"text-xl h-full w-full"}),w(J),D(I,J)};K(ut,I=>{h(O)&&I(lt)})}var dt=k(ut,2);or(dt,I=>U(A,I),()=>h(A));var P=k(dt,2),H=b(P);{var X=I=>{var J=cp(),yt=b(J);Sr(yt,{}),w(J),D(I,J)},N=I=>{var J=Gt(),yt=_t(J);{var Mt=pt=>{var It=dp(),Vt=_t(It);_l(Vt,Xt=>({...Xt,class:"h-full w-full"}),[()=>na(G)],void 0,void 0,"svelte-raj50z");var Ce=b(Vt);{var Bt=Xt=>{var se=hp();ct(()=>Wt(se,"src",h(et))),D(Xt,se)};K(Ce,Xt=>{s()!==ae.None&&i()===ln.BlurredBackground&&Xt(Bt)})}var oe=k(Ce,2);or(oe,Xt=>Rt.imgRef=Xt,()=>Rt?.imgRef);var ue=k(oe,2);kr(ue,1,()=>Zm(e(),Rt.zoomState,Rt.imgRef),fl,(Xt,se)=>{var dr=up();ct(()=>cs(dr,`top: ${h(se).top??""}px; left: ${h(se).left??""}px; height: ${h(se).height??""}px; width: ${h(se).width??""}px;`)),D(Xt,dr)});var Ar=k(ue,2);kr(Ar,17,()=>h(M),Xt=>Xt.id,(Xt,se)=>{Gm(Xt,{get ocrBox(){return h(se)}})}),w(Vt),Ue(Vt,(Xt,se)=>Kd?.(Xt,se),()=>({disabled:h(F)}));var Rr=k(Vt,2);{var qe=Xt=>{Vc(Xt,{get htmlElement(){return Rt.imgRef},get containerWidth(){return h(z)},get containerHeight(){return h(Z)},get assetId(){return h(v).id}})};K(Rr,Xt=>{hs.value&&Xt(qe)})}ct(Xt=>{Wt(oe,"src",h(et)),Wt(oe,"alt",Xt),Cr(oe,1,`h-full w-full ${(s()===ae.None?"object-contain":td[i()])??""}`)},[()=>n()(Pe(h(v)))]),ar(3,Vt,()=>Ln,()=>({duration:u()?Cl:0})),D(pt,It)};K(yt,pt=>{h(O)||pt(Mt)},!0)}D(I,J)};K(H,I=>{h(y)?I(N,!1):I(X)})}w(P),or(P,I=>c(I),()=>c()),ct(()=>Wt(dt,"src",h(et))),He("load",dt,W),He("error",dt,tt),Xc(dt),xn(P,"clientWidth",I=>U(z,I)),xn(P,"clientHeight",I=>U(Z,I)),D(a,rt),Ot(),l()}var fp=q('<div class="flex place-items-center items-center justify-center"><div class="relative flex aspect-square w-62.5 overflow-hidden rounded-full border-4 border-immich-primary bg-immich-dark-primary dark:border-immich-dark-primary dark:bg-immich-primary"><!></div></div>');function mp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",s),r=()=>ht(Xs,"$user",s),[s,i]=Et();let n=st(void 0);lr(()=>{h(n)&&(h(n).style.width="100%")});const o=async c=>{const u=new Image;u.src=URL.createObjectURL(c),await u.decode();const d=document.createElement("canvas");d.width=u.width,d.height=u.height;const g=d.getContext("2d");if(!g)throw new Error("Could not get canvas context.");g.drawImage(u,0,0);const m=g.getImageData(0,0,d.width,d.height)?.data;if(!m)throw new Error("Could not get image data.");for(let p=0;p<m.length;p+=4)if(m[p+3]<255)return!0;return!1},l=async()=>{if(h(n))try{const c=h(n).offsetHeight,u=h(n).offsetWidth,d=await Vd.toBlob(h(n),{width:u,height:c});if(await o(d)){cr.danger(e()("errors.profile_picture_transparent_pixels"));return}const g=new File([d],"profile-picture.png",{type:"image/png"}),{profileImagePath:f,profileChangedAt:m}=await Pu({createProfileImageDto:{file:g}});cr.success(e()("profile_picture_set")),da(Xs,ws(r).profileImagePath=f,ws(r)),da(Xs,ws(r).profileChangedAt=m,ws(r)),t.onClose()}catch(c){he(c,e()("errors.unable_to_set_profile_picture"))}};{let c=x(()=>e()("set_profile_picture"));zo(a,{size:"small",get title(){return h(c)},get onClose(){return t.onClose},onSubmit:l,children:(u,d)=>{var g=fp(),f=b(g),m=b(f);{let p=x(()=>({current:t.asset}));Io(m,{get cursor(){return h(p)},get element(){return h(n)},set element(v){U(n,v,!0)}})}w(f),w(g),D(u,g)},$$slots:{default:!0}})}Ot(),i()}function pp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();{let i=x(()=>e()("set_as_profile_picture"));Ae(a,{get icon(){return ah},onClick:()=>Or.show(mp,{asset:t.asset}),get text(){return h(i)}})}Ot(),s()}function vp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{const n=await Mu({id:t.stack.id,stackUpdateDto:{primaryAssetId:t.asset.id}});n&&t.onAction({type:Ut.SET_STACK_PRIMARY_ASSET,stack:n})};{let n=x(()=>e()("set_stack_primary_asset"));Ae(a,{get icon(){return lh},onClick:i,get text(){return h(n)}})}Ot(),s()}function _p(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=t.asset.visibility===an.Locked,n=async()=>{if(await Or.showDialog({title:i?e()("remove_from_locked_folder"):e()("move_to_locked_folder"),prompt:i?e()("remove_from_locked_folder_confirmation"):e()("move_to_locked_folder_confirmation"),confirmText:e()("move"),confirmColor:i?"danger":"primary",icon:i?la:ca}))try{t.preAction({type:i?Ut.SET_VISIBILITY_TIMELINE:Ut.SET_VISIBILITY_LOCKED,asset:t.asset}),await Iu({assetBulkUpdateDto:{ids:[t.asset.id],visibility:i?an.Timeline:an.Locked}}),t.onAction({type:i?Ut.SET_VISIBILITY_TIMELINE:Ut.SET_VISIBILITY_LOCKED,asset:t.asset})}catch(l){he(l,e()("errors.unable_to_save_settings"))}};{let o=x(()=>i?e()("move_off_locked_folder"):e()("move_to_locked_folder")),l=x(()=>i?la:ca);Ae(a,{onClick:()=>n(),get text(){return h(o)},get icon(){return h(l)}})}Ot(),s()}function yp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async()=>{const n=await cu([t.stack.id]);n&&t.onAction({type:Ut.UNSTACK,assets:n.map(o=>Pe(o))})};{let n=x(()=>e()("unstack"));Ae(a,{get icon(){return ch},onClick:i,get text(){return h(n)}})}Ot(),s()}var xp=q("<!> <!>",1),wp=q("<!> <!>",1),bp=q("<!> <!> <!>",1),Sp=q("<!> <!>",1),Cp=q("<!> <!> <!>",1),Tp=q("<!> <!>",1),kp=q("<hr/> <!> <!> <!> <!>",1),Op=q("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1),Ap=q('<!> <div class="flex h-16 place-items-center justify-between bg-linear-to-b from-black/40 px-3 transition-transform duration-200"><div class="dark"><!></div> <div class="flex gap-2 overflow-x-auto dark" data-testid="asset-viewer-navbar-actions"><!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!></div></div>',1);function Dp(a,t){kt(t,!0);const e=()=>ht(Xs,"$user",s),r=()=>ht(Ft,"$t",s),[s,i]=Et();let n=St(t,"album",3,null),o=St(t,"person",3,null),l=St(t,"stack",3,null),c=St(t,"showSlideshow",3,!1),u=St(t,"onUndoDelete",3,void 0),d=St(t,"playOriginalVideo",3,!1);const g=x(()=>e()&&t.asset.ownerId===e()?.id),f=x(()=>t.asset.visibility===an.Locked),m=x(()=>Ro.value.smartSearch),p=x(()=>$h(r())),v=x(()=>h(p).Cast),y=x(()=>({title:r()("go_back"),type:r()("assets"),icon:gh,$if:()=>!!t.onClose,onAction:()=>t.onClose?.(),shortcuts:[{key:"Escape"}]})),S=x(()=>qu(r(),t.asset)),O=x(()=>h(S).Share),A=x(()=>h(S).Download),M=x(()=>h(S).DownloadOriginal),F=x(()=>h(S).SharedLinkDownload),E=x(()=>h(S).Offline),_=x(()=>h(S).Favorite),j=x(()=>h(S).Unfavorite),Y=x(()=>h(S).PlayMotionPhoto),G=x(()=>h(S).StopMotionPhoto),R=x(()=>h(S).ZoomIn),V=x(()=>h(S).ZoomOut),W=x(()=>h(S).Copy),tt=x(()=>h(S).Info),et=x(()=>h(S).Edit),z=x(()=>h(S).RefreshFacesJob),Z=x(()=>h(S).RefreshMetadataJob),Q=x(()=>h(S).RegenerateThumbnailJob),rt=x(()=>h(S).TranscodeVideoJob),nt=kl();var ut=Ap(),lt=_t(ut);{let ge=x(()=>r()("assets")),gr=x(()=>hu([h(y),h(v),h(O),h(A),h(M),h(F),h(E),h(_),h(j),h(Y),h(G),h(R),h(V),h(W),h(tt),h(et),h(z),h(Z),h(Q),h(rt)]));rd(lt,{get name(){return h(ge)},get actions(){return h(gr)}})}var dt=k(lt,2),P=b(dt),H=b(P);Ve(H,{get action(){return h(y)}}),w(P);var X=k(P,2),N=b(X);Ve(N,{get action(){return h(v)}});var I=k(N,2);Ve(I,{get action(){return h(O)}});var J=k(I,2);Ve(J,{get action(){return h(E)}});var yt=k(J,2);Ve(yt,{get action(){return h(Y)}});var Mt=k(yt,2);Ve(Mt,{get action(){return h(G)}});var pt=k(Mt,2);Ve(pt,{get action(){return h(R)}});var It=k(pt,2);Ve(It,{get action(){return h(V)}});var Vt=k(It,2);Ve(Vt,{get action(){return h(W)}});var Ce=k(Vt,2);Ve(Ce,{get action(){return h(F)}});var Bt=k(Ce,2);Ve(Bt,{get action(){return h(tt)}});var oe=k(Bt,2);Ve(oe,{get action(){return h(_)}});var ue=k(oe,2);Ve(ue,{get action(){return h(j)}});var Ar=k(ue,2);{var Rr=ge=>{Id(ge,{get asset(){return t.asset},get onAction(){return t.onAction}})};K(Ar,ge=>{h(g)&&ge(Rr)})}var qe=k(Ar,2);Ve(qe,{get action(){return h(et)}});var Xt=k(qe,2);{var se=ge=>{Pd(ge,{get asset(){return t.asset},get onAction(){return t.onAction},get preAction(){return t.preAction},get onUndoDelete(){return u()}})};K(Xt,ge=>{h(g)&&ge(se)})}var dr=k(Xt,2);{var fs=ge=>{{let gr=x(()=>r()("more"));ed(ge,{direction:"left",align:"top-right",color:"secondary",get title(){return h(gr)},get icon(){return hh},children:(Br,Is)=>{var fr=Op(),zr=_t(fr);{var Yt=gt=>{{let Pt=x(()=>r()("slideshow"));Ae(gt,{get icon(){return uh},get text(){return h(Pt)},get onClick(){return t.onPlaySlideshow}})}};K(zr,gt=>{c()&&!h(f)&&gt(Yt)})}var Zt=k(zr,2);Ls(Zt,{get action(){return h(A)}});var Te=k(Zt,2);Ls(Te,{get action(){return h(M)}});var Ze=k(Te,2);{var ot=gt=>{var Pt=Gt(),le=_t(Pt);{var ke=Kt=>{Fd(Kt,{get asset(){return t.asset},get onAction(){return t.onAction}})},fe=Kt=>{var Jt=xp(),ve=_t(Jt);ya(ve,{get asset(){return t.asset},get onAction(){return t.onAction}});var ye=k(ve,2);ya(ye,{get asset(){return t.asset},get onAction(){return t.onAction},shared:!0}),D(Kt,Jt)};K(le,Kt=>{t.asset.isTrashed?Kt(ke):Kt(fe,!1)})}D(gt,Pt)};K(Ze,gt=>{h(f)||gt(ot)})}var it=k(Ze,2);{var vt=gt=>{var Pt=Sp(),le=_t(Pt);Dd(le,{get asset(){return t.asset},get stack(){return l()},get onAction(){return t.onAction}});var ke=k(le,2);{var fe=Kt=>{var Jt=bp(),ve=_t(Jt);yp(ve,{get stack(){return l()},get onAction(){return t.onAction}});var ye=k(ve,2);Md(ye,{get stack(){return l()},get asset(){return t.asset},get onAction(){return t.onAction}});var Je=k(ye,2);{var Ie=ze=>{var Ke=wp(),rs=_t(Ke);vp(rs,{get stack(){return l()},get asset(){return t.asset},get onAction(){return t.onAction}});var ii=k(rs,2);{var Qe=mr=>{Ld(mr,{get asset(){return t.asset},get stack(){return l()},get onAction(){return t.onAction}})};K(ii,mr=>{l()?.assets?.length>2&&mr(Qe)})}D(ze,Ke)};K(Je,ze=>{l()?.primaryAssetId!==t.asset.id&&ze(Ie)})}D(Kt,Jt)};K(ke,Kt=>{l()&&Kt(fe)})}D(gt,Pt)};K(it,gt=>{h(g)&&gt(vt)})}var Ct=k(it,2);{var Tt=gt=>{jd(gt,{get asset(){return t.asset},get album(){return n()}})};K(Ct,gt=>{n()&&gt(Tt)})}var At=k(Ct,2);{var xt=gt=>{Rd(gt,{get asset(){return t.asset},get person(){return o()},get onAction(){return t.onAction}})};K(At,gt=>{o()&&gt(xt)})}var wt=k(At,2);{var jt=gt=>{pp(gt,{get asset(){return t.asset}})};K(wt,gt=>{t.asset.type===as.Image&&!h(f)&&gt(jt)})}var zt=k(wt,2);{var Nt=gt=>{var Pt=Tp(),le=_t(Pt);{var ke=Jt=>{var ve=Cp(),ye=_t(ve);Ed(ye,{get asset(){return t.asset},get onAction(){return t.onAction},get preAction(){return t.preAction}});var Je=k(ye,2);{let Ke=x(()=>r()("replace_with_upload"));Ae(Je,{get icon(){return fh},onClick:()=>Gu(t.asset.id),get text(){return h(Ke)}})}var Ie=k(Je,2);{var ze=Ke=>{{let rs=x(()=>r()("view_in_timeline"));Ae(Ke,{get icon(){return ph},onClick:()=>vn(rr.photos({at:l()?.primaryAssetId??t.asset.id})),get text(){return h(rs)}})}};K(Ie,Ke=>{!t.asset.isArchived&&!t.asset.isTrashed&&Ke(ze)})}D(Jt,ve)};K(le,Jt=>{h(g)&&Jt(ke)})}var fe=k(le,2);{var Kt=Jt=>{{let ve=x(()=>r()("view_similar_photos"));Ae(Jt,{get icon(){return mh},onClick:()=>vn(rr.search({queryAssetId:l()?.primaryAssetId??t.asset.id})),get text(){return h(ve)}})}};K(fe,Jt=>{!t.asset.isArchived&&!t.asset.isTrashed&&h(m)&&Jt(Kt)})}D(gt,Pt)};K(zt,gt=>{h(f)||gt(Nt)})}var Dt=k(zt,2);{var L=gt=>{{let Pt=x(()=>Pe(t.asset));_p(gt,{get asset(){return h(Pt)},get onAction(){return t.onAction},get preAction(){return t.preAction}})}};K(Dt,gt=>{!t.asset.isTrashed&&h(g)&&gt(L)})}var $=k(Dt,2);{var at=gt=>{{let Pt=x(()=>d()?r()("play_transcoded_video"):r()("play_original_video"));Ae(gt,{get icon(){return dh},onClick:()=>t.setPlayOriginalVideo(!d()),get text(){return h(Pt)}})}};K($,gt=>{t.asset.type===as.Video&&gt(at)})}var bt=k($,2);{var ie=gt=>{var Pt=kp(),le=k(_t(Pt),2);Ls(le,{get action(){return h(z)}});var ke=k(le,2);Ls(ke,{get action(){return h(Z)}});var fe=k(ke,2);Ls(fe,{get action(){return h(Q)}});var Kt=k(fe,2);Ls(Kt,{get action(){return h(rt)}}),D(gt,Pt)};K(bt,gt=>{h(g)&&gt(ie)})}D(Br,fr)},$$slots:{default:!0}})}};K(dr,ge=>{nt||ge(fs)})}w(X),w(dt),D(a,ut),Ot(),i()}function ul(){return{a:1,c:0,e:0,b:0,d:1,f:0}}function Yc(...a){a=Array.isArray(a[0])?a[0]:a;const t=(e,r)=>({a:e.a*r.a+e.c*r.b,c:e.a*r.c+e.c*r.d,e:e.a*r.e+e.c*r.f+e.e,b:e.b*r.a+e.d*r.b,d:e.b*r.c+e.d*r.d,f:e.b*r.e+e.d*r.f+e.f});switch(a.length){case 0:throw new Error("no matrices provided");case 1:return a[0];case 2:return t(a[0],a[1]);default:{const[e,r,...s]=a,i=t(e,r);return Yc(i,...s)}}}function Ep(...a){return Yc(...a)}const{cos:Pp,sin:Mp}=Math;function Ip(a,t,e){const r=Pp(a),s=Mp(a);return{a:r,c:-s,e:0,b:s,d:r,f:0}}function Lp(){return{a:1,c:0,e:0,b:0,d:-1,f:0}}function Fp(){return{a:-1,c:0,e:0,b:0,d:1,f:0}}const dl=(a,t=1e-15)=>Math.abs(a)<t,jp=a=>{const{a:t,b:e,c:r,d:s}=Rp(a),i=(dl(t)?Math.asin(r):Math.acos(t))*180/Math.PI;return{rotation:i<0?360+i:i,mirrorHorizontal:!1,mirrorVertical:dl(t)?e===r:t===-s}},Rp=a=>Ep(ul(),...a.map(t=>{switch(t.action){case"rotate":{const r=-t.parameters.angle*Math.PI/180;return Ip(r)}case"mirror":return t.parameters.axis==="horizontal"?Fp():Lp();default:return ul()}}));class Bp{#t=x(()=>this.checkEdits());get canReset(){return h(this.#t)}set canReset(t){U(this.#t,t)}#r=st(!1);get hasChanges(){return h(this.#r)}set hasChanges(t){U(this.#r,t,!0)}#i=st(.65);get darkenLevel(){return h(this.#i)}set darkenLevel(t){U(this.#i,t,!0)}#s=st(!1);get isInteracting(){return h(this.#s)}set isInteracting(t){U(this.#s,t,!0)}#e=st(!1);get isDragging(){return h(this.#e)}set isDragging(t){U(this.#e,t,!0)}#n=st(null);get animationFrame(){return h(this.#n)}set animationFrame(t){U(this.#n,t,!0)}#o=st("default");get canvasCursor(){return h(this.#o)}set canvasCursor(t){U(this.#o,t,!0)}#a=st(de({x:0,y:0}));get dragOffset(){return h(this.#a)}set dragOffset(t){U(this.#a,t,!0)}#l=st("");get resizeSide(){return h(this.#l)}set resizeSide(t){U(this.#l,t,!0)}#c=st(null);get imgElement(){return h(this.#c)}set imgElement(t){U(this.#c,t,!0)}#h=st(null);get cropAreaEl(){return h(this.#h)}set cropAreaEl(t){U(this.#h,t,!0)}#u=st(null);get overlayEl(){return h(this.#u)}set overlayEl(t){U(this.#u,t,!0)}#d=st(null);get cropFrame(){return h(this.#d)}set cropFrame(t){U(this.#d,t,!0)}#g=st(de({width:1e3,height:1e3}));get cropImageSize(){return h(this.#g)}set cropImageSize(t){U(this.#g,t,!0)}#f=st(1);get cropImageScale(){return h(this.#f)}set cropImageScale(t){U(this.#f,t,!0)}#m=st("free");get cropAspectRatio(){return h(this.#m)}set cropAspectRatio(t){U(this.#m,t,!0)}#p=st(de({width:1e3,height:1e3}));get originalImageSize(){return h(this.#p)}set originalImageSize(t){U(this.#p,t,!0)}#v=st(de({x:0,y:0,width:100,height:100}));get region(){return h(this.#v)}set region(t){U(this.#v,t,!0)}#_=x(()=>({width:this.cropImageSize.width*this.cropImageScale,height:this.cropImageSize.height*this.cropImageScale}));get previewImageSize(){return h(this.#_)}set previewImageSize(t){U(this.#_,t)}#y=st(0);get imageRotation(){return h(this.#y)}set imageRotation(t){U(this.#y,t,!0)}#x=st(!1);get mirrorHorizontal(){return h(this.#x)}set mirrorHorizontal(t){U(this.#x,t,!0)}#w=st(!1);get mirrorVertical(){return h(this.#w)}set mirrorVertical(t){U(this.#w,t,!0)}#b=x(()=>{const t=this.imageRotation%360;return t<0?t+360:t});get normalizedRotation(){return h(this.#b)}set normalizedRotation(t){U(this.#b,t)}#S=x(()=>this.normalizedRotation%180>0);get orientationChanged(){return h(this.#S)}set orientationChanged(t){U(this.#S,t)}#C=x(()=>this.getEdits());get edits(){return h(this.#C)}set edits(t){U(this.#C,t)}setAspectRatio(t){if(this.hasChanges=!0,this.cropAspectRatio=t,!this.imgElement||!this.cropAreaEl)return;const e=Qt.recalculateCrop(t);e&&(Qt.animateCropChange(this.cropAreaEl,this.region,e),this.region=e)}checkEdits(){return Math.abs(this.previewImageSize.width-this.region.width)>2||Math.abs(this.previewImageSize.height-this.region.height)>2||this.mirrorHorizontal||this.mirrorVertical||this.normalizedRotation!==0}checkCropEdits(){return Math.abs(this.previewImageSize.width-this.region.width)>2||Math.abs(this.previewImageSize.height-this.region.height)>2}getEdits(){const t=[];if(this.checkCropEdits()){let e=this.getRegionInPreviewCoords(this.region);e=this.applyMirrorToCoords(e,this.cropImageSize),e=this.convertRegion({region:e,from:this.cropImageSize,to:this.originalImageSize}),e=this.constrainToBounds(e,this.originalImageSize),t.push({action:ai.Crop,parameters:e})}return this.mirrorHorizontal&&t.push({action:ai.Mirror,parameters:{axis:pa.Horizontal}}),this.mirrorVertical&&t.push({action:ai.Mirror,parameters:{axis:pa.Vertical}}),this.normalizedRotation!==0&&t.push({action:ai.Rotate,parameters:{angle:this.normalizedRotation}}),t}async resetAllChanges(){this.imageRotation=0,this.mirrorHorizontal=!1,this.mirrorVertical=!1,await Qn(),this.onImageLoad([])}async onActivate(t,e){const r=Ol(t.exifInfo);this.originalImageSize={width:r.width??0,height:r.height??0},this.imgElement=new Image;const s=ks({id:t.id,cacheKey:t.thumbhash,edited:!1,size:ls.Preview});this.imgElement.src=s,this.imgElement.addEventListener("load",()=>Qt.onImageLoad(e),{passive:!0}),this.imgElement.addEventListener("error",o=>he(o,"ErrorLoadingImage"),{passive:!0}),globalThis.addEventListener("mousemove",o=>Qt.handleMouseMove(o),{passive:!0});const i=e.filter(o=>o.action==="rotate"||o.action==="mirror"),n=jp(i);this.imageRotation=n.rotation,this.mirrorHorizontal=n.mirrorHorizontal,this.mirrorVertical=n.mirrorVertical,await Qn(),this.resizeCanvas()}onDeactivate(){globalThis.removeEventListener("mousemove",Qt.handleMouseMove),this.reset()}reset(){this.darkenLevel=.65,this.isInteracting=!1,this.animationFrame=null,this.canvasCursor="default",this.dragOffset={x:0,y:0},this.resizeSide="",this.imgElement=null,this.cropAreaEl=null,this.isDragging=!1,this.overlayEl=null,this.imageRotation=0,this.mirrorHorizontal=!1,this.mirrorVertical=!1,this.region={x:0,y:0,width:100,height:100},this.cropImageSize={width:1e3,height:1e3},this.originalImageSize={width:1e3,height:1e3},this.cropImageScale=1,this.cropAspectRatio="free",this.hasChanges=!1}mirror(t){this.hasChanges=!0,this.imageRotation%180!==0&&(t=t==="horizontal"?"vertical":"horizontal"),t==="horizontal"?this.mirrorHorizontal=!this.mirrorHorizontal:this.mirrorVertical=!this.mirrorVertical}async rotate(t){this.hasChanges=!0,this.imageRotation+=t,await Qn(),this.onImageLoad()}recalculateCrop(t=this.cropAspectRatio){if(!this.cropAreaEl)return this.region;const e=this.cropAreaEl.clientWidth,r=this.cropAreaEl.clientHeight,{newWidth:s,newHeight:i}=this.keepAspectRatio(this.region.width,this.region.height,t);let n=s,o=i;return s>e?(n=e,o=e/(s/i)):i>r&&(o=r,n=r*(s/i)),{x:Math.max(0,Math.min(this.region.x,e-n)),y:Math.max(0,Math.min(this.region.y,r-o)),width:n,height:o}}animateCropChange(t,e,r,s=100){if(!t.querySelector(".crop-frame"))return;const n=performance.now(),o={...e},l=c=>{const u=c-n,d=Math.min(u/s,1);e.x=o.x+(r.x-o.x)*d,e.y=o.y+(r.y-o.y)*d,e.width=o.width+(r.width-o.width)*d,e.height=o.height+(r.height-o.height)*d,this.draw(e),d<1&&requestAnimationFrame(l)};requestAnimationFrame(l)}keepAspectRatio(t,e,r=this.cropAspectRatio){const[s,i]=r.split(":").map(Number);return s&&i?{newWidth:e*s/i,newHeight:e}:{newWidth:t,newHeight:e}}getConstrainedDimensions(t,e,r,s,i=50){const{newWidth:n,newHeight:o}=this.adjustDimensions(t,e,this.cropAspectRatio,r,s,i);return{width:Math.max(i,Math.min(n,r)),height:Math.max(i,Math.min(o,s))}}adjustDimensions(t,e,r,s,i,n){let o=t,l=e,c;if(r==="free")c=t/e;else{const[u,d]=r.split(":").map(Number);c=u&&d?u/d:t/e}return r!=="free"&&(l=o/c),o>s&&(o=s,r!=="free"&&(l=o/c)),l>i&&(l=i,r!=="free"&&(o=l*c)),o<n&&(o=n,r!=="free"&&(l=o/c)),l<n&&(l=n,r!=="free"&&(o=l*c)),r!=="free"&&o/l!==c&&(o<n&&(l=o/c),l<n&&(o=l*c)),{newWidth:o,newHeight:l}}draw(t=this.region){this.cropFrame&&(this.cropFrame.style.left=`${t.x}px`,this.cropFrame.style.top=`${t.y}px`,this.cropFrame.style.width=`${t.width}px`,this.cropFrame.style.height=`${t.height}px`,this.drawOverlay(t))}drawOverlay(t){this.overlayEl&&(this.overlayEl.style.clipPath=`
    polygon(
      0% 0%,
      0% 100%,
      100% 100%,
      100% 0%,
      0% 0%,
      ${t.x}px ${t.y}px,
      ${t.x+t.width}px ${t.y}px,
      ${t.x+t.width}px ${t.y+t.height}px,
      ${t.x}px ${t.y+t.height}px,
      ${t.x}px ${t.y}px
    )
  `)}onImageLoad(t=null){const e=this.imgElement;if(!this.cropAreaEl||!e)return;this.cropImageSize={width:e.width,height:e.height};const r=this.calculateScale();if(t===null){const s=this.cropFrame;s?.classList.add("transition"),this.region=this.normalizeCropArea(r),s?.classList.add("transition"),s?.addEventListener("transitionend",()=>s?.classList.remove("transition"),{passive:!0})}else{const s=t.find(i=>i.action===ai.Crop);if(s){const i=s.parameters;let{x:n,y:o,width:l,height:c}=this.convertRegion({region:i,from:this.originalImageSize,to:this.cropImageSize});this.mirrorHorizontal&&(n=e.width-n-l),this.mirrorVertical&&(o=e.height-o-c),this.region={x:n*r,y:o*r,width:l*r,height:c*r}}else this.region={x:0,y:0,width:e.width*r,height:e.height*r}}this.cropImageScale=r,e.style.width=`${e.width*r}px`,e.style.height=`${e.height*r}px`,this.draw()}calculateScale(){const t=this.imgElement,e=this.cropAreaEl;if(!e||!t)return 1;const r=e.clientWidth,s=e.clientHeight;let i=r/t.width;return t.height*i>s&&(i=s/t.height),i}normalizeCropArea(t){const e=this.imgElement;if(!e)return{...this.region};const r=t/this.cropImageScale,s={x:this.region.x*r,y:this.region.y*r,width:this.region.width*r,height:this.region.height*r};return this.constrainToBounds(s,{width:e.width*t,height:e.height*t})}resizeCanvas(){const t=this.imgElement;if(!this.cropAreaEl||!t)return;const r=this.calculateScale();this.region=this.normalizeCropArea(r),this.cropImageScale=r,t.style.width=`${t.width*r}px`,t.style.height=`${t.height*r}px`,this.draw()}handleMouseDown(t){if(!this.cropAreaEl)return;const{mouseX:r,mouseY:s}=this.getMousePosition(t),{onLeftBoundary:i,onRightBoundary:n,onTopBoundary:o,onBottomBoundary:l,onTopLeftCorner:c,onTopRightCorner:u,onBottomLeftCorner:d,onBottomRightCorner:g}=this.isOnCropBoundary(r,s);c||u||d||g||i||n||o||l?this.setResizeSide(r,s):this.isInCropArea(r,s)&&this.startDragging(r,s),document.body.style.userSelect="none",globalThis.addEventListener("mouseup",()=>this.handleMouseUp(),{passive:!0})}handleMouseMove(t){if(!this.cropAreaEl)return;const r=this.resizeSide,{mouseX:s,mouseY:i}=this.getMousePosition(t);this.isDragging?this.moveCrop(s,i):r?this.resizeCrop(s,i):this.updateCursor(s,i)}handleMouseUp(){globalThis.removeEventListener("mouseup",this.handleMouseUp),document.body.style.userSelect="",this.isInteracting=!1,this.isDragging=!1,this.resizeSide="",this.fadeOverlay(!0)}getMousePosition(t){let e=t.clientX,r=t.clientY;const s=this.cropAreaEl?.getBoundingClientRect(),i=this.normalizedRotation;return i==90?(e=t.clientY-(s?.top??0),r=window.innerWidth-t.clientX-(window.innerWidth-(s?.right??0))):i==180?(e=window.innerWidth-t.clientX-(window.innerWidth-(s?.right??0)),r=window.innerHeight-t.clientY-(window.innerHeight-(s?.bottom??0))):i==270?(e=window.innerHeight-t.clientY-(window.innerHeight-(s?.bottom??0)),r=t.clientX-(s?.left??0)):i==0&&(e-=s?.left??0,r-=s?.top??0),{mouseX:e,mouseY:r}}isInRange(t,e,r){return t>=e-r&&t<=e+r}isWithinBounds(t,e,r){return t>=e&&t<=r}isOnCropBoundary(t,e){const{x:r,y:s,width:i,height:n}=this.region,o=10,l=15,{width:c,height:u}=this.cropImageSize;if(t>c||e>u||t<0||e<0)return{onLeftBoundary:!1,onRightBoundary:!1,onTopBoundary:!1,onBottomBoundary:!1,onTopLeftCorner:!1,onTopRightCorner:!1,onBottomLeftCorner:!1,onBottomRightCorner:!1};const g=this.isInRange(t,r,o)&&this.isWithinBounds(e,s,s+n),f=this.isInRange(t,r+i,o)&&this.isWithinBounds(e,s,s+n),m=this.isInRange(e,s,o)&&this.isWithinBounds(t,r,r+i),p=this.isInRange(e,s+n,o)&&this.isWithinBounds(t,r,r+i),v=this.isInRange(t,r,l)&&this.isInRange(e,s,l),y=this.isInRange(t,r+i,l)&&this.isInRange(e,s,l),S=this.isInRange(t,r,l)&&this.isInRange(e,s+n,l),O=this.isInRange(t,r+i,l)&&this.isInRange(e,s+n,l);return{onLeftBoundary:g,onRightBoundary:f,onTopBoundary:m,onBottomBoundary:p,onTopLeftCorner:v,onTopRightCorner:y,onBottomLeftCorner:S,onBottomRightCorner:O}}isInCropArea(t,e){const{x:r,y:s,width:i,height:n}=this.region;return t>=r&&t<=r+i&&e>=s&&e<=s+n}setResizeSide(t,e){const{onLeftBoundary:r,onRightBoundary:s,onTopBoundary:i,onBottomBoundary:n,onTopLeftCorner:o,onTopRightCorner:l,onBottomLeftCorner:c,onBottomRightCorner:u}=this.isOnCropBoundary(t,e);o?this.resizeSide="top-left":l?this.resizeSide="top-right":c?this.resizeSide="bottom-left":u?this.resizeSide="bottom-right":r?this.resizeSide="left":s?this.resizeSide="right":i?this.resizeSide="top":n&&(this.resizeSide="bottom")}startDragging(t,e){this.isDragging=!0;const r=this.region;this.isInteracting=!0,this.dragOffset={x:t-r.x,y:e-r.y},this.fadeOverlay(!1)}moveCrop(t,e){const r=this.cropAreaEl;if(!r)return;this.hasChanges=!0;const s=Math.max(0,Math.min(t-this.dragOffset.x,r.clientWidth-this.region.width)),i=Math.max(0,Math.min(e-this.dragOffset.y,r.clientHeight-this.region.height));this.region={...this.region,x:s,y:i},this.draw()}resizeCrop(t,e){const r=this.cropAreaEl,s=this.region,i=this.resizeSide;if(!r||!i)return;this.fadeOverlay(!1),this.hasChanges=!0;const{x:n,y:o,width:l,height:c}=s,u=50;let d={...s};switch(i){case"left":{const g=l+(n-t);if(g>=u&&t>=0){const{newWidth:f,newHeight:m}=this.keepAspectRatio(g,c),p=Math.max(u,Math.min(f,r.clientWidth)),v=Math.max(u,Math.min(m,r.clientHeight));d={x:Math.max(0,n+l-p),y:o,width:p,height:v}}break}case"right":{const g=t-n;if(g>=u&&t<=r.clientWidth){const{newWidth:f,newHeight:m}=this.keepAspectRatio(g,c);d={...d,width:Math.max(u,Math.min(f,r.clientWidth-n)),height:Math.max(u,Math.min(m,r.clientHeight))}}break}case"top":{const g=c+(o-e);if(g>=u&&e>=0){const{newWidth:f,newHeight:m}=this.adjustDimensions(l,g,this.cropAspectRatio,r.clientWidth,r.clientHeight,u);d={x:n,y:Math.max(0,o+c-m),width:f,height:m}}break}case"bottom":{const g=e-o;if(g>=u&&e<=r.clientHeight){const{newWidth:f,newHeight:m}=this.adjustDimensions(l,g,this.cropAspectRatio,r.clientWidth,r.clientHeight-o,u);d={...d,width:f,height:m}}break}case"top-left":{const g=l+(n-Math.max(t,0)),f=c+(o-Math.max(e,0)),{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth,r.clientHeight,u);d={x:Math.max(0,n+l-m),y:Math.max(0,o+c-p),width:m,height:p};break}case"top-right":{const g=Math.max(t,0)-n,f=c+(o-Math.max(e,0)),{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth-n,o+c,u);d={x:n,y:Math.max(0,o+c-p),width:m,height:p};break}case"bottom-left":{const g=l+(n-Math.max(t,0)),f=Math.max(e,0)-o,{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth,r.clientHeight-o,u);d={x:Math.max(0,n+l-m),y:o,width:m,height:p};break}case"bottom-right":{const g=Math.max(t,0)-n,f=Math.max(e,0)-o,{newWidth:m,newHeight:p}=this.adjustDimensions(g,f,this.cropAspectRatio,r.clientWidth-n,r.clientHeight-o,u);d={...d,width:m,height:p};break}}this.region={...d,x:Math.max(0,Math.min(d.x,r.clientWidth-d.width)),y:Math.max(0,Math.min(d.y,r.clientHeight-d.height))},this.draw()}updateCursor(t,e){if(!this.cropAreaEl)return;let{onLeftBoundary:r,onRightBoundary:s,onTopBoundary:i,onBottomBoundary:n,onTopLeftCorner:o,onTopRightCorner:l,onBottomLeftCorner:c,onBottomRightCorner:u}=this.isOnCropBoundary(t,e);this.normalizedRotation==90?([i,s,n,r]=[r,i,s,n],[o,l,u,c]=[c,o,l,u]):this.normalizedRotation==180?([i,n]=[n,i],[r,s]=[s,r],[o,u]=[u,o],[l,c]=[c,l]):this.normalizedRotation==270&&([i,s,n,r]=[s,n,r,i],[o,l,u,c]=[l,u,c,o]);let d="";o||u?d="nwse-resize":l||c?d="nesw-resize":r||s?d="ew-resize":i||n?d="ns-resize":this.isInCropArea(t,e)?d="move":d="default",this.canvasCursor!=d&&this.cropAreaEl&&!er.isShowingConfirmDialog&&(this.canvasCursor=d,document.body.style.cursor=d,this.cropAreaEl.style.cursor=d)}fadeOverlay(t){const e=this.overlayEl,r=document.querySelector(".crop-frame");t?(e?.classList.remove("light"),r?.classList.remove("resizing")):(e?.classList.add("light"),r?.classList.add("resizing")),this.isInteracting=!t}resetCrop(){this.cropAspectRatio="free",this.region={x:0,y:0,width:this.cropImageSize.width*this.cropImageScale-1,height:this.cropImageSize.height*this.cropImageScale-1}}rotateAspectRatio(){const t=this.cropAspectRatio;if(t==="free"||t==="reset")return;const[e,r]=t.split(":");this.setAspectRatio(`${r}:${e}`)}convertRegion(t){const{region:e,from:r,to:s}=t,i=s.width/r.width,n=s.height/r.height;return{x:Math.round(e.x*i),y:Math.round(e.y*n),width:Math.round(e.width*i),height:Math.round(e.height*n)}}getRegionInPreviewCoords(t){return{x:Math.round(t.x/this.cropImageScale),y:Math.round(t.y/this.cropImageScale),width:Math.round(t.width/this.cropImageScale),height:Math.round(t.height/this.cropImageScale)}}applyMirrorToCoords(t,e){let{x:r,y:s}=t;const{width:i,height:n}=t;return this.mirrorHorizontal&&(r=e.width-r-i),this.mirrorVertical&&(s=e.height-s-n),{x:r,y:s,width:i,height:n}}constrainToBounds(t,e){const{x:r,y:s,width:i,height:n}=t;return{x:Math.max(0,Math.min(r,e.width-i)),y:Math.max(0,Math.min(s,e.height-n)),width:Math.min(i,e.width-Math.max(0,r)),height:Math.min(n,e.height-Math.max(0,s))}}}const Qt=new Bp;var zp=q("<!> <!> <!> <!>",1),Vp=q("<div></div>"),Wp=q("<div></div>"),Hp=q('<!> <span class="text-sm text-white text-left"> </span>',1),Yp=q('<div class="mt-3 px-4"><div class="flex h-10 w-full items-center justify-between text-sm mt-2"><h2> </h2></div> <!> <div class="flex h-10 w-full items-center justify-between text-sm mt-6"><h2> </h2></div> <div class="grid grid-cols-2 mb-4"></div></div>');function Xp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=[{label:e()("crop_aspect_ratio_free"),value:"free",isFree:!0},{label:e()("crop_aspect_ratio_original"),value:"original",width:24,height:18},{label:"5:4",value:"5:4",width:22,height:18},{label:"4:5",value:"4:5",width:18,height:22},{label:"4:3",value:"4:3",width:24,height:18},{label:"3:4",value:"3:4",width:18,height:24},{label:"3:2",value:"3:2",width:24,height:16},{label:"2:3",value:"2:3",width:16,height:24},{label:"16:9",value:"16:9",width:24,height:14},{label:"9:16",value:"9:16",width:14,height:24},{label:"Square",value:"1:1",width:20,height:20}];let n=x(()=>Qt.normalizedRotation%180!==0);function o(M){if(M.value==="free")return M.value;if(h(n)){let[F,E]=M.value.split(":");return`${E}:${F}`}else return M.value}function l(M){let F;if(M.value==="original"){const{width:E,height:_}=Qt.cropImageSize;h(n)&&(F=`${_}:${E}`),F=`${E}:${_}`}return F=o(M),Qt.cropAspectRatio===F}function c(M){let F;if(M.value==="original"){const{width:E,height:_}=Qt.cropImageSize;F=`${E}:${_}`}else F=o(M);Qt.setAspectRatio(F)}async function u(M){await Qt.rotate(M)}function d(M){Qt.mirror(M)}var g=Yp(),f=b(g),m=b(f),p=b(m,!0);w(m),w(f);var v=k(f,2);yn(v,{children:(M,F)=>{var E=zp(),_=_t(E);{let R=x(()=>e()("editor_rotate_left"));ee(_,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return vh},onclick:()=>u(-90)})}var j=k(_,2);{let R=x(()=>e()("editor_rotate_right"));ee(j,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return _h},onclick:()=>u(90)})}var Y=k(j,2);{let R=x(()=>e()("editor_flip_horizontal"));ee(Y,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return yh},onclick:()=>d("horizontal")})}var G=k(Y,2);{let R=x(()=>e()("editor_flip_vertical"));ee(G,{class:"w-full",size:"small",get"aria-label"(){return h(R)},get icon(){return xh},onclick:()=>d("vertical")})}D(M,E)},$$slots:{default:!0}});var y=k(v,2),S=b(y),O=b(S,!0);w(S),w(y);var A=k(y,2);kr(A,21,()=>i,M=>M.value,(M,F)=>{yn(M,{children:(E,_)=>{var j=Hp(),Y=_t(j);{let V=x(()=>l(h(F))?"primary":"secondary"),W=x(()=>l(h(F))?"filled":"outline");pn(Y,{class:"w-14 h-14 m-2",shape:"round",onclick:()=>c(h(F)),get"aria-label"(){return h(F).label},get color(){return h(V)},get variant(){return h(W)},children:(tt,et)=>{var z=Gt(),Z=_t(z);{var Q=nt=>{var ut=Vp();ct(lt=>Cr(ut,1,`w-6 h-6 border-2 border-dashed rounded-xs flex-shrink-0 ${lt??""}`),[()=>l(h(F))?"border-black":"border-white"]),D(nt,ut)},rt=nt=>{var ut=Wp();ct(lt=>{Cr(ut,1,`border-2 rounded-xs flex-shrink-0 ${lt??""}`),cs(ut,`width: ${h(F).width??""}px; height: ${h(F).height??""}px;`)},[()=>l(h(F))?"border-black":"border-white"]),D(nt,ut)};K(Z,nt=>{h(F).isFree?nt(Q):nt(rt,!1)})}D(tt,z)},$$slots:{default:!0}})}var G=k(Y,2),R=b(G,!0);w(G),ct(()=>ft(R,h(F).label)),D(E,j)},$$slots:{default:!0}})}),w(A),w(g),ct((M,F)=>{ft(p,M),ft(O,F)},[()=>e()("editor_orientation"),()=>e()("crop")]),D(a,g),Ot(),s()}var oa=(a=>(a.Transform="transform",a))(oa||{});class Np{tools=[{type:"transform",icon:wh,component:Xp,manager:Qt}];#t=st(null);get currentAsset(){return h(this.#t)}set currentAsset(t){U(this.#t,t,!0)}#r=st(null);get selectedTool(){return h(this.#r)}set selectedTool(t){U(this.#r,t,!0)}#i=st(!1);get isShowingConfirmDialog(){return h(this.#i)}set isShowingConfirmDialog(t){U(this.#i,t,!0)}#s=st(!1);get isApplyingEdits(){return h(this.#s)}set isApplyingEdits(t){U(this.#s,t,!0)}#e=st(!1);get hasAppliedEdits(){return h(this.#e)}set hasAppliedEdits(t){U(this.#e,t,!0)}#n=x(()=>this.tools.some(t=>t.manager.hasChanges)&&!this.hasAppliedEdits);get hasUnsavedChanges(){return h(this.#n)}set hasUnsavedChanges(t){U(this.#n,t)}#o=x(()=>this.tools.some(t=>t.manager.canReset));get canReset(){return h(this.#o)}set canReset(t){U(this.#o,t)}async closeConfirm(){if(this.isShowingConfirmDialog)return!1;if(!this.hasUnsavedChanges)return!0;this.isShowingConfirmDialog=!0;const t=await Or.show(bu,{title:"Discard Edits?",prompt:"You have unsaved edits. Are you sure you want to discard them?",confirmText:"Discard Edits"});return this.isShowingConfirmDialog=!1,t}reset(){for(const t of this.tools)t.manager.onDeactivate?.();this.selectedTool=this.tools[0]}async activateTool(t,e,r){if(this.hasAppliedEdits=!1,this.selectedTool?.type===t)return;this.currentAsset=e,this.selectedTool?.manager.onDeactivate?.();const s=this.tools.find(i=>i.type===t);s&&(this.selectedTool=s,await s.manager.onActivate?.(e,r.edits))}cleanup(){for(const t of this.tools)t.manager.onDeactivate?.();this.currentAsset=null,this.selectedTool=null}async resetAllChanges(){for(const t of this.tools)await t.manager.resetAllChanges()}async applyEdits(){this.isApplyingEdits=!0;const t=this.tools.flatMap(r=>r.manager.edits);if(!this.currentAsset)return!1;const e=this.currentAsset.id;try{const r=uu("AssetEditReadyV1",s=>s.asset.id===e,1e4);return await(t.length===0?Lu({id:e}):Fu({id:e,assetEditActionListDto:{edits:t}})),await r,Ml.emit("AssetEditsApplied",e),cr.success("Edits applied successfully"),this.hasAppliedEdits=!0,!0}catch{return cr.danger("Failed to apply edits"),!1}finally{this.isApplyingEdits=!1}}}const er=new Np;class Up{constructor(t){this.onChange=t}history=[];index=0;reset(){this.history=[],this.index=0}queue(t){this.history.push(t),this.index===this.history.length-2&&this.index++}next(){return this.index===this.history.length-1?!1:(this.index++,this.onChange(this.history[this.index]),!0)}previous(){return this.index===0?!1:(this.index--,this.onChange(this.history[this.index]),!0)}}var Gp=q('<section class="px-4 mt-10"><!></section>'),qp=q('<section class="px-4 mt-6"><p class="wrap-break-word whitespace-pre-line w-full text-black dark:text-white text-base"> </p></section>');function Kp(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=x(()=>t.asset.exifInfo?.description??""),n=x(()=>h(i));const o=async()=>{if(h(n)!==h(i))try{await Di({id:t.asset.id,updateAssetDto:{description:h(n)}}),cr.success(e()("asset_description_updated"))}catch(g){he(g,e()("cannot_update_the_description"))}};var l=Gt(),c=_t(l);{var u=g=>{var f=Gp(),m=b(f);{let p=x(()=>e()("add_a_description"));od(m,{class:"max-h-40 pl-0 outline-none border-b border-gray-500 bg-transparent ring-0 focus:ring-0 resize-none focus:border-b-2 focus:border-immich-primary dark:focus:border-immich-dark-primary dark:bg-transparent",rows:1,grow:!0,shape:"rectangle",onfocusout:o,get placeholder(){return h(p)},"data-testid":"autogrow-textarea",[bh()]:v=>(Sh(Ai,()=>({shortcut:{key:"Enter",ctrl:!0},onShortcut:y=>y.currentTarget.blur()}))||Lo)(v),get value(){return h(n)},set value(v){U(n,v)}})}w(f),D(g,f)},d=g=>{var f=Gt(),m=_t(f);{var p=v=>{var y=qp(),S=b(y),O=b(S,!0);w(S),w(y),ct(()=>ft(O,h(n))),D(v,y)};K(m,v=>{h(n)&&v(p)},!0)}D(g,f)};K(c,g=>{t.isOwner?g(u):g(d,!1)})}D(a,l),Ot(),s()}var $p=q("<p> </p>"),Zp=q('<div class="flex gap-2 text-sm"><p> </p></div>'),Jp=q('<div class="flex gap-2 text-sm"><p> </p></div>'),Qp=q("<div><!></div>"),tv=q('<button type="button"><div class="flex gap-4"><div><!></div> <div><!> <!> <!></div></div> <!></button>'),ev=q('<button type="button" class="flex w-full text-start justify-between place-items-start gap-4 py-4 rounded-lg hover:text-primary"><div class="flex gap-4"><div><!></div> <p> </p></div> <div class="focus:outline-none p-1"><!></div></button>'),rv=q("<!> <!>",1);function sv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"asset",15),n=st(!1);const o=async m=>{if(U(n,!1),!!m)try{i(await Di({id:i().id,updateAssetDto:{latitude:m.lat,longitude:m.lng}}))}catch(p){he(p,e()("errors.unable_to_change_location"))}};var l=rv(),c=_t(l);{var u=m=>{var p=tv();let v;p.__click=()=>t.isOwner?U(n,!0):null;var y=b(p),S=b(y),O=b(S);Se(O,{get icon(){return ha},size:"24"}),w(S);var A=k(S,2),M=b(A);{var F=V=>{var W=$p(),tt=b(W,!0);w(W),ct(()=>ft(tt,i().exifInfo.city)),D(V,W)};K(M,V=>{i().exifInfo?.city&&V(F)})}var E=k(M,2);{var _=V=>{var W=Zp(),tt=b(W),et=b(tt,!0);w(tt),w(W),ct(()=>ft(et,i().exifInfo.state)),D(V,W)};K(E,V=>{i().exifInfo?.state&&V(_)})}var j=k(E,2);{var Y=V=>{var W=Jp(),tt=b(W),et=b(tt,!0);w(tt),w(W),ct(()=>ft(et,i().exifInfo.country)),D(V,W)};K(j,V=>{i().exifInfo?.country&&V(Y)})}w(A),w(y);var G=k(y,2);{var R=V=>{var W=Qp(),tt=b(W);Se(tt,{get icon(){return Ys},size:"20"}),w(W),D(V,W)};K(G,V=>{t.isOwner&&V(R)})}w(p),ct(V=>{v=Cr(p,1,"flex w-full text-start justify-between place-items-start gap-4 py-4",null,v,{"hover:text-primary":t.isOwner}),Wt(p,"title",V)},[()=>t.isOwner?e()("edit_location"):""]),D(m,p)},d=m=>{var p=Gt(),v=_t(p);{var y=S=>{var O=ev();O.__click=()=>U(n,!0);var A=b(O),M=b(A),F=b(M);Se(F,{get icon(){return ha},size:"24"}),w(M);var E=k(M,2),_=b(E,!0);w(E),w(A);var j=k(A,2),Y=b(j);Se(Y,{get icon(){return Ys},size:"20"}),w(j),w(O),ct((G,R)=>{Wt(O,"title",G),ft(_,R)},[()=>e()("add_location"),()=>e()("add_a_location")]),D(S,O)};K(v,S=>{!i().exifInfo?.city&&t.isOwner&&S(y)},!0)}D(m,p)};K(c,m=>{i().exifInfo?.country?m(u):m(d,!1)})}var g=k(c,2);{var f=m=>{ld(m,{children:(p,v)=>{ad(p,{get asset(){return i()},onClose:o})},$$slots:{default:!0}})};K(g,m=>{h(n)&&m(f)})}D(a,l),Ot(),s()}Fr(["click"]);var iv=q('<label data-testid="star"><span class="sr-only"> </span> <!></label> <input type="radio" name="stars" class="sr-only"/>',1),nv=q('<button type="button" class="cursor-pointer text-xs text-primary"> </button>'),ov=q('<fieldset class="text-primary w-fit cursor-default"><legend class="sr-only"> </legend> <div class="flex flex-row" data-testid="star-container"></div></fieldset> <!>',1);function av(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=[];let n=St(t,"count",3,5),o=St(t,"readOnly",3,!1),l=x(()=>t.rating),c=st(0),u=st(0),d;const g="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z",f=gd(),m=j=>{o()||j!==t.rating&&t.onRating(j)},p=j=>{o()||U(c,j,!0)},v=()=>{p(0),U(u,0)},y=j=>{clearTimeout(d),d=setTimeout(()=>{m(j)},300)};var S=ov(),O=_t(S),A=b(O),M=b(A,!0);w(A);var F=k(A,2);kr(F,21,()=>({length:n()}),fl,(j,Y,G)=>{const R=x(()=>G+1),V=x(()=>h(c)>=h(R)||h(c)===0&&h(l)>=h(R)),W=x(()=>`${f}-${h(R)}`);var tt=iv(),et=_t(tt);et.__mouseover=()=>p(h(R)),Wt(et,"tabindex",-1);let z;var Z=b(et),Q=b(Z,!0);w(Z);var rt=k(Z,2);{let lt=x(()=>h(V)?"currentcolor":"transparent"),dt=x(()=>h(V)?"currentcolor":"#c1cce8");Se(rt,{icon:g,size:"1.5em",strokeWidth:1,get color(){return h(lt)},get strokeColor(){return h(dt)},"aria-hidden":!0})}w(et);var nt=k(et,2);yl(nt),nt.__change=()=>y(h(R));var ut;ct(lt=>{Wt(et,"for",h(W)),z=Cr(et,1,"",null,z,{"cursor-pointer":!o(),"ring-2":h(u)===h(R)}),ft(Q,lt),Wt(nt,"id",h(W)),nt.disabled=o(),ut!==(ut=h(R))&&(nt.value=(nt.__value=h(R))??"")},[()=>e()("rating_count",{values:{count:h(R)}})]),He("focus",nt,()=>{U(u,h(R))}),cd(i,[],nt,()=>(h(R),h(l)),lt=>U(l,lt)),D(j,tt)}),w(F),w(O),Ue(O,(j,Y)=>ud?.(j,Y),()=>({onFocusOut:v})),Ue(O,(j,Y)=>Ps?.(j,Y),()=>[{shortcut:{key:"ArrowLeft"},preventDefault:!1,onShortcut:j=>j.stopPropagation()},{shortcut:{key:"ArrowRight"},preventDefault:!1,onShortcut:j=>j.stopPropagation()}]);var E=k(O,2);{var _=j=>{var Y=nv();Y.__click=()=>{U(l,0),m(h(l))};var G=b(Y,!0);w(Y),ct(R=>ft(G,R),[()=>e()("rating_clear")]),D(j,Y)};K(E,j=>{h(l)>0&&!o()&&j(_)})}ct(j=>ft(M,j),[()=>e()("rating")]),He("mouseleave",O,()=>p(0)),D(a,S),Ot(),s()}Fr(["mouseover","change","click"]);var lv=q('<section class="px-4 pt-2"><!></section>');function cv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",s),r=()=>ht(Bo,"$preferences",s),[s,i]=Et();let n=x(()=>t.asset.exifInfo?.rating||0);const o=async d=>{try{await Di({id:t.asset.id,updateAssetDto:{rating:d}})}catch(g){he(g,e()("errors.cant_apply_changes"))}};var l=Gt(),c=_t(l);{var u=d=>{var g=lv(),f=b(g);{let m=x(()=>!t.isOwner);av(f,{get rating(){return h(n)},get readOnly(){return h(m)},onRating:p=>Er(o(p))})}w(g),D(d,g)};K(c,d=>{!Ks.isSharedLink&&r()?.ratings.enabled&&d(u)})}D(a,l),Ot(),i()}var hv=q('<div class="flex group transition-all"><a class="inline-block h-min whitespace-nowrap ps-3 pe-1 group-hover:ps-3 py-1 text-center align-baseline leading-none text-gray-100 dark:text-immich-dark-gray bg-primary rounded-s-full hover:bg-immich-primary/80 dark:hover:bg-immich-dark-primary/80 transition-all"><p class="text-sm"> </p></a> <button type="button" class="text-gray-100 dark:text-immich-dark-gray bg-immich-primary/95 dark:bg-immich-dark-primary/95 rounded-e-full place-items-center place-content-center pe-2 ps-1 py-1 hover:bg-immich-primary/80 dark:hover:bg-immich-dark-primary/80 transition-all" title="Remove tag"><!></button></div>'),uv=q('<section class="px-4 mt-4"><div class="flex h-10 w-full items-center justify-between text-sm"><!></div> <section class="flex flex-wrap pt-2 gap-1" data-testid="detail-panel-tags"><!> <button type="button" class="rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-700 dark:hover:text-gray-200 flex place-items-center place-content-center gap-1 px-2 py-1"><span class="text-sm px-1 flex place-items-center place-content-center gap-1"><!> </span></button></section></section>');function dv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"asset",15),n=x(()=>i().tags||[]);const o=async()=>{await Or.show(fd,{assetIds:[i().id]})&&i(await xi({id:i().id}))},l=async g=>{await du({tagIds:[g],assetIds:[i().id],showNotification:!1})&&i(await xi({id:i().id}))};var c=Gt();Ue(Re,(g,f)=>Ai?.(g,f),()=>({shortcut:{key:"t"},onShortcut:o}));var u=_t(c);{var d=g=>{var f=uv(),m=b(f),p=b(m);Rs(p,{color:"muted",children:(F,E)=>{ir();var _=xe();ct(j=>ft(_,j),[()=>e()("tags")]),D(F,_)},$$slots:{default:!0}}),w(m);var v=k(m,2),y=b(v);kr(y,17,()=>h(n),F=>F.id,(F,E)=>{var _=hv(),j=b(_),Y=b(j),G=b(Y,!0);w(Y),w(j);var R=k(j,2);R.__click=()=>l(h(E).id);var V=b(R);Se(V,{get icon(){return Oi}}),w(R),w(_),ct(W=>{Wt(j,"href",W),ft(G,h(E).value)},[()=>rr.tags({path:h(E).value})]),D(F,_)});var S=k(y,2);S.__click=o;var O=b(S),A=b(O);Se(A,{get icon(){return Fo}});var M=k(A,1,!0);w(O),w(S),w(v),w(f),ct((F,E)=>{Wt(S,"title",F),ft(M,E)},[()=>e()("add_tag"),()=>e()("add")]),D(g,f)};K(u,g=>{t.isOwner&&!Ks.isSharedLink&&g(d)})}D(a,c),Ot(),s()}Fr(["click"]);var gv=q('<div class="w-full"><!></div>'),fv=q("<!> <!> <!>",1);function mv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"initialDate",19,()=>fi.now()),n=St(t,"timezoneInput",3,!0),o=st(de(i().toFormat("yyyy-MM-dd'T'HH:mm:ss.SSS")));const l=x(()=>Uu(h(o)));let c=de(_a(i(),t.initialTimeZone,h(l))),u=x(()=>_a(i(),t.initialTimeZone,h(l),c));const d=async()=>{if(!h(g).isValid||!h(u)){t.onClose(!1);return}const f=Nu(h(o),h(u));try{await Di({id:t.asset.id,updateAssetDto:{dateTimeOriginal:f}}),t.onClose(!0)}catch(m){he(m,e()("errors.unable_to_change_date")),t.onClose(!1)}},g=x(()=>fi.fromISO(h(o),{zone:h(u)?.value,setZone:!0}));{let f=x(()=>e()("edit_date_and_time")),m=x(()=>e()("confirm")),p=x(()=>!h(g).isValid||!h(u));zo(a,{get title(){return h(f)},get icon(){return Ch},onClose:()=>t.onClose(!1),onSubmit:d,get submitText(){return h(m)},get disabled(){return h(p)},size:"small",children:(v,y)=>{var S=fv(),O=_t(S);hd(O,{for:"datetime",class:"block mb-1",children:(E,_)=>{ir();var j=xe();ct(Y=>ft(j,Y),[()=>e()("date_and_time")]),D(E,j)},$$slots:{default:!0}});var A=k(O,2);md(A,{class:"immich-form-input text-gray-700 w-full mb-2",id:"datetime",type:"datetime-local",get value(){return h(o)},set value(E){U(o,E,!0)}});var M=k(A,2);{var F=E=>{var _=gv(),j=b(_);{let Y=x(()=>e()("timezone")),G=x(()=>e()("search_timezone"));dd(j,{get label(){return h(Y)},get options(){return h(l)},get placeholder(){return h(G)},get selectedOption(){return h(u)},set selectedOption(R){U(u,R)}})}w(_),D(E,_)};K(M,E=>{n()&&E(F)})}D(v,S)},$$slots:{default:!0}})}Ot(),s()}var pv=q('<div class="flex place-content-center place-items-center"><!></div>'),vv=q('<div class="flex items-center gap-2"><!> <p class="flex text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <div class="flex justify-end gap-2"><!> <!></div>',1),_v=q("<div><!></div>"),yv=q('<!> <div class="w-full flex"><!> <!></div> <!>',1),xv=q('<div class="flex w-full justify-center"><!></div>'),wv=q('<div class="w-fit"><button type="button" class="w-22.5"><div class="relative"><!></div> <p class="mt-1 truncate font-medium"> </p></button></div>'),bv=q('<div class="immich-scrollbar mt-4 flex flex-wrap gap-2 overflow-y-auto"></div>'),Sv=q('<section class="absolute top-0 h-full w-90 overflow-x-hidden p-2 dark:text-immich-dark-fg bg-light"><div class="flex place-items-center justify-between gap-2"><!></div> <div class="px-4 py-4 text-sm"><h2 class="mb-8 mt-4"> </h2> <!></div></section>');function Cv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",s),r=()=>ht(Il,"$getPersonNameWithHiddenValue",s),[s,i]=Et();let n=st(de([])),o=st(!1);async function l(){const G=setTimeout(()=>U(o,!0),_n);try{const{people:R}=await El({withHidden:!0,closestAssetId:t.editedFace.id});U(n,R,!0)}catch(R){he(R,e()("errors.cant_get_faces"))}finally{clearTimeout(G)}U(o,!1)}let c=st(!1),u=st(!1),d=st(de([])),g=st(!1),f=st(""),m=x(()=>h(f)?h(d):h(n).filter(G=>!G.isHidden));lr(()=>{Er(l())});const p=async()=>{const G=setTimeout(()=>U(c,!0),_n),R=await Wc(t.editedFace,t.assetId,t.assetType,Rt.imgRef);t.onCreatePerson(R),clearTimeout(G),U(c,!1),t.onCreatePerson(R)};var v=Sv(),y=b(v),S=b(y);{var O=G=>{var R=vv(),V=_t(R),W=b(V);{let ut=x(()=>e()("back"));ee(W,{color:"secondary",variant:"ghost",shape:"round",get icon(){return yo},get"aria-label"(){return h(ut)},get onclick(){return t.onClose}})}var tt=k(W,2),et=b(tt,!0);w(tt),w(V);var z=k(V,2),Z=b(z);{let ut=x(()=>e()("search_for_existing_person"));ee(Z,{color:"secondary",variant:"ghost",shape:"round",get icon(){return Th},get"aria-label"(){return h(ut)},onclick:()=>{U(g,!0)}})}var Q=k(Z,2);{var rt=ut=>{{let lt=x(()=>e()("create_new_person"));ee(ut,{color:"secondary",variant:"ghost",shape:"round",get icon(){return Fo},get"aria-label"(){return h(lt)},onclick:p})}},nt=ut=>{var lt=pv(),dt=b(lt);Sr(dt,{}),w(lt),D(ut,lt)};K(Q,ut=>{h(c)?ut(nt,!1):ut(rt)})}w(z),ct(ut=>ft(et,ut),[()=>e()("select_face")]),D(G,R)},A=G=>{var R=yv(),V=_t(R);{let Q=x(()=>e()("back"));ee(V,{color:"secondary",variant:"ghost",shape:"round",get icon(){return yo},get"aria-label"(){return h(Q)},get onclick(){return t.onClose}})}var W=k(V,2),tt=b(W);vd(tt,{type:"input",get searchName(){return h(f)},set searchName(Q){U(f,Q,!0)},get showLoadingSpinner(){return h(u)},set showLoadingSpinner(Q){U(u,Q,!0)},get searchedPeopleLocal(){return h(d)},set searchedPeopleLocal(Q){U(d,Q,!0)}});var et=k(tt,2);{var z=Q=>{var rt=_v(),nt=b(rt);Sr(nt,{}),w(rt),D(Q,rt)};K(et,Q=>{h(u)&&Q(z)})}w(W);var Z=k(W,2);{let Q=x(()=>e()("cancel_search"));ee(Z,{color:"secondary",variant:"ghost",shape:"round",get icon(){return Oi},get"aria-label"(){return h(Q)},onclick:()=>U(g,!1)})}D(G,R)};K(S,G=>{h(g)?G(A,!1):G(O)})}w(y);var M=k(y,2),F=b(M),E=b(F,!0);w(F);var _=k(F,2);{var j=G=>{var R=xv(),V=b(R);Sr(V,{}),w(R),D(G,R)},Y=G=>{var R=bv();kr(R,21,()=>h(m),V=>V.id,(V,W)=>{var tt=Gt(),et=_t(tt);{var z=Z=>{var Q=wv(),rt=b(Q);rt.__click=()=>t.onReassign(h(W));var nt=b(rt),ut=b(nt);{let P=x(()=>yi(h(W))),H=x(()=>r()(h(W).name,h(W).isHidden)),X=x(()=>r()(h(W).name,h(W).isHidden));os(ut,{curve:!0,shadow:!0,get url(){return h(P)},get altText(){return h(H)},get title(){return h(X)},widthStyle:"90px",heightStyle:"90px",get hidden(){return h(W).isHidden}})}w(nt);var lt=k(nt,2),dt=b(lt,!0);w(lt),w(rt),w(Q),ct(P=>{Wt(lt,"title",P),ft(dt,h(W).name)},[()=>r()(h(W).name,h(W).isHidden)]),D(Z,Q)};K(et,Z=>{(!t.editedFace.person||h(W).id!==t.editedFace.person.id)&&Z(z)})}D(V,tt)}),w(R),D(G,R)};K(_,G=>{h(o)?G(j):G(Y,!1)})}w(M),w(v),ct(G=>ft(E,G),[()=>e()("all_people")]),ar(3,v,()=>Ts,()=>({x:360,duration:100,easing:Ll})),D(a,v),Ot(),i()}Fr(["click"]);var Tv=q('<button type="button" class="justify-self-end rounded-lg p-2 hover:bg-immich-dark-primary hover:dark:bg-immich-dark-primary/50"> </button>'),kv=q('<div class="flex w-full justify-center"><!></div>'),Ov=q("<span> </span>"),Av=q('<p class="relative mt-1 truncate font-medium"><!></p>'),Dv=q('<div class="flex place-content-center place-items-center rounded-full bg-[#d3d3d3] p-1 transition-all absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform"><!></div>'),Ev=q('<div class="absolute -end-[3px] top-8 h-5 w-5 rounded-full"><!></div>'),Pv=q('<div class="relative h-29 w-24"><div role="button" class="absolute start-0 top-0 h-22.5 w-22.5 cursor-default"><div class="relative"><!></div> <!> <div class="absolute -end-[3px] -top-[3px] h-5 w-5 rounded-full"><!></div> <div class="absolute end-8 -top-[3px] h-5 w-5 rounded-full"><!></div> <!></div></div>'),Mv=q('<!> <section class="absolute top-0 h-full w-90 overflow-x-hidden p-2 dark:text-immich-dark-fg bg-light"><div class="flex place-items-center justify-between gap-2"><div class="flex items-center gap-2"><!> <p class="flex text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <!></div> <div class="px-4 py-4 text-sm"><div class="mt-4 flex flex-wrap gap-2"><!></div></div></section> <!>',1);function Iv(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",s),r=()=>ht(Il,"$getPersonNameWithHiddenValue",s),[s,i]=Et();let n=[],o=[],l=st(de([])),c=de({}),u=de({}),d=st(void 0),g=st(!1),f=st(!1),m=st(!1),p,v;const y="90px";async function S(){const I=setTimeout(()=>U(f,!0),_n);try{U(l,await Ru({id:t.assetId}),!0)}catch(J){he(J,e()("errors.cant_get_faces"))}finally{clearTimeout(I)}U(f,!1)}const O=({id:I})=>{o.push(I),A(o,n)&&p&&v&&Object.keys(u).length===n.length&&(clearTimeout(p),clearTimeout(v),t.onRefresh())};lr(()=>{Er(S())});const A=(I,J)=>J.every(yt=>I.includes(yt)),M=I=>{c[I]&&delete c[I],u[I]&&delete u[I]},F=async()=>{p=setTimeout(()=>U(g,!0),_n);const I=Object.keys(u).length+Object.keys(c).length;if(I>0)try{for(const J of h(l)){const yt=c[J.id]?.id;if(yt)await va({id:yt,faceDto:{id:J.id}});else if(u[J.id]){const Mt=await ju({personCreateDto:{}});n.push(Mt.id),await va({id:Mt.id,faceDto:{id:J.id}})}}cr.success(e()("people_edits_count",{values:{count:I}}))}catch(J){he(J,e()("errors.cant_apply_changes"))}U(g,!1),n.length===0?(clearTimeout(p),t.onRefresh()):v=setTimeout(t.onRefresh,15e3)},E=I=>{I&&h(d)&&(u[h(d).id]=I),U(m,!1)},_=I=>{I&&h(d)&&(c[h(d).id]=I),U(m,!1)},j=I=>{U(d,I,!0),U(m,!0)},Y=async I=>{try{if(!I.person||!await Or.showDialog({prompt:e()("confirm_delete_face",{values:{name:I.person.name}})}))return;await Bu({id:I.id,assetFaceDeleteDto:{force:!1}}),U(l,h(l).filter(yt=>yt.id!==I.id),!0),await wn.setAssetId(t.assetId)}catch(J){he(J,e()("error_delete_face"))}};var G=Mv(),R=_t(G);Pl(R,{onPersonThumbnailReady:O});var V=k(R,2),W=b(V),tt=b(W),et=b(tt);{let I=x(()=>e()("back"));ee(et,{shape:"round",color:"secondary",variant:"ghost",get icon(){return yo},get"aria-label"(){return h(I)},get onclick(){return t.onClose}})}var z=k(et,2),Z=b(z,!0);w(z),w(tt);var Q=k(tt,2);{var rt=I=>{var J=Tv();J.__click=()=>F();var yt=b(J,!0);w(J),ct(Mt=>ft(yt,Mt),[()=>e()("done")]),D(I,J)},nt=I=>{Sr(I,{})};K(Q,I=>{h(g)?I(nt,!1):I(rt)})}w(W);var ut=k(W,2),lt=b(ut),dt=b(lt);{var P=I=>{var J=kv(),yt=b(J);Sr(yt,{}),w(J),D(I,J)},H=I=>{var J=Gt(),yt=_t(J);kr(yt,19,()=>h(l),Mt=>Mt.id,(Mt,pt,It)=>{const Vt=x(()=>h(pt).person?h(pt).person?.name:e()("face_unassigned"));var Ce=Pv(),Bt=b(Ce);Bt.__mouseover=()=>te(Gr,[h(l)[h(It)]]);var oe=b(Bt),ue=b(oe);{var Ar=Yt=>{{let Zt=x(()=>e()("new_person")),Te=x(()=>e()("new_person"));os(Yt,{curve:!0,shadow:!0,get url(){return u[h(pt).id]},get altText(){return h(Zt)},get title(){return h(Te)},widthStyle:y,heightStyle:y})}},Rr=Yt=>{var Zt=Gt(),Te=_t(Zt);{var Ze=it=>{{let vt=x(()=>yi(c[h(pt).id])),Ct=x(()=>r()(c[h(pt).id].name,c[h(pt).id]?.isHidden));os(it,{curve:!0,shadow:!0,get url(){return h(vt)},get altText(){return c[h(pt).id].name},get title(){return h(Ct)},widthStyle:y,heightStyle:y,get hidden(){return c[h(pt).id].isHidden}})}},ot=it=>{var vt=Gt(),Ct=_t(vt);{var Tt=xt=>{{let wt=x(()=>yi(h(pt).person)),jt=x(()=>r()(h(pt).person.name,h(pt).person.isHidden));os(xt,{curve:!0,shadow:!0,get url(){return h(wt)},get altText(){return h(pt).person.name},get title(){return h(jt)},widthStyle:y,heightStyle:y,get hidden(){return h(pt).person.isHidden}})}},At=xt=>{var wt=Gt(),jt=_t(wt);wi(jt,()=>Wc(h(pt),t.assetId,t.assetType,Rt.imgRef),zt=>{{let Nt=x(()=>e()("face_unassigned")),Dt=x(()=>e()("face_unassigned"));os(zt,{curve:!0,shadow:!0,url:"/src/lib/assets/no-thumbnail.png",get altText(){return h(Nt)},get title(){return h(Dt)},widthStyle:"90px",heightStyle:"90px"})}},(zt,Nt)=>{{let Dt=x(()=>h(Nt)===null?"/src/lib/assets/no-thumbnail.png":h(Nt)),L=x(()=>e()("face_unassigned")),$=x(()=>e()("face_unassigned"));os(zt,{curve:!0,shadow:!0,get url(){return h(Dt)},get altText(){return h(L)},get title(){return h($)},widthStyle:"90px",heightStyle:"90px"})}}),D(xt,wt)};K(Ct,xt=>{h(pt).person?xt(Tt):xt(At,!1)},!0)}D(it,vt)};K(Te,it=>{c[h(pt).id]?it(Ze):it(ot,!1)},!0)}D(Yt,Zt)};K(ue,Yt=>{u[h(pt).id]?Yt(Ar):Yt(Rr,!1)})}w(oe);var qe=k(oe,2);{var Xt=Yt=>{var Zt=Av(),Te=b(Zt);{var Ze=it=>{var vt=xe();ct(()=>ft(vt,c[h(pt).id]?.name)),D(it,vt)},ot=it=>{var vt=Ov(),Ct=b(vt,!0);w(vt),ct(Tt=>{Cr(vt,1,Tt),ft(Ct,h(Vt))},[()=>xl(h(Vt)===e()("face_unassigned")?"dark:text-gray-500":"")]),D(it,vt)};K(Te,it=>{c[h(pt).id]?.id?it(Ze):it(ot,!1)})}w(Zt),ct(()=>Wt(Zt,"title",h(Vt))),D(Yt,Zt)};K(qe,Yt=>{u[h(pt).id]||Yt(Xt)})}var se=k(qe,2),dr=b(se);{var fs=Yt=>{{let Zt=x(()=>e()("reset"));ee(Yt,{shape:"round",variant:"ghost",color:"primary",get icon(){return kh},get"aria-label"(){return h(Zt)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>M(h(pt).id)})}},ge=Yt=>{{let Zt=x(()=>e()("select_new_face"));ee(Yt,{shape:"round",color:"primary",get icon(){return Ys},get"aria-label"(){return h(Zt)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>j(h(pt))})}};K(dr,Yt=>{u[h(pt).id]||c[h(pt).id]?Yt(fs):Yt(ge,!1)})}w(se);var gr=k(se,2),Br=b(gr);{var Is=Yt=>{var Zt=Dv(),Te=b(Zt);Se(Te,{color:"primary",get icon(){return Oh},"aria-hidden":!0,size:"24"}),w(Zt),D(Yt,Zt)};K(Br,Yt=>{!u[h(pt).id]&&!c[h(pt).id]&&!h(pt).person&&Yt(Is)})}w(gr);var fr=k(gr,2);{var zr=Yt=>{var Zt=Ev(),Te=b(Zt);{let Ze=x(()=>e()("delete_face"));ee(Te,{shape:"round",color:"danger",get icon(){return Ah},get"aria-label"(){return h(Ze)},size:"small",class:"absolute start-1/2 top-1/2 translate-x-[-50%] translate-y-[-50%] transform",onclick:()=>Y(h(pt))})}w(Zt),D(Yt,Zt)};K(fr,Yt=>{h(pt).person!=null&&Yt(zr)})}w(Bt),w(Ce),ct(()=>Wt(Bt,"tabindex",h(It))),He("focus",Bt,()=>te(Gr,[h(l)[h(It)]])),He("mouseleave",Bt,()=>te(Gr,[])),D(Mt,Ce)}),D(I,J)};K(dt,I=>{h(f)?I(P):I(H,!1)})}w(lt),w(ut),w(V);var X=k(V,2);{var N=I=>{Cv(I,{get editedFace(){return h(d)},get assetId(){return t.assetId},get assetType(){return t.assetType},onClose:()=>U(m,!1),onCreatePerson:E,onReassign:_})};K(X,I=>{h(m)&&h(d)&&I(N)})}ct(I=>ft(Z,I),[()=>e()("edit_faces")]),ar(3,V,()=>Ts,()=>({x:360,duration:100,easing:Ll})),D(a,G),Ot(),i()}Fr(["click","mouseover"]);var Lv=q('<section class="px-4 py-4"><div role="alert"><div class="rounded-t bg-red-500 px-4 py-2 font-bold text-white"> </div> <div class="border border-t-0 border-red-400 bg-red-100 px-4 py-3 text-red-700"><p><!></p></div> <div class="rounded-b bg-red-500 px-4 py-2 text-white text-sm"><p> </p></div></div></section>'),Fv=q('<p class="font-light"><!></p>'),jv=q('<a class="w-22"><div class="relative"><!></div> <p class="mt-1 truncate font-medium"> </p> <!></a>'),Rv=q('<section class="px-4 pt-4 text-sm"><div class="flex h-10 w-full items-center justify-between"><!> <div class="flex gap-2 items-center"><!> <!> <!></div></div> <div class="mt-2 flex flex-wrap gap-2"></div></section>'),Bv=q('<div class="flex h-10 w-full items-center justify-between text-sm"><!></div>'),zv=q('<div class="p-1"><!></div>'),Vv=q('<button type="button"><div class="flex gap-4"><div><!></div> <div><p> </p> <div class="flex gap-2 text-sm"><p> </p></div></div></div> <!></button>'),Wv=q('<div class="flex justify-between place-items-start gap-4 py-4"><div class="flex gap-4"><div><!></div></div> <div class="p-1"><!></div></div>'),Hv=q('<p class="text-xs opacity-50 break-all pb-2 hover:text-primary"><a class="whitespace-pre-wrap"> </a></p>'),Yv=q("<p> </p>"),Xv=q("<!> <p> </p>",1),Nv=q("<p> </p>"),Uv=q('<div class="flex gap-2 text-sm"><!> <!></div>'),Gv=q('<p><a class="hover:text-primary"> </a></p>'),qv=q("<p> </p>"),Kv=q("<p> </p>"),$v=q('<div class="flex gap-4 py-4"><div><!></div> <div><!> <div class="flex gap-2 text-sm"><!> <!></div></div></div>'),Zv=q('<p><a class="hover:text-primary line-clamp-1"> </a></p>'),Jv=q("<p> </p>"),Qv=q("<p> </p>"),t_=q('<div class="flex gap-4 py-4"><div><!></div> <div><!> <div class="flex gap-2 text-sm"><!> <!></div></div></div>'),e_=q('<div class="flex flex-col items-center gap-1"><p class="font-bold"> </p> <a target="_blank" class="font-medium text-primary underline focus:outline-none"> </a></div>'),r_=q('<div class="flex items-center justify-center h-full w-full"><!></div>'),s_=q('<div class="h-90"><!></div>'),i_=q('<section class="px-6 dark:text-immich-dark-fg mt-4"><!> <div class="flex gap-4 pt-4"><div><!></div> <div class="mb-auto mt-auto"><p> </p></div></div></section>'),n_=q('<a><div class="flex gap-4 pt-2 hover:cursor-pointer items-center"><div><img class="h-12.5 w-12.5 rounded object-cover" draggable="false"/></div> <div class="mb-auto mt-auto"><p class="dark:text-immich-dark-primary"> </p> <div class="flex flex-col gap-0 text-sm"><div><!></div></div></div></div></a>'),o_=q('<section class="px-6 py-6 dark:text-immich-dark-fg"><div class="pb-4"><!></div> <!></section>'),a_=q('<section class="relative px-2 pb-12 dark:bg-immich-dark-bg dark:text-immich-dark-fg"><!></section>'),l_=q('<section class="relative p-2"><div class="flex place-items-center gap-2"><!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg"> </p></div> <!> <!> <!> <!> <div class="px-4 py-4"><!> <!> <div class="flex gap-4 py-4"><div><!></div> <div><p class="break-all flex place-items-center gap-2 whitespace-pre-wrap"> <!></p> <!> <!></div></div> <!> <!> <!></div></section> <!> <!> <!> <!> <!>',1);function c_(a,t){kt(t,!0);const e=()=>ht(Xs,"$user",n),r=()=>ht(Ft,"$t",n),s=()=>ht(fu,"$locale",n),i=()=>ht(Bo,"$preferences",n),[n,o]=Et();let l=St(t,"asset",7),c=St(t,"albums",19,()=>[]),u=St(t,"currentAlbum",3,null),d=st(!1),g=st(!1),f=x(()=>e()?.id===l().ownerId),m=x(()=>l().people||[]),p=x(()=>l().unassignedFaces||[]),v=st(!1),y=x(()=>l().exifInfo?.timeZone??void 0),S=x(()=>h(y)&&l().exifInfo?.dateTimeOriginal?xu(l().exifInfo.dateTimeOriginal,h(y)):wu(l().localDateTime)),O=x(()=>(()=>{const ot=l().exifInfo?.latitude,it=l().exifInfo?.longitude;if(ot&&it)return{lat:Number(ot.toFixed(7)),lng:Number(it.toFixed(7))}})()),A=st(void 0),M=x(()=>u()?.id?rr.viewAlbum(u()):rr.photos());Ee(()=>{h(A)||U(A,l().id,!0),l().id!==h(A)&&(U(g,!1),U(A,l().id,!0))});const F=(ot,it)=>{const vt=Math.round(it*ot/1e6);if(vt)return vt},E=async()=>{l(await xi({id:l().id})),U(g,!1)},_=ot=>rr.folders({path:pd(ot.originalPath)}),j=()=>U(d,!h(d)),Y=async()=>{h(f)&&await Or.show(mv,{asset:Pe(l()),initialDate:h(S),initialTimeZone:h(y)})};var G=l_(),R=_t(G),V=b(R),W=b(V);{let ot=x(()=>r()("close"));ee(W,{get icon(){return Oi},get"aria-label"(){return h(ot)},onclick:()=>Rt.closeDetailPanel(),shape:"round",color:"secondary",variant:"ghost"})}var tt=k(W,2),et=b(tt,!0);w(tt),w(V);var z=k(V,2);{var Z=ot=>{var it=Lv(),vt=b(it),Ct=b(vt),Tt=b(Ct,!0);w(Ct);var At=k(Ct,2),xt=b(At),wt=b(xt);{var jt=$=>{var at=xe();ct(bt=>ft(at,bt),[()=>r()("admin.asset_offline_description")]),D($,at)},zt=$=>{var at=xe();ct(bt=>ft(at,bt),[()=>r()("asset_offline_description")]),D($,at)};K(wt,$=>{e()?.isAdmin?$(jt):$(zt,!1)})}w(xt),w(At);var Nt=k(At,2),Dt=b(Nt),L=b(Dt,!0);w(Dt),w(Nt),w(vt),w(it),ct($=>{ft(Tt,$),ft(L,l().originalPath)},[()=>r()("asset_offline")]),D(ot,it)};K(z,ot=>{l().isOffline&&ot(Z)})}var Q=k(z,2);Kp(Q,{get asset(){return l()},get isOwner(){return h(f)}});var rt=k(Q,2);cv(rt,{get asset(){return l()},get isOwner(){return h(f)}});var nt=k(rt,2);{var ut=ot=>{var it=Rv(),vt=b(it),Ct=b(vt);Rs(Ct,{size:"small",color:"muted",children:(Dt,L)=>{ir();var $=xe();ct(at=>ft($,at),[()=>r()("people")]),D(Dt,$)},$$slots:{default:!0}});var Tt=k(Ct,2),At=b(Tt);{var xt=Dt=>{{let L=x(()=>r()("show_hidden_people")),$=x(()=>h(v)?Ih:Lh);ee(Dt,{get"aria-label"(){return h(L)},get icon(){return h($)},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>U(v,!h(v))})}};K(At,Dt=>{h(m).some(L=>L.isHidden)&&Dt(xt)})}var wt=k(At,2);{let Dt=x(()=>r()("tag_people"));ee(wt,{get"aria-label"(){return h(Dt)},get icon(){return Fo},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>hs.value=!hs.value})}var jt=k(wt,2);{var zt=Dt=>{{let L=x(()=>r()("edit_people"));ee(Dt,{get"aria-label"(){return h(L)},get icon(){return Ys},size:"medium",shape:"round",color:"secondary",variant:"ghost",onclick:()=>U(g,!0)})}};K(jt,Dt=>{(h(m).length>0||h(p).length>0)&&Dt(zt)})}w(Tt),w(vt);var Nt=k(vt,2);kr(Nt,23,()=>h(m),Dt=>Dt.id,(Dt,L,$)=>{var at=Gt(),bt=_t(at);{var ie=gt=>{var Pt=jv();Pt.__mouseover=()=>te(Gr,h(m)[h($)].faces);var le=b(Pt),ke=b(le);{let ye=x(()=>yi(h(L)));os(ke,{curve:!0,shadow:!0,get url(){return h(ye)},get altText(){return h(L).name},get title(){return h(L).name},widthStyle:"90px",heightStyle:"90px",get hidden(){return h(L).isHidden}})}w(le);var fe=k(le,2),Kt=b(fe,!0);w(fe);var Jt=k(fe,2);{var ve=ye=>{const Je=x(()=>fi.fromISO(h(L).birthDate)),Ie=x(()=>Math.floor(fi.fromISO(l().localDateTime).diff(h(Je),"years").years)),ze=x(()=>Math.floor(fi.fromISO(l().localDateTime).diff(h(Je),"months").months));var Ke=Gt(),rs=_t(Ke);{var ii=Qe=>{var mr=Fv(),qn=b(mr);{var Kn=Le=>{var Dr=xe();ct(ni=>ft(Dr,ni),[()=>r()("age_months",{values:{months:h(ze)}})]),D(Le,Dr)},$n=Le=>{var Dr=Gt(),ni=_t(Dr);{var Zn=ss=>{var ms=xe();ct(Jn=>ft(ms,Jn),[()=>r()("age_year_months",{values:{months:h(ze)-12}})]),D(ss,ms)},oi=ss=>{var ms=xe();ct(Jn=>ft(ms,Jn),[()=>r()("age_years",{values:{years:h(Ie)}})]),D(ss,ms)};K(ni,ss=>{h(ze)>12&&h(ze)<=23?ss(Zn):ss(oi,!1)},!0)}D(Le,Dr)};K(qn,Le=>{h(ze)<=11?Le(Kn):Le($n,!1)})}w(mr),ct(Le=>Wt(mr,"title",Le),[()=>h(Je).toLocaleString({month:"long",day:"numeric",year:"numeric"},{locale:s()})]),D(Qe,mr)};K(rs,Qe=>{h(Ie)>=0&&Qe(ii)})}D(ye,Ke)};K(Jt,ye=>{h(L).birthDate&&ye(ve)})}w(Pt),ct(ye=>{Wt(Pt,"href",ye),Wt(fe,"title",h(L).name),ft(Kt,h(L).name)},[()=>rr.viewPerson(h(L),{previousRoute:h(M)})]),He("focus",Pt,()=>te(Gr,h(m)[h($)].faces)),He("blur",Pt,()=>te(Gr,[])),He("mouseleave",Pt,()=>te(Gr,[])),D(gt,Pt)};K(bt,gt=>{(h(v)||!h(L).isHidden)&&gt(ie)})}D(Dt,at)}),w(Nt),w(it),D(ot,it)};K(nt,ot=>{!Ks.isSharedLink&&h(f)&&ot(ut)})}var lt=k(nt,2),dt=b(lt);{var P=ot=>{var it=Bv(),vt=b(it);Rs(vt,{size:"small",color:"muted",children:(Ct,Tt)=>{ir();var At=xe();ct(xt=>ft(At,xt),[()=>r()("details")]),D(Ct,At)},$$slots:{default:!0}}),w(it),D(ot,it)},H=ot=>{Rs(ot,{size:"small",color:"muted",children:(it,vt)=>{ir();var Ct=xe();ct(Tt=>ft(Ct,Tt),[()=>r()("no_exif_info_available")]),D(it,Ct)},$$slots:{default:!0}})};K(dt,ot=>{l().exifInfo?ot(P):ot(H,!1)})}var X=k(dt,2);{var N=ot=>{var it=Vv();let vt;it.__click=Y;var Ct=b(it),Tt=b(Ct),At=b(Tt);Se(At,{get icon(){return ua},size:"24"}),w(Tt);var xt=k(Tt,2),wt=b(xt),jt=b(wt,!0);w(wt);var zt=k(wt,2),Nt=b(zt),Dt=b(Nt,!0);w(Nt),w(zt),w(xt),w(Ct);var L=k(Ct,2);{var $=at=>{var bt=zv(),ie=b(bt);Se(ie,{get icon(){return Ys},size:"20"}),w(bt),D(at,bt)};K(L,at=>{h(f)&&at($)})}w(it),ct((at,bt,ie)=>{vt=Cr(it,1,"flex w-full text-start justify-between place-items-start gap-4 py-4",null,vt,{"hover:text-primary":h(f)}),Wt(it,"title",at),ft(jt,bt),ft(Dt,ie)},[()=>h(f)?r()("edit_date"):"",()=>h(S).toLocaleString({month:"short",day:"numeric",year:"numeric"},{locale:s()}),()=>h(S).toLocaleString({weekday:"short",hour:"numeric",minute:"2-digit",second:"2-digit",timeZoneName:h(y)?"longOffset":void 0},{locale:s()})]),D(ot,it)},I=ot=>{var it=Gt(),vt=_t(it);{var Ct=Tt=>{var At=Wv(),xt=b(At),wt=b(xt),jt=b(wt);Se(jt,{get icon(){return ua},size:"24"}),w(wt),w(xt);var zt=k(xt,2),Nt=b(zt);Se(Nt,{get icon(){return Ys},size:"20"}),w(zt),w(At),D(Tt,At)};K(vt,Tt=>{!h(S)&&h(f)&&Tt(Ct)},!0)}D(ot,it)};K(X,ot=>{h(S)?ot(N):ot(I,!1)})}var J=k(X,2),yt=b(J),Mt=b(yt);Se(Mt,{get icon(){return vl},size:"24"}),w(yt);var pt=k(yt,2),It=b(pt),Vt=b(It),Ce=k(Vt);{var Bt=ot=>{{let it=x(()=>r()("show_file_location"));ee(ot,{get icon(){return Dh},get"aria-label"(){return h(it)},size:"small",shape:"round",color:"secondary",variant:"ghost",onclick:j})}};K(Ce,ot=>{h(f)&&ot(Bt)})}w(It);var oe=k(It,2);{var ue=ot=>{var it=Hv(),vt=b(it),Ct=b(vt,!0);w(vt),w(it),ct((Tt,At)=>{Wt(vt,"href",Tt),Wt(vt,"title",At),ft(Ct,l().originalPath)},[()=>_(l()),()=>r()("go_to_folder")]),ar(3,it,()=>Eh,()=>({duration:250})),D(ot,it)};K(oe,ot=>{h(d)&&ot(ue)})}var Ar=k(oe,2);{var Rr=ot=>{var it=Uv(),vt=b(it);{var Ct=xt=>{const wt=x(()=>{const{width:$,height:at}=Ol(l().exifInfo);return{width:$,height:at}});var jt=Xv(),zt=_t(jt);{var Nt=$=>{var at=Yv(),bt=b(at);w(at),ct(ie=>ft(bt,`${ie??""} MP`),[()=>F(l().exifInfo.exifImageHeight,l().exifInfo.exifImageWidth)]),D($,at)};K(zt,$=>{F(l().exifInfo.exifImageHeight,l().exifInfo.exifImageWidth)&&$(Nt)})}var Dt=k(zt,2),L=b(Dt);w(Dt),ct(()=>ft(L,`${h(wt).width??""} x ${h(wt).height??""}`)),D(xt,jt)};K(vt,xt=>{l().exifInfo?.exifImageHeight&&l().exifInfo?.exifImageWidth&&xt(Ct)})}var Tt=k(vt,2);{var At=xt=>{var wt=Nv(),jt=b(wt,!0);w(wt),ct(zt=>ft(jt,zt),[()=>mu(l().exifInfo.fileSizeInByte,s())]),D(xt,wt)};K(Tt,xt=>{l().exifInfo?.fileSizeInByte&&xt(At)})}w(it),D(ot,it)};K(Ar,ot=>{(l().exifInfo?.exifImageHeight&&l().exifInfo?.exifImageWidth||l().exifInfo?.fileSizeInByte)&&ot(Rr)})}w(pt),w(J);var qe=k(J,2);{var Xt=ot=>{var it=$v(),vt=b(it),Ct=b(vt);Se(Ct,{get icon(){return Ph},size:"24"}),w(vt);var Tt=k(vt,2),At=b(Tt);{var xt=L=>{var $=Gv(),at=b($),bt=b(at);w(at),w($),ct((ie,gt)=>{Wt(at,"href",ie),Wt(at,"title",`${gt??""} ${(l().exifInfo.make||"")??""} ${(l().exifInfo.model||"")??""}`),ft(bt,`${(l().exifInfo.make||"")??""}
                ${(l().exifInfo.model||"")??""}`)},[()=>rr.search({make:l().exifInfo?.make??void 0,model:l().exifInfo?.model??void 0}),()=>r()("search_for")]),D(L,$)};K(At,L=>{(l().exifInfo?.make||l().exifInfo?.model)&&L(xt)})}var wt=k(At,2),jt=b(wt);{var zt=L=>{var $=qv(),at=b($,!0);w($),ct(()=>ft(at,`${l().exifInfo.exposureTime} s`)),D(L,$)};K(jt,L=>{l().exifInfo.exposureTime&&L(zt)})}var Nt=k(jt,2);{var Dt=L=>{var $=Kv(),at=b($,!0);w($),ct(()=>ft(at,`ISO ${l().exifInfo.iso}`)),D(L,$)};K(Nt,L=>{l().exifInfo.iso&&L(Dt)})}w(wt),w(Tt),w(it),D(ot,it)};K(qe,ot=>{(l().exifInfo?.make||l().exifInfo?.model||l().exifInfo?.exposureTime||l().exifInfo?.iso)&&ot(Xt)})}var se=k(qe,2);{var dr=ot=>{var it=t_(),vt=b(it),Ct=b(vt);Se(Ct,{get icon(){return Mh},size:"24"}),w(vt);var Tt=k(vt,2),At=b(Tt);{var xt=L=>{var $=Zv(),at=b($),bt=b(at,!0);w(at),w($),ct((ie,gt)=>{Wt(at,"href",ie),Wt(at,"title",`${gt??""} ${l().exifInfo.lensModel??""}`),ft(bt,l().exifInfo.lensModel)},[()=>rr.search({lensModel:l().exifInfo.lensModel}),()=>r()("search_for")]),D(L,$)};K(At,L=>{l().exifInfo?.lensModel&&L(xt)})}var wt=k(At,2),jt=b(wt);{var zt=L=>{var $=Jv(),at=b($);w($),ct(bt=>ft(at,`/${bt??""}`),[()=>l().exifInfo.fNumber.toLocaleString(s())]),D(L,$)};K(jt,L=>{l().exifInfo?.fNumber&&L(zt)})}var Nt=k(jt,2);{var Dt=L=>{var $=Qv(),at=b($,!0);w($),ct(bt=>ft(at,bt),[()=>`${l().exifInfo.focalLength.toLocaleString(s())} mm`]),D(L,$)};K(Nt,L=>{l().exifInfo.focalLength&&L(Dt)})}w(wt),w(Tt),w(it),D(ot,it)};K(se,ot=>{(l().exifInfo?.lensModel||l().exifInfo?.fNumber||l().exifInfo?.focalLength)&&ot(dr)})}var fs=k(se,2);sv(fs,{get isOwner(){return h(f)},get asset(){return l()}}),w(lt),w(R);var ge=k(R,2);{var gr=ot=>{var it=s_(),vt=b(it);wi(vt,()=>zs(()=>import("./C1N4k4OZ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50])),Ct=>{var Tt=Gt(),At=_t(Tt);wi(At,()=>gu(Jh),null,xt=>{var wt=r_(),jt=b(wt);Sr(jt,{}),w(wt),D(xt,wt)}),D(Ct,Tt)},(Ct,Tt)=>{var At=x(()=>{var{default:zt}=h(Tt);return{Map:zt}}),xt=x(()=>h(At).Map),wt=Gt(),jt=_t(wt);{const zt=(L,$)=>{let at=()=>$?.().marker;const bt=x(()=>{const{lat:fe,lon:Kt}=at();return{lat:fe,lon:Kt}});var ie=e_(),gt=b(ie),Pt=b(gt);w(gt);var le=k(gt,2),ke=b(le,!0);w(le),w(ie),ct((fe,Kt,Jt)=>{ft(Pt,`${fe??""}, ${Kt??""}`),Wt(le,"href",`https://www.openstreetmap.org/?mlat=${h(bt).lat??""}&mlon=${h(bt).lon??""}&zoom=13#map=15/${h(bt).lat??""}/${h(bt).lon??""}`),ft(ke,Jt)},[()=>h(bt).lat.toPrecision(6),()=>h(bt).lon.toPrecision(6),()=>r()("open_in_openstreetmap")]),D(L,ie)};let Nt=x(()=>[{lat:h(O).lat,lon:h(O).lng,id:l().id,city:l().exifInfo?.city??null,state:l().exifInfo?.state??null,country:l().exifInfo?.country??null}]),Dt=x(()=>!h(g));Fn(jt,()=>h(xt),(L,$)=>{$(L,{get mapMarkers(){return h(Nt)},get center(){return h(O)},showSettings:!1,zoom:12.5,simplified:!0,useLocationPin:!0,get showSimpleControls(){return h(Dt)},onOpenInMapView:()=>vn(rr.map({...h(O),zoom:12.5})),popup:zt,$$slots:{popup:!0}})})}D(Ct,wt)}),w(it),D(ot,it)};K(ge,ot=>{h(O)&&Ro.value.map&&ot(gr)})}var Br=k(ge,2);{var Is=ot=>{var it=i_(),vt=b(it);Rs(vt,{size:"small",color:"muted",children:(zt,Nt)=>{ir();var Dt=xe();ct(L=>ft(Dt,L),[()=>r()("shared_by")]),D(zt,Dt)},$$slots:{default:!0}});var Ct=k(vt,2),Tt=b(Ct),At=b(Tt);Zh(At,{get user(){return l().owner},size:"md"}),w(Tt);var xt=k(Tt,2),wt=b(xt),jt=b(wt,!0);w(wt),w(xt),w(Ct),w(it),ct(()=>ft(jt,l().owner.name)),D(ot,it)};K(Br,ot=>{u()&&u().albumUsers.length>0&&l().owner&&ot(Is)})}var fr=k(Br,2);{var zr=ot=>{var it=o_(),vt=b(it),Ct=b(vt);Rs(Ct,{size:"small",color:"muted",children:(At,xt)=>{ir();var wt=xe();ct(jt=>ft(wt,jt),[()=>r()("appears_in")]),D(At,wt)},$$slots:{default:!0}}),w(vt);var Tt=k(vt,2);kr(Tt,17,c,At=>At.id,(At,xt)=>{var wt=n_(),jt=b(wt),zt=b(jt),Nt=b(zt);w(zt);var Dt=k(zt,2),L=b(Dt),$=b(L,!0);w(L);var at=k(L,2),bt=b(at),ie=b(bt);tu(ie,{get album(){return h(xt)}}),w(bt),w(at),w(Dt),w(jt),w(wt),ct((gt,Pt)=>{Wt(wt,"href",gt),Wt(Nt,"alt",h(xt).albumName),Wt(Nt,"src",Pt),ft($,h(xt).albumName)},[()=>rr.viewAlbum(h(xt)),()=>h(xt).albumThumbnailAssetId&&ks({id:h(xt).albumThumbnailAssetId,size:ls.Preview})]),D(At,wt)}),w(it),D(ot,it)};K(fr,ot=>{c().length>0&&ot(zr)})}var Yt=k(fr,2);{var Zt=ot=>{var it=a_(),vt=b(it);dv(vt,{get asset(){return l()},get isOwner(){return h(f)}}),w(it),D(ot,it)};K(Yt,ot=>{i()?.tags?.enabled&&ot(Zt)})}var Te=k(Yt,2);{var Ze=ot=>{Iv(ot,{get assetId(){return l().id},get assetType(){return l().type},onClose:()=>U(g,!1),onRefresh:E})};K(Te,ot=>{h(g)&&ot(Ze)})}ct(ot=>{ft(et,ot),ft(Vt,`${l().originalFileName??""} `)},[()=>r()("info")]),D(a,G),Ot(),o()}Fr(["mouseover","click"]);var h_=q('<!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg capitalize"> </p>',1),u_=q("<!> <!>",1),d_=q('<section class="relative flex flex-col h-full p-2 dark:bg-immich-dark-bg dark:text-immich-dark-fg dark pt-3"><!> <section><!></section> <div class="flex-1"></div> <section class="p-4"><!></section></section>');function g_(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();lr(()=>pu.on("on_asset_update",p=>{p.id===o().id&&o(p)})),lr(async()=>{const p=await zu({id:o().id});await er.activateTool(oa.Transform,o(),p)}),qs(()=>{er.cleanup()});async function i(){await er.applyEdits()&&t.onClose()}async function n(){await er.closeConfirm()&&t.onClose()}let o=St(t,"asset",15);var l=d_();Ue(Re,(p,v)=>Ai?.(p,v),()=>({shortcut:{key:"Escape"},onShortcut:t.onClose}));var c=b(l);yn(c,{class:"justify-between me-4",children:(p,v)=>{var y=u_(),S=_t(y);yn(S,{children:(A,M)=>{var F=h_(),E=_t(F);{let Y=x(()=>e()("close"));ee(E,{shape:"round",variant:"ghost",color:"secondary",get icon(){return Oi},get"aria-label"(){return h(Y)},onclick:n})}var _=k(E,2),j=b(_,!0);w(_),ct(Y=>ft(j,Y),[()=>e()("editor")]),D(A,F)},$$slots:{default:!0}});var O=k(S,2);pn(O,{shape:"round",size:"small",onclick:i,get loading(){return er.isApplyingEdits},children:(A,M)=>{ir();var F=xe();ct(E=>ft(F,E),[()=>e()("save")]),D(A,F)},$$slots:{default:!0}}),D(p,y)},$$slots:{default:!0}});var u=k(c,2),d=b(u);{var g=p=>{var v=Gt(),y=_t(v);Fn(y,()=>er.selectedTool.component,(S,O)=>{O(S,{})}),D(p,v)};K(d,p=>{er.selectedTool&&p(g)})}w(u);var f=k(u,4),m=b(f);{let p=x(()=>!er.canReset);pn(m,{variant:"outline",onclick:()=>er.resetAllChanges(),get disabled(){return h(p)},class:"self-start",shape:"round",size:"small",children:(v,y)=>{ir();var S=xe();ct(O=>ft(S,O),[()=>e()("editor_reset_all_changes")]),D(v,S)},$$slots:{default:!0}})}w(f),w(l),D(a,l),Ot(),s()}var f_=q('<div class="canvas-container svelte-5ud7ea"><button aria-label="Crop area" type="button"><img draggable="false" class="svelte-5ud7ea"/> <div><div class="grid svelte-5ud7ea"></div> <div class="corner top-left svelte-5ud7ea"></div> <div class="corner top-right svelte-5ud7ea"></div> <div class="corner bottom-left svelte-5ud7ea"></div> <div class="corner bottom-right svelte-5ud7ea"></div></div> <div></div></button></div>');function m_(a,t){kt(t,!0);const e=()=>ht(Dl,"$getAltText",r),[r,s]=Et();let i=st(null),n=x(()=>ks({id:t.asset.id,cacheKey:t.asset.thumbhash,edited:!1,size:ls.Preview})),o=x(()=>{const f=[];return Qt.mirrorHorizontal&&f.push("scaleX(-1)"),Qt.mirrorVertical&&f.push("scaleY(-1)"),f.join(" ")});Ee(()=>{if(!h(i))return;const f=new ResizeObserver(()=>{Qt.resizeCanvas()});return f.observe(h(i)),()=>{f.disconnect()}});var l=f_(),c=b(l);c.__mousedown=f=>Qt.handleMouseDown(f),c.__mouseup=()=>Qt.handleMouseUp();var u=b(c),d=k(u,2);or(d,f=>Qt.cropFrame=f,()=>Qt?.cropFrame);var g=k(d,2);or(g,f=>Qt.overlayEl=f,()=>Qt?.overlayEl),w(c),or(c,f=>Qt.cropAreaEl=f,()=>Qt?.cropAreaEl),w(l),or(l,f=>U(i,f),()=>h(i)),ct(f=>{Cr(c,1,`crop-area ${Qt.orientationChanged?"changedOriention":""}`,"svelte-5ud7ea"),cs(c,`rotate:${Qt.imageRotation}deg`),Wt(u,"src",h(n)),Wt(u,"alt",f),cs(u,h(o)?`transform: ${h(o)}`:""),Cr(d,1,`${Qt.isInteracting?"resizing":""} crop-frame`,"svelte-5ud7ea"),Cr(g,1,`${Qt.isInteracting?"light":""} overlay`,"svelte-5ud7ea")},[()=>e()(Pe(t.asset))]),D(a,l),Ot(),s()}Fr(["mousedown","mouseup"]);var p_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function v_(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=async l=>{const c=await Vu({...Ks.params,id:l,size:ls.Preview});return URL.createObjectURL(c)};var n=p_(),o=b(n);wi(o,()=>Promise.all([i(t.asset.id),zs(()=>import("./DqZGkw0T.js"),__vite__mapDeps([51,1,6,4,5,7,21,12,9,52,53,3,41,42,13,14,43,17,25,19,2,8,30,31,11,10,15,24,54,55,56,28,57,58,18,59,60,27,29,33,23,34,26,32,61,35,36,37,38,62,63,64,65]))]),l=>{Sr(l,{})},(l,c)=>{var u=x(()=>{var[p,{default:v}]=h(c);return{data:p,PhotoSphereViewer:v}}),d=x(()=>h(u).data),g=x(()=>h(u).PhotoSphereViewer),f=Gt(),m=_t(f);{let p=x(()=>jo({asset:t.asset,forceOriginal:!0}));Fn(m,()=>h(g),(v,y)=>{y(v,{get panorama(){return h(d)},get originalPanorama(){return h(p)}})})}D(l,f)},l=>{var c=xe();ct(u=>ft(c,u),[()=>e()("errors.failed_to_load_asset")]),D(l,c)}),w(n),ar(3,n,()=>Ln,()=>({duration:150})),D(a,n),Ot(),s()}function __(a,t){kt(t,!1);const e=()=>ht(Ft,"$t",r),[r,s]=Et();yd();{let i=aa(()=>Ir.showOverlay?e()("hide_text_recognition"):e()("show_text_recognition")),n=aa(()=>e()("text_recognition"));ee(a,{get title(){return h(i)},get icon(){return Fh},class:"dark {ocrStore.showOverlay ? 'bg-immich-primary text-white dark' : 'dark'}",color:"secondary",variant:"ghost",shape:"round",get"aria-label"(){return h(n)},onclick:()=>Ir.toggleOcrBoundingBox()})}Ot(),s()}var y_=q('<span class="absolute start-0 h-[3px] bg-immich-primary shadow-2xl"></span>');function x_(a,t){kt(t,!0);const e=()=>ht(g,"$progress",r),[r,s]=Et();let i=St(t,"autoplay",3,!1),n=St(t,"status",15),o=St(t,"hidden",3,!1),l=St(t,"duration",3,5),c=St(t,"onPlaying",3,()=>{}),u=St(t,"onPaused",3,()=>{});const d=async E=>{g=y(E),await f()};let g=y(l());Ee(()=>{Er(d(l()))}),Ee(()=>{e()===1&&t.onDone()}),lr(async()=>{i()?(n(Xr.Playing),await f()):(n(Xr.Paused),await g.set(0))});const f=async()=>{n(Xr.Playing),c()(),await g.set(1)},m=async()=>{n(Xr.Paused),u()(),await g.set(e())},p=async()=>{await g.set(0),n()!==Xr.Paused&&await f()},v=async()=>{await g.set(0)};function y(E){return xd(0,{duration:(_,j)=>j?E*1e3*(j-_):0})}var S={play:f,pause:m,restart:p,resetProgress:v},O=Gt(),A=_t(O);{var M=E=>{var _=y_();let j;ct(()=>j=cs(_,"",j,{width:`${e()*100}%`})),D(E,_)};K(A,E=>{o()||E(M)})}D(a,O);var F=Ot(S);return s(),F}var w_=q('<div class="rounded-full bg-orange-100 px-2 text-[10px] text-orange-900"> </div>'),b_=q('<div class="flex place-items-center justify-between"><div><div class="flex h-6.5 place-items-center gap-1"><label class="font-medium text-primary text-sm"> </label> <!></div> <p class="text-sm dark:text-immich-dark-fg"> </p> <!></div> <div class="w-fit"><!></div></div>');function gl(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=St(t,"subtitle",3,""),n=St(t,"selectedOption",15),o=St(t,"isEdited",3,!1);var l=b_(),c=b(l),u=b(c),d=b(u),g=b(d,!0);w(d);var f=k(d,2);{var m=A=>{var M=w_(),F=b(M,!0);w(M),ct(E=>ft(F,E),[()=>e()("unsaved_change")]),ar(3,M,()=>Ts,()=>({x:10,duration:200,easing:_d})),D(A,M)};K(f,A=>{o()&&A(m)})}w(u);var p=k(u,2),v=b(p,!0);w(p);var y=k(p,2);Sl(y,()=>t.children??Lo),w(c);var S=k(c,2),O=b(S);wd(O,{get options(){return t.options},hideTextOnSmallScreen:!1,render:A=>({title:A.title,icon:A.icon}),get onSelect(){return t.onToggle},get selectedOption(){return n()},set selectedOption(A){n(A)}}),w(S),w(l),ct(()=>{Wt(d,"for",t.title),ft(g,t.title),ft(v,i())}),D(a,l),Ot(),s()}var S_=q("<!> <!>",1),C_=q('<div class="flex flex-col gap-4"><!> <!> <!> <!> <!> <!> <!></div>');function T_(a,t){kt(t,!0);const e=()=>ht(g,"$slideshowDelay",u),r=()=>ht(f,"$showProgressBar",u),s=()=>ht(m,"$slideshowNavigation",u),i=()=>ht(p,"$slideshowLook",u),n=()=>ht(v,"$slideshowTransition",u),o=()=>ht(y,"$slideshowAutoplay",u),l=()=>ht(S,"$slideshowRepeat",u),c=()=>ht(Ft,"$t",u),[u,d]=Et(),{slideshowDelay:g,showProgressBar:f,slideshowNavigation:m,slideshowLook:p,slideshowTransition:v,slideshowAutoplay:y,slideshowRepeat:S,slideshowState:O}=jn;let A=st(de(e())),M=st(de(r())),F=st(de(s())),E=st(de(i())),_=st(de(n())),j=st(de(o())),Y=st(de(l()));const G={[Os.Shuffle]:{icon:Bh,title:c()("shuffle")},[Os.AscendingOrder]:{icon:Rh,title:c()("backward")},[Os.DescendingOrder]:{icon:jh,title:c()("forward")}},R={[ln.Contain]:{icon:Wh,title:c()("contain")},[ln.Cover]:{icon:Vh,title:c()("cover")},[ln.BlurredBackground]:{icon:zh,title:c()("blurred_background")}},V=(tt,et)=>{for(const[z,Z]of Object.entries(et))if(Z===tt)return z},W=()=>{te(g,h(A)),te(f,h(M)),te(m,h(F)),te(p,h(E)),te(v,h(_)),te(y,h(j)),te(S,h(Y)),te(O,ae.PlaySlideshow),t.onClose()};{let tt=x(()=>c()("slideshow_settings"));zo(a,{size:"small",get title(){return h(tt)},get onClose(){return t.onClose},onSubmit:W,children:(et,z)=>{var Z=C_(),Q=b(Z);{let H=x(()=>c()("direction")),X=x(()=>Object.values(G));gl(Q,{get title(){return h(H)},get options(){return h(X)},get selectedOption(){return G[h(F)]},onToggle:N=>{U(F,V(N,G)||h(F),!0)}})}var rt=k(Q,2);{let H=x(()=>c()("look")),X=x(()=>Object.values(R));gl(rt,{get title(){return h(H)},get options(){return h(X)},get selectedOption(){return R[h(E)]},onToggle:N=>{U(E,V(N,R)||h(E),!0)}})}var nt=k(rt,2);{let H=x(()=>c()("autoplay_slideshow"));li(nt,{get label(){return h(H)},children:(X,N)=>{Ii(X,{get checked(){return h(j)},set checked(I){U(j,I,!0)}})},$$slots:{default:!0}})}var ut=k(nt,2);{let H=x(()=>c()("show_progress_bar"));li(ut,{get label(){return h(H)},children:(X,N)=>{Ii(X,{get checked(){return h(M)},set checked(I){U(M,I,!0)}})},$$slots:{default:!0}})}var lt=k(ut,2);{let H=x(()=>c()("show_slideshow_transition"));li(lt,{get label(){return h(H)},children:(X,N)=>{Ii(X,{get checked(){return h(_)},set checked(I){U(_,I,!0)}})},$$slots:{default:!0}})}var dt=k(lt,2);{let H=x(()=>c()("slideshow_repeat")),X=x(()=>c()("slideshow_repeat_description"));li(dt,{get label(){return h(H)},get description(){return h(X)},children:(N,I)=>{Ii(N,{get checked(){return h(Y)},set checked(J){U(Y,J,!0)}})},$$slots:{default:!0}})}var P=k(dt,2);{let H=x(()=>c()("duration"));li(P,{get label(){return h(H)},children:(X,N)=>{var I=S_(),J=_t(I);bd(J,{min:1,get value(){return h(A)},set value(Mt){U(A,Mt,!0)}});var yt=k(J,2);Sd(yt,{children:(Mt,pt)=>{ir();var It=xe();ct(Vt=>ft(It,Vt),[()=>c()("admin.slideshow_duration_description")]),D(Mt,It)},$$slots:{default:!0}}),D(X,I)},$$slots:{default:!0}})}w(Z),D(et,Z)},$$slots:{default:!0}})}Ot(),d()}var k_=q('<div class="m-4 flex gap-2 dark" role="navigation"><!> <!> <!> <!> <!> <!></div>'),O_=q(" <!> <!>",1);function A_(a,t){kt(t,!0);const e=()=>ht(y,"$slideshowNavigation",o),r=()=>ht(Ft,"$t",o),s=()=>ht(S,"$slideshowAutoplay",o),i=()=>ht(v,"$showProgressBar",o),n=()=>ht(p,"$slideshowDelay",o),[o,l]=Et();let c=St(t,"onNext",3,()=>{}),u=St(t,"onPrevious",3,()=>{}),d=St(t,"onClose",3,()=>{}),g=St(t,"onSetToFullScreen",3,()=>{});const{restartProgress:f,stopProgress:m,slideshowDelay:p,showProgressBar:v,slideshowNavigation:y,slideshowAutoplay:S}=jn;let O=st(void 0),A=st(void 0),M=st(!0),F,E=st(!1);const _=x(()=>t.assetType===as.Video);let j,Y;const G=X=>{document.body.style.cursor=X},R=()=>{clearTimeout(F),G("")},V=()=>{U(M,!0),R(),W()},W=()=>{F=setTimeout(()=>{h(E)||(U(M,!1),G("none"))},2500)};lr(()=>{W(),j=f.subscribe(X=>{X&&h(A)?.restart()}),Y=m.subscribe(X=>{X&&(h(A)?.restart(),R())})}),qs(()=>{j&&j(),Y&&Y()});const tt=async()=>{if(await h(A)?.resetProgress(),e()===Os.AscendingOrder){u()();return}c()()},et=async()=>{document.fullscreenElement&&await document.exitFullscreen(),await Or.show(T_)};lr(()=>{function X(){const N=document;!document.fullscreenElement&&!N.webkitIsFullScreen&&d()()}return document.addEventListener("fullscreenchange",X),document.addEventListener("webkitfullscreenchange",X),()=>{document.removeEventListener("fullscreenchange",X),document.removeEventListener("webkitfullscreenchange",X)}});const{swipe:z,onswipe:Z,onswipedown:Q}=na(()=>{},()=>({touchAction:"pan-x"}),{onswipedown:V},!0),rt=x(()=>{const X=[{shortcut:{key:"Escape"},onShortcut:d()},{shortcut:{key:"ArrowLeft"},onShortcut:u()},{shortcut:{key:"ArrowRight"},onShortcut:c()}];return h(_)||X.push({shortcut:{key:" "},onShortcut:()=>{h(O)===Xr.Paused?h(A)?.play():h(A)?.pause()},preventDefault:!0}),X});ir();var nt=O_();He("mousemove",Re,V),Ue(Re,(X,N)=>Ps?.(X,N),()=>h(rt)),Hh(Re.body,()=>z),He("swipe",Re.body,Z),He("swipedown",Re.body,Q);var ut=_t(nt);ut.nodeValue=" ";var lt=k(ut);{var dt=X=>{var N=k_(),I=b(N);{let Bt=x(()=>r()("exit_slideshow"));ee(I,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Oi},get onclick(){return d()},get"aria-label"(){return h(Bt)}})}var J=k(I,2);{var yt=Bt=>{{let oe=x(()=>h(O)===Xr.Paused?wl:bl),ue=x(()=>h(O)===Xr.Paused?r()("play"):r()("pause"));ee(Bt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return h(oe)},onclick:()=>h(O)===Xr.Paused?h(A)?.play():h(A)?.pause(),get"aria-label"(){return h(ue)}})}};K(J,Bt=>{h(_)||Bt(yt)})}var Mt=k(J,2);{let Bt=x(()=>r()("previous"));ee(Mt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return pl},get onclick(){return u()},get"aria-label"(){return h(Bt)}})}var pt=k(Mt,2);{let Bt=x(()=>r()("next"));ee(pt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return ml},get onclick(){return c()},get"aria-label"(){return h(Bt)}})}var It=k(pt,2);{let Bt=x(()=>r()("slideshow_settings"));ee(It,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Yh},onclick:et,get"aria-label"(){return h(Bt)}})}var Vt=k(It,2);{var Ce=Bt=>{{let oe=x(()=>r()("set_slideshow_to_fullscreen"));ee(Bt,{variant:"ghost",shape:"round",color:"secondary",get icon(){return Xh},get onclick(){return g()},get"aria-label"(){return h(oe)}})}};K(Vt,Bt=>{t.isFullScreen||Bt(Ce)})}w(N),He("mouseenter",N,()=>U(E,!0)),He("mouseleave",N,()=>U(E,!1)),ar(3,N,()=>Ts,()=>({duration:150})),D(X,N)};K(lt,X=>{h(M)&&X(dt)})}var P=k(lt,2);{var H=X=>{{let N=x(()=>!i());or(x_(X,{get autoplay(){return s()},get hidden(){return h(N)},get duration(){return n()},onDone:tt,get status(){return h(O)},set status(I){U(O,I,!0)}}),I=>U(A,I,!0),()=>h(A))}};K(P,X=>{h(_)||X(H)})}D(a,nt),Ot(),l()}var D_=q('<div class="p-3"><!></div>'),E_=q('<span class="flex items-center space-x-2 text-gray-200 text-2xl font-bold"><!> <span> </span></span> <img alt="poster" class="rounded-xl m-4"/> <div class="flex place-content-center place-items-center"><!> <input type="range" min="0" class="w-full h-4 bg-primary"/></div>',1);function P_(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et();let i=st(null);const n=async()=>{switch(Oe.castState){case ps.PLAYING:{Oe.pause();break}case ps.IDLE:{await o(t.assetFileUrl,!0);break}default:{Oe.play();break}}};Ee(()=>{t.assetFileUrl&&o(t.assetFileUrl)}),Ee(()=>{Oe.castState===ps.IDLE&&h(i)!==ps.PAUSED&&t.onVideoEnded(),U(i,Oe.castState,!0)});const o=async(A,M=!1)=>{if(!A||!Oe.isCasting)return;const F=new URL(A,globalThis.location.href);try{await Oe.loadMedia(F.href,M),t.onVideoStarted()}catch(E){he(E,"Unable to cast");return}};function l(A){const M=Number.parseFloat(A.target.value);Oe.seekTo(M)}var c=E_(),u=_t(c),d=b(u);Se(d,{get icon(){return Nh},class:"text-primary",size:"36"});var g=k(d,2),f=b(g);w(g),w(u);var m=k(u,2),p=k(m,2),v=b(p);{var y=A=>{var M=D_(),F=b(M);Sr(F,{}),w(M),D(A,M)},S=A=>{{let M=x(()=>Oe.castState==ps.PLAYING?bl:wl),F=x(()=>Oe.castState==ps.PLAYING?"Pause":"Play");ee(A,{color:"primary",shape:"round",variant:"ghost",get icon(){return h(M)},onclick:()=>n(),get"aria-label"(){return h(F)}})}};K(v,A=>{Oe.castState==ps.BUFFERING?A(y):A(S,!1)})}var O=k(v,2);yl(O),O.__change=l,w(p),ct(A=>{ft(f,`${A??""} ${Oe.receiverName??""}`),Wt(m,"src",t.poster),Wt(O,"max",Oe.duration),Uh(O,Oe.currentTime??0)},[()=>e()("connected_to")]),D(a,c),Ot(),s()}Fr(["change"]);var M_=q('<div class="place-content-center h-full place-items-center"><!></div>'),I_=q('<div class="absolute flex place-content-center place-items-center"><!></div>'),L_=q("<video></video> <!> <!>",3),F_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function j_(a,t){kt(t,!0);const e=()=>ht(_u,"$loopVideoPreference",n),r=()=>ht(vu,"$autoPlayVideo",n),s=()=>ht(ga,"$videoViewerMuted",n),i=()=>ht(fa,"$videoViewerVolume",n),[n,o]=Et();let l=St(t,"onPreviousAsset",3,()=>{}),c=St(t,"onNextAsset",3,()=>{}),u=St(t,"onVideoEnded",3,()=>{}),d=St(t,"onVideoStarted",3,()=>{}),g=St(t,"onClose",3,()=>{}),f=st(void 0),m=st(!0),p=x(()=>t.playOriginalVideo?ks({id:t.assetId,size:ls.Original,cacheKey:t.cacheKey}):Al({id:t.assetId,cacheKey:t.cacheKey})),v=st(!1),y=st(!1);lr(()=>{U(y,!0)}),Ee(()=>{h(p)&&h(f)?.load()}),qs(()=>{h(f)&&(h(f).src="")});const S=async Y=>{try{!Y.paused&&!h(v)&&(await Y.play(),d()())}catch(G){if(G instanceof DOMException&&G.name==="NotAllowedError"){await O(Y);return}}finally{U(m,!1)}},O=async Y=>{if(!Y.muted)try{Y.muted=!0,await S(Y)}catch{}},A=Y=>{Y.detail.direction==="left"&&c()(),Y.detail.direction==="right"&&l()()};let M=st(0),F=st(0);Ee(()=>{hs.value&&h(f)?.pause()});var E=Gt(),_=_t(E);{var j=Y=>{var G=F_(),R=b(G);{var V=tt=>{var et=M_(),z=b(et);{let Z=x(()=>ks({id:t.assetId,size:ls.Preview,cacheKey:t.cacheKey}));P_(z,{get poster(){return h(Z)},get onVideoStarted(){return d()},get onVideoEnded(){return u()},get assetFileUrl(){return h(p)}})}w(et),D(tt,et)},W=tt=>{var et=L_(),z=_t(et),Z=N=>S(N.currentTarget),Q=N=>te(ga,N.currentTarget.muted),rt=()=>U(v,!0),nt=()=>U(v,!1),ut=N=>{N.currentTarget.focus()},lt=()=>g()();_l(z,(N,I)=>({loop:e()&&t.loopVideo,autoplay:r(),playsinline:!0,controls:!0,disablePictureInPicture:!0,class:"h-full object-contain",...N,oncanplay:Z,onended:u(),onvolumechange:Q,onseeking:rt,onseeked:nt,onplaying:ut,onclose:lt,muted:s(),poster:I,src:h(p)}),[()=>na(A),()=>ks({id:t.assetId,size:ls.Preview,cacheKey:t.cacheKey})]),or(z,N=>U(f,N),()=>h(f));var dt=k(z,2);{var P=N=>{var I=I_(),J=b(I);Sr(J,{}),w(I),D(N,I)};K(dt,N=>{h(m)&&N(P)})}var H=k(dt,2);{var X=N=>{Vc(N,{get htmlElement(){return h(f)},get containerWidth(){return h(M)},get containerHeight(){return h(F)},get assetId(){return t.assetId}})};K(H,N=>{hs.value&&N(X)})}Cd(z,i,N=>te(fa,N)),D(tt,et)};K(R,tt=>{Oe.isCasting?tt(V):tt(W,!1)})}w(G),ar(3,G,()=>Ln,()=>({duration:Cl})),xn(G,"clientWidth",tt=>U(M,tt)),xn(G,"clientHeight",tt=>U(F,tt)),D(Y,G)};K(_,Y=>{h(y)&&Y(j)})}D(a,E),Ot(),o()}var R_=q('<div class="flex h-full select-none place-content-center place-items-center"><!></div>');function B_(a,t){kt(t,!0);const e=()=>ht(Ft,"$t",r),[r,s]=Et(),i=Promise.all([zs(()=>import("./DqZGkw0T.js"),__vite__mapDeps([51,1,6,4,5,7,21,12,9,52,53,3,41,42,13,14,43,17,25,19,2,8,30,31,11,10,15,24,54,55,56,28,57,58,18,59,60,27,29,33,23,34,26,32,61,35,36,37,38,62,63,64,65])).then(l=>l.default),zs(()=>import("./Cs33NVWg.js"),__vite__mapDeps([66,64])).then(l=>l.EquirectangularVideoAdapter),zs(()=>import("./BD8ry1BU.js"),__vite__mapDeps([67,64])).then(l=>l.VideoPlugin),zs(()=>Promise.resolve({}),__vite__mapDeps([68]))]);var n=R_(),o=b(n);wi(o,()=>i,l=>{Sr(l,{})},(l,c)=>{var u=x(()=>{var[v,y,S]=h(c);return{PhotoSphereViewer:v,adapter:y,videoPlugin:S}}),d=x(()=>h(u).PhotoSphereViewer),g=x(()=>h(u).adapter),f=x(()=>h(u).videoPlugin),m=Gt(),p=_t(m);{let v=x(()=>({source:Al({id:t.asset.id})})),y=x(()=>({source:jo({asset:t.asset,forceOriginal:!0})})),S=x(()=>[h(f)]);Fn(p,()=>h(d),(O,A)=>{A(O,{get panorama(){return h(v)},get originalPanorama(){return h(y)},get plugins(){return h(S)},get adapter(){return h(g)},navbar:!0})})}D(l,m)},l=>{var c=xe();ct(u=>ft(c,u),[()=>e()("errors.failed_to_load_asset")]),D(l,c)}),w(n),ar(3,n,()=>Ln,()=>({duration:150})),D(a,n),Ot(),s()}function _o(a,t){kt(t,!0);const e=x(()=>t.assetId??t.asset.id);var r=Gt(),s=_t(r);{var i=o=>{B_(o,{get asset(){return t.asset}})},n=o=>{j_(o,{get loopVideo(){return t.loopVideo},get cacheKey(){return t.cacheKey},get assetId(){return h(e)},get playOriginalVideo(){return t.playOriginalVideo},get onPreviousAsset(){return t.onPreviousAsset},get onNextAsset(){return t.onNextAsset},get onVideoEnded(){return t.onVideoEnded},get onVideoStarted(){return t.onVideoStarted},get onClose(){return t.onClose}})};K(s,o=>{t.projectionType===Tl.EQUIRECTANGULAR?o(i):o(n,!1)})}D(a,r),Ot()}var z_=q('<div class="col-span-4 col-start-1 row-span-1 row-start-1 transition-transform"><!></div>'),V_=q('<div class="absolute w-full flex justify-center"><!></div>'),W_=q('<div class="my-auto col-span-1 col-start-1 row-span-full row-start-1 justify-self-start"><!></div>'),H_=q('<div class="absolute bottom-0 end-0 mb-20 me-8"><!></div>'),Y_=q('<div class="absolute bottom-0 end-0 mb-6 me-6"><!></div>'),X_=q('<div class="my-auto col-span-1 col-start-4 row-span-full row-start-1 justify-self-end"><!></div>'),N_=q('<div id="detail-panel" class="row-start-1 row-span-4 w-90 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray bg-light" translate="yes"><!></div>'),U_=q('<div id="editor-panel" class="row-start-1 row-span-4 w-100 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray" translate="yes"><!></div>'),G_=q('<div class="w-full flex place-items-center place-content-center"><div class="w-2 h-2 bg-white rounded-full flex mt-0.5"></div></div>'),q_=q("<div><!> <!></div>"),K_=q('<div id="stack-slideshow" class="absolute bottom-0 w-full col-span-4 col-start-1 pointer-events-none"><div class="relative flex flex-row no-wrap overflow-x-auto overflow-y-hidden horizontal-scrollbar svelte-skymrn"></div></div>'),$_=q('<div id="activity-panel" class="row-start-1 row-span-5 w-90 md:w-115 overflow-y-auto transition-all dark:border-l dark:border-s-immich-dark-gray" translate="yes"><!></div>'),Z_=q('<!> <section id="immich-asset-viewer" class="fixed start-0 top-0 grid size-full grid-cols-4 grid-rows-[64px_1fr] overflow-hidden bg-black svelte-skymrn"><!> <!> <!> <div class="z-[-1] relative col-start-1 col-span-4 row-start-1 row-span-full"><!> <!> <!></div> <!> <!> <!> <!> <!></section>',1);function J_(a,t){kt(t,!0);const e=()=>ht(yu,"$alwaysLoadOriginalVideo",c),r=()=>ht(Ft,"$t",c),s=()=>ht(O,"$slideshowState",c),i=()=>ht(S,"$slideshowNavigation",c),n=()=>ht(M,"$slideshowRepeat",c),o=()=>ht(A,"$slideshowTransition",c),l=()=>ht(Xs,"$user",c),[c,u]=Et();let d=St(t,"cursor",7),g=St(t,"showNavigation",3,!0),f=St(t,"withStacked",3,!1),m=St(t,"isShared",3,!1);const{setAssetId:p}=wn,{restartProgress:v,stopProgress:y,slideshowNavigation:S,slideshowState:O,slideshowTransition:A,slideshowRepeat:M}=jn,F=60,E=65,_=x(()=>d().current),j=x(()=>d().nextAsset),Y=x(()=>d().previousAsset);let G=st(de([])),R=kl(),V=st(void 0),W=st(void 0),tt=[],et=st(null),z=st(de(e())),Z=st(void 0);const Q=L=>{U(z,L,!0)},rt=async()=>{Ks.isSharedLink||(h(_).stack&&U(et,await Wu({id:h(_).stack.id}),!0),h(et)?.assets.some(({id:L})=>L===h(_).id)||U(et,null),ws(()=>{di.preload(h(et)?.assets[1])}))},nt=async()=>{if(t.album&&t.album.isActivityEnabled)try{await Vr.toggleLike()}catch(L){he(L,r()("errors.unable_to_change_favorite"))}};lr(async()=>{tt.push(O.subscribe(L=>{L===ae.PlaySlideshow?(N.reset(),N.queue(Pe(h(_))),Er(J())):L===ae.StopSlideshow&&Er(yt())}),S.subscribe(L=>{L===Os.Shuffle&&(N.reset(),N.queue(Pe(h(_))))})),R||await ut()}),qs(()=>{for(const L of tt)L();Vr.reset()});const ut=async()=>{if(!Ks.isSharedLink)try{U(G,await Hu({assetId:h(_).id}),!0)}catch(L){console.error("Error getting album that asset belong to",L)}},lt=()=>{t.onClose?.(h(_))},dt=async()=>{if(er.hasAppliedEdits){const L=await xi({id:h(_).id});t.onAssetChange?.(L),wn.setAsset(L)}Rt.closeEditor()},P=new Qu,H=(L,$)=>{if(!L)if(s()===ae.PlaySlideshow)L=i()===Os.AscendingOrder?"previous":"next";else return;di.cancel(h(_)),!P.isActive()&&P.invoke(async()=>{let at=!1;if(s()===ae.PlaySlideshow&&i()===Os.Shuffle){if(at=L==="previous"?N.previous():N.next(),!at){const bt=await t.onRandom?.();bt&&(N.queue(bt),at=!0)}}else at=L==="previous"?await ma(d().previousAsset):await ma(d().nextAsset);s()===ae.PlaySlideshow&&(at?te(v,!0):n()&&h(Z)?(await p(h(Z)),te(v,!0)):await yt())},r()("error_while_navigating"))};let X=st(void 0);const N=new Up(L=>{Er(p(L.id).then(()=>te(v,!0)))}),I=()=>{s()===ae.PlaySlideshow&&te(y,!0)},J=async()=>{U(Z,h(_).id,!0);try{await h(X)?.requestFullscreen?.()}catch(L){he(L,r()("errors.unable_to_enter_fullscreen")),te(O,ae.StopSlideshow)}},yt=async()=>{try{document.fullscreenElement&&(document.body.style.cursor="",await document.exitFullscreen())}catch(L){he(L,r()("errors.unable_to_exit_fullscreen"))}finally{te(y,!0),te(O,ae.None)}},Mt=(L,$)=>{U(V,L?$:void 0,!0)},pt=L=>{t.preAction?.(L)},It=async L=>{switch(L.type){case Ut.ADD_TO_ALBUM:{await ut();break}case Ut.DELETE:case Ut.TRASH:{Ml.emit("AssetsDelete",[h(_).id]);break}case Ut.REMOVE_ASSET_FROM_STACK:{U(et,L.stack,!0),h(et)&&(d().current=h(et).assets[0]);break}case Ut.STACK:case Ut.SET_STACK_PRIMARY_ASSET:{U(et,L.stack,!0);break}case Ut.SET_PERSON_FEATURED_PHOTO:{const $=await xi({id:h(_).id});d().current={...h(_),people:$.people};break}case Ut.RATING:{d().current={...h(_),exifInfo:{...h(_).exifInfo,rating:L.rating}};break}case Ut.KEEP_THIS_DELETE_OTHERS:case Ut.UNSTACK:{lt();break}}t.onAction?.(L)};let Vt=x(()=>h(W)!==null);Ee(()=>{t.album&&!t.album.isActivityEnabled&&Vr.commentCount===0&&Rt.closeActivityPanel()}),Ee(()=>{t.album&&m()&&h(_).id&&Er(Vr.init(t.album.id,h(_).id))});const Ce=async()=>{await rt(),await ut(),Ir.clear(),R||(h(V)&&await Ir.getAssetOcr(h(V).id),await Ir.getAssetOcr(h(_).id))};Ee(()=>{h(_),ws(()=>Er(Ce())),di.preload(d().nextAsset),di.preload(d().previousAsset)});const Bt=async({oldAssetId:L,newAssetId:$})=>{L===h(_).id&&(await new Promise(at=>setTimeout(at,500)),await vn(rr.viewAsset({id:$})))},oe=L=>{h(_).id===L.id&&(d().current=L)},ue=x(()=>h(V)?h(_).type===as.Image?"StackPhotoViewer":"StackVideoViewer":h(_).type===as.Video?"VideoViewer":Rt.isPlayingMotionPhoto&&h(_).livePhotoVideoId?"LiveVideoViewer":h(_).exifInfo?.projectionType===Tl.EQUIRECTANGULAR||h(_).originalPath&&h(_).originalPath.toLowerCase().endsWith(".insp")?"ImagePanaramaViewer":Rt.isShowEditor&&er.selectedTool?.type===oa.Transform?"CropArea":"PhotoViewer"),Ar=x(()=>s()===ae.None&&m()&&(t.album&&t.album.isActivityEnabled||Vr.commentCount>0)&&!Vr.isLoading),Rr=x(()=>s()===ae.None&&h(_).type===as.Image&&h(_).exifInfo?.projectionType!=="EQUIRECTANGULAR"&&!Rt.isShowEditor&&Ir.hasOcrData);var qe=Z_(),Xt=_t(qe);Pl(Xt,{onAssetReplace:Bt,onAssetUpdate:oe});var se=k(Xt,2),dr=b(se);{var fs=L=>{var $=z_(),at=b($);{let bt=x(()=>t.onClose?()=>t.onClose(h(_)):void 0);Dp(at,{get asset(){return h(_)},get album(){return t.album},get person(){return t.person},get stack(){return h(et)},showSlideshow:!0,preAction:pt,onAction:It,get onUndoDelete(){return t.onUndoDelete},onPlaySlideshow:()=>te(O,ae.PlaySlideshow),get onClose(){return h(bt)},get playOriginalVideo(){return h(z)},setPlayOriginalVideo:Q})}w($),D(L,$)};K(dr,L=>{s()===ae.None&&!Rt.isShowEditor&&L(fs)})}var ge=k(dr,2);{var gr=L=>{var $=V_(),at=b($);{let bt=x(()=>h(V)?.type??h(_).type);A_(at,{get isFullScreen(){return h(Vt)},get assetType(){return h(bt)},onSetToFullScreen:()=>h(X)?.requestFullscreen?.(),onPrevious:()=>H("previous"),onNext:()=>H("next"),onClose:()=>te(O,ae.StopSlideshow)})}w($),D(L,$)};K(ge,L=>{s()!=ae.None&&L(gr)})}var Br=k(ge,2);{var Is=L=>{var $=W_(),at=b($);Ad(at,{onPreviousAsset:()=>H("previous")}),w($),D(L,$)};K(Br,L=>{s()===ae.None&&g()&&!Rt.isShowEditor&&h(Y)&&L(Is)})}var fr=k(Br,2),zr=b(fr);{var Yt=L=>{{let $=x(()=>({...d(),current:h(V)}));Io(L,{get cursor(){return h($)},onPreviousAsset:()=>H("previous"),onNextAsset:()=>H("next"),haveFadeTransition:!1,get sharedLink(){return R}})}},Zt=L=>{var $=Gt(),at=_t($);{var bt=gt=>{{let Pt=x(()=>h(V).exifInfo?.projectionType);_o(gt,{get asset(){return h(V)},get cacheKey(){return h(V).thumbhash},get projectionType(){return h(Pt)},loopVideo:!0,onPreviousAsset:()=>H("previous"),onNextAsset:()=>H("next"),onClose:lt,onVideoEnded:()=>H(),onVideoStarted:I,get playOriginalVideo(){return h(z)}})}},ie=gt=>{var Pt=Gt(),le=_t(Pt);{var ke=Kt=>{{let Jt=x(()=>h(_).exifInfo?.projectionType),ve=x(()=>s()!==ae.PlaySlideshow);_o(Kt,{get asset(){return h(_)},get assetId(){return h(_).livePhotoVideoId},get cacheKey(){return h(_).thumbhash},get projectionType(){return h(Jt)},get loopVideo(){return h(ve)},onPreviousAsset:()=>H("previous"),onNextAsset:()=>H("next"),onVideoEnded:()=>Rt.isPlayingMotionPhoto=!1,get playOriginalVideo(){return h(z)}})}},fe=Kt=>{var Jt=Gt(),ve=_t(Jt);{var ye=Ie=>{v_(Ie,{get asset(){return h(_)}})},Je=Ie=>{var ze=Gt(),Ke=_t(ze);{var rs=Qe=>{m_(Qe,{get asset(){return h(_)}})},ii=Qe=>{var mr=Gt(),qn=_t(mr);{var Kn=Le=>{{let Dr=x(()=>s()!==ae.None&&o());Io(Le,{get cursor(){return d()},onPreviousAsset:()=>H("previous"),onNextAsset:()=>H("next"),get sharedLink(){return R},get haveFadeTransition(){return h(Dr)}})}},$n=Le=>{var Dr=Gt(),ni=_t(Dr);{var Zn=oi=>{{let ss=x(()=>h(_).exifInfo?.projectionType),ms=x(()=>s()!==ae.PlaySlideshow);_o(oi,{get asset(){return h(_)},get cacheKey(){return h(_).thumbhash},get projectionType(){return h(ss)},get loopVideo(){return h(ms)},onPreviousAsset:()=>H("previous"),onNextAsset:()=>H("next"),onClose:lt,onVideoEnded:()=>H(),onVideoStarted:I,get playOriginalVideo(){return h(z)}})}};K(ni,oi=>{h(ue)==="VideoViewer"&&oi(Zn)},!0)}D(Le,Dr)};K(qn,Le=>{h(ue)==="PhotoViewer"?Le(Kn):Le($n,!1)},!0)}D(Qe,mr)};K(Ke,Qe=>{h(ue)==="CropArea"?Qe(rs):Qe(ii,!1)},!0)}D(Ie,ze)};K(ve,Ie=>{h(ue)==="ImagePanaramaViewer"?Ie(ye):Ie(Je,!1)},!0)}D(Kt,Jt)};K(le,Kt=>{h(ue)==="LiveVideoViewer"?Kt(ke):Kt(fe,!1)},!0)}D(gt,Pt)};K(at,gt=>{h(ue)==="StackVideoViewer"?gt(bt):gt(ie,!1)},!0)}D(L,$)};K(zr,L=>{h(ue)==="StackPhotoViewer"?L(Yt):L(Zt,!1)})}var Te=k(zr,2);{var Ze=L=>{var $=H_(),at=b($);{let bt=x(()=>!t.album?.isActivityEnabled);sd(at,{get disabled(){return h(bt)},get isLiked(){return Vr.isLiked},get numberOfComments(){return Vr.commentCount},get numberOfLikes(){return Vr.likeCount},onFavorite:nt})}w($),D(L,$)};K(Te,L=>{h(Ar)&&L(Ze)})}var ot=k(Te,2);{var it=L=>{var $=Y_(),at=b($);__(at,{}),w($),D(L,$)};K(ot,L=>{h(Rr)&&L(it)})}w(fr);var vt=k(fr,2);{var Ct=L=>{var $=X_(),at=b($);Od(at,{onNextAsset:()=>H("next")}),w($),D(L,$)};K(vt,L=>{s()===ae.None&&g()&&!Rt.isShowEditor&&h(j)&&L(Ct)})}var Tt=k(vt,2);{var At=L=>{var $=N_(),at=b($);c_(at,{get asset(){return h(_)},get currentAlbum(){return t.album},get albums(){return h(G)}}),w($),ar(3,$,()=>Ts,()=>({duration:150})),D(L,$)};K(Tt,L=>{h(_).hasMetadata&&s()===ae.None&&Rt.isShowDetailPanel&&!Rt.isShowEditor&&L(At)})}var xt=k(Tt,2);{var wt=L=>{var $=U_(),at=b($);g_(at,{get asset(){return h(_)},onClose:dt}),w($),ar(3,$,()=>Ts,()=>({duration:150})),D(L,$)};K(xt,L=>{Rt.isShowEditor&&L(wt)})}var jt=k(xt,2);{var zt=L=>{const $=x(()=>h(et).assets);var at=K_(),bt=b(at);kr(bt,21,()=>h($),ie=>ie.id,(ie,gt)=>{var Pt=q_();Cr(Pt,1,xl(["inline-block px-1 relative transition-all pb-2 pointer-events-auto"]));let le;var ke=b(Pt);{let Jt=x(()=>({"border-2 border-white":h(gt).id===h(_).id})),ve=x(()=>h(gt).id!==h(_).id),ye=x(()=>Pe(h(gt))),Je=x(()=>h(gt).id===h(_).id?E:F);nd(ke,{get imageClass(){return h(Jt)},brokenAssetClass:"text-xs",get dimmed(){return h(ve)},get asset(){return h(ye)},onClick:()=>{d().current=h(gt),U(V,void 0)},onMouseEvent:({isMouseOver:Ie})=>Mt(Ie,h(gt)),readonly:!0,get thumbnailSize(){return h(Je)},showStackedIcon:!1,disableLinkMouseOver:!0})}var fe=k(ke,2);{var Kt=Jt=>{var ve=G_();D(Jt,ve)};K(fe,Jt=>{h(gt).id===h(_).id&&Jt(Kt)})}w(Pt),ct(()=>le=cs(Pt,"",le,{bottom:h(gt).id===h(_).id?"0":"-10px"})),D(ie,Pt)}),w(bt),w(at),D(L,at)};K(jt,L=>{h(et)&&f()&&!Rt.isShowEditor&&L(zt)})}var Nt=k(jt,2);{var Dt=L=>{var $=$_(),at=b($);{let bt=x(()=>!t.album.isActivityEnabled);id(at,{get user(){return l()},get disabled(){return h(bt)},get assetType(){return h(_).type},get albumOwnerId(){return t.album.ownerId},get albumId(){return t.album.id},get assetId(){return h(_).id}})}w($),ar(3,$,()=>Ts,()=>({duration:150})),D(L,$)};K(Nt,L=>{m()&&t.album&&Rt.isShowActivityPanel&&l()&&L(Dt)})}w(se),Ue(se,L=>qh?.(L)),or(se,L=>U(X,L),()=>h(X)),Td("fullscreenElement","fullscreenchange",Re,L=>U(W,L,!0)),D(a,qe),Ot(),u()}const cy=Object.freeze(Object.defineProperty({__proto__:null,default:J_},Symbol.toStringTag,{value:"Module"}));export{qm as A,cy as a,Gr as b};
