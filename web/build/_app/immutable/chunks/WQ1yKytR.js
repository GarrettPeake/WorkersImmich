import{a as S}from"./DxRnQWdm.js";import{aC as E,a0 as I,h as _,i as M,g as P,j as x,d as w,a1 as A}from"./D0CSSuTl.js";import{e as L}from"./BpCm29KX.js";import{U as f}from"./DnqqNi3p.js";import{ah as C,n as O,ai as j,aj as q,ak as k}from"./BP6NvnZ7.js";import{u as R}from"./CJGyQpNN.js";import{h as B,I as N,Y as v,L as F,F as Q}from"./DUXNbmIP.js";import{$}from"./DWQ0JXRY.js";import{h as G}from"./DLePdI2u.js";function H(){const e=I([]),t=I({errors:0,duplicates:0,success:0,total:0}),{subscribe:i}=e,c=E(e,a=>a.length>0),u=E(e,a=>a.some(s=>s.state===f.ERROR||s.state===f.DUPLICATED)),o=E(e,a=>a.filter(s=>s.state===f.PENDING||s.state===f.STARTED).length),l=a=>{e.update(s=>s.find(n=>n.id===a.id)?s.map(n=>n.id===a.id?a:n):(t.update(n=>(n.total++,n)),s.push({...a,speed:0,state:f.PENDING,progress:0,eta:0}),s))},p=(a,s,g)=>{m(a,n=>{const b=n.startDate?s/((Date.now()-n.startDate)/1e3):0;return{...n,progress:Math.floor(s/g*100),speed:b,eta:Math.ceil((g-s)/b)}})},r=a=>{h(a,{state:f.STARTED,startDate:Date.now()})},m=(a,s)=>{e.update(g=>g.map(n=>n.id==a?s(n):n))},h=(a,s)=>{m(a,g=>({...g,...s}))};return{stats:t,remainingUploads:o,isDismissible:u,isUploading:c,track:a=>{t.update(s=>{switch(a){case"success":{s.success++;break}case"duplicate":{s.duplicates++;break}case"error":{s.errors++;break}}return s})},dismissErrors:()=>e.update(a=>a.filter(s=>s.state!==f.ERROR&&s.state!==f.DUPLICATED)),reset:()=>{e.set([]),t.set({errors:0,duplicates:0,success:0,total:0})},markStarted:r,addItem:l,updateItem:h,removeItem:a=>{e.update(s=>s.filter(g=>g.id!=a))},updateProgress:p,subscribe:i}}const d=H();class W{#t=_(M({image:[],sidecar:[],video:[]}));get mediaTypes(){return P(this.#t)}set mediaTypes(t){x(this.#t,t,!0)}constructor(){L.on({AppInit:()=>this.#e(),AuthLogout:()=>this.reset()})}reset(){d.reset()}async#e(){try{this.mediaTypes=await C()}catch{console.error("Failed to load supported media types")}}getExtensions(){return[...this.mediaTypes.image,...this.mediaTypes.video]}}const U=new W;class V{queue=[];running=0;_concurrency;constructor(t){this._concurrency=t?.concurrency||2}get concurrency(){return this._concurrency}set concurrency(t){if(t<1)return;this._concurrency=t;const i=t-this.running;if(i>0)for(let c=0;c<i;c++)this.tryRun()}addTask(t){return new Promise((i,c)=>{this.queue.push(async()=>{try{this.running++;const u=t();i(await u)}catch(u){c(u)}finally{this.taskFinished()}}),this.tryRun()})}taskFinished(){this.running--,this.tryRun()}tryRun(){if(this.running>=this.concurrency)return;const t=this.queue.shift();t&&B(t())}}const Y=new V({concurrency:2}),z=async(e={})=>{const{multiple:t=!0,extensions:i}=e;return new Promise((c,u)=>{try{const o=document.createElement("input");o.type="file",o.multiple=t,i&&(o.accept=i.join(",")),o.addEventListener("change",l=>{const p=l.target;if(!p.files)return;const r=Array.from(p.files);c(r)},{passive:!0}),o.click()}catch(o){console.log("Error selecting file",o),u(o)}})},ut=async(e={})=>{const{albumId:t,multiple:i=!0}=e,c=U.getExtensions(),u=await z({multiple:i,extensions:c});return J({files:u,albumId:t})},J=async({files:e,albumId:t,isLockedAssets:i=!1})=>{const c=U.getExtensions(),u=[];for(const l of e){const p=l.name.toLowerCase();if(c.some(r=>p.endsWith(r))){const r=K(l);d.addItem({id:r,file:l,albumId:t}),u.push(Y.addTask(()=>X({assetFile:l,deviceAssetId:r,albumId:t,isLockedAssets:i})))}}return(await Promise.all(u)).filter(l=>!!l)};function K(e){return"web-"+e.name+"-"+e.lastModified}async function X({assetFile:e,deviceAssetId:t,albumId:i,isLockedAssets:c=!1}){const u=new Date(e.lastModified).toISOString(),o=w($),l=!!w(R);d.markStarted(t);try{const p=new FormData;for(const[m,h]of Object.entries({deviceAssetId:t,deviceId:"WEB",fileCreatedAt:u,fileModifiedAt:new Date(e.lastModified).toISOString(),isFavorite:"false",duration:"0:00:00.000000",assetData:new File([e],e.name)}))p.append(m,h);c&&p.append("visibility",O.Locked);let r;if(crypto?.subtle?.digest&&!S.isSharedLink){d.updateItem(t,{message:o("asset_hashing")}),await A();try{const m=await e.arrayBuffer(),h=await crypto.subtle.digest("SHA-1",m),y=Array.from(new Uint8Array(h)).map(T=>T.toString(16).padStart(2,"0")).join(""),{results:[D]}=await j({assetBulkUploadCheckDto:{assets:[{id:e.name,checksum:y}]}});D.action===q.Reject&&D.assetId&&(r={status:k.Duplicate,id:D.assetId,isTrashed:D.isTrashed})}catch(m){console.error(`Error calculating sha1 file=${e.name})`,m)}}if(!r){const m=N(S.params);d.updateItem(t,{message:o("asset_uploading")});const h=await v({url:F()+"/assets"+(m?`?${m}`:""),data:p,onUploadProgress:y=>d.updateProgress(t,y.loaded,y.total)});if(![200,201].includes(h.status))throw new Error(o("errors.unable_to_upload_file"));r=h.data}return r.status===k.Duplicate?d.track("duplicate"):d.track("success"),i&&(d.updateItem(t,{message:o("asset_adding_to_album")}),await Q(i,[r.id],!1),d.updateItem(t,{message:o("asset_added_to_album")})),d.updateItem(t,{state:r.status===k.Duplicate?f.DUPLICATED:f.DONE,assetId:r.id,isTrashed:r.isTrashed}),r.status!==k.Duplicate&&setTimeout(()=>{d.removeItem(t)},1e3),r.id}catch(p){if(l&&!w(R))return;const r=G(p,o("errors.unable_to_upload_file"));d.track("error"),d.updateItem(t,{state:f.ERROR,error:r});return}}export{z as a,Y as b,J as f,ut as o,d as u};
