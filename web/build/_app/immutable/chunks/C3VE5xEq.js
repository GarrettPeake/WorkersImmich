import"./DsnmJJEf.js";import{p as Ke,c as a,g as e,s as h,r as i,t as L,a as Ge,u as j,h as x,i as Ne,j as l,d as Me,aQ as le,V as nt,b as vt,f as ne}from"./D0CSSuTl.js";import{d as dt,s as U,e as ct}from"./C8vxa4mj.js";import{a as m,f as _,c as we}from"./Bd1JH_Ov.js";import{i as w}from"./D8NIUdeB.js";import{a as ke,ci as ut,cj as Qe,ck as mt,q as gt,p as ht,I as Oe,w as ft,cl as _t,cm as yt,v as bt,ac as pt,cn as wt,s as S,a2 as ze,ah as Re}from"./D-UYCH9y.js";import{s as We,a as Ae,p as He}from"./zonMEKN6.js";import{a as Xe}from"./BZ21-Ulh.js";import{l as Ye,h as Pe,y as Ue,a2 as xt}from"./DUXNbmIP.js";import{h as je,e as kt,t as At}from"./DLePdI2u.js";import{b as xe}from"./Dgf_MdoC.js";import{a as jt}from"./BVZhy_zG.js";import{B as Be}from"./GXf5CvES.js";import{M as Fe}from"./B2VKg7zy.js";import{a as Lt}from"./0qPXRVhz.js";import{u as Ct,D as ve}from"./CJGyQpNN.js";import{aV as It,aW as C,aX as Tt,aY as Ve,aZ as St,a_ as Dt}from"./BP6NvnZ7.js";import{$ as Ze}from"./DWQ0JXRY.js";import{R as qe}from"./gegweU97.js";import{U as Ee}from"./CIJfCxLq.js";import{T as Mt}from"./BcI9YXFA.js";var Ot=_('<div class="text-l"> </div>'),zt=_('<div class="text-l"> </div>'),Rt=_('<div class="w-full flex p-4 items-center justify-center rounded-full gap-5 bg-subtle border bg-opacity-60"><button type="button"><div class="flex gap-2 items-center justify-center"><!> <!></div></button> <button type="button"><div class="flex gap-2 items-center justify-center"><!> <!></div></button></div>');function yi(O,t){Ke(t,!0);const r=()=>Ae(Ye,"$locale",n),[n,B]=We();var z=Rt(),A=a(z);A.__click=function(...u){t.onFavorite?.apply(this,u)};var I=a(A),N=a(I);{let u=j(()=>t.isLiked?Qe:mt),b=j(()=>t.isLiked?"text-primary":"text-fg");ke(N,{get icon(){return e(u)},size:"24",get class(){return e(b)}})}var T=h(N,2);{var ie=u=>{var b=Ot(),F=a(b,!0);i(b),L(V=>U(F,V),[()=>t.numberOfLikes.toLocaleString(r())]),m(u,b)};w(T,u=>{t.numberOfLikes&&u(ie)})}i(I),i(A);var R=h(A,2);R.__click=()=>Xe.toggleActivityPanel();var Q=a(R),W=a(Q);ke(W,{get icon(){return ut},class:"scale-x-[-1]",size:"24"});var de=h(W,2);{var se=u=>{var b=zt(),F=a(b,!0);i(b),L(V=>U(F,V),[()=>t.numberOfComments.toLocaleString(r())]),m(u,b)};w(de,u=>{t.numberOfComments&&u(se)})}i(Q),i(R),i(z),L(()=>{gt(A,1,ht(t.disabled?"cursor-not-allowed":"")),A.disabled=t.disabled}),m(O,z),Ge(),B()}dt(["click"]);class Ht{#e=x();#i=x();#t=x(Ne([]));#a=x(0);#r=x(0);#s=x(null);#o=new Map;#n=x(!1);get isLoading(){return e(this.#n)}set isLoading(t){l(this.#n,t,!0)}get assetId(){return e(this.#i)}get activities(){return e(this.#t)}get commentCount(){return e(this.#a)}get likeCount(){return e(this.#r)}get isLiked(){return e(this.#s)}#l(t,r){return`${t}:${r??""}`}async init(t,r){if(!(r&&r===e(this.#i))){l(this.#e,t,!0),l(this.#i,r,!0);try{await k.refreshActivities(t,r)}catch(n){je(n,Me(Ze)("errors.unable_to_get_comments_number"))}}}#v(t,r){this.#o.delete(this.#l(t)),this.#o.delete(this.#l(t,r))}async addActivity(t){if(e(this.#e)===void 0)return;const r=await It({activityCreateDto:t});return l(this.#t,[...e(this.#t),r],!0),r.type===C.Comment&&le(this.#a),r.type===C.Like&&le(this.#r),this.#v(e(this.#e),e(this.#i)),Pe(this.refreshActivities(e(this.#e),e(this.#i))),r}async deleteActivity(t,r){e(this.#e)&&(t.type===C.Comment&&le(this.#a,-1),t.type===C.Like&&le(this.#r,-1),l(this.#t,r?e(this.#t).splice(r,1):e(this.#t).filter(({id:n})=>n!==t.id),!0),await Tt({id:t.id}),this.#v(e(this.#e),e(this.#i)),Pe(this.refreshActivities(e(this.#e),e(this.#i))))}async toggleLike(){e(this.#e)&&(e(this.#s)?(await this.deleteActivity(e(this.#s)),l(this.#s,null)):l(this.#s,await this.addActivity({albumId:e(this.#e),assetId:e(this.#i),type:C.Like}),!0))}async refreshActivities(t,r){this.isLoading=!0;const n=this.#l(t,r);if(this.#o.has(n)){const I=this.#o.get(n);l(this.#t,I.activities,!0),l(this.#a,I.commentCount,!0),l(this.#r,I.likeCount,!0),l(this.#s,I.isLiked??null,!0),this.isLoading=!1;return}l(this.#t,await Ve({albumId:t,assetId:r}),!0);const[B]=await Ve({albumId:t,assetId:r,userId:Me(Ct).id,$type:C.Like,level:r?void 0:St.Album});l(this.#s,B??null,!0);const{comments:z,likes:A}=await Dt({albumId:t,assetId:r});l(this.#a,z,!0),l(this.#r,A,!0),this.#o.set(n,{activities:e(this.#t),commentCount:e(this.#a),likeCount:e(this.#r),isLiked:e(this.#s)}),this.isLoading=!1}reset(){l(this.#e,void 0),l(this.#i,void 0),l(this.#t,[],!0),l(this.#a,0),l(this.#r,0)}}const k=new Ht,Pt=(O,t)=>!O||!t?!1:Math.abs(new Date(O).getTime()-new Date(t).getTime())/(1e3*60)>=10;var Ut=_('<a class="aspect-square w-19 h-19 svelte-1ohjg3g"><img class="rounded-lg w-19 h-19 object-cover svelte-1ohjg3g"/></a>'),Bt=_('<div class="me-4 svelte-1ohjg3g"><!></div>'),Ft=_('<div class="pt-1 px-2 text-right w-full text-sm text-gray-500 dark:text-gray-300 svelte-1ohjg3g"> </div>'),Vt=_('<div class="flex dark:bg-gray-800 bg-gray-200 py-3 ps-3 mt-3 rounded-lg gap-4 justify-start svelte-1ohjg3g"><div class="flex items-center svelte-1ohjg3g"><!></div> <div class="w-full leading-4 overflow-hidden self-center wrap-break-word text-sm svelte-1ohjg3g"> </div> <!> <!></div> <!>',1),qt=_('<a class="aspect-square w-19 h-19 svelte-1ohjg3g"><img class="rounded-lg w-19 h-19 object-cover svelte-1ohjg3g"/></a>'),Et=_('<div class="me-4 svelte-1ohjg3g"><!></div>'),Kt=_('<div class="pt-1 px-2 text-right w-full text-sm text-gray-500 dark:text-gray-300 svelte-1ohjg3g"> </div>'),Gt=_('<div class="relative svelte-1ohjg3g"><div class="flex py-3 ps-3 mt-3 gap-4 items-center text-sm svelte-1ohjg3g"><div class="text-primary svelte-1ohjg3g"><!></div> <div class="w-full svelte-1ohjg3g"> </div> <!> <!></div> <!></div>'),Nt=_('<div class="overflow-y-auto immich-scrollbar relative w-full px-2 svelte-1ohjg3g"></div>'),Qt=_('<div class="flex place-items-center pb-2 ms-0 svelte-1ohjg3g"><div class="flex w-full place-items-center svelte-1ohjg3g"><!></div></div>'),Wt=_('<div class="flex items-center w-fit ms-0 light svelte-1ohjg3g"><!></div>'),Xt=_('<div class="overflow-y-hidden relative h-full border-l border-subtle bg-subtle svelte-1ohjg3g"><div class="w-full h-full svelte-1ohjg3g"><div class="flex w-full h-fit dark:text-immich-dark-fg p-2 bg-subtle svelte-1ohjg3g"><div class="flex place-items-center gap-2 svelte-1ohjg3g"><!> <p class="text-lg text-immich-fg dark:text-immich-dark-fg svelte-1ohjg3g"> </p></div></div> <!></div> <div class="absolute w-full bottom-0 svelte-1ohjg3g"><div class="flex items-center justify-center p-2 svelte-1ohjg3g"><div class="flex p-2 gap-4 h-fit bg-gray-200 text-immich-dark-gray rounded-3xl w-full svelte-1ohjg3g"><div class="svelte-1ohjg3g"><!></div> <form class="flex w-full items-center max-h-56 gap-1 svelte-1ohjg3g"><!> <!></form></div></div></div></div>');function bi(O,t){Ke(t,!0);const r=()=>Ae(Ye,"$locale",B),n=()=>Ae(Ze,"$t",B),[B,z]=We(),A=["year","month","week","day","hour","minute","second"],I=(s,v)=>{const d=ve.fromISO(s,{locale:r()}),o=ve.fromISO(v,{locale:r()});return d.hasSame(o,"hour")||d.toRelative()===o.toRelative()},N=s=>{const v=s.diffNow().shiftTo(...A),d=A.find(g=>v.get(g)!==0)||"second";return new Intl.RelativeTimeFormat(r(),{numeric:"auto"}).format(Math.trunc(v.as(d)),d)};let T=He(t,"assetId",3,void 0),ie=He(t,"assetType",3,void 0),R=x(0),Q=x(0),W=x(0),de=j(()=>e(R)-e(Q)),se=x(Ne(T())),u=x(""),b=x(!1);const F={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1},V=async(s,v)=>{try{await k.deleteActivity(s,v);const d={[C.Comment]:n()("comment_deleted"),[C.Like]:n()("like_deleted")};At.success(d[s.type])}catch(d){je(d,n()("errors.unable_to_remove_reaction"))}},ce=async()=>{if(!e(u))return;const s=setTimeout(()=>l(b,!0),Lt);try{await k.addActivity({albumId:t.albumId,assetId:T(),type:C.Comment,comment:e(u)}),l(u,"")}catch(v){je(v,n()("errors.unable_to_add_comment"))}finally{clearTimeout(s)}l(b,!1)};nt(()=>{T()&&e(se)!=T()&&l(se,T())});const Je=async s=>{s.preventDefault(),await ce()};var ae=Xt(),ue=a(ae),re=a(ue),Le=a(re),Ce=a(Le);{let s=j(()=>n()("close"));Oe(Ce,{shape:"round",variant:"ghost",color:"secondary",onclick:()=>Xe.closeActivityPanel(),get icon(){return ft},get"aria-label"(){return e(s)}})}var Ie=h(Ce,2),$e=a(Ie,!0);i(Ie),i(Le),i(re);var et=h(re,2);{var tt=s=>{var v=Nt();kt(v,23,()=>k.activities,d=>d.id,(d,o,g)=>{var q=we(),fe=ne(q);{var _e=E=>{var X=Vt(),Y=ne(X),Z=a(Y),J=a(Z);Ee(J,{get user(){return e(o).user},size:"sm"}),i(Z);var H=h(Z,2),$=a(H,!0);i(H);var K=h(H,2);{var ye=p=>{var f=Ut(),D=a(f);i(f),L((P,c)=>{S(f,"href",P),S(D,"src",c),S(D,"alt",`Profile picture of ${e(o).user.name??""}, who commented on this asset`)},[()=>qe.viewAlbumAsset({albumId:t.albumId,assetId:e(o).assetId}),()=>Ue({id:e(o).assetId})]),m(p,f)};w(K,p=>{T()===void 0&&e(o).assetId&&p(ye)})}var G=h(K,2);{var be=p=>{var f=Bt(),D=a(f);{let P=j(()=>n()("comment_options"));Be(D,{get icon(){return Re},get title(){return e(P)},align:"top-right",direction:"left",size:"small",children:(c,y)=>{{let M=j(()=>n()("remove"));Fe(c,{activeColor:"bg-red-200",get icon(){return ze},get text(){return e(M)},onClick:()=>V(e(o),e(g))})}},$$slots:{default:!0}})}i(f),m(p,f)};w(G,p=>{(e(o).user.id===t.user.id||t.albumOwnerId===t.user.id)&&p(be)})}i(Y);var oe=h(Y,2);{var pe=p=>{var f=Ft(),D=a(f,!0);i(f),L((P,c)=>{S(f,"title",P),U(D,c)},[()=>new Date(e(o).createdAt).toLocaleDateString(void 0,F),()=>N(ve.fromISO(e(o).createdAt,{locale:r()}))]),m(p,f)};w(oe,p=>{(e(g)!=k.activities.length-1&&!I(k.activities[e(g)].createdAt,k.activities[e(g)+1].createdAt)||e(g)===k.activities.length-1)&&p(pe)})}L(()=>U($,e(o).comment)),m(E,X)},ot=E=>{var X=we(),Y=ne(X);{var Z=J=>{var H=Gt(),$=a(H),K=a($),ye=a(K);ke(ye,{get icon(){return Qe},size:"20"}),i(K);var G=h(K,2),be=a(G,!0);i(G);var oe=h(G,2);{var pe=c=>{var y=qt(),M=a(y);i(y),L((ee,te)=>{S(y,"href",ee),S(M,"src",te),S(M,"alt",`Profile picture of ${e(o).user.name??""}, who liked this asset`)},[()=>qe.viewAlbumAsset({albumId:t.albumId,assetId:e(o).assetId}),()=>Ue({id:e(o).assetId})]),m(c,y)};w(oe,c=>{T()===void 0&&e(o).assetId&&c(pe)})}var p=h(oe,2);{var f=c=>{var y=Et(),M=a(y);{let ee=j(()=>n()("reaction_options"));Be(M,{get icon(){return Re},get title(){return e(ee)},align:"top-right",direction:"left",size:"small",children:(te,Yt)=>{{let lt=j(()=>n()("remove"));Fe(te,{activeColor:"bg-red-200",get icon(){return ze},get text(){return e(lt)},onClick:()=>V(e(o),e(g))})}},$$slots:{default:!0}})}i(y),m(c,y)};w(p,c=>{(e(o).user.id===t.user.id||t.albumOwnerId===t.user.id)&&c(f)})}i($);var D=h($,2);{var P=c=>{var y=Kt(),M=a(y,!0);i(y),L((ee,te)=>{S(y,"title",ee),U(M,te)},[()=>new Date(e(o).createdAt).toLocaleDateString(navigator.language,F),()=>N(ve.fromISO(e(o).createdAt,{locale:r()}))]),m(c,y)};w(D,c=>{(e(g)!=k.activities.length-1&&Pt(k.activities[e(g)].createdAt,k.activities[e(g)+1].createdAt)||e(g)===k.activities.length-1)&&c(P)})}i(H),L(c=>{S(G,"title",`${e(o).user.name} (${e(o).user.email})`),U(be,c)},[()=>n()("user_liked",{values:{user:e(o).user.name,type:ie()?xt(ie()).toLowerCase():null}})]),m(J,H)};w(Y,J=>{e(o).type===C.Like&&J(Z)},!0)}m(E,X)};w(fe,E=>{e(o).type===C.Comment?E(_e):E(ot,!1)})}m(d,q)}),i(v),L(()=>pt(v,`height: ${e(de)??""}px;padding-bottom: ${e(W)??""}px`)),m(s,v)};w(et,s=>{e(R)&&s(tt)})}i(ue);var Te=h(ue,2),me=a(Te),Se=a(me),ge=a(Se),it=a(ge);Ee(it,{get user(){return t.user},size:"md",noTitle:!0}),i(ge);var he=h(ge,2),De=a(he);{let s=j(()=>t.disabled?n()("comments_are_disabled"):n()("say_something")),v=j(()=>t.disabled?"cursor-not-allowed":"");Mt(De,{get disabled(){return t.disabled},rows:1,grow:!0,get placeholder(){return e(s)},[_t()]:d=>(yt(jt,()=>({shortcut:{key:"Enter"},onShortcut:()=>ce()}))||vt)(d),get class(){return`${e(v)??""} ring-0! w-full max-h-56 pe-2 items-center overflow-y-auto leading-4 outline-none resize-none bg-gray-200 dark:bg-gray-200`},get value(){return e(u)},set value(d){l(u,d,!0)}})}var st=h(De,2);{var at=s=>{var v=Qt(),d=a(v),o=a(d);bt(o,{size:"large"}),i(d),i(v),m(s,v)},rt=s=>{var v=we(),d=ne(v);{var o=g=>{var q=Wt(),fe=a(q);{let _e=j(()=>n()("send_message"));Oe(fe,{shape:"round",get"aria-label"(){return e(_e)},variant:"ghost",get icon(){return wt},onclick:()=>ce()})}i(q),m(g,q)};w(d,g=>{e(u)&&g(o)},!0)}m(s,v)};w(st,s=>{e(b)?s(at):s(rt,!1)})}i(he),i(Se),i(me),i(Te),i(ae),L(s=>U($e,s),[()=>n()("activity")]),xe(re,"clientHeight",s=>l(Q,s)),ct("submit",he,Je),xe(me,"clientHeight",s=>l(W,s)),xe(ae,"offsetHeight",s=>l(R,s)),m(O,ae),Ge(),z()}export{yi as A,k as a,bi as b};
