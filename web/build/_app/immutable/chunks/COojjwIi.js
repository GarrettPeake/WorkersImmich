import{g as J}from"./gvLJu3l0.js";import{O as R}from"./0qPXRVhz.js";import{e as d}from"./BpCm29KX.js";import{h as f,i as x,u as c,g as o,j,p as O,a as S}from"./D0CSSuTl.js";import{aB as T,aC as A,aD as r,aE as i,aF as U,aG as B,aH as y,aI as v,aJ as w}from"./BP6NvnZ7.js";import{D as E}from"./CJGyQpNN.js";import"./DsnmJJEf.js";import{a as I,s as L}from"./zonMEKN6.js";import{C as N}from"./DCmy867i.js";import{t as g,h as b}from"./DLePdI2u.js";import{g as p,$ as V}from"./DWQ0JXRY.js";import{F as G}from"./BMcevgEe.js";import{R as W}from"./gegweU97.js";import{br as X,bV as q,bW as H,bX as K,bY as h,bZ as Y,b_ as Z,b$ as z,c0 as $,bh as ee,c1 as ae,c2 as te,c3 as ie,c4 as oe,c5 as ne,ag as se,c6 as re,bp as C,K as ce,w as me,bo as ue}from"./D-UYCH9y.js";import{m as le}from"./BHTYC334.js";class de{#e=f(x([]));#i=c(()=>o(this.#e).at(-1)?.snapshot??[]);#t;#a=0;get snapshots(){return o(this.#e)}get queues(){return o(this.#i)}constructor(){d.on({QueueUpdate:()=>this.refresh()})}listen(){return this.#t||(this.#t=setInterval(()=>{this.refresh(!0)},3e3)),this.#a++,this.refresh(),()=>this.#a--}async refresh(a=!1){o(this.#e).push({timestamp:E.now().toMillis(),snapshot:this.#a>0||!a?await T().catch(()=>{}):void 0}),j(this.#e,o(this.#e).slice(-30),!0)}}const be=new de,pe=async e=>{const a=await p();try{return await A({jobCreateDto:e}),g.success(a("admin.job_created")),!0}catch(t){b(t,a("errors.unable_to_submit_job"))}};function _e(e,a){O(a,!0);const t=()=>I(V,"$t",n),[n,m]=L(),u=[{title:t()("admin.person_cleanup_job"),value:r.PersonCleanup},{title:t()("admin.tag_cleanup_job"),value:r.TagCleanup},{title:t()("admin.user_cleanup_job"),value:r.UserCleanup},{title:t()("admin.memory_cleanup_job"),value:r.MemoryCleanup},{title:t()("admin.memory_generate_job"),value:r.MemoryCreate},{title:t()("admin.backup_database"),value:r.BackupDatabase}].map(({value:l,title:_})=>({id:l,label:_,value:l}));let s=f(void 0);const Q=async()=>{if(!o(s))return;await pe({name:o(s).value})&&a.onClose()};{let l=c(()=>t()("admin.create_job")),_=c(()=>t()("create")),D=c(()=>!o(s));G(e,{get title(){return o(l)},get submitText(){return o(_)},get disabled(){return o(D)},get onClose(){return a.onClose},onSubmit:Q,children:(M,we)=>{{let P=c(()=>t()("jobs")),F=c(()=>t()("admin.search_jobs"));N(M,{get label(){return o(P)},get options(){return u},get placeholder(){return o(F)},get selectedOption(){return o(s)},set selectedOption(k){j(s,k,!0)}})}},$$slots:{default:!0}})}S(),m()}const Be=(e,a)=>{const t=(a??[]).filter(({isPaused:s})=>s).map(({name:s})=>s),n={title:e("resume_paused_jobs",{values:{count:t.length}}),$if:()=>t.length>0,icon:C,onAction:()=>je(t),data:{title:t.join(", ")}},m={icon:se,title:e("admin.create_job"),type:e("command"),shortcuts:{shift:!0,key:"n"},onAction:()=>le.show(_e,{})},u={icon:re,title:e("admin.manage_concurrency"),description:e("admin.manage_concurrency_description"),type:e("page"),onAction:()=>J(W.systemSettings({isOpen:R.JOB}))};return{ResumePaused:n,ManageConcurrency:u,CreateJob:m}},Ee=(e,a)=>{const t={icon:ue,title:e("pause"),$if:()=>!a.isPaused,onAction:()=>ge(a)},n={icon:C,title:e("resume"),$if:()=>a.isPaused,onAction:()=>he(a)},m={icon:me,title:e("clear"),onAction:()=>fe(a)},u={icon:ce,color:"danger",title:e("admin.remove_failed_jobs"),onAction:()=>ye(a)};return{Pause:t,Resume:n,Empty:m,RemoveFailedJobs:u}},ge=async e=>{const a=await w({name:e.name,queueUpdateDto:{isPaused:!0}});d.emit("QueueUpdate",a)},he=async e=>{const a=await w({name:e.name,queueUpdateDto:{isPaused:!1}});d.emit("QueueUpdate",a)},fe=async e=>{const a=await p(),t=ve(a,e);try{await y({name:e.name,queueDeleteDto:{failed:!1}});const n=await v({name:e.name});d.emit("QueueUpdate",n),g.success(a("admin.cleared_jobs",{values:{job:t.title}}))}catch(n){b(n,a("errors.something_went_wrong"))}},je=async e=>{const a=await p();try{for(const t of e)await U({name:t,queueCommandDto:{command:B.Resume,force:!1}});await be.refresh()}catch(t){b(t,a("admin.failed_job_command",{values:{command:"resume",job:"paused jobs"}}))}},ye=async e=>{const a=await p();try{await y({name:e.name,queueDeleteDto:{failed:!0}});const t=await v({name:e.name});d.emit("QueueUpdate",t),g.success()}catch(t){b(t,a("errors.something_went_wrong"))}},ve=(e,a)=>({[i.ThumbnailGeneration]:{icon:ne,title:e("admin.thumbnail_generation_job"),subtitle:e("admin.thumbnail_generation_job_description")},[i.MetadataExtraction]:{icon:oe,title:e("admin.metadata_extraction_job"),subtitle:e("admin.metadata_extraction_job_description")},[i.Library]:{icon:ie,title:e("external_libraries"),subtitle:e("admin.library_tasks_description")},[i.Sidecar]:{title:e("admin.sidecar_job"),icon:te,subtitle:e("admin.sidecar_job_description")},[i.SmartSearch]:{icon:ae,title:e("admin.machine_learning_smart_search"),subtitle:e("admin.smart_search_job_description")},[i.DuplicateDetection]:{icon:ee,title:e("admin.machine_learning_duplicate_detection"),subtitle:e("admin.duplicate_detection_job_description")},[i.FaceDetection]:{icon:$,title:e("admin.face_detection"),subtitle:e("admin.face_detection_description")},[i.FacialRecognition]:{icon:z,title:e("admin.machine_learning_facial_recognition"),subtitle:e("admin.facial_recognition_job_description")},[i.Ocr]:{icon:Z,title:e("admin.machine_learning_ocr"),subtitle:e("admin.ocr_job_description")},[i.VideoConversion]:{icon:Y,title:e("admin.video_conversion_job"),subtitle:e("admin.video_conversion_job_description")},[i.StorageTemplateMigration]:{icon:h,title:e("admin.storage_template_migration")},[i.Migration]:{icon:h,title:e("admin.migration_job"),subtitle:e("admin.migration_job_description")},[i.BackgroundTask]:{icon:K,title:e("admin.background_task_job")},[i.Search]:{icon:"",title:e("search")},[i.Notifications]:{icon:"",title:e("notifications")},[i.BackupDatabase]:{icon:H,title:e("admin.backup_database")},[i.Workflow]:{icon:q,title:e("workflows")},[i.Editor]:{icon:X,title:e("editor")}})[a.name];export{ve as a,Be as b,Ee as g,be as q};
